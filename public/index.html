<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Client</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“§</text></svg>">
  <style>
    /* STRICT monochrome: only black (#000) and white (#fff) */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      letter-spacing: -0.01em;
      margin: 0;
      padding: 0;
      background:#fff;
      color:#000;
    }
    h1 {
      margin:0 0 16px 0;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* Layout: 20% menu (left) + 80% board (right) */
    #layout{
      display:flex;
      min-height:100vh;
    }
    #sidebar{
      flex:0 0 64px;
      min-width:64px;
      border-right:1px solid #000;
      padding:16px 12px;
      box-sizing:border-box;
      transition:flex-basis 0.2s ease;
      display:flex;
      flex-direction:column;
      gap:10px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    #sidebar:hover{
      flex-basis:180px;
    }
    #board{
      flex:1;
      padding:32px;
      box-sizing:border-box;
    }

    #emails {max-width:800px; margin:0; background:#fff; border:1px solid #000; padding:24px;}
    ul {list-style:none; padding:0; margin:0;}
    li {padding:16px; border-bottom:1px solid #e0e0e0; cursor:pointer; transition: all 0.15s ease;}
    li:hover {background:#000; color:#fff; transform: translateX(4px);}
    .sub {font-weight:600; font-size:15px; margin-bottom:4px;}
    .meta {font-size:13px; opacity:0.6;}
    pre {background:#fff; padding:15px; border:1px solid #000;}

    /* Inputs (monochrome) */
    input, textarea{
      width:100%;
      padding:12px;
      border:1.5px solid #000;
      background:#fff;
      color:#000;
      box-sizing:border-box;
      font-family:inherit;
      transition: all 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }
    textarea{ min-height:150px; resize:vertical; }

    /* Minimal monochrome modal (no browser alerts/confirms) */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      z-index:10000;
      padding:20px;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      color:#000;
      border:1px solid #000;
      box-shadow:0 12px 32px rgba(0,0,0,.25);
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid #000;
      font-weight:700;
      letter-spacing:.2px;
    }
    .modal-body{
      padding:14px 16px;
      font-size:14px;
      line-height:1.45;
      word-break:break-word;
    }
    .modal-actions{
      padding:12px 16px;
      border-top:1px solid #000;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Email reader modal - Microsoft Outlook style */
    .email-modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.2);
      display:flex; align-items:center; justify-content:center;
      z-index:10001;
      padding:10px;
      overflow-y: auto; /* Allow modal overlay to scroll if content is too tall */
    }
    .email-modal{
      width:min(1200px, 95vw);
      height:min(800px, 90vh);
      min-height: 600px; /* Ensure minimum height */
      background:#fff;
      color:#000;
      border:2px solid #000;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      display:flex;
      flex-direction:row; /* Changed from column to row for 80/20 split */
      max-height: 90vh; /* Ensure modal doesn't exceed viewport height */
      overflow: hidden; /* Prevent content from overflowing outside modal */
      position: relative; /* Ensure proper positioning context */
    }

    /* Left content area (80%) */
    .email-modal-content{
      flex: 0 0 80%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Right action panel (20%) */
    .email-modal-actions{
      flex: 0 0 20%;
      min-width: 0; /* Prevent flex item from overflowing */
      border-left: 1px solid #000;
      padding: 24px 20px;
      overflow-y: auto;
      overflow-x: hidden; /* Prevent horizontal overflow */
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box; /* Include padding in width calculation */
    }

    /* Action buttons */
    .action-btn{
      width: 100%;
      padding: 14px 16px;
      background: #fff;
      color: #000;
      border: 1.5px solid #000;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-align: left;
      transition: all 0.12s ease;
      box-sizing: border-box; /* Include padding and border in width */
    }
    .action-btn:hover{
      background: #000;
      color: #fff;
    }
    .action-btn:active{
      transform: translateY(0);
    }

    /* Expandable button */
    .action-btn.expandable::after{
      content: 'â–¼';
      float: right;
      transition: transform 0.2s;
    }
    .action-btn.expandable.expanded::after{
      transform: rotate(180deg);
    }

    /* Sub-options container */
    .sub-options{
      display: none;
      flex-direction: column;
      gap: 5px;
      margin-top: 5px;
      padding-left: 10px;
    }
    .sub-options.expanded{
      display: flex;
    }

    /* Sub-option buttons */
    .sub-option-btn{
      width: 100%;
      padding: 10px;
      background: #fff;
      color: #000;
      border: 1px solid #000;
      cursor: pointer;
      font-size: 13px;
      text-align: left;
      transition: all 0.2s;
      box-sizing: border-box; /* Include padding and border in width */
    }
    .sub-option-btn:hover{
      background: #000;
      color: #fff;
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    .email-modal-header{
      padding:20px 24px;
      border-bottom:1px solid #000;
      background:#fafafa;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .email-modal-title{
      font-weight:600;
      font-size:16px;
      margin:0;
      flex:1;
    }
    .email-modal-close{
      background:none;
      border:1px solid #000;
      color:#000;
      cursor:pointer;
      padding:6px 12px;
      font-size:14px;
    }
    .email-modal-close:hover{
      background:#000;
      color:#fff;
    }
    .email-modal-meta{
      padding:12px 20px;
      border-bottom:1px solid #000;
      background:#fafafa;
      font-size:14px;
    }
    .email-modal-from{
      font-weight:600;
      margin-bottom:4px;
    }
    .email-modal-date{
      color:#666;
      font-size:13px;
    }
    .email-modal-body{
      flex:1;
      padding:32px;
      overflow-y:auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height:1.5;
      word-wrap:break-word;
    }
    /* Remove focus outline / highlight for date input in modal */
    .email-modal input[type="date"] {
      outline: none;
      box-shadow: none;
    }
    .email-modal input[type="date"]:focus {
      outline: none;
      box-shadow: none;
    }
    .btn{
      appearance:none;
      border:1.5px solid #000;
      background:#fff;
      color:#000;
      padding:10px 16px;
      cursor:pointer;
      font-weight:600;
      transition: all 0.12s ease;
    }
    .btn:hover{ background:#000; color:#fff; transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background:#000; color:#fff; }
    .btn.primary:hover{ background:#fff; color:#000; }

    /* Page buttons */
    .topbar{ margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; }
    .page-btn{
      border:1.5px solid #000;
      background:#fff;
      color:#000;
      padding:10px 16px;
      cursor:pointer;
      font-weight:700;
      text-align:center;
      transition: all 0.12s ease;
    }
    .page-btn:hover{ background:#000; color:#fff; transform: translateY(-1px); }
    .page-btn:active{ transform: translateY(0); }
    /* Sidebar buttons: make square and center the letter precisely */
    #sidebar .page-btn {
      width:44px;
      height:44px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      overflow:hidden;
      white-space:nowrap;
      transition: width 0.18s ease, padding 0.18s ease, justify-content 0.18s ease;
    }
    /* When sidebar is hovered, expand buttons to fill sidebar width and left-align text */
    #sidebar:hover .page-btn {
      width:100%;
      padding:8px 10px;
      justify-content:center;
      text-align:center;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .notice{
      padding:12px;
      border-bottom:1px solid #000;
      background:#fff;
      color:#000;
      font-weight:700;
    }

    /* Tabs (board top) */
    .tabs-bar{
      display:flex;
      gap:4px;
      margin-bottom:10px;
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #000;
      padding: 10px 0;
      z-index: 100;
    }
    .tab{
      border:1px solid #000;
      background:#fff;
      color:#000;
      padding:6px 10px;
      cursor:pointer;
      font-weight:600;
      position:relative;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tab-active{
      background:#000;
      color:#fff;
    }
    .tab-disabled{
      opacity:0.5;
      cursor:not-allowed;
      background:#f0f0f0;
      color:#999;
    }

    /* Quotation tag selection styles */
    .quotation-tag-btn.selected {
      background:#000 !important;
      color:#fff !important;
    }
    .quotation-tag-btn:hover:not(.selected) {
      background:#ccc !important;
      color:#000 !important;
    }
    .tab-close{
      display:none;
      border:none;
      background:transparent;
      color:inherit;
      cursor:pointer;
      padding:0;
      width:16px;
      height:16px;
      font-size:14px;
      line-height:1;
    }
    .tab:hover .tab-close{
      display:block;
    }

    /* Submenu styling */
    .menu-group {
      position: relative;
    }
    .submenu {
      margin-left: 20px;
      margin-top: 5px;
    }
    .submenu-btn {
      appearance: none;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      width: 100%;
      text-align: left;
      margin-bottom: 2px;
    }
    .submenu-btn:hover {
      background: #000;
      color: #fff;
    }

    /* Submenu styling */
    .menu-group {
      position: relative;
    }
    .submenu {
      margin-left: 20px;
      margin-top: 5px;
    }
    .submenu-btn {
      appearance: none;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      width: 100%;
      text-align: left;
      margin-bottom: 2px;
    }
    .submenu-btn:hover {
      background: #000;
      color: #fff;
    }

    /* Autocomplete dropdown styling */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    .autocomplete-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      box-sizing: border-box;
      font-family: inherit;
    }
    .autocomplete-input:focus {
      outline: none;
      border-color: #666;
    }
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #000;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: #000;
      color: #fff;
    }
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    .autocomplete-no-results {
      padding: 8px 12px;
      color: #666;
      font-style: italic;
    }

    /* Supplier tag styling */
    .supplier-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid #000;
      font-size: 13px;
      font-weight: 600;
    }

    .supplier-tag-remove {
      cursor: pointer;
      font-weight: bold;
      color: #666;
      margin-left: 4px;
      font-size: 16px;
      line-height: 1;
    }

    .supplier-tag-remove:hover {
      color: #000;
    }

    /* Loading spinner overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10002;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #fff;
      border-top: 5px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <!-- Chart.js library for better chart layout and responsiveness -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="layout">
    <div id="sidebar">
      <div class="menu-group">
        <button id="menuEmail" class="page-btn" data-short="E" data-full="Email" data-testid="menu-email">E</button>
        <div id="emailSubmenu" class="submenu" style="display:none;">
          <button id="emailReceiveBtn" class="submenu-btn" data-testid="email-receive-btn">Receive</button>
          <button id="emailSendBtn" class="submenu-btn" data-testid="email-send-btn">Send</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="menuCustomer" class="page-btn" data-short="C" data-full="Customer">C</button>
        <div id="customerSubmenu" class="submenu" style="display:none;">
          <button id="customerCreateBtn" class="submenu-btn">Create</button>
          <button id="customerViewBtn" class="submenu-btn">View</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="menuSupplier" class="page-btn" data-short="S" data-full="Supplier">S</button>
        <div id="supplierSubmenu" class="submenu" style="display:none;">
          <button id="supplierCreateBtn" class="submenu-btn">Create</button>
          <button id="supplierViewBtn" class="submenu-btn">View</button>
        </div>
      </div>
      <button id="menuTasks" class="page-btn" data-short="T" data-full="Task List">T</button>
      <button id="menuSkills" class="page-btn" data-short="K" data-full="Skills">K</button>
      <div class="menu-group">
      <button id="menuQuotation" class="page-btn" data-short="Q" data-full="Quotation" data-testid="menu-quotation">Q</button>
        <div id="quotationSubmenu" class="submenu" style="display:none;">
          <button id="quotationCreateBtn" class="submenu-btn" data-testid="quotation-create-btn">Create</button>
          <button id="quotationViewBtn" class="submenu-btn" data-testid="quotation-view-btn">View</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="menuOutsourcing" class="page-btn" data-short="O" data-full="Outsourcing">O</button>
        <div id="outsourcingSubmenu" class="submenu" style="display:none;">
          <button id="outsourcingCreateBtn" class="submenu-btn">Create</button>
          <button id="outsourcingViewBtn" class="submenu-btn">View</button>
        </div>
      </div>
      <button id="menuSettings" class="page-btn" data-short="S" data-full="Setting">S</button>
      <div style="flex:1;"></div>
      <div style="font-size:0.75em; text-align:center; color:#666; margin-top:10px; padding:5px;">
        v1.0.23
      </div>
    </div>
    <div id="board">
      <div id="tabsBar" class="tabs-bar"></div>

      <!-- Welcome / future dashboard -->
      <div id="welcomePanel" style="overflow:hidden; height:calc(100vh - 80px); display:flex; flex-direction:column;">
        <!-- Dashboard Header -->
        <div style="border:1px solid #000; padding:8px 12px; margin-bottom:2px; background:#666; color:#fff; flex-shrink:0;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <h1 style="margin:0; font-size:36px; font-weight:300; letter-spacing:-0.03em; line-height:1;">Dashboard.hello</h1>
            </div>
            <div style="display:flex; gap:4px; margin-top:2px;">
              <button id="viewModePie" class="page-btn" style="padding:4px 8px; font-size:13px; letter-spacing:0.1em; text-transform:uppercase;" title="Pie Chart">Pie</button>
              <button id="viewModeBar" class="page-btn" style="padding:4px 8px; font-size:13px; letter-spacing:0.1em; text-transform:uppercase;" title="Bar Chart">Bar</button>
            </div>
          </div>
        </div>

        <!-- 4-Column Grid Layout -->
        <div id="dashboardGrid" style="display:grid; grid-template-columns:1fr 3fr; gap:2px; flex:1; overflow:hidden; min-height:0; height:100%; transition:grid-template-columns 0.3s ease;">

          <!-- Column 1: Pie Chart (Always visible, clickable to expand) -->
          <div id="quotationDistributionColumn" style="border:1px solid #000; padding:20px 18px; background:#fff; display:flex; flex-direction:column; overflow:hidden; cursor:pointer; transition:all 0.3s ease;" onclick="toggleDashboardExpansion()">
            <div style="margin-bottom:16px; flex-shrink:0;">
              <h3 style="margin:0 0 4px 0; font-size:21px; letter-spacing:0.15em; text-transform:uppercase; font-weight:600;">Quotation Distribution</h3>
              <div style="width:42px; height:2px; background:#000; margin-top:6px;"></div>
              <div id="expandHint" style="margin-top:8px; font-size:14px; opacity:0.5; font-style:italic;">Click to expand â†’</div>
            </div>
            <div id="dashboardChart" style="flex:1; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; min-height:0;">
              <canvas id="chartCanvas" style="max-width:100%; max-height:100%;"></canvas>
              <div id="chartLoading" style="text-align:center; color:#999; font-size:25px;">Loading...</div>
            </div>
          </div>

          <!-- Empty space (shown when collapsed) -->
          <div id="emptySpace" style="display:block;"></div>

          <!-- Column 2: Status Breakdown (hidden by default) -->
          <div id="statusColumn" style="border:1px solid #000; padding:20px 18px; background:#fff; display:none; flex-direction:column; overflow:hidden;">
            <div style="margin-bottom:16px; flex-shrink:0;">
              <h3 style="margin:0 0 4px 0; font-size:21px; letter-spacing:0.15em; text-transform:uppercase; font-weight:600;">Status</h3>
              <div style="width:42px; height:2px; background:#000; margin-top:6px;"></div>
            </div>
            <div id="dashboardLegend" style="display:flex; flex-direction:column; gap:8px; flex:1; overflow:hidden; min-height:0;">
            </div>
          </div>

          <!-- Column 3: Metrics (hidden by default) -->
          <div id="metricsColumn" style="border:1px solid #000; padding:20px 18px; background:#fff; display:none; flex-direction:column; overflow:hidden;">
            <div style="margin-bottom:16px; flex-shrink:0;">
              <h3 style="margin:0 0 4px 0; font-size:21px; letter-spacing:0.15em; text-transform:uppercase; font-weight:600;">Metrics</h3>
              <div style="width:42px; height:2px; background:#000; margin-top:6px;"></div>
            </div>
            <div id="dashboardMetrics" style="display:flex; flex-direction:column; gap:18px; flex:1; justify-content:space-around; min-height:0;">
              <div>
                <div style="font-size:84px; font-weight:300; letter-spacing:-0.02em; line-height:1; margin-bottom:6px;" id="totalCount">â€”</div>
                <div style="font-size:21px; letter-spacing:0.1em; text-transform:uppercase; opacity:0.6;">Total Quotations</div>
              </div>
              <div>
                <div style="font-size:59px; font-weight:300; letter-spacing:-0.02em; line-height:1; margin-bottom:6px;" id="activeCount">â€”</div>
                <div style="font-size:21px; letter-spacing:0.1em; text-transform:uppercase; opacity:0.6;">Active</div>
              </div>
              <div>
                <div style="font-size:59px; font-weight:300; letter-spacing:-0.02em; line-height:1; margin-bottom:6px;" id="completedCount">â€”</div>
                <div style="font-size:21px; letter-spacing:0.1em; text-transform:uppercase; opacity:0.6;">Completed</div>
              </div>
            </div>
          </div>

          <!-- Column 4: Insights (hidden by default) -->
          <div id="insightsColumn" style="border:1px solid #000; padding:20px 18px; background:#fff; display:none; flex-direction:column; overflow:hidden;">
            <div style="margin-bottom:16px; flex-shrink:0;">
              <h3 style="margin:0 0 4px 0; font-size:21px; letter-spacing:0.15em; text-transform:uppercase; font-weight:600;">Insights</h3>
              <div style="width:42px; height:2px; background:#000; margin-top:6px;"></div>
            </div>
            <div id="dashboardInsights" style="display:flex; flex-direction:column; gap:14px; flex:1; font-size:25px; line-height:1.5; justify-content:space-around; min-height:0;">
              <div style="padding:12px; border:1px solid #000; background:#f9f9f9;">
                <div style="font-weight:600; margin-bottom:6px; font-size:21px; letter-spacing:0.1em; text-transform:uppercase;">Top Status</div>
                <div id="topStatus" style="font-size:27px;">â€”</div>
              </div>
              <div style="padding:12px; border:1px solid #000;">
                <div style="font-weight:600; margin-bottom:6px; font-size:21px; letter-spacing:0.1em; text-transform:uppercase;">Conversion Rate</div>
                <div id="conversionRate" style="font-size:27px;">â€”</div>
              </div>
              <div style="padding:12px; border:1px solid #000; background:#f9f9f9;">
                <div style="font-weight:600; margin-bottom:6px; font-size:21px; letter-spacing:0.1em; text-transform:uppercase;">Pending Review</div>
                <div id="pendingReview" style="font-size:27px;">â€”</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Profiles list (landing page for settings) -->
      <div id="profilesListPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3>Email Profiles</h3>
          <button id="addProfileBtn" class="page-btn" style="font-size:18px; padding:8px 16px;">+</button>
        </div>
        <div id="profilesList"></div>
      </div>

      <!-- Task List board -->
      <div id="tasksPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <h3>Task List</h3>
        <!-- Task list content will go here -->
      </div>

      <!-- Customer board -->
      <div id="customerPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <!-- Customer Tabs -->
        <div class="tabs-bar" style="margin-bottom:20px;">
          <div class="tab tab-active" data-tab="customer-info">Customer</div>
          <div class="tab tab-disabled" data-tab="member-info">Member</div>
        </div>

        <!-- Customer Info Tab -->
        <div id="customerInfoTab" style="display:block;">
          <form id="customerForm">
            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyName">Company Name *</label>
                <input id="companyName" type="text" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="emailDomain">Email Domain *</label>
                <input id="emailDomain" type="text" placeholder="example.com" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyAddress">Address</label>
                <textarea id="companyAddress" style="width:100%; min-height:60px;"></textarea>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyTel">Telephone</label>
                <input id="companyTel" type="tel" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyType">Type *</label>
                <select id="companyType" required style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                  <option value="">Select Type</option>
                  <option value="buyer">Buyer</option>
                  <option value="agent">Agent</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyWebsite">Website</label>
                <input id="companyWebsite" type="url" placeholder="https://www.example.com" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyDocs">Documents</label>
                <div style="border:2px dashed #ccc; padding:20px; text-align:center; background:#f9f9f9;">
                  <p>Drag & drop files here, or click to browse</p>
                  <input id="companyDocs" type="file" multiple style="margin-top:10px;">
                  <p style="font-size:0.8em; color:#666; margin-top:10px;">
                    Support: Browse, Copy & Paste, Drag & Drop
                  </p>
                </div>
              </div>
            </div>

            <div class="row">
              <button type="button" id="dummyInputBtn" class="page-btn" style="margin-right:10px;">Dummy Input</button>
              <button type="button" id="saveCustomerBtn" class="page-btn">Save & Continue to Members</button>
            </div>
          </form>
        </div>

        <!-- Member Info Tab -->
        <div id="memberInfoTab" style="display:none;">
          <div style="margin-bottom:15px;">
            <button id="addMemberBtn" class="page-btn">+ Add Member</button>
            <button id="dummyMemberBtn" class="page-btn" style="margin-left:10px;">Dummy Input</button>
          </div>

          <div id="membersList">
            <!-- Members will be added here dynamically -->
          </div>
        </div>
      </div>

      <!-- Customer View board -->
      <div id="customerViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <button id="refreshCustomersBtn" class="page-btn">Refresh List</button>
        </div>


        <!-- Customer Table -->
        <div id="customersTableContainer">
          <table id="customersTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Company Name</div>
                  <input type="text" id="customerFilterName" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Type</div>
                  <select id="customerFilterType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="buyer">Buyer</option>
                    <option value="agent">Agent</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email Domain</div>
                  <input type="text" id="customerFilterDomain" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="customerFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Website</div>
                  <input type="text" id="customerFilterWebsite" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Members</div>
                  <input type="text" id="customerFilterMembers" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Action</div>
                </th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <tr>
                <td colspan="7" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No customers saved yet. Create customers first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Supplier board -->
      <div id="supplierPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <!-- Supplier Tabs -->
        <div class="tabs-bar" style="margin-bottom:20px;">
          <div class="tab tab-active" data-tab="supplier-info">Supplier</div>
          <div class="tab tab-disabled" data-tab="supplier-member-info">Member</div>
        </div>

        <!-- Supplier Info Tab -->
        <div id="supplierInfoTab" style="display:block;">
          <form id="supplierForm">
            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyName">Company Name *</label>
                <input id="supplierCompanyName" type="text" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierEmailDomain">Email Domain *</label>
                <input id="supplierEmailDomain" type="text" placeholder="example.com" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyAddress">Address</label>
                <textarea id="supplierCompanyAddress" style="width:100%; min-height:60px;"></textarea>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyTel">Telephone</label>
                <input id="supplierCompanyTel" type="tel" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyType">Type *</label>
                <select id="supplierCompanyType" required style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                  <option value="">Select Type</option>
                  <option value="hang_tag">Hang Tag</option>
                  <option value="woven_label">Woven Label</option>
                  <option value="care_label">Care Label</option>
                  <option value="transfer">Transfer</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyWebsite">Website</label>
                <input id="supplierCompanyWebsite" type="url" placeholder="https://www.example.com" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="supplierCompanyDocs">Documents</label>
                <div style="border:2px dashed #ccc; padding:20px; text-align:center; background:#f9f9f9;">
                  <p>Drag & drop files here, or click to browse</p>
                  <input id="supplierCompanyDocs" type="file" multiple style="margin-top:10px;">
                  <p style="font-size:0.8em; color:#666; margin-top:10px;">
                    Support: Browse, Copy & Paste, Drag & Drop
                  </p>
                </div>
              </div>
            </div>

            <div class="row">
              <button type="button" id="supplierDummyInputBtn" class="page-btn" style="margin-right:10px;">Dummy Input</button>
              <button type="button" id="saveSupplierBtn" class="page-btn">Save & Continue to Members</button>
            </div>
          </form>
        </div>

        <!-- Member Info Tab -->
        <div id="supplierMemberInfoTab" style="display:none;">
          <div style="margin-bottom:15px;">
            <button id="addSupplierMemberBtn" class="page-btn">+ Add Member</button>
            <button id="dummySupplierMemberBtn" class="page-btn" style="margin-left:10px;">Dummy Input</button>
          </div>

          <div id="supplierMembersList">
            <!-- Members will be added here dynamically -->
          </div>
        </div>
      </div>

      <!-- Supplier View board -->
      <div id="supplierViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <button id="refreshSuppliersBtn" class="page-btn">Refresh List</button>
        </div>


        <!-- Supplier Table -->
        <div id="suppliersTableContainer">
          <table id="suppliersTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Company Name</div>
                  <input type="text" id="supplierFilterName" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Type</div>
                  <select id="supplierFilterType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="hang_tag">Hang Tag</option>
                    <option value="woven_label">Woven Label</option>
                    <option value="care_label">Care Label</option>
                    <option value="transfer">Transfer</option>
                    <option value="other">Other</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email Domain</div>
                  <input type="text" id="supplierFilterDomain" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="supplierFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Website</div>
                  <input type="text" id="supplierFilterWebsite" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Members</div>
                  <input type="text" id="supplierFilterMembers" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Action</div>
                </th>
              </tr>
            </thead>
            <tbody id="suppliersTableBody">
              <tr>
                <td colspan="7" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No suppliers saved yet. Create suppliers first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quotation View board -->
      <div id="quotationViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="refreshQuotationsBtn" class="page-btn">Refresh List</button>
          <button id="selectAllQuotationsBtn" class="page-btn">Select All</button>
          <button id="deselectAllQuotationsBtn" class="page-btn">Deselect All</button>
          <button id="batchDeleteQuotationsBtn" class="page-btn" style="background:#dc3545; color:#fff;">Delete Selected</button>
          <button id="batchUpdateStatusBtn" class="page-btn">Update Status</button>
        </div>

        <!-- Quotation Table -->
        <div id="quotationsTableContainer">
          <table id="quotationsTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:center; width:40px;">
                  <input type="checkbox" id="selectAllCheckbox" style="cursor:pointer;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Customer Name</div>
                  <input type="text" id="quotationFilterCustomer" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Contact Person</div>
                  <input type="text" id="quotationFilterContact" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email</div>
                  <input type="text" id="quotationFilterEmail" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="quotationFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Product Type</div>
                  <select id="quotationFilterType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="hang-tag">Hang Tag</option>
                    <option value="woven-label">Woven Label</option>
                    <option value="care-label">Care Label</option>
                    <option value="heat-transfer">Heat Transfer</option>
                    <option value="others">Others</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Quantity</div>
                  <input type="text" id="quotationFilterQuantity" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Total (HKD)</div>
                  <input type="text" id="quotationFilterTotal" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Type</div>
                  <select id="quotationFilterSourceType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="email">Email</option>
                    <option value="non email">Non Email</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Status</div>
                  <select id="quotationFilterStatus" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="send to customer">Send to Customer</option>
                    <option value="price confirmed">Price Confirmed</option>
                    <option value="sampling">Sampling</option>
                    <option value="sample delivered">Sample Delivered</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Date Created</div>
                  <input type="text" id="quotationFilterDate" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Action</div>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:center;">
                  <div>Delete</div>
                </th>
              </tr>
            </thead>
            <tbody id="quotationsTableBody">
              <tr>
                <td colspan="13" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No quotations saved yet. Create quotations first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Outsourcing View board -->
      <div id="outsourcingViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="refreshOutsourcingBtn" class="page-btn">Refresh List</button>
          <button id="selectAllOutsourcingBtn" class="page-btn">Select All</button>
          <button id="deselectAllOutsourcingBtn" class="page-btn">Deselect All</button>
          <button id="batchDeleteOutsourcingBtn" class="page-btn" style="background:#dc3545; color:#fff;">Delete Selected</button>
        </div>

        <!-- Outsourcing Table -->
        <div id="outsourcingTableContainer">
          <table id="outsourcingTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:center; width:40px;">
                  <input type="checkbox" id="selectAllOutsourcingCheckbox" style="cursor:pointer;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Customer Name</div>
                  <input type="text" id="outsourcingFilterCustomer" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Contact Person</div>
                  <input type="text" id="outsourcingFilterContact" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email</div>
                  <input type="text" id="outsourcingFilterEmail" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="outsourcingFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Product Type</div>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Quantity</div>
                  <input type="text" id="outsourcingFilterQuantity" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Total (HKD)</div>
                  <input type="text" id="outsourcingFilterTotal" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Type</div>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Status</div>
                  <select id="outsourcingFilterStatus" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="send to outsourcing supplier">Send to Outsourcing Supplier</option>
                    <option value="await quotation">Await Quotation</option>
                    <option value="compare quotation">Compare Quotation</option>
                    <option value="send to customer">Send to Customer</option>
                    <option value="price confirmed">Price Confirmed</option>
                    <option value="sampling">Sampling</option>
                    <option value="sample delivered">Sample Delivered</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Date Created</div>
                  <input type="text" id="outsourcingFilterDate" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Supplier</div>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:center;">
                  <div>Action</div>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:center;">
                  <div>Delete</div>
                </th>
              </tr>
            </thead>
            <tbody id="outsourcingTableBody">
              <tr>
                <td colspan="14" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No outsourcing quotations saved yet. Create outsourcing quotations first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Agent Skills board -->
      <div id="skillsPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <h3>Agent Skills Documentation System</h3>
          <p class="meta" style="margin-bottom:10px;">Track technical skills, implementations, and achievements</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="addSkillBtn" class="page-btn">Create Skill</button>
            <button id="refreshSkillsBtn" class="page-btn">Refresh</button>
            <select id="skillStatusFilter" class="page-btn" style="background:#fff; color:#000; border:1px solid #000; padding:8px;">
              <option value="">All Status</option>
              <option value="planned">Planned</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="deprecated">Deprecated</option>
            </select>
            <select id="skillCategoryFilter" class="page-btn" style="background:#fff; color:#000; border:1px solid #000; padding:8px;">
              <option value="">All Categories</option>
              <option value="frontend">Frontend</option>
              <option value="backend">Backend</option>
              <option value="database">Database</option>
              <option value="deployment">Deployment</option>
              <option value="design">Design</option>
              <option value="testing">Testing</option>
              <option value="documentation">Documentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-top:10px;">
            <input type="text" id="skillSearch" placeholder="Search skills..." style="width:100%; padding:8px; border:1px solid #000; box-sizing:border-box;">
          </div>
        </div>

        <!-- Skills Statistics -->
        <div id="skillsStats" style="margin-bottom:20px; padding:15px; background:#f8f8f8; border:1px solid #000;">
          <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div><strong>Total Skills:</strong> <span id="totalSkills">0</span></div>
            <div><strong>Completed:</strong> <span id="completedSkills">0</span></div>
            <div><strong>In Progress:</strong> <span id="inProgressSkills">0</span></div>
            <div><strong>Planned:</strong> <span id="plannedSkills">0</span></div>
          </div>
        </div>

        <!-- Skills Table -->
        <div id="skillsTableContainer">
          <table id="skillsTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">Skill Name</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Status</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Category</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Description</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Version</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Actions</th>
              </tr>
            </thead>
            <tbody id="skillsTableBody">
              <tr id="skillsLoadingRow">
                <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center;">
                  Loading skills...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quotation board -->
      <div id="quotationPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-bottom:20px;">
          <button class="quotation-tag-btn page-btn" id="hangTagBtn" data-tag="hang-tag" data-testid="hang-tag-btn">Hang Tag</button>
          <button class="quotation-tag-btn page-btn" id="wovenLabelBtn" data-tag="woven-label" data-testid="woven-label-btn">Woven Label</button>
          <button class="quotation-tag-btn page-btn" id="careLabelBtn" data-tag="care-label" data-testid="care-label-btn">Care Label</button>
          <button class="quotation-tag-btn page-btn" id="heatTransferBtn" data-tag="heat-transfer" data-testid="heat-transfer-btn">Heat Transfer</button>
          <button class="quotation-tag-btn page-btn" id="othersBtn" data-tag="others" data-testid="others-btn">Others</button>
        </div>

        <!-- Quotation Sub-board -->
        <div id="quotationSubBoard" style="display:none; margin-top:20px; padding:20px; border:1px solid #000; overflow:auto;">
          <div id="quotationSubBoardHeader" style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #000;">
            <h3 id="quotationSubBoardTitle" style="margin:0;"></h3>
          </div>
          <div id="quotationSubBoardContent">
            <!-- Content will be dynamically loaded here -->
          </div>
        </div>
      </div>

      <!-- Settings board (IMAP/SMTP profile edit form) -->
      <div id="settingsPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <form id="settingsForm">
        <h3>Profile &amp; Connection Settings</h3>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:1;">
            <label for="cfgMailUser">MAIL_USER</label>
            <input id="cfgMailUser" type="email" autocomplete="username">
          </div>
          <div style="flex:1;">
            <label for="cfgMailPass">MAIL_PASS</label>
            <div style="position:relative;">
              <input id="cfgMailPass" type="password" autocomplete="current-password" style="padding-right:30px;">
              <button id="togglePassword" type="button" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:#000; font-size:14px;">ðŸ‘ï¸</button>
            </div>
          </div>
        </div>

        <h4>IMAP (incoming)</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:2;">
            <label for="cfgImapHost">IMAP_HOST</label>
            <input id="cfgImapHost" type="text">
          </div>
          <div style="flex:1;">
            <label for="cfgImapPort">IMAP_PORT</label>
            <input id="cfgImapPort" type="number">
          </div>
          <div style="flex:1;">
            <label for="cfgImapTls">IMAP_TLS (true/false)</label>
            <input id="cfgImapTls" type="text">
          </div>
        </div>

        <h4>SMTP (outgoing)</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:2;">
            <label for="cfgSmtpHost">SMTP_HOST</label>
            <input id="cfgSmtpHost" type="text">
          </div>
          <div style="flex:1;">
            <label for="cfgSmtpPort">SMTP_PORT</label>
            <input id="cfgSmtpPort" type="number">
          </div>
          <div style="flex:1;">
            <label for="cfgSmtpSecure">SMTP_SECURE (true/false)</label>
            <input id="cfgSmtpSecure" type="text">
          </div>
        </div>

        <h4>Server</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:1;">
            <label for="cfgPort">PORT</label>
            <input id="cfgPort" type="number">
          </div>
        </div>

        <div class="row">
          <button id="saveConfigBtn" class="page-btn">Save Settings</button>
          <button id="dummyFillSettingsBtn" class="page-btn" type="button">Auto Fill (Random)</button>
        </div>
        <p class="meta" id="settingsNote"></p>
        </form>
      </div>

      <!-- Email UI (next step; hidden for now) -->
      <div id="emails" style="margin:0; display:none; width:100%;">
        <div class="topbar">
          <button id="composeBtn" class="page-btn">Compose</button>
          <button id="refreshEmailsBtn" class="page-btn">Refresh List</button>
          <button id="testSendBtn" class="page-btn">Send Test Email</button>
          <button id="testSmtpBtn" class="page-btn">Test SMTP Connection</button>
        </div>
        <div id="composeForm" style="display:none; background:#fff; padding:15px; border:1px solid #000; margin-bottom:15px;">
          <h3>Compose Email</h3>
          <input type="email" id="toEmail" placeholder="To:" style="margin-bottom:10px;">
          <input type="text" id="subjectEmail" placeholder="Subject:" style="margin-bottom:10px;">
          <textarea id="bodyEmail" placeholder="Message:" style="margin-bottom:10px;"></textarea>
          <div class="row">
            <button id="sendBtn" class="page-btn">Send</button>
            <button id="cancelBtn" class="page-btn">Cancel</button>
            <button id="dummyFillComposeBtn" class="page-btn" type="button" style="margin-left:auto;">Dummy Fill</button>
          </div>
        </div>
        <table id="emailTable" style="width:100%; border-collapse:collapse; border:1px solid #000; margin-bottom:15px;">
          <thead>
            <tr style="background:#fff;">
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Date</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Sender</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Subject</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Context</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Attachment</th>
            </tr>
            <tr style="background:#fff;">
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="dateSearch" placeholder="Search date..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="senderSearch" placeholder="Search sender..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="subjectSearch" placeholder="Search subject..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="contextSearch" placeholder="Search content..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="attachmentSearch" placeholder="Search attachments..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
            </tr>
          </thead>
          <tbody id="emailTableBody"></tbody>
        </table>

        <!-- Email Reader Modal (Microsoft Outlook style) -->
        <div id="emailModal" class="email-modal-overlay" style="display:none;">
          <div class="email-modal">
            <!-- Left content area (80%) -->
            <div class="email-modal-content">
              <div class="email-modal-header">
                <h2 id="emailModalSubject" class="email-modal-title">Email Subject</h2>
                <button id="emailModalClose" class="email-modal-close">Ã—</button>
              </div>
              <div class="email-modal-meta">
                <div id="emailModalFrom" class="email-modal-from">From: sender@example.com</div>
                <div id="emailModalTo" class="email-modal-from">To: recipient@example.com</div>
                <div id="emailModalDate" class="email-modal-date">Date: 2024-01-15</div>
                <!-- Customer Information Display -->
                <div id="emailCustomerInfo" style="margin-top:10px; padding:10px; border:1px solid #000; background:#f0f0f0; display:none;">
                  <div style="font-weight:bold; margin-bottom:5px;">ðŸ“‹ Customer Information</div>
                  <div id="customerInfoContent" style="font-size:14px;"></div>
                </div>
              </div>
              <div id="emailModalBody" class="email-modal-body">
                Email content will appear here...
              </div>
            </div>

            <!-- Right action panel (20%) -->
            <div class="email-modal-actions">
              <button class="action-btn expandable" id="quotationBtn" data-testid="email-quotation-btn">Quotation</button>
              <div class="sub-options" id="quotationSubOptions">
                <button class="sub-option-btn" data-type="hang-tag" data-testid="quotation-hang-tag-btn">Hang Tag</button>
                <button class="sub-option-btn" data-type="woven-label" data-testid="quotation-woven-label-btn">Woven Label</button>
                <button class="sub-option-btn" data-type="care-label" data-testid="quotation-care-label-btn">Care Label</button>
                <button class="sub-option-btn" data-type="transfer" data-testid="quotation-transfer-btn">Transfer</button>
                <button class="sub-option-btn" data-type="outsource" data-testid="quotation-outsource-btn">Outsource</button>
              </div>
              <button class="action-btn" id="imageLibBtn">Image Lib</button>
            </div>
          </div>
        </div>

        <!-- Email Quotation Modal -->
        <div id="emailQuotationModal" class="email-modal-overlay" style="display:none; z-index:10002;">
          <div class="email-modal" style="width:min(1400px, 95vw); height:min(900px, 90vh);">
            <div style="display:flex; flex-direction:column; width:100%; height:100%;">
              <div class="email-modal-header" style="background:#ffeb3b; border-bottom:2px solid #000;">
                <h2 class="email-modal-title" style="margin:0;">ðŸ“§ Email Quotation</h2>
                <button id="emailQuotationModalClose" class="email-modal-close">Ã—</button>
              </div>
              <div id="emailQuotationContent" style="flex:1; overflow:auto; padding:20px;">
                <!-- Quotation form will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Send UI (duplicated from receive with send focus) -->
      <div id="email-send" style="margin:0; display:none; width:100%;">
        <div class="topbar">
          <button id="composeSendBtn" class="page-btn">Compose</button>
          <button id="testSendEmailBtn" class="page-btn">Send Test Email</button>
          <button id="testSmtpConnectionBtn" class="page-btn">Test SMTP Connection</button>
        </div>
        <div id="composeSendForm" style="display:none; background:#fff; padding:15px; border:1px solid #000; margin-bottom:15px;">
          <h3>Compose Email</h3>
          <input type="email" id="toSendEmail" placeholder="To:" style="margin-bottom:10px;">
          <input type="text" id="subjectSendEmail" placeholder="Subject:" style="margin-bottom:10px;">
          <textarea id="bodySendEmail" placeholder="Message:" style="margin-bottom:10px;"></textarea>
          <div class="row">
            <button id="sendEmailBtn" class="page-btn">Send</button>
            <button id="cancelSendBtn" class="page-btn">Cancel</button>
            <button id="dummyFillSendComposeBtn" class="page-btn" type="button" style="margin-left:auto;">Dummy Fill</button>
          </div>
        </div>
        <div style="border:1px solid #000; padding:15px; margin-bottom:15px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Sent Emails from m.yau.01@longriverlabel.com</h3>
            <button id="refreshSentEmailsBtn" class="page-btn">Refresh</button>
          </div>
          <table id="sentEmailsTable" style="width:100%; border-collapse:collapse; border:1px solid #000; margin-bottom:15px;">
            <thead>
              <tr style="background:#fff;">
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Date Sent</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">From</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">To</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Subject</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Status</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Details</th>
              </tr>
              <tr style="background:#fff;">
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentDateSearch" placeholder="Search date..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentFromSearch" placeholder="Search sender..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentToSearch" placeholder="Search recipient..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentSubjectSearch" placeholder="Search subject..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <select id="sentStatusFilter" style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                    <option value="">All Status</option>
                    <option value="sent">Sent</option>
                    <option value="failed">Failed</option>
                  </select>
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentDetailsSearch" placeholder="Search content..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
              </tr>
            </thead>
            <tbody id="sentEmailsTableBody"></tbody>
          </table>
          <div id="sentEmailsLoading" style="text-align:center; padding:20px; display:none;">Loading sent emails...</div>
          <div id="sentEmailsEmpty" style="text-align:center; padding:20px; color:#666; display:none;">No sent emails found from m.yau.01@longriverlabel.com</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const tabsBar = document.getElementById('tabsBar');
    const welcomePanel = document.getElementById('welcomePanel');
    const profilesListPanel = document.getElementById('profilesListPanel');
    const settingsPanel = document.getElementById('settingsPanel');

    const menuSettingsBtn = document.getElementById('menuSettings');
    const menuTasksBtn = document.getElementById('menuTasks');
    const menuSkillsBtn = document.getElementById('menuSkills');
    const menuQuotationBtn = document.getElementById('menuQuotation');
    const menuOutsourcingBtn = document.getElementById('menuOutsourcing');
    const addProfileBtn = document.getElementById('addProfileBtn');
    const profilesListEl = document.getElementById('profilesList');
    const settingsNoteEl = document.getElementById('settingsNote');
    
    // Store current email list for quick access
    let currentEmails = [];
    let currentLoadController = null; // Track current load request
    let currentEmailMeta = null; // Track currently shown email (for task creation)
    let currentEmailModalMeta = null; // Track email in modal (for task creation)
    let currentCustomerData = null; // Track customer data for current email

    // Decode Quoted-Printable encoded content
    function decodeQuotedPrintable(str) {
      if (!str) return str;

      // Replace =XX with the corresponding character
      return str
        .replace(/=\r?\n/g, '') // Remove soft line breaks
        .replace(/=([0-9A-F]{2})/gi, (match, hex) => {
          return String.fromCharCode(parseInt(hex, 16));
        })
        .replace(/=20/g, ' ') // Replace =20 with space
        .replace(/=3D/g, '='); // Replace =3D with =
    }

    // Decode HTML entities (e.g., &lt; to <, &gt; to >, &amp; to &)
    function decodeHtmlEntities(str) {
      if (!str) return str;
      const textarea = document.createElement('textarea');
      textarea.innerHTML = str;
      return textarea.value;
    }

    // Search for customer by email address
    async function searchCustomerByEmail(email) {
      if (!email) return null;

      try {
        const response = await fetch('/api/email/search-customer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();
        if (data.success) {
          return {
            customer: data.customer,
            member: data.member,
            allMembers: data.allMembers
          };
        }
        return null;
      } catch (err) {
        console.error('Failed to search customer:', err);
        return null;
      }
    }

    // Display customer information in email modal
    function displayCustomerInfo(customerData) {
      const customerInfoEl = document.getElementById('emailCustomerInfo');
      const customerInfoContent = document.getElementById('customerInfoContent');

      if (!customerInfoEl || !customerInfoContent) return;

      let memberHtml = '';
      let customerHtml = '';

      // Build member information (left side)
      if (customerData.member) {
        const m = customerData.member;
        memberHtml += `<div style="margin-bottom:8px;"><strong>Contact:</strong> ${m.name}</div>`;
        if (m.title) {
          memberHtml += `<div style="margin-bottom:8px;"><strong>Title:</strong> ${m.title}</div>`;
        }
        if (m.tel) {
          memberHtml += `<div style="margin-bottom:8px;"><strong>Tel:</strong> ${m.tel}</div>`;
        }
        if (m.emailPrefix) {
          memberHtml += `<div style="margin-bottom:8px;"><strong>Email:</strong> ${m.emailPrefix}@${customerData.customer.emailDomain}</div>`;
        }
      } else if (customerData.allMembers && customerData.allMembers.length > 0) {
        // Show all members if specific member not found
        memberHtml += `<div style="margin-bottom:8px;"><strong>All Members:</strong></div>`;
        customerData.allMembers.forEach(m => {
          memberHtml += `<div style="margin-left:10px; margin-bottom:4px;">â€¢ ${m.name}`;
          if (m.title) memberHtml += ` (${m.title})`;
          memberHtml += `</div>`;
        });
      }

      // Build customer information (right side)
      if (customerData.customer) {
        const c = customerData.customer;
        customerHtml += `<div style="margin-bottom:8px;"><strong>Company:</strong> ${c.companyName}</div>`;
        customerHtml += `<div style="margin-bottom:8px;"><strong>Type:</strong> ${c.companyType}</div>`;
        if (c.companyAddress) {
          customerHtml += `<div style="margin-bottom:8px;"><strong>Address:</strong> ${c.companyAddress}</div>`;
        }
        if (c.companyTel) {
          customerHtml += `<div style="margin-bottom:8px;"><strong>Tel:</strong> ${c.companyTel}</div>`;
        }
        if (c.companyWebsite) {
          customerHtml += `<div style="margin-bottom:8px;"><strong>Website:</strong> ${c.companyWebsite}</div>`;
        }
      }

      // Create 50/50 split layout
      const html = `
        <div style="display:flex; gap:15px;">
          <div style="flex:1; padding-right:15px; border-right:1px solid #ccc;">
            <div style="font-weight:bold; margin-bottom:8px;">ðŸ‘¤ Member</div>
            ${memberHtml}
          </div>
          <div style="flex:1; padding-left:15px;">
            <div style="font-weight:bold; margin-bottom:8px;">ðŸ¢ Company</div>
            ${customerHtml}
          </div>
        </div>
      `;

      customerInfoContent.innerHTML = html;
      customerInfoEl.style.display = 'block';
    }

    // Hide customer information in email modal
    function hideCustomerInfo() {
      const customerInfoEl = document.getElementById('emailCustomerInfo');
      if (customerInfoEl) {
        customerInfoEl.style.display = 'none';
      }
    }

    // Decode MIME encoded-word (RFC 2047) - e.g., =?utf-8?B?V2Vp?= to "Wei"
    function decodeMimeEncodedWord(str) {
      if (!str) return str;
      return str.replace(/=\?([^?]+)\?([BQbq])\?([^?]+)\?=/g, (match, charset, encoding, encodedText) => {
        try {
          if (encoding.toUpperCase() === 'B') {
            // Base64 encoding
            const decoded = atob(encodedText);
            return decodeURIComponent(escape(decoded));
          } else if (encoding.toUpperCase() === 'Q') {
            // Quoted-Printable encoding
            const decoded = encodedText
              .replace(/_/g, ' ')
              .replace(/=([0-9A-F]{2})/gi, (m, hex) => String.fromCharCode(parseInt(hex, 16)));
            return decodeURIComponent(escape(decoded));
          }
        } catch (e) {
          console.warn('Failed to decode MIME encoded-word:', match, e);
          return match;
        }
        return match;
      });
    }

    // -------- SETTINGS (board) --------
    const cfgMailUser = document.getElementById('cfgMailUser');
    const cfgMailPass = document.getElementById('cfgMailPass');
    const cfgImapHost = document.getElementById('cfgImapHost');
    const cfgImapPort = document.getElementById('cfgImapPort');
    const cfgImapTls = document.getElementById('cfgImapTls');
    const cfgSmtpHost = document.getElementById('cfgSmtpHost');
    const cfgSmtpPort = document.getElementById('cfgSmtpPort');
    const cfgSmtpSecure = document.getElementById('cfgSmtpSecure');
    const cfgPort = document.getElementById('cfgPort');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const dummyFillSettingsBtn = document.getElementById('dummyFillSettingsBtn');
    const togglePasswordBtn = document.getElementById('togglePassword');

    async function loadConfig() {
      try {
        const res = await fetch('/api/config', { cache: 'no-cache' });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Load Settings Error', JSON.stringify(data, null, 2));
          return;
        }
        const cfg = data.config || {};
        cfgMailUser.value = cfg.MAIL_USER || '';
        cfgMailPass.value = cfg.MAIL_PASS || '';
        cfgImapHost.value = cfg.IMAP_HOST || '';
        cfgImapPort.value = cfg.IMAP_PORT || '';
        cfgImapTls.value = cfg.IMAP_TLS || '';
        cfgSmtpHost.value = cfg.SMTP_HOST || '';
        cfgSmtpPort.value = cfg.SMTP_PORT || '';
        cfgSmtpSecure.value = cfg.SMTP_SECURE || '';
        cfgPort.value = cfg.PORT || '';
        settingsNoteEl.textContent = data.note || 'Changes require server restart.';
      } catch (err) {
        await showCopyableError('Load Settings Error', `Error loading config: ${err.message}`);
      }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function fillDummyForm(panelEl) {
      const controls = Array.from(panelEl.querySelectorAll('input, textarea, select'));

      for (const el of controls) {
        if (el.disabled) continue;
        if (el.tagName === 'INPUT') {
          const type = (el.type || 'text').toLowerCase();
          if (type === 'button' || type === 'submit' || type === 'reset' || type === 'hidden') continue;
        }

        // Skip hidden/inactive elements
        if (el.offsetParent === null) continue;

        const id = (el.id || '').toLowerCase();
        const name = (el.name || '').toLowerCase();
        const labelEl = el.id ? panelEl.querySelector(`label[for="${CSS.escape(el.id)}"]`) : null;
        const label = (labelEl?.textContent || '').toLowerCase();
        const hint = `${id} ${name} ${label}`;

        if (el.tagName === 'SELECT') {
          const enabledOptions = Array.from(el.options).filter(o => !o.disabled && o.value !== '');
          if (enabledOptions.length) el.value = randomFrom(enabledOptions).value;
          continue;
        }

        if (el.tagName === 'TEXTAREA') {
          if (!el.value.trim()) el.value = 'Dummy text ' + randomInt(1000, 9999);
          el.dispatchEvent(new Event('input', { bubbles: true }));
          continue;
        }

        // INPUT types
        const type = (el.type || 'text').toLowerCase();
        if (type === 'checkbox') {
          el.checked = true;
          el.dispatchEvent(new Event('change', { bubbles: true }));
          continue;
        }
        if (type === 'radio') {
          el.checked = true;
          el.dispatchEvent(new Event('change', { bubbles: true }));
          continue;
        }
        if (type === 'number') {
          if (!String(el.value || '').trim()) el.value = String(randomInt(1, 9999));
          el.dispatchEvent(new Event('input', { bubbles: true }));
          continue;
        }
        if (el.tagName === 'SELECT') {
          if (hint.includes('contact') && hint.includes('person')) {
            // Special handling for contact person - will be populated when customer is selected
            continue;
          }
          const enabledOptions = Array.from(el.options).filter(o => !o.disabled && o.value !== '');
          if (enabledOptions.length) el.value = randomFrom(enabledOptions).value;
          el.dispatchEvent(new Event('change', { bubbles: true }));
          continue;
        }
        if (type === 'email') {
          if (!el.value.trim()) el.value = `dummy${randomInt(10, 999)}@example.com`;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          continue;
        }
        if (type === 'password') {
          if (!el.value) el.value = 'DummyPass' + randomInt(1000, 9999);
          el.dispatchEvent(new Event('input', { bubbles: true }));
          continue;
        }

        // Heuristics based on id/label
        if (!el.value.trim()) {
          if (hint.includes('imap_host')) el.value = 'imap.example.com';
          else if (hint.includes('smtp_host')) el.value = 'smtp.example.com';
          else if (hint.includes('host')) el.value = 'localhost';
          else if (hint.includes('imap_port')) el.value = '993';
          else if (hint.includes('smtp_port')) el.value = '465';
          else if (hint.includes('port')) el.value = '3001';
          else if (hint.includes('tls') || hint.includes('secure')) el.value = 'true';
          else if (hint.includes('customer') && hint.includes('name')) {
            // Special handling for customer name - use real customer from database
            if (window.customerAutocomplete && window.customerAutocomplete.customers && window.customerAutocomplete.customers.length > 0) {
              // Select a random customer from the database
              const randomCustomer = randomFrom(window.customerAutocomplete.customers);
              window.customerAutocomplete.selectCustomer(randomCustomer.id);
              continue; // Skip setting value manually since selectCustomer handles it
            } else {
              el.value = 'ABC Company Ltd';
            }
          }
          else if (hint.includes('contact') && hint.includes('person')) el.value = 'John Smith';
          else if (hint.includes('phone')) el.value = '+852 ' + randomInt(90000000, 99999999);
          else if (hint.includes('size')) el.value = randomInt(1, 5) + 'x' + randomInt(1, 8) + ' inches';
          else if (hint.includes('width')) el.value = randomInt(1, 4) + ' inch';
          else if (hint.includes('quantity')) el.value = String(randomFrom([500, 1000, 2000, 5000, 10000]));
          else if (hint.includes('unit') && hint.includes('price')) el.value = String(randomFrom([0.1, 0.25, 0.5, 0.75, 1.0, 1.5, 2.0]));
          else el.value = 'Dummy ' + randomInt(1000, 9999);
        }
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }

    dummyFillSettingsBtn.onclick = () => {
      fillDummyForm(settingsPanel);
    };

    togglePasswordBtn.onclick = () => {
      const passwordInput = document.getElementById('cfgMailPass');
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      togglePasswordBtn.textContent = isPassword ? 'ðŸ™ˆ' : 'ðŸ‘ï¸';
    };

    saveConfigBtn.onclick = async () => {
      try {
        // 1) Validate settings form completeness FIRST (before any profile-name prompt)
        const inputs = Array.from(settingsPanel.querySelectorAll('input'));
        const missingLabels = [];

        for (const input of inputs) {
          // Skip inputs that are not actionable/visible
          if (input.disabled) continue;
          if (input.type === 'button' || input.type === 'submit' || input.type === 'reset') continue;

          // Skip hidden inputs or anything inside a hidden container
          // (offsetParent is null when display:none or not in layout)
          if (input.type === 'hidden' || input.offsetParent === null) continue;

          const value = (input.value ?? '').toString().trim();
          if (value) continue;

          // Derive label from <label for="..."> when possible, fallback to id/name
          const labelEl = settingsPanel.querySelector(`label[for="${CSS.escape(input.id)}"]`);
          const label = (labelEl?.textContent || input.name || input.id || 'Unnamed field').trim();
          missingLabels.push(label);
        }

        if (missingLabels.length) {
          await showModal({
            title: 'Incomplete fields',
            body: `Please fill in:\n${missingLabels.join('\n')}`
          });
          return;
        }

        // 2) Load existing profiles (for duplicate name check)
        const listRes = await fetch('/api/profiles', { cache: 'no-cache' });
        const listData = await listRes.json();
        const profiles = listData?.profiles || [];

        // 3) Prompt for profile name (required + unique)
        let profileName = currentEditingProfileId ? (profiles.find(p => p.id === currentEditingProfileId)?.name || '') : '';
        while (true) {
          const result = await showTextInputModal({
            title: 'Profile name',
            label: 'Profile name (required):',
            initialValue: profileName,
            okText: 'OK',
            cancelText: 'Cancel'
          });

          if (!result.ok) {
            return; // user cancelled
          }

          profileName = (result.value || '').trim();
          if (!profileName) {
            await showModal({ title: 'Profile name required', body: 'Please enter a profile name.' });
            continue;
          }
          const exists = profiles.some(p => String(p.name || '').toLowerCase() === profileName.toLowerCase() && p.id !== currentEditingProfileId);
          if (exists) {
            await showModal({ title: 'Name already exists', body: `Profile name "${profileName}" already exists. Please use a different name.` });
            continue;
          }
          break;
        }

        const payload = {
          name: profileName,
          remark: profileName,
          mailUser: cfgMailUser.value.trim(),
          mailPass: cfgMailPass.value,
          imapHost: cfgImapHost.value.trim(),
          imapPort: cfgImapPort.value.trim(),
          imapTls: cfgImapTls.value.trim(),
          smtpHost: cfgSmtpHost.value.trim(),
          smtpPort: cfgSmtpPort.value.trim(),
          smtpSecure: cfgSmtpSecure.value.trim(),
          port: cfgPort.value.trim(),
          isActive: 0,
        };

        const url = currentEditingProfileId ? `/api/profiles/${currentEditingProfileId}` : '/api/profiles';
        const method = currentEditingProfileId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Save Profile Error', JSON.stringify(data, null, 2));
          return;
        }

        settingsHasUnsavedChanges = false;
        await loadProfilesList();

        await showModal({
          title: 'Profile Saved',
          body: `Profile "${profileName}" saved.\nIf you want it to take effect for sending/receiving email, select the profile and implement activation logic (next step).`,
        });

        // Close editor after saving
        settingsPanel.style.display = 'none';
        currentEditingProfileId = null;
      } catch (err) {
        await showCopyableError('Save Profile Error', `Error saving profile: ${err.message}`);
      }
    };

    // Track changes to settings form
    [cfgMailUser, cfgMailPass, cfgImapHost, cfgImapPort, cfgImapTls, cfgSmtpHost, cfgSmtpPort, cfgSmtpSecure, cfgPort].forEach(input => {
      input.addEventListener('input', () => {
        settingsHasUnsavedChanges = true;
      });
    });

    // Track if settings have unsaved changes
    let settingsHasUnsavedChanges = false;
    let currentEditingProfileId = null; // null means creating new profile

    // --- Tabs handling (welcome + future boards) ---
    function ensureTab(id, label) {
      let tab = tabsBar.querySelector(`[data-tab-id="${id}"]`);
      if (!tab) {
        tab = document.createElement('div');
        tab.className = 'tab';
        tab.dataset.tabId = id;
        
        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        tab.appendChild(labelSpan);
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.textContent = 'Ã—';
        closeBtn.onclick = async (e) => {
          e.stopPropagation();
          await closeTab(id);
        };
        tab.appendChild(closeBtn);
        
        tab.onclick = () => activateTab(id);
        tabsBar.appendChild(tab);
      }
      return tab;
    }

    async function closeTab(id) {
      // Always prompt warning before closing profiles tab
      if (id === 'profiles') {
        const confirmed = await showModal({
          title: 'Warning',
          body: 'Closing this tag will lose everything.',
          okText: 'Close',
          cancelText: 'Cancel'
        });
        if (!confirmed) {
          return; // Do not close if user cancels
        }
      }
      
      // Hide all panels first
      settingsPanel.style.display = 'none';
      profilesListPanel.style.display = 'none';
      
      // Remove tab
      const tab = tabsBar.querySelector(`[data-tab-id="${id}"]`);
      if (tab) {
        tab.remove();
      }
      
      // Always switch to welcome when closing a tab
      activateTab('welcome');
      
      // Reset unsaved changes flag
      settingsHasUnsavedChanges = false;
    }

    function activateTab(id) {
      // Visual active state
      Array.from(tabsBar.children).forEach(el => {
        if (el.dataset.tabId === id) {
          el.classList.add('tab-active');
        } else {
          el.classList.remove('tab-active');
        }
      });

      // Panels
      welcomePanel.style.display = id === 'welcome' ? 'block' : 'none';
      profilesListPanel.style.display = id === 'profiles' ? 'block' : 'none';
      document.getElementById('emails').style.display = id === 'emails' ? 'block' : 'none';
      document.getElementById('email-send').style.display = id === 'email-send' ? 'block' : 'none';
      document.getElementById('customerPanel').style.display = id === 'customer' ? 'block' : 'none';
      document.getElementById('customerViewPanel').style.display = id === 'customer-view' ? 'block' : 'none';
      document.getElementById('supplierPanel').style.display = id === 'supplier' ? 'block' : 'none';
      document.getElementById('supplierViewPanel').style.display = id === 'supplier-view' ? 'block' : 'none';
      document.getElementById('tasksPanel').style.display = id === 'tasks' ? 'block' : 'none';
      document.getElementById('skillsPanel').style.display = id === 'skills' ? 'block' : 'none';
      document.getElementById('quotationPanel').style.display = (id === 'quotation' || id === 'outsourcing') ? 'block' : 'none';
      document.getElementById('quotationViewPanel').style.display = id === 'quotation-view' ? 'block' : 'none';
      document.getElementById('outsourcingViewPanel').style.display = id === 'outsourcing-view' ? 'block' : 'none';
      // settingsPanel is shown inline within profiles when a profile is clicked
      settingsPanel.style.display = 'none';

      if (id === 'profiles') {
        loadProfilesList().catch(() => {});
      }

      if (id === 'welcome') {
        loadDashboardQuotations().catch(() => {});
      }
    }

    let currentDashboardView = 'pie'; // 'pie' or 'bar'
    let dashboardData = null;
    let dashboardExpanded = false; // Track expansion state

    // Toggle dashboard expansion
    function toggleDashboardExpansion() {
      dashboardExpanded = !dashboardExpanded;

      const grid = document.getElementById('dashboardGrid');
      const emptySpace = document.getElementById('emptySpace');
      const statusColumn = document.getElementById('statusColumn');
      const metricsColumn = document.getElementById('metricsColumn');
      const insightsColumn = document.getElementById('insightsColumn');
      const expandHint = document.getElementById('expandHint');

      if (dashboardExpanded) {
        // Expand: Show all 4 columns (each 25% width = 100% total)
        grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
        emptySpace.style.display = 'none';
        statusColumn.style.display = 'flex';
        metricsColumn.style.display = 'flex';
        insightsColumn.style.display = 'flex';
        expandHint.textContent = 'â† Click to collapse';
      } else {
        // Collapse: Show only quotation distribution (25% width, 75% empty)
        grid.style.gridTemplateColumns = '1fr 3fr';
        emptySpace.style.display = 'block';
        statusColumn.style.display = 'none';
        metricsColumn.style.display = 'none';
        insightsColumn.style.display = 'none';
        expandHint.textContent = 'Click to expand â†’';
      }
    }

    async function loadDashboardQuotations() {
      try {
        const quotations = await loadQuotationsFromStorage();

        // Group quotations by status and count
        const statusCounts = {
          'pending': 0,
          'send to customer': 0,
          'price confirmed': 0,
          'sampling': 0,
          'sample delivered': 0
        };

        quotations.forEach(q => {
          const status = (q.status || 'draft').toLowerCase();
          if (statusCounts.hasOwnProperty(status)) {
            statusCounts[status]++;
          }
        });

        // Calculate total and percentages
        const total = Object.values(statusCounts).reduce((sum, count) => sum + count, 0);

        dashboardData = {
          statuses: [
            { name: 'Pending', key: 'pending', count: statusCounts['pending'], color: '#17a2b8', icon: 'â³' },
            { name: 'Send to Customer', key: 'send to customer', count: statusCounts['send to customer'], color: '#007bff', icon: 'ðŸ“§' },
            { name: 'Price Confirmed', key: 'price confirmed', count: statusCounts['price confirmed'], color: '#28a745', icon: 'âœ…' },
            { name: 'Sampling', key: 'sampling', count: statusCounts['sampling'], color: '#6f42c1', icon: 'ðŸ”¬' },
            { name: 'Sample Delivered', key: 'sample delivered', count: statusCounts['sample delivered'], color: '#20c997', icon: 'ðŸ“¦' }
          ],
          total: total
        };

        // Calculate percentages
        dashboardData.statuses.forEach(status => {
          status.percentage = total > 0 ? ((status.count / total) * 100).toFixed(1) : 0;
        });

        // Render based on current view mode
        renderDashboard();

        // Set up view mode switcher buttons
        const pieBtn = document.getElementById('viewModePie');
        const barBtn = document.getElementById('viewModeBar');

        if (pieBtn && barBtn) {
          pieBtn.onclick = () => {
            currentDashboardView = 'pie';
            pieBtn.style.background = '#000';
            pieBtn.style.color = '#fff';
            barBtn.style.background = '#fff';
            barBtn.style.color = '#000';
            renderDashboard();
          };

          barBtn.onclick = () => {
            currentDashboardView = 'bar';
            barBtn.style.background = '#000';
            barBtn.style.color = '#fff';
            pieBtn.style.background = '#fff';
            pieBtn.style.color = '#000';
            renderDashboard();
          };

          // Set initial button states
          pieBtn.style.background = '#000';
          pieBtn.style.color = '#fff';
        }

      } catch (error) {
        console.error('Error loading dashboard quotations:', error);
        const chartContainer = document.getElementById('dashboardChart');
        if (chartContainer) {
          chartContainer.innerHTML = '<div style="text-align:center; padding:50px; color:#dc3545;">Error loading quotation data</div>';
        }
      }
    }

    function renderDashboard() {
      if (!dashboardData) return;

      if (currentDashboardView === 'pie') {
        renderPieChart();
      } else {
        renderBarChart();
      }

      renderLegend();
    }

    let chartInstance = null; // Store chart instance for cleanup

    function renderPieChart() {
      const canvas = document.getElementById('chartCanvas');
      const loading = document.getElementById('chartLoading');
      if (!canvas) return;

      if (dashboardData.total === 0) {
        canvas.style.display = 'none';
        if (loading) {
          loading.style.display = 'block';
          loading.innerHTML = 'No data';
        }
        return;
      }

      // Show canvas and hide loading
      canvas.style.display = 'block';
      if (loading) loading.style.display = 'none';

      // Destroy previous chart instance if exists
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Prepare data for Chart.js - BLACK AND WHITE ONLY
      const labels = dashboardData.statuses.map(s => s.name);
      const data = dashboardData.statuses.map(s => s.count);

      // Black and white gradient shades
      const bwColors = ['#000000', '#333333', '#666666', '#999999', '#cccccc', '#e5e5e5'];

      // Create new Chart.js doughnut chart with minimal black and white design
      const ctx = canvas.getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: bwColors.slice(0, data.length),
            borderColor: '#fff',
            borderWidth: 3,
            hoverBorderWidth: 4,
            hoverBorderColor: '#000'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          cutout: '65%',
          layout: {
            padding: 10
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: true,
              backgroundColor: '#000',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#000',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              titleFont: {
                size: 11,
                weight: '600',
                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
              },
              bodyFont: {
                size: 13,
                weight: '300',
                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
              },
              callbacks: {
                title: function(context) {
                  return context[0].label.toUpperCase();
                },
                label: function(context) {
                  const value = context.parsed || 0;
                  const percentage = ((value / dashboardData.total) * 100).toFixed(1);
                  return `${value} (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 800,
            easing: 'easeInOutQuart'
          }
        },
        plugins: [{
          id: 'centerText',
          beforeDraw: function(chart) {
            const width = chart.width;
            const height = chart.height;
            const ctx = chart.ctx;
            ctx.restore();

            const fontSize = (height / 180).toFixed(2);
            ctx.font = `300 ${fontSize}em -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#000';

            const text = dashboardData.total.toString();
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 2 - 10;

            ctx.fillText(text, textX, textY);

            // Label below number
            ctx.font = `600 ${(fontSize * 0.25).toFixed(2)}em -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
            ctx.fillStyle = '#666';
            const label = 'TOTAL';
            const labelX = Math.round((width - ctx.measureText(label).width) / 2);
            const labelY = height / 2 + 20;
            ctx.fillText(label, labelX, labelY);

            ctx.save();
          }
        }]
      });

      // Update metrics
      updateDashboardMetrics();
    }

    function renderBarChart() {
      const canvas = document.getElementById('chartCanvas');
      const loading = document.getElementById('chartLoading');
      if (!canvas) return;

      if (dashboardData.total === 0) {
        canvas.style.display = 'none';
        if (loading) {
          loading.style.display = 'block';
          loading.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">No quotations to display</div>';
        }
        return;
      }

      // Show canvas and hide loading
      canvas.style.display = 'block';
      if (loading) loading.style.display = 'none';

      // Destroy previous chart instance if exists
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Prepare data for Chart.js
      const labels = dashboardData.statuses.map(s => `${s.icon} ${s.name}`);
      const data = dashboardData.statuses.map(s => s.count);
      const colors = dashboardData.statuses.map(s => s.color);

      // Create new Chart.js horizontal bar chart with layout plugin configuration
      const ctx = canvas.getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quotations',
            data: data,
            backgroundColor: colors,
            borderColor: '#000',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y', // Horizontal bars
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.8,
          layout: {
            padding: {
              top: 20,
              bottom: 20,
              left: 20,
              right: 20
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#000',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#000',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  const value = context.parsed.x || 0;
                  const percentage = ((value / dashboardData.total) * 100).toFixed(1);
                  return `${context.dataset.label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                color: '#000',
                font: {
                  size: 12,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                color: '#e0e0e0',
                drawBorder: true,
                borderColor: '#000'
              }
            },
            y: {
              ticks: {
                color: '#000',
                font: {
                  size: 13,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                display: false,
                drawBorder: true,
                borderColor: '#000'
              }
            }
          }
        }
      });
    }

    function renderLegend() {
      const legendContainer = document.getElementById('dashboardLegend');
      if (!legendContainer) return;

      // Black and white gradient shades
      const bwColors = ['#000000', '#333333', '#666666', '#999999', '#cccccc', '#e5e5e5'];

      const legendItems = dashboardData.statuses.map((status, index) => `
        <div style="display:flex; align-items:flex-start; gap:8px; padding:6px 0; border-bottom:1px solid #f0f0f0;">
          <div style="width:50px; height:50px; background:${bwColors[index]}; border:1px solid #000; flex-shrink:0; margin-top:1px;"></div>
          <div style="flex:1;">
            <div style="font-size:19px; letter-spacing:0.1em; text-transform:uppercase; font-weight:600; margin-bottom:2px;">${status.name}</div>
            <div style="font-size:38px; font-weight:300; letter-spacing:-0.02em; line-height:1; margin-bottom:2px;">${status.count}</div>
            <div style="font-size:21px; opacity:0.6;">${status.percentage}%</div>
          </div>
        </div>
      `).join('');

      legendContainer.innerHTML = legendItems;
    }

    function updateDashboardMetrics() {
      if (!dashboardData) return;

      // Update total count
      const totalCountEl = document.getElementById('totalCount');
      if (totalCountEl) {
        totalCountEl.textContent = dashboardData.total;
      }

      // Calculate active (draft + pending + send to customer)
      const activeStatuses = ['draft', 'pending', 'send to customer'];
      const activeCount = dashboardData.statuses
        .filter(s => activeStatuses.includes(s.key))
        .reduce((sum, s) => sum + s.count, 0);

      const activeCountEl = document.getElementById('activeCount');
      if (activeCountEl) {
        activeCountEl.textContent = activeCount;
      }

      // Calculate completed (price confirmed + rejected)
      const completedStatuses = ['price confirmed', 'rejected'];
      const completedCount = dashboardData.statuses
        .filter(s => completedStatuses.includes(s.key))
        .reduce((sum, s) => sum + s.count, 0);

      const completedCountEl = document.getElementById('completedCount');
      if (completedCountEl) {
        completedCountEl.textContent = completedCount;
      }

      // Update insights
      // Top status
      const topStatus = dashboardData.statuses.reduce((max, status) =>
        status.count > max.count ? status : max
      , dashboardData.statuses[0]);

      const topStatusEl = document.getElementById('topStatus');
      if (topStatusEl) {
        topStatusEl.textContent = `${topStatus.name} (${topStatus.count})`;
      }

      // Conversion rate (price confirmed / total)
      const priceConfirmed = dashboardData.statuses.find(s => s.key === 'price confirmed');
      const conversionRate = dashboardData.total > 0
        ? ((priceConfirmed.count / dashboardData.total) * 100).toFixed(1)
        : '0.0';

      const conversionRateEl = document.getElementById('conversionRate');
      if (conversionRateEl) {
        conversionRateEl.textContent = `${conversionRate}%`;
      }

      // Pending review (pending + send to customer)
      const pendingReviewStatuses = ['pending', 'send to customer'];
      const pendingReviewCount = dashboardData.statuses
        .filter(s => pendingReviewStatuses.includes(s.key))
        .reduce((sum, s) => sum + s.count, 0);

      const pendingReviewEl = document.getElementById('pendingReview');
      if (pendingReviewEl) {
        pendingReviewEl.textContent = pendingReviewCount;
      }
    }

    // Profiles list functions
    async function loadProfilesList() {
      try {
        const res = await fetch('/api/profiles', { cache: 'no-cache' });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Load Profiles Error', JSON.stringify(data, null, 2));
          return;
        }
        const profiles = data.profiles || [];
        
        // If no profiles, create default "longriver.com"
        if (profiles.length === 0) {
          await createDefaultProfile();
          return loadProfilesList(); // Reload after creating default
        }

        profilesListEl.innerHTML = '';
        profiles.forEach(p => {
          const item = document.createElement('div');
          item.style.cssText = 'padding:12px; border-bottom:1px solid #000; cursor:pointer;';
          item.innerHTML = `
            <div style="font-weight:700;">${p.name || 'Unnamed'}</div>
            <div class="meta">${p.remark || ''}</div>
            <div class="meta" style="font-size:0.85em;">${p.mailUser || ''} | Active: ${p.isActive ? 'Yes' : 'No'}</div>
          `;
          item.innerHTML += `<div style="margin-top:6px; display:flex; gap:6px;">
              <button class="btn ${p.isActive ? 'primary' : ''}" data-action="activate">${p.isActive ? 'Active' : 'Activate'}</button>
              <button class="btn" data-action="edit">Edit</button>
              <button class="btn" data-action="delete">Delete</button>
            </div>`;
          item.onclick = (e) => {
            const action = e.target?.dataset?.action;
            if (action === 'activate') {
              e.stopPropagation();
              (async () => {
                // Toggle active state
                const newActiveState = p.isActive ? 0 : 1;
                const res = await fetch(`/api/profiles/${p.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ...p, isActive: newActiveState })
                });
                const data = await res.json();
                if (!data.success) {
                  await showCopyableError('Update Profile Error', JSON.stringify(data, null, 2));
                  return;
                }
                await loadProfilesList(); // Refresh the list
              })();
            } else if (action === 'edit') {
              e.stopPropagation();
              // Edit profile
              currentEditingProfileId = p.id;
            settingsPanel.style.display = 'block';
            cfgMailUser.value = p.mailUser || '';
            cfgMailPass.value = p.mailPass || '';
            cfgImapHost.value = p.imapHost || '';
            cfgImapPort.value = p.imapPort || '';
            cfgImapTls.value = p.imapTls || 'true';
            cfgSmtpHost.value = p.smtpHost || '';
            cfgSmtpPort.value = p.smtpPort || '';
            cfgSmtpSecure.value = p.smtpSecure || 'true';
            cfgPort.value = p.port || '';
            } else if (action === 'delete') {
              e.stopPropagation();
              (async () => {
                const ok = await showModal({
                  title: 'Delete profile',
                  body: `Delete profile "${p.name}"?`,
                  okText: 'Delete',
                  cancelText: 'Cancel'
                });
                if (!ok) return;
                await fetch(`/api/profiles/${p.id}`, { method: 'DELETE' });
                await loadProfilesList();
              })();
            } else {
              // View profile details (toggle behavior)
              if (currentEditingProfileId === p.id && settingsPanel.style.display === 'block') {
                // Clicking the same profile that's currently displayed - collapse it
                settingsPanel.style.display = 'none';
                currentEditingProfileId = null;
              } else {
                // Clicking a different profile or expanding - show it
              currentEditingProfileId = p.id;
              settingsPanel.style.display = 'block';
              cfgMailUser.value = p.mailUser || '';
              cfgMailPass.value = p.mailPass || '';
              cfgImapHost.value = p.imapHost || '';
              cfgImapPort.value = p.imapPort || '';
              cfgImapTls.value = p.imapTls || 'true';
              cfgSmtpHost.value = p.smtpHost || '';
              cfgSmtpPort.value = p.smtpPort || '';
              cfgSmtpSecure.value = p.smtpSecure || 'true';
              cfgPort.value = p.port || '';
              }
            }
          };
          profilesListEl.appendChild(item);
        });
      } catch (err) {
        await showCopyableError('Load Profiles Error', `Error: ${err.message}`);
      }
    }

    async function createDefaultProfile() {
      try {
        // Get current config from server
        const configRes = await fetch('/api/config', { cache: 'no-cache' });
        const configData = await configRes.json();
        const cfg = configData.config || {};

        // Default profile: longriver.com
        const res = await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'longriver.com',
            remark: 'longriver.com',
            mailUser: cfg.MAIL_USER || '',
            mailPass: cfg.MAIL_PASS || '',
            imapHost: cfg.IMAP_HOST || 'imap.bbmail.com.hk',
            imapPort: Number(cfg.IMAP_PORT) || 993,
            imapTls: cfg.IMAP_TLS || 'true',
            smtpHost: cfg.SMTP_HOST || 'homegw.bbmail.com.hk',
            smtpPort: Number(cfg.SMTP_PORT) || 465,
            smtpSecure: cfg.SMTP_SECURE || 'true',
            port: Number(cfg.PORT) || 3001,
            isActive: 1
          })
        });
        const data = await res.json();
        if (!data.success) {
          console.error('Failed to create default profile:', data);
        }

        // Additional profile: lcf
        const resLcf = await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'lcf',
            remark: 'lcf',
            mailUser: 'weiwu@fuchanghk.com',
            mailPass: 'mrkE190#',
            imapHost: 'imap.qiye.163.com',
            imapPort: 993,
            imapTls: 'true',
            smtpHost: 'smtp.qiye.163.com',
            smtpPort: 994,
            smtpSecure: 'true',
            port: 3001,
            isActive: 0
          })
        });
        const dataLcf = await resLcf.json();
        if (!dataLcf.success) {
          console.error('Failed to create lcf profile:', dataLcf);
        }
      } catch (err) {
        console.error('Error creating default profile:', err);
      }
    }

    // Initial state: Welcome tab
    ensureTab('welcome', 'Welcome');
    activateTab('welcome');

    const menuEmailBtn = document.getElementById('menuEmail');
    const menuCustomerBtn = document.getElementById('menuCustomer');
    const sidebar = document.getElementById('sidebar');

    // Menu click: toggle email submenu
    menuEmailBtn.onclick = () => {
      const submenu = document.getElementById('emailSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Menu click: toggle customer submenu
    menuCustomerBtn.onclick = () => {
      const submenu = document.getElementById('customerSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Menu click: toggle quotation submenu
    menuQuotationBtn.onclick = () => {
      const submenu = document.getElementById('quotationSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Menu click: toggle outsourcing submenu
    menuOutsourcingBtn.onclick = () => {
      const submenu = document.getElementById('outsourcingSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Customer submenu buttons
    const customerCreateBtn = document.getElementById('customerCreateBtn');
    const customerViewBtn = document.getElementById('customerViewBtn');

    customerCreateBtn.onclick = () => {
      // Hide submenu and go to customer creation
      document.getElementById('customerSubmenu').style.display = 'none';
      ensureTab('customer', 'Customer (Create)');
      activateTab('customer');
      initializeCustomerPanel();
    };

    customerViewBtn.onclick = () => {
      // Hide submenu and go to customer view
      document.getElementById('customerSubmenu').style.display = 'none';
      ensureTab('customer-view', 'Customer (View)');
      activateTab('customer-view');
      initializeCustomerViewPanel();
    };

    // Menu click: toggle supplier submenu
    const menuSupplierBtn = document.getElementById('menuSupplier');
    menuSupplierBtn.onclick = () => {
      const submenu = document.getElementById('supplierSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Supplier submenu buttons
    const supplierCreateBtn = document.getElementById('supplierCreateBtn');
    const supplierViewBtn = document.getElementById('supplierViewBtn');

    supplierCreateBtn.onclick = () => {
      // Hide submenu and go to supplier creation
      document.getElementById('supplierSubmenu').style.display = 'none';
      ensureTab('supplier', 'Supplier (Create)');
      activateTab('supplier');
      initializeSupplierPanel();
    };

    supplierViewBtn.onclick = () => {
      // Hide submenu and go to supplier view
      document.getElementById('supplierSubmenu').style.display = 'none';
      ensureTab('supplier-view', 'Supplier (View)');
      activateTab('supplier-view');
      initializeSupplierViewPanel();
    };

    // Email submenu buttons
    const emailReceiveBtn = document.getElementById('emailReceiveBtn');
    const emailSendBtn = document.getElementById('emailSendBtn');

    emailReceiveBtn.onclick = () => {
      // Hide submenu and go to email receive board
      document.getElementById('emailSubmenu').style.display = 'none';
      ensureTab('emails', 'Email (receive)');
      activateTab('emails');
      // Load emails if not already loaded
      if (!currentEmails || currentEmails.length === 0) {
        load(true);
      }
    };

    emailSendBtn.onclick = () => {
      // Hide submenu and go to email send board
      document.getElementById('emailSubmenu').style.display = 'none';
      ensureTab('email-send', 'Email (send)');
      activateTab('email-send');
      // Initialize email send panel
      initializeEmailSendPanel();
    };

    // Hover on entire sidebar to show full text
    sidebar.onmouseenter = () => {
      menuEmailBtn.textContent = menuEmailBtn.dataset.full || 'Email';
      menuCustomerBtn.textContent = menuCustomerBtn.dataset.full || 'Customer';
      menuSupplierBtn.textContent = menuSupplierBtn.dataset.full || 'Supplier';
      menuSettingsBtn.textContent = menuSettingsBtn.dataset.full || 'Setting';
      menuTasksBtn.textContent = menuTasksBtn.dataset.full || 'Task List';
      menuSkillsBtn.textContent = menuSkillsBtn.dataset.full || 'Skills';
      menuQuotationBtn.textContent = menuQuotationBtn.dataset.full || 'Quotation';
      menuOutsourcingBtn.textContent = menuOutsourcingBtn.dataset.full || 'Outsourcing';
    };
    sidebar.onmouseleave = () => {
      menuEmailBtn.textContent = menuEmailBtn.dataset.short || 'E';
      menuCustomerBtn.textContent = menuCustomerBtn.dataset.short || 'C';
      menuSupplierBtn.textContent = menuSupplierBtn.dataset.short || 'S';
      menuSettingsBtn.textContent = menuSettingsBtn.dataset.short || 'S';
      menuTasksBtn.textContent = menuTasksBtn.dataset.short || 'T';
      menuSkillsBtn.textContent = menuSkillsBtn.dataset.short || 'K';
      menuQuotationBtn.textContent = menuQuotationBtn.dataset.short || 'Q';
      menuOutsourcingBtn.textContent = menuOutsourcingBtn.dataset.short || 'O';
      // Hide submenus on mouse leave
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });
    };

    // Menu click: show profiles list (settings landing page)
    menuSettingsBtn.onclick = () => {
      ensureTab('profiles', 'Setting');
      activateTab('profiles');
      loadProfilesList();
    };

    // Menu click: show tasks
    menuTasksBtn.onclick = () => {
      ensureTab('tasks', 'Task');
      activateTab('tasks');
    };

    // Menu click: show agent skills
    menuSkillsBtn.onclick = () => {
      ensureTab('skills', 'Agent Skills');
      activateTab('skills');
      loadAgentSkills();
    };

    // Quotation submenu button
    const quotationCreateBtn = document.getElementById('quotationCreateBtn');

    quotationCreateBtn.onclick = () => {
      // Hide submenu and go to quotation creation board
      document.getElementById('quotationSubmenu').style.display = 'none';
      ensureTab('quotation', 'Quotation (create)');
      activateTab('quotation');
      initializeQuotationPanel();
    };

    quotationViewBtn.onclick = () => {
      // Hide submenu and go to quotation view
      document.getElementById('quotationSubmenu').style.display = 'none';
      ensureTab('quotation-view', 'Quotation (View)');
      activateTab('quotation-view');
      initializeQuotationViewPanel();
    };

    // Outsourcing submenu buttons
    const outsourcingCreateBtn = document.getElementById('outsourcingCreateBtn');
    const outsourcingViewBtn = document.getElementById('outsourcingViewBtn');

    outsourcingCreateBtn.onclick = () => {
      // Hide submenu and go to outsourcing creation board
      document.getElementById('outsourcingSubmenu').style.display = 'none';
      ensureTab('outsourcing', 'Outsourcing (create)');
      activateTab('outsourcing');
      initializeOutsourcingPanel();
    };

    outsourcingViewBtn.onclick = () => {
      // Hide submenu and go to outsourcing view
      document.getElementById('outsourcingSubmenu').style.display = 'none';
      ensureTab('outsourcing-view', 'Outsourcing (View)');
      activateTab('outsourcing-view');
      initializeOutsourcingViewPanel();
    };

    // Add profile button
    addProfileBtn.onclick = () => {
      // Show blank form for new profile input
      settingsPanel.style.display = 'block';
      currentEditingProfileId = null; // create mode
      cfgMailUser.value = '';
      cfgMailPass.value = '';
      cfgImapHost.value = '';
      cfgImapPort.value = '';
      cfgImapTls.value = 'true';
      cfgSmtpHost.value = '';
      cfgSmtpPort.value = '';
      cfgSmtpSecure.value = 'true';
      cfgPort.value = '';
    };
    
    async function load(showLoading = true) {
      try {
        // Cancel any existing load request
        if (currentLoadController) {
          
          currentLoadController.abort();
        }
        
        // Create new abort controller for this request
        currentLoadController = new AbortController();
        const controller = currentLoadController;
        
        if (showLoading) {
          const tableBody = document.getElementById('emailTableBody');
          tableBody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; border:1px solid #000;">Loading emails...</td></tr>';
        } else {
          
        }
        
        // Add timeout to fetch request
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {

            controller.abort();
          }
        }, 45000); // 45 second timeout (increased from 30)

        let res;
        try {
          res = await fetch('/api/emails?limit=20', { 
            signal: controller.signal,
            cache: 'no-cache' // Prevent caching
          });
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on success
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on error
          
          if (fetchErr.name === 'AbortError') {
            // Only show error if we were showing loading state
            if (showLoading) {
              throw new Error('Request timeout - server took too long to respond');
            } else {
              // Background refresh failed, just log it
              console.warn('Background refresh failed:', fetchErr.message);
              return;
            }
          }
          throw fetchErr;
        }
        
        
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to load emails';
          const errorCode = errorData.code ? ` (${errorData.code})` : '';
          const troubleshooting = errorData.troubleshooting ? '\n\nTroubleshooting:\n' + errorData.troubleshooting.join('\n') : '';

          await showCopyableError('Email Loading Error',
            `Error: ${errorMsg}${errorCode}\nStatus: ${res.status}${troubleshooting}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`
          );
          return;
        }
        
        const data = await res.json();
        
        
        if (!data.success) {
          const tableBody = document.getElementById('emailTableBody');
          tableBody.innerHTML = `<tr><td colspan="5" style="padding:20px; border:1px solid #000; text-align:center;">Error: ${data.error || 'Failed to load emails'}</td></tr>`;
          console.error('API error:', data);
          return;
        }
        
        const emails = data.emails || [];
        
        currentEmails = emails; // Store for reference
        
        // Render the email list (only if showLoading was true, otherwise we're in background)
        if (showLoading) {
          renderEmailList(emails);
        } else {
          // Background refresh - update cache and re-render list
          currentEmails = emails;
            renderEmailList(emails);
        }
      } catch (err) {
        console.error('Load function error:', err);
        // Show error modal for any loading issues
        await showCopyableError('Email Loading Error',
          `Failed to load emails: ${err.message}\n\nThis could be due to:\nâ€¢ Network connectivity issues\nâ€¢ Email server configuration problems\nâ€¢ Authentication failures\n\nStack trace:\n${err.stack || 'N/A'}`
        );
      }
    }
    
    async function show(uid){
      console.log('ðŸ”´ SHOW FUNCTION CALLED - UID:', uid);

      // Find the email in the cached list to get envelope data
      const cachedEmail = currentEmails.find(e => e.uid === uid);
      console.log('ðŸŸ¢ Found cached email:', cachedEmail);

      // NOTE: after long idle, the browser may throw "TypeError: Failed to fetch" even though
      // the backend can reconnect. We retry once automatically to avoid showing an error popup.
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      // Show loading spinner
      showLoadingSpinner();

      // Show loading state in modal
      document.getElementById('emailModalBody').textContent = 'Loading email...';

      async function fetchEmailOnce(attempt){
        

        // Add timeout to fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            
            controller.abort();
          }
        }, 30000); // 30 second timeout

        try {
          const res = await fetch('/api/emails/'+uid, {
            signal: controller.signal,
            cache: 'no-cache'
          });
          clearTimeout(timeoutId);

          

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${res.status}` };
            }
            const errorMsg = errorData.error || 'Failed to fetch email';
            const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isHttpError = true;
            err.__fullError = fullError;
            throw err;
          }

          const data = await res.json();
          if (!data.success) {
            const errorMsg = data.error || 'Failed to load email';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isApiError = true;
            err.__fullError = fullError;
            throw err;
          }

          return data;
        } catch (fetchErr) {
          clearTimeout(timeoutId);

          // Normalize "idle timeout" style errors so we can retry once.
          const isAbort = fetchErr?.name === 'AbortError';
          const msg = fetchErr?.message || '';
          const isNetwork = msg.includes('Failed to fetch') || msg.includes('NetworkError') || fetchErr instanceof TypeError;
          const isRetryable = isAbort || isNetwork;

          if (isRetryable) {
            const err = new Error(isAbort
              ? 'Request timeout - server took too long to respond'
              : 'Network error - connection lost');
            err.__retryable = true;
            err.__original = fetchErr;
            throw err;
          }

          throw fetchErr;
        }
      }

      let data;
      try {
        data = await fetchEmailOnce(1);
      } catch (err1) {
        // Retry once automatically for idle network/timeout issues
        if (err1?.__retryable) {
          // Inform user we are reconnecting, but do not show any popup
          document.getElementById('d-body').textContent = 'Connection timed out (idle). Reconnecting??(retrying)';
          
          // Refresh email list/cache in the background so we truly "reconnect"
          try {
            await load(false);
          } catch (loadErr) {
            console.warn('Background reconnect (list reload) failed:', loadErr);
          }

          await sleep(500); // small pause so reconnect can settle

          try {
            // Second attempt to fetch the same email after reconnect
            data = await fetchEmailOnce(2);
          } catch (err2) {
            // Show error in modal
            console.warn('Email fetch failed after retry:', err2);
            document.getElementById('emailModalBody').textContent = 'Failed to load email. Please try again.';
            return;
          }
        } else if (err1?.__fullError) {
          hideLoadingSpinner();
          showCopyableError(err1.__isHttpError ? 'Fetch Email Error' : 'Email Error', err1.__fullError);
          console.error('Fetch email error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        } else {
          hideLoadingSpinner();
          const fullError = `Error fetching email: ${err1.message}\n\nUID: ${uid}\n\nStack trace:\n${err1.stack || 'N/A'}`;
          showCopyableError('Network Error', fullError);
          console.error('Fetch error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        }
      }

        // Parse email from source - simplified to just show context/body
        const source = data.source || '';
        // Use cached envelope data from email list instead of API response (which returns null)
        const envelope = cachedEmail?.envelope || data.envelope || null;
        let subject = '';
        let from = '';
        let date = '';
        let bodyContent = '';

        // DEBUG: Log the received data
        console.log('ðŸ”µ DEBUG show() function - UID:', uid);
        console.log('ðŸ”µ Using cached envelope:', !!cachedEmail?.envelope);
        console.log('ðŸ”µ Envelope data:', envelope);

        // Extract subject, from, and date with robust fallback logic
        // Try envelope first (preferred), then fall back to regex parsing

        // Extract subject
        if (envelope && envelope.subject) {
          subject = envelope.subject;
        } else {
          const subjectMatch = source.match(/^Subject:\s*(.+)$/mi);
          if (subjectMatch) subject = decodeMimeEncodedWord(subjectMatch[1].trim());
        }

        // Extract from
        if (envelope && envelope.from && Array.isArray(envelope.from) && envelope.from.length > 0) {
          const fromObj = envelope.from[0];
          if (fromObj.address) {
            from = fromObj.name ? `${fromObj.name} <${fromObj.address}>` : fromObj.address;
          } else if (fromObj.name) {
            from = fromObj.name;
          }
        }
        if (!from) {
          const fromMatch = source.match(/^From:\s*(.+)$/mi);
          if (fromMatch) from = decodeMimeEncodedWord(fromMatch[1].trim());
        }

        // Extract date
        if (envelope && envelope.date) {
          try {
            date = new Date(envelope.date).toLocaleString();
          } catch (e) {
            console.warn('Failed to parse envelope date:', e);
          }
        }
        if (!date) {
          const dateMatch = source.match(/^Date:\s*(.+)$/mi);
          if (dateMatch) date = dateMatch[1].trim();
        }

        console.log('ðŸ”µ Extracted - subject:', subject, 'from:', from, 'date:', date);
        
        // Extract just the actual email content (skip headers and boundaries)
        const headerEndMatch = source.match(/\n\n|\r\n\r\n/);
        if (headerEndMatch) {
          const bodyPart = source.substring(headerEndMatch.index + headerEndMatch[0].length);

          // Simple approach: find the first actual content after headers
          // Look for content that comes after Content-Type declarations
          const lines = bodyPart.split('\n');
          let contentStart = -1;

          // Look for HTML content first (prefer HTML over plain text)
          let htmlContentStart = -1;
          let plainContentStart = -1;

          for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('Content-Type:')) {
              const isHtml = lines[i].toLowerCase().includes('text/html');
              const isPlain = lines[i].toLowerCase().includes('text/plain');

              // Find where content starts (after Content-Transfer-Encoding or after blank line)
              let startLine = i + 1;
              while (startLine < lines.length && (lines[startLine].includes('Content-Transfer-Encoding:') || lines[startLine].includes('charset=') || lines[startLine].trim() === '')) {
                startLine++;
              }

              if (isHtml && htmlContentStart === -1) {
                htmlContentStart = startLine;
              } else if (isPlain && plainContentStart === -1) {
                plainContentStart = startLine;
              }
            }
          }

          // Prefer HTML content over plain text
          contentStart = htmlContentStart !== -1 ? htmlContentStart : plainContentStart;

          if (contentStart >= 0 && contentStart < lines.length) {
            // Collect content until we hit a boundary
            const contentLines = [];
            for (let i = contentStart; i < lines.length; i++) {
              if (lines[i].startsWith('----_') || lines[i].startsWith('--=_')) {
                break; // Stop at boundary
              }
              contentLines.push(lines[i]);
            }
            let rawContent = contentLines.join('\n').trim();

            // Check Content-Type to determine if it's HTML (look backwards from contentStart)
            let isHtmlContent = false;
            for (let i = contentStart - 1; i >= 0 && i >= contentStart - 5; i--) {
              if (lines[i].toLowerCase().includes('text/html')) {
                isHtmlContent = true;
                break;
              }
            }

            // Check if content is base64 encoded (look for base64 in the Content-Transfer-Encoding header)
            if (lines[contentStart - 1] && lines[contentStart - 1].toLowerCase().includes('base64')) {
              try {
                // Remove any whitespace and validate base64 format
                const cleanBase64 = rawContent.replace(/\s/g, '');

                // Check if it looks like valid base64 (only contains valid base64 characters)
                if (/^[A-Za-z0-9+/]*={0,2}$/.test(cleanBase64)) {
                  let decodedContent = atob(cleanBase64);

                  // Decode Quoted-Printable if present
                  if (decodedContent.includes('=20') || decodedContent.includes('=\n')) {
                    decodedContent = decodeQuotedPrintable(decodedContent);
                  }

                  // Update isHtmlContent if not already set and content looks like HTML
                  if (!isHtmlContent && decodedContent.includes('<') && decodedContent.includes('>')) {
                    isHtmlContent = true;
                  }
                  bodyContent = decodedContent;
                } else {
                  console.warn('Content appears to be base64 but contains invalid characters, keeping original');
                  bodyContent = rawContent;
                }
              } catch (e) {
                console.warn('Failed to decode base64 content:', e);
                // Keep original content if decoding fails
                bodyContent = rawContent;
              }
            } else {
              // Not base64, might be Quoted-Printable or plain text
              bodyContent = rawContent;

              // Decode Quoted-Printable if present
              if (rawContent.includes('=20') || rawContent.includes('=3D') || /=\r?\n/.test(rawContent)) {
                bodyContent = decodeQuotedPrintable(rawContent);
              }

              // Update isHtmlContent if not already set and content looks like HTML
              if (!isHtmlContent && bodyContent.includes('<') && bodyContent.includes('>')) {
                isHtmlContent = true;
              }
            }

            // Handle HTML content display - but don't return early, let it continue
            if (isHtmlContent) {
              document.getElementById('emailModalBody').innerHTML = bodyContent;
              // Don't return - continue to show the modal
            }
          } else {
            // Try to extract any readable content from mixed/corrupted emails
            let extractedContent = '';

            // Look for any lines that might be readable text (not base64, not headers)
            const contentLines = bodyPart.split('\n');
            for (const line of contentLines) {
              // Skip obvious headers and boundaries
              if (line.includes('Content-Type:') ||
                  line.includes('Content-Transfer-Encoding:') ||
                  line.startsWith('----') ||
                  line.trim() === '' ||
                  line.includes('charset=')) {
                continue;
              }

              // Try to decode if it looks like base64
              if (/^[A-Za-z0-9+/]*={0,2}$/.test(line.trim()) && line.length > 10) {
                try {
                  const decoded = atob(line.trim());
                  // Only use if decoding gives readable text
                  if (decoded.length > 0 && !/[\x00-\x08\x0B\x0C\x0E-\x1F]/.test(decoded)) {
                    extractedContent += decoded + '\n';
                    continue;
                  }
                } catch (e) {
                  // Not valid base64, continue
                }
              }

              // Keep line if it looks like readable text
              if (line.length > 0 && !/^[A-Za-z0-9+/]*={0,2}$/.test(line.trim().replace(/\s/g, ''))) {
                extractedContent += line + '\n';
              }
            }

            bodyContent = extractedContent.trim() || bodyPart.replace(/----_[^\n]*\n/g, '').replace(/Content-Type:[^\n]*\n/g, '').replace(/Content-Transfer-Encoding:[^\n]*\n/g, '').replace(/^\n+/, '').replace(/\n+$/, '');
          }
        } else {
          // Fallback: show the whole source
          bodyContent = source;
        }

        // Display just the actual message content
        // Decode Quoted-Printable if present
        if (bodyContent && (bodyContent.includes('=20') || bodyContent.includes('=\n') || bodyContent.includes('=3D'))) {
          bodyContent = decodeQuotedPrintable(bodyContent);
        }

        // Fallback: Check if body content looks like base64 (for emails without proper MIME headers or detection)
        if (bodyContent && bodyContent.length > 50) {
          // Remove MIME boundary markers and whitespace
          let cleanedBody = bodyContent.split(/------=_NextPart/)[0].split(/--=_NextPart/)[0];
          cleanedBody = cleanedBody.replace(/\s/g, '');

          // Remove any trailing non-base64 characters
          cleanedBody = cleanedBody.replace(/[^A-Za-z0-9+/=]+$/, '');

          // Check if it looks like base64 (at least 80% base64 characters)
          const base64Chars = cleanedBody.replace(/[^A-Za-z0-9+/=]/g, '');
          const isLikelyBase64 = cleanedBody.length > 50 && (base64Chars.length / cleanedBody.length) > 0.8;

          if (isLikelyBase64) {
            // Clean to only valid base64 characters
            cleanedBody = base64Chars;

            // Add proper padding if needed
            const paddingNeeded = (4 - (cleanedBody.length % 4)) % 4;
            cleanedBody = cleanedBody + '='.repeat(paddingNeeded);

            try {
              const decoded = atob(cleanedBody);
              if (decoded && decoded.length > 0) {
                bodyContent = decoded;
                console.log('Successfully decoded base64 body content (fallback detection)');
              }
            } catch (e) {
              console.warn('Body looks like base64 but failed to decode:', e);
              // Keep original content if decoding fails
            }
          }
        }

        // Decode HTML entities (e.g., &lt; to <, &gt; to >, &amp; to &)
        bodyContent = decodeHtmlEntities(bodyContent);

        // Always render as HTML using innerHTML
        const modalBodyEl = document.getElementById('emailModalBody');
        modalBodyEl.innerHTML = bodyContent || 'No content available';

        // Display email metadata in modal
        document.getElementById('emailModalSubject').textContent = subject || '(No subject)';
        document.getElementById('emailModalFrom').textContent = `From: ${from || 'Unknown'}`;
        document.getElementById('emailModalDate').textContent = `Date: ${date || 'Unknown'}`;

        // Extract plain email address from From header if possible
        let emailAddress = null;
        if (from) {
          const m = from.match(/<([^>]+)>/);
          emailAddress = m ? m[1].trim() : from.trim();
        }

        // Remember current email meta for task creation
        // Extract To header if present
        let toAddress = null;
        const toMatch = source.match(/^To:\s*(.+)$/mi);
        if (toMatch) {
          toAddress = decodeMimeEncodedWord(toMatch[1].trim());
        }

        // Extract Message-ID header for email threading
        let messageId = null;
        const messageIdMatch = source.match(/^Message-ID:\s*(.+)$/mi);
        if (messageIdMatch) {
          messageId = messageIdMatch[1].trim();
        }

        currentEmailMeta = {
          uid,
          subject: subject || '',
          from: from || '',
          email: emailAddress || null,
          to: toAddress || null,
          date: date || '',
          messageId: messageId || null
        };

        // Search for customer by email address
        if (emailAddress) {
          console.log('Searching for customer with email:', emailAddress);
          const customerData = await searchCustomerByEmail(emailAddress);
          if (customerData) {
            console.log('Customer found:', customerData);
            currentCustomerData = customerData;
            displayCustomerInfo(customerData);
          } else {
            console.log('No customer found for email:', emailAddress);
            currentCustomerData = null;
            hideCustomerInfo();
          }
        } else {
          currentCustomerData = null;
          hideCustomerInfo();
        }

      // Show email modal
      populateEmailModal(subject, from, date, bodyContent, currentEmailMeta);
      // Ensure modal is attached to document.body so it's visible even when the emails panel is hidden
      try {
        const modalEl = document.getElementById('emailModal');
        if (modalEl && modalEl.parentNode !== document.body) {
          document.body.appendChild(modalEl);
        }
      } catch (attachErr) {
        console.error('Failed to attach modal to body:', attachErr);
      }

      // Hide loading spinner and show modal
      hideLoadingSpinner();
      document.getElementById('emailModal').style.display='flex';
      document.body.classList.add('modal-open');
    }

    // Loading spinner functions
    function showLoadingSpinner() {
      // Remove existing spinner if any
      hideLoadingSpinner();

      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingSpinner';

      const spinner = document.createElement('div');
      spinner.className = 'loading-spinner';

      overlay.appendChild(spinner);
      document.body.appendChild(overlay);
    }

    function hideLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.remove();
      }
    }

    // Function to show sent email from IMAP (similar to show() for received emails)
    async function showSentEmail(uid){
      // Use the same endpoint as received emails, but with folder=sent parameter
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      // Show loading spinner
      showLoadingSpinner();

      // Show loading state in modal
      document.getElementById('emailModalBody').textContent = 'Loading sent email...';

      async function fetchSentEmailOnce(attempt){
        // Add timeout to fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            controller.abort();
          }
        }, 30000); // 30 second timeout

        try {
          const res = await fetch('/api/emails/'+uid+'?folder=sent', {
            signal: controller.signal,
            cache: 'no-cache'
          });
          clearTimeout(timeoutId);

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${res.status}` };
            }
            const errorMsg = errorData.error || 'Failed to fetch sent email';
            const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isHttpError = true;
            err.__fullError = fullError;
            throw err;
          }

          const data = await res.json();
          if (!data.success) {
            const errorMsg = data.error || 'Failed to load sent email';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isApiError = true;
            err.__fullError = fullError;
            throw err;
          }

          return data;
        } catch (fetchErr) {
          clearTimeout(timeoutId);

          // Normalize "idle timeout" style errors so we can retry once.
          const isAbort = fetchErr?.name === 'AbortError';
          const msg = fetchErr?.message || '';
          const isNetwork = msg.includes('Failed to fetch') || msg.includes('NetworkError') || fetchErr instanceof TypeError;
          const isRetryable = isAbort || isNetwork;

          if (isRetryable) {
            const err = new Error(isAbort
              ? 'Request timeout - server took too long to respond'
              : 'Network error - connection lost');
            err.__retryable = true;
            err.__original = fetchErr;
            throw err;
          }

          throw fetchErr;
        }
      }

      let data;
      try {
        data = await fetchSentEmailOnce(1);
      } catch (err1) {
        // Retry once automatically for idle network/timeout issues
        if (err1?.__retryable) {
          document.getElementById('emailModalBody').textContent = 'Connection timed out. Reconnecting and retrying...';

          await sleep(500);

          try {
            data = await fetchSentEmailOnce(2);
          } catch (err2) {
            console.warn('Sent email fetch failed after retry:', err2);
            document.getElementById('emailModalBody').textContent = 'Failed to load sent email. Please try again.';
            return;
          }
        } else if (err1?.__fullError) {
          hideLoadingSpinner();
          showCopyableError(err1.__isHttpError ? 'Fetch Sent Email Error' : 'Sent Email Error', err1.__fullError);
          console.error('Fetch sent email error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        } else {
          hideLoadingSpinner();
          const fullError = `Error fetching sent email: ${err1.message}\n\nUID: ${uid}\n\nStack trace:\n${err1.stack || 'N/A'}`;
          showCopyableError('Network Error', fullError);
          console.error('Fetch error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        }
      }

      // Parse email from source - simplified to just show context/body
      const source = data.source || '';
      let subject = '';
      let from = '';
      let to = '';
      let date = '';
      let bodyContent = '';

      // Extract headers
      const subjectMatch = source.match(/^Subject:\s*(.+)$/mi);
      const fromMatch = source.match(/^From:\s*(.+)$/mi);
      const toMatch = source.match(/^To:\s*(.+)$/mi);
      const dateMatch = source.match(/^Date:\s*(.+)$/mi);

      if (subjectMatch) subject = subjectMatch[1].trim();
      if (fromMatch) from = fromMatch[1].trim();
      if (toMatch) to = toMatch[1].trim();
      if (dateMatch) date = dateMatch[1].trim();

      // Extract body (simplified - look for blank line then content)
      const parts = source.split(/\r?\n\r?\n/);
      if (parts.length > 1) {
        bodyContent = parts.slice(1).join('\n\n');
      }

      // Try to parse HTML if present
      const htmlMatch = source.match(/Content-Type:\s*text\/html[^\n]*\n(?:[^\n]*\n)*?\n([\s\S]*?)(?=\n--|\n\r?\n--|\Z)/i);
      if (htmlMatch) {
        bodyContent = htmlMatch[1].trim();
      }

      // Extract email addresses
      let emailAddress = null;
      let toAddress = null;
      const fromEmailMatch = from.match(/<([^>]+)>/);
      if (fromEmailMatch) {
        emailAddress = fromEmailMatch[1];
      } else if (from.includes('@')) {
        emailAddress = from;
      }

      const toEmailMatch = to.match(/<([^>]+)>/);
      if (toEmailMatch) {
        toAddress = toEmailMatch[1];
      } else if (to.includes('@')) {
        toAddress = to;
      }

      const currentEmailMeta = {
        uid,
        subject: subject || '',
        from: from || '',
        email: emailAddress || null,
        to: toAddress || null,
        date: date || ''
      };

      // Show email modal (pass isSentEmail=true to hide Quotation and Image Lib buttons)
      populateEmailModal(subject, from, date, bodyContent, currentEmailMeta, true);
      // Ensure modal is attached to document.body
      try {
        const modalEl = document.getElementById('emailModal');
        if (modalEl && modalEl.parentNode !== document.body) {
          document.body.appendChild(modalEl);
        }
      } catch (attachErr) {
        console.error('Failed to attach modal to body:', attachErr);
      }

      // Hide loading spinner and show modal
      hideLoadingSpinner();
      document.getElementById('emailModal').style.display='flex';
      document.body.classList.add('modal-open');
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randPick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randString(len) {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let out = '';
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    function fillFormDummy(container, { includeHidden = false } = {}) {
      const inputs = Array.from(container.querySelectorAll('input'));
      const textareas = Array.from(container.querySelectorAll('textarea'));

      const fillInput = (input) => {
        if (input.disabled) return;
        if (input.type === 'button' || input.type === 'submit' || input.type === 'reset') return;
        if (!includeHidden && (input.type === 'hidden' || input.offsetParent === null)) return;

        const id = (input.id || '').toLowerCase();
        const name = (input.name || '').toLowerCase();
        const key = `${id} ${name}`;

        if (input.type === 'email' || key.includes('mail_user') || key.includes('user') || key.includes('email')) {
          const domain = randPick(['example.com', 'longriver.com', 'test.local']);
          input.value = `user.${randString(6)}@${domain}`;
        } else if (input.type === 'password' || key.includes('pass')) {
          input.value = `P@ss${randString(10)}!`;
        } else if (input.type === 'number' || key.includes('port')) {
          // reasonable defaults for known ports
          if (key.includes('imap')) input.value = String(randPick([993, 143]));
          else if (key.includes('smtp')) input.value = String(randPick([465, 587, 25]));
          else input.value = String(randPick([3001, 3000, 8080, randInt(1024, 65535)]));
        } else if (key.includes('tls') || key.includes('secure')) {
          input.value = randPick(['true', 'false']);
        } else if (key.includes('host')) {
          const host = randPick(['imap.qiye.163.com', 'smtp.qiye.163.com', 'imap.bbmail.com.hk', 'homegw.bbmail.com.hk', 'mail.example.com']);
          input.value = host;
        } else {
          input.value = randString(10);
        }

        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
      };

      const fillTextarea = (ta) => {
        if (ta.disabled) return;
        if (!includeHidden && ta.offsetParent === null) return;
        ta.value = `Dummy content ${randString(12)}\n\nLine 2 ${randString(8)}`;
        ta.dispatchEvent(new Event('input', { bubbles: true }));
        ta.dispatchEvent(new Event('change', { bubbles: true }));
      };

      inputs.forEach(fillInput);
      textareas.forEach(fillTextarea);
    }
    
    // Copyable modal in minimal black & white style (no browser popups)
    async function showCopyableError(title, errorText) {
      await showModal({
        title,
        body: errorText,
        copyText: errorText,
        okText: 'Close'
      });
    }

    // Minimal black & white modal (replaces alert/confirm)
    function showModal({ title = 'Message', body = '', copyText = null, okText = 'OK', cancelText = null }) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.style.zIndex = '20000'; // Higher than all other modals

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = title;

        const content = document.createElement('div');
        content.className = 'modal-body';
        content.textContent = body;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = okText;

        const close = (result) => {
          try { document.body.removeChild(overlay); } catch {}
          resolve(result);
        };

        okBtn.onclick = () => close(true);

        if (copyText) {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn';
          copyBtn.textContent = 'Copy';
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(copyText);
              copyBtn.textContent = 'Copied';
              setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
            } catch (e) {
              // Fallback: select-able content already in body
              copyBtn.textContent = 'Copy failed';
              setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
            }
          };
          actions.appendChild(copyBtn);
        }

        if (cancelText) {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn';
          cancelBtn.textContent = cancelText;
          cancelBtn.onclick = () => close(false);
          actions.appendChild(cancelBtn);
        }

        actions.appendChild(okBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Close on clicking overlay (only for non-confirm)
        overlay.onclick = (e) => {
          if (e.target === overlay && !cancelText) close(true);
        };

        // ESC closes (OK for non-confirm, Cancel for confirm)
        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            close(cancelText ? false : true);
          }
        };
        document.addEventListener('keydown', onKey);
      });
    }
    
    // Text input modal (replaces prompt)
    function showTextInputModal({ title = 'Input', label = '', initialValue = '', okText = 'OK', cancelText = 'Cancel' }) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = title;

        const content = document.createElement('div');
        content.className = 'modal-body';

        const labelEl = document.createElement('div');
        labelEl.style.fontWeight = '700';
        labelEl.style.marginBottom = '8px';
        labelEl.textContent = label;

        const input = document.createElement('input');
        input.type = 'text';
        input.value = initialValue || '';

        content.appendChild(labelEl);
        content.appendChild(input);

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = cancelText;

        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = okText;

        const close = (result) => {
          try { document.body.removeChild(overlay); } catch {}
          resolve(result);
        };

        cancelBtn.onclick = () => close({ ok: false, value: input.value });
        okBtn.onclick = () => close({ ok: true, value: input.value });

        actions.appendChild(cancelBtn);
        actions.appendChild(okBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        overlay.onclick = (e) => {
          if (e.target === overlay) close({ ok: false, value: input.value });
        };

        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            close({ ok: false, value: input.value });
          }
          if (e.key === 'Enter') {
            document.removeEventListener('keydown', onKey);
            close({ ok: true, value: input.value });
          }
        };
        document.addEventListener('keydown', onKey);

        // focus after attach
        setTimeout(() => {
          input.focus();
          input.select();
        }, 0);
      });
    }
    

    
    // Function to populate and show email modal
    function populateEmailModal(subject, from, date, body, emailMeta, isSentEmail = false) {
      document.getElementById('emailModalSubject').textContent = subject || '(No subject)';
      document.getElementById('emailModalFrom').textContent = `From: ${from || 'Unknown'}`;
      // Set To field if available
      const modalToEl = document.getElementById('emailModalTo');
      if (modalToEl) {
        const toVal = (emailMeta && (emailMeta.to || emailMeta.toEmail || emailMeta.email)) || '';
        modalToEl.textContent = toVal ? `To: ${toVal}` : 'To: (unknown)';
      }
      document.getElementById('emailModalDate').textContent = `Date: ${date || 'Unknown'}`;

      // Display the already processed body content
      const modalBody = document.getElementById('emailModalBody');
      if (body && typeof body === 'string') {
        // Decode Quoted-Printable if present
        let decodedBody = body;
        if (body.includes('=20') || body.includes('=\n') || body.includes('=3D')) {
          decodedBody = decodeQuotedPrintable(body);
        }

        // Decode HTML entities (e.g., &lt; to <, &gt; to >, &amp; to &)
        decodedBody = decodeHtmlEntities(decodedBody);

        // Check if content is HTML or plain text
        const isHtml = /<[a-z][\s\S]*>/i.test(decodedBody);

        if (isHtml) {
          // Render as HTML
          modalBody.innerHTML = decodedBody;
        } else {
          // Display as plain text with preserved formatting
          modalBody.style.whiteSpace = 'pre-wrap';
          modalBody.style.wordWrap = 'break-word';
          modalBody.style.fontFamily = 'inherit';
          modalBody.textContent = decodedBody;
        }
      } else {
        modalBody.textContent = 'No content available';
      }

      // Hide Quotation and Image Lib buttons for sent emails, show for received emails
      const quotationBtn = document.getElementById('quotationBtn');
      const imageLibBtn = document.getElementById('imageLibBtn');
      if (quotationBtn) {
        quotationBtn.style.display = isSentEmail ? 'none' : 'block';
      }
      if (imageLibBtn) {
        imageLibBtn.style.display = isSentEmail ? 'none' : 'block';
      }

      // Store current email meta for task creation
      currentEmailModalMeta = emailMeta;
    }
    
    // Helper function to render email list
    function renderEmailList(emails) {
      const tableBody = document.getElementById('emailTableBody');
      tableBody.innerHTML='';
      
      if (emails.length === 0) {
        const noEmailsRow = document.createElement('tr');
        noEmailsRow.innerHTML = '<td colspan="5" style="padding:20px; text-align:center; border:1px solid #000;">No emails found in inbox</td>';
        tableBody.appendChild(noEmailsRow);
        return;
      }
      
      emails.forEach(e=>{
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.style.border = '1px solid #000';

        // Format date
        const date = new Date(e.envelope?.date);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Extract sender email from from field
        let senderEmail = '';
        const fromMatch = (e.envelope?.from?.[0]?.address || '').match(/<([^>]+)>/);
        if (fromMatch) {
          senderEmail = fromMatch[1];
        } else {
          senderEmail = e.envelope?.from?.[0]?.address || e.envelope?.from?.[0]?.name || '';
        }

        // For now, we'll use placeholder data for context and attachments since they're not available in the current email data structure
        const context = '<span style="cursor:pointer; font-weight:500;">Click to view</span>'; // Placeholder with clickable styling
        const attachment = 'N/A'; // Placeholder - would need to be extracted from email headers

        row.innerHTML = `
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${formattedDate}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${senderEmail}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${e.envelope?.subject||'No subject'}</td>
          <td class="email-view-cell" style="padding:12px; border:1px solid #000; vertical-align:top;">${context}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${attachment}</td>
        `;

        tableBody.appendChild(row);

        // Add event listeners after appending to DOM
        row.onmouseover = () => row.style.background = 'rgba(0, 0, 0, 0.3)';
        row.onmouseout = () => row.style.background = '#fff';

        // Only make the "Click to view" cell clickable
        const viewCell = row.querySelector('.email-view-cell');
        viewCell.onclick = (event) => {
          console.log('View cell clicked for email UID:', e.uid);
          show(e.uid);
        };
      });

    }

    // Search functionality
    let currentFilteredEmails = [];

    function filterEmails() {
      const dateSearch = document.getElementById('dateSearch').value.toLowerCase();
      const senderSearch = document.getElementById('senderSearch').value.toLowerCase();
      const subjectSearch = document.getElementById('subjectSearch').value.toLowerCase();
      const contextSearch = document.getElementById('contextSearch').value.toLowerCase();
      const attachmentSearch = document.getElementById('attachmentSearch').value.toLowerCase();

      currentFilteredEmails = currentEmails.filter(email => {
        const date = new Date(email.envelope?.date).toLocaleDateString().toLowerCase();
        const sender = (email.envelope?.from?.[0]?.address || email.envelope?.from?.[0]?.name || '').toLowerCase();
        const subject = (email.envelope?.subject || '').toLowerCase();
        const context = '(click to view)'; // Placeholder for now
        const attachment = 'n/a'; // Placeholder for now

        return date.includes(dateSearch) &&
               sender.includes(senderSearch) &&
               subject.includes(subjectSearch) &&
               context.includes(contextSearch) &&
               attachment.includes(attachmentSearch);
      });

      renderEmailList(currentFilteredEmails);
    }

    // Add event listeners for search inputs
    document.getElementById('dateSearch').addEventListener('input', filterEmails);
    document.getElementById('senderSearch').addEventListener('input', filterEmails);
    document.getElementById('subjectSearch').addEventListener('input', filterEmails);
    document.getElementById('contextSearch').addEventListener('input', filterEmails);
    document.getElementById('attachmentSearch').addEventListener('input', filterEmails);
    
    // Compose email handlers
    const composeBtn = document.getElementById('composeBtn');
    const composeForm = document.getElementById('composeForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const sendBtn = document.getElementById('sendBtn');
    const testSendBtn = document.getElementById('testSendBtn');
    const dummyFillComposeBtn = document.getElementById('dummyFillComposeBtn');
    if (dummyFillComposeBtn) {
      dummyFillComposeBtn.onclick = () => {
        fillDummyForm(composeForm);
      };
    }
    
    composeBtn.onclick = () => {
      composeForm.style.display = composeForm.style.display === 'none' ? 'block' : 'none';
    };

    refreshEmailsBtn.onclick = () => {
      // Refresh the email list
      load(true);
    };
    
    cancelBtn.onclick = () => {
      composeForm.style.display = 'none';
      document.getElementById('toEmail').value = '';
      document.getElementById('subjectEmail').value = '';
      document.getElementById('bodyEmail').value = '';
    };
    
    sendBtn.onclick = async () => {
      const to = document.getElementById('toEmail').value;
      const subject = document.getElementById('subjectEmail').value;
      const text = document.getElementById('bodyEmail').value;
      
      if (!to || !subject || !text) {
        await showModal({ title: 'Missing fields', body: 'Please fill in: To, Subject, and Message.' });
        return;
      }
      
      try {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        
        // Add timeout to fetch request (increased for idle reconnection)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            controller.abort();
          }
        }, 60000); // 60 second timeout (increased to allow for SMTP reconnection)
        
        let res;
        try {
          res = await fetch('/api/email/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, subject, text }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          if (fetchErr.name === 'AbortError') {
            throw new Error('Request timeout - server took too long to respond');
          }
          throw new Error(`Network error: ${fetchErr.message}`);
        }
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to send email';
          const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
          const fullError = `Error sending email:\n${errorMsg}${errorCode}\n\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
          showCopyableError('Send Email Error', fullError);
          console.error('Send email error:', errorData);
          return;
        }
        
        const data = await res.json();
        if (data.success) {
          await showModal({
            title: 'Sent',
            body: `Email sent successfully.\nMessage ID: ${data.messageId || 'N/A'}`,
          });
          composeForm.style.display = 'none';
          document.getElementById('toEmail').value = '';
          document.getElementById('subjectEmail').value = '';
          document.getElementById('bodyEmail').value = '';

          // Refresh sent emails list if we're on the sent emails tab
          if (typeof loadSentEmails === 'function') {
            loadSentEmails();
          }
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Error sending email:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Send Email Error', errorText);
          console.error('Send email error:', data);
        }
      } catch (err) {
        const errorText = `Error sending email: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`;
        showCopyableError('Send Email Error', errorText);
        console.error('Send email error:', err);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    };
    
    // Test SMTP connection
    const testSmtpBtn = document.getElementById('testSmtpBtn');
    testSmtpBtn.onclick = async () => {
      try {
        testSmtpBtn.disabled = true;
        testSmtpBtn.textContent = 'Testing...';
        
        const res = await fetch('/api/smtp/test');
        const data = await res.json();
        if (data.success) {
          await showModal({
            title: 'SMTP OK',
            body: `SMTP connection successful.\nHost: ${data.host}\nPort: ${data.port}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}`,
          });
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `??SMTP Connection Failed:\n${errorMsg}${errorCode}\n\nHost: ${data.host || 'N/A'}\nPort: ${data.port || 'N/A'}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}\n\n${data.troubleshooting || ''}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('SMTP Connection Error', errorText);
          console.error('SMTP test error:', data);
        }
      } catch (err) {
        showCopyableError('SMTP Test Error', `Error testing SMTP: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
        console.error('SMTP test error:', err);
      } finally {
        testSmtpBtn.disabled = false;
        testSmtpBtn.textContent = '?? Test SMTP Connection';
      }
    };
    
    // Test send email to eric.brilliant@gmail.com
    testSendBtn.onclick = async () => {
      const ok = await showModal({
        title: 'Send test email',
        body: 'Send test email to eric.brilliant@gmail.com?',
        okText: 'Send',
        cancelText: 'Cancel'
      });
      if (!ok) return;
      try {
        testSendBtn.disabled = true;
        testSendBtn.textContent = 'Sending...';
        const res = await fetch('/api/email/test', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          await showModal({ title: 'Sent', body: `Test email sent successfully to ${data.to}!` });
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Test Email Error:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Test Email Error', errorText);
          console.error('Test email error:', data);
        }
      } catch (err) {
        showCopyableError('Test Email Error', `Error: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
      } finally {
        testSendBtn.disabled = false;
        testSendBtn.textContent = '?ï¿½ï¿½ Send Test Email';
      }
    };

    // Email modal event listeners
    document.getElementById('emailModalClose').onclick = () => {
      document.getElementById('emailModal').style.display = 'none';
      document.body.classList.remove('modal-open');
    };

    document.getElementById('emailModal').onclick = (e) => {
      if (e.target === document.getElementById('emailModal')) {
        document.getElementById('emailModal').style.display = 'none';
        document.body.classList.remove('modal-open');
      }
    };

    // Quotation button expandable functionality
    document.getElementById('quotationBtn').onclick = () => {
      const btn = document.getElementById('quotationBtn');
      const subOptions = document.getElementById('quotationSubOptions');

      btn.classList.toggle('expanded');
      subOptions.classList.toggle('expanded');
    };

    // Quotation sub-option click handlers
    document.querySelectorAll('.sub-option-btn').forEach(btn => {
      btn.onclick = () => {
        const quotationType = btn.getAttribute('data-type');
        const quotationName = btn.textContent;
        console.log('Quotation type selected:', quotationType);

        // Set flag to disable customer fields when opening from email view
        window.isDummy2Mode = true;

        // Open email quotation modal with current email metadata
        openEmailQuotationModal(quotationType, quotationName, currentEmailMeta);
      };
    });

    // Image Lib button click handler
    document.getElementById('imageLibBtn').onclick = () => {
      console.log('Image Lib button clicked');
      // TODO: Implement image library logic
    };

    // Fill quotation form with random data (optionally keeping customer info fixed)
    function fillDummyQuotationData(keepCustomerInfoFixed = false) {
      // Random dimensions
      const widths = ['0.5 inch', '1 inch', '1.5 inches', '2 inches', '2.5 inches', '3 inches'];
      const lengths = ['1 inch', '1.5 inches', '2 inches', '2.5 inches', '3 inches', '4 inches'];

      // Random color counts
      const colorCounts = ['1 Color', '2 Colors', '3 Colors', '4 Colors', '5 Colors', '6+ Colors'];

      // Random edge finishes
      const edgeFinishes = ['Cut Edge', 'Folded Edge', 'Heat Cut', 'Ultrasonic Cut', 'Laser Cut'];

      // Random quantities
      const quantities = [500, 1000, 2000, 3000, 5000, 10000];

      // Random unit prices
      const unitPrices = [0.25, 0.35, 0.50, 0.75, 1.00, 1.25, 1.50];

      // Random notes
      const notes = [
        'Rush order - need within 2 weeks',
        'Standard production timeline acceptable',
        'Please provide sample before full production',
        'Repeat order - same specifications as last time',
        'New design - please confirm artwork before production',
        'Urgent - customer deadline approaching'
      ];

      // Fill product specifications (NOT customer info)
      const widthField = document.getElementById('quotationWidth');
      if (widthField) {
        widthField.value = widths[Math.floor(Math.random() * widths.length)];
      }

      const lengthField = document.getElementById('quotationLength');
      if (lengthField) {
        lengthField.value = lengths[Math.floor(Math.random() * lengths.length)];
      }

      const colorCountField = document.getElementById('quotationColorCount');
      if (colorCountField) {
        const randomColor = colorCounts[Math.floor(Math.random() * colorCounts.length)];
        // Set the select dropdown value
        for (let i = 0; i < colorCountField.options.length; i++) {
          if (colorCountField.options[i].text === randomColor) {
            colorCountField.selectedIndex = i;
            break;
          }
        }
      }

      const edgeFinishField = document.getElementById('quotationEdgeFinish');
      if (edgeFinishField) {
        const randomEdge = edgeFinishes[Math.floor(Math.random() * edgeFinishes.length)];
        // Set the select dropdown value
        for (let i = 0; i < edgeFinishField.options.length; i++) {
          if (edgeFinishField.options[i].text === randomEdge) {
            edgeFinishField.selectedIndex = i;
            break;
          }
        }
      }

      // Fill quantity and pricing
      const quantityField = document.getElementById('quotationQuantity');
      if (quantityField) {
        quantityField.value = quantities[Math.floor(Math.random() * quantities.length)];
      }

      const unitPriceField = document.getElementById('quotationUnitPrice');
      if (unitPriceField) {
        unitPriceField.value = unitPrices[Math.floor(Math.random() * unitPrices.length)].toFixed(2);
      }

      // Calculate total
      if (quantityField && unitPriceField) {
        const quantity = parseFloat(quantityField.value) || 0;
        const unitPrice = parseFloat(unitPriceField.value) || 0;
        const totalField = document.getElementById('quotationTotal');
        if (totalField) {
          totalField.value = (quantity * unitPrice).toFixed(2);
        }
      }

      // Fill notes
      const notesField = document.getElementById('quotationNotes');
      if (notesField) {
        notesField.value = notes[Math.floor(Math.random() * notes.length)];
      }

      console.log('Dummy quotation data filled (customer info preserved)');
    }

    // Email Quotation Modal Functions
    function openEmailQuotationModal(quotationType, quotationName, emailMeta = null) {
      const modal = document.getElementById('emailQuotationModal');
      const content = document.getElementById('emailQuotationContent');

      // Store email metadata for later use when saving quotation
      window.currentQuotationEmailMeta = emailMeta;

      // Update modal title
      const titleElement = modal.querySelector('.email-modal-title');
      titleElement.innerHTML = `ðŸ“§ Email Quotation - ${quotationName}`;

      // Load quotation form content (pass isDummy2Mode flag)
      content.innerHTML = generateQuotationContent(quotationType, quotationName, 'email', window.isDummy2Mode || false);

      // Show modal
      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      // Initialize form handlers after content is loaded
      setTimeout(() => {
        // Initialize customer autocomplete
        if (document.getElementById('quotationCustomerName')) {
          window.customerAutocomplete = new CustomerAutocomplete('quotationCustomerName', 'customerAutocompleteDropdown');
        }

        // Pre-populate customer data if available
        if (currentCustomerData && currentCustomerData.customer) {
          const customerNameField = document.getElementById('quotationCustomerName');
          const contactPersonField = document.getElementById('quotationContactPerson');
          const emailField = document.getElementById('quotationEmail');
          const phoneField = document.getElementById('quotationPhone');

          // Set customer name
          if (customerNameField) {
            customerNameField.value = currentCustomerData.customer.companyName;

            // Set up the customer object with members for autocomplete
            if (window.customerAutocomplete) {
              const customerWithMembers = {
                ...currentCustomerData.customer,
                members: currentCustomerData.allMembers || []
              };
              window.customerAutocomplete.selectedCustomer = customerWithMembers;

              // Manually populate contact person dropdown
              if (contactPersonField) {
                contactPersonField.innerHTML = '<option value="">Select Contact Person</option>';

                if (currentCustomerData.allMembers && currentCustomerData.allMembers.length > 0) {
                  currentCustomerData.allMembers.forEach(member => {
                    if (member.name) {
                      const option = document.createElement('option');
                      option.value = member.name;
                      option.textContent = `${member.name}${member.title ? ` (${member.title})` : ''}`;
                      option.dataset.memberData = JSON.stringify(member);
                      contactPersonField.appendChild(option);
                    }
                  });
                }
              }
            }
          }

          // Pre-select the specific member if found
          if (contactPersonField && currentCustomerData.member) {
            // Wait a bit for the dropdown to be populated
            setTimeout(() => {
              const options = contactPersonField.options;
              for (let i = 0; i < options.length; i++) {
                if (options[i].value === currentCustomerData.member.name) {
                  contactPersonField.selectedIndex = i;
                  // Trigger change event to populate email and phone
                  contactPersonField.dispatchEvent(new Event('change'));
                  break;
                }
              }
            }, 100);
          } else if (emailField && emailMeta && emailMeta.email) {
            // If no specific member found, use email from emailMeta
            emailField.value = emailMeta.email;
          }

          // Set phone if member has it and no contact person selected
          if (phoneField && currentCustomerData.member && currentCustomerData.member.tel && !contactPersonField.value) {
            phoneField.value = currentCustomerData.member.tel;
          }
        } else if (emailMeta && emailMeta.email) {
          // Fallback: if no customer data but we have email metadata, use that
          const emailField = document.getElementById('quotationEmail');
          if (emailField) {
            emailField.value = emailMeta.email;
          }
        }

        // Initialize file upload functionality
        initializeFileUploads(quotationType);

        // Add event listener for contact person selection
        const contactPersonField = document.getElementById('quotationContactPerson');
        if (contactPersonField) {
          contactPersonField.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const emailField = document.getElementById('quotationEmail');
            const phoneField = document.getElementById('quotationPhone');

            if (selectedOption && selectedOption.value && selectedOption.dataset.memberData) {
              const memberData = JSON.parse(selectedOption.dataset.memberData);

              // Auto-populate and disable email field
              if (emailField && memberData.emailPrefix) {
                emailField.value = `${memberData.emailPrefix}@${window.customerAutocomplete.selectedCustomer.emailDomain}`;
                emailField.disabled = true;
                emailField.style.backgroundColor = '#f5f5f5';
                emailField.style.color = '#666';
              }

              // Auto-populate and disable phone field
              if (phoneField && memberData.tel) {
                phoneField.value = memberData.tel;
                phoneField.disabled = true;
                phoneField.style.backgroundColor = '#f5f5f5';
                phoneField.style.color = '#666';
              }
            } else {
              // No contact person selected - enable fields for manual entry
              if (emailField) {
                emailField.disabled = false;
                emailField.style.backgroundColor = '#fff';
                emailField.style.color = '#000';
              }
              if (phoneField) {
                phoneField.disabled = false;
                phoneField.style.backgroundColor = '#fff';
                phoneField.style.color = '#000';
              }
            }
          });
        }

        // Set up event listeners for total calculation
        const quantityField = document.getElementById('quotationQuantity');
        const unitPriceField = document.getElementById('quotationUnitPrice');
        const totalField = document.getElementById('quotationTotal');

        if (quantityField && unitPriceField && totalField) {
          const calculateTotal = () => {
            const quantity = parseFloat(quantityField.value) || 0;
            const unitPrice = parseFloat(unitPriceField.value) || 0;
            const total = quantity * unitPrice;
            totalField.value = total.toFixed(2);
          };

          quantityField.addEventListener('input', calculateTotal);
          unitPriceField.addEventListener('input', calculateTotal);
        }

        // Initialize supplier autocomplete
        setupSupplierAutocomplete();

        // Set initial visibility of supplier section based on product type
        const productTypeSelect = document.getElementById('quotationProductType');
        if (productTypeSelect) {
          toggleSupplierSection(productTypeSelect.value);
        }
      }, 100);
    }

    // Close email quotation modal
    document.getElementById('emailQuotationModalClose').onclick = () => {
      document.getElementById('emailQuotationModal').style.display = 'none';
      document.body.classList.remove('modal-open');
    };

    // Close modal when clicking outside
    document.getElementById('emailQuotationModal').onclick = (e) => {
      if (e.target === document.getElementById('emailQuotationModal')) {
        document.getElementById('emailQuotationModal').style.display = 'none';
        document.body.classList.remove('modal-open');
      }
    };

    // ========== EMAIL SEND PANEL FUNCTIONALITY ==========

    // Store current sent emails list
    let currentSentEmails = [];

    function initializeEmailSendPanel() {
      console.log('Initializing email send panel');
      // Compose email handlers for send panel
      const composeSendBtn = document.getElementById('composeSendBtn');
      const composeSendForm = document.getElementById('composeSendForm');
      const cancelSendBtn = document.getElementById('cancelSendBtn');
      const sendEmailBtn = document.getElementById('sendEmailBtn');
      const testSendEmailBtn = document.getElementById('testSendEmailBtn');
      const testSmtpConnectionBtn = document.getElementById('testSmtpConnectionBtn');
      const dummyFillSendComposeBtn = document.getElementById('dummyFillSendComposeBtn');

      if (dummyFillSendComposeBtn) {
        dummyFillSendComposeBtn.onclick = () => {
          fillDummyForm(composeSendForm);
        };
      }

      composeSendBtn.onclick = () => {
        composeSendForm.style.display = composeSendForm.style.display === 'none' ? 'block' : 'none';
      };

      cancelSendBtn.onclick = () => {
        composeSendForm.style.display = 'none';
        document.getElementById('toSendEmail').value = '';
        document.getElementById('subjectSendEmail').value = '';
        document.getElementById('bodySendEmail').value = '';
      };

      sendEmailBtn.onclick = async () => {
        const to = document.getElementById('toSendEmail').value;
        const subject = document.getElementById('subjectSendEmail').value;
        const text = document.getElementById('bodySendEmail').value;

        if (!to || !subject || !text) {
          await showModal({ title: 'Missing fields', body: 'Please fill in: To, Subject, and Message.' });
          return;
        }

        try {
          sendEmailBtn.disabled = true;
          sendEmailBtn.textContent = 'Sending...';

          // Add timeout to fetch request (increased for idle reconnection)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            if (!controller.signal.aborted) {
              controller.abort();
            }
          }, 60000); // 60 second timeout (increased to allow for SMTP reconnection)

          let res;
          try {
            res = await fetch('/api/email/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ to, subject, text }),
              signal: controller.signal
            });
            clearTimeout(timeoutId);
          } catch (fetchErr) {
            clearTimeout(timeoutId);
            if (fetchErr.name === 'AbortError') {
              throw new Error('Request timeout - server took too long to respond');
            }
            throw new Error(`Network error: ${fetchErr.message}`);
          }

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${res.status}` };
            }
            const errorMsg = errorData.error || 'Failed to send email';
            const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
            const fullError = `Error sending email:\n${errorMsg}${errorCode}\n\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
            showCopyableError('Send Email Error', fullError);
            console.error('Send email error:', errorData);
            return;
          }

          const data = await res.json();
          if (data.success) {
            await showModal({
              title: 'Sent',
              body: `Email sent successfully.\nMessage ID: ${data.messageId || 'N/A'}`,
            });
            composeSendForm.style.display = 'none';
            document.getElementById('toSendEmail').value = '';
            document.getElementById('subjectSendEmail').value = '';
            document.getElementById('bodySendEmail').value = '';
            // Auto refresh the sent emails table to show the newly sent email
            loadSentEmails();
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `Error sending email:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('Send Email Error', errorText);
            console.error('Send email error:', data);
          }
        } catch (err) {
          const errorText = `Error sending email: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`;
          showCopyableError('Send Email Error', errorText);
          console.error('Send email error:', err);
        } finally {
          sendEmailBtn.disabled = false;
          sendEmailBtn.textContent = 'Send';
        }
      };

      // Test SMTP connection
      testSmtpConnectionBtn.onclick = async () => {
        try {
          testSmtpConnectionBtn.disabled = true;
          testSmtpConnectionBtn.textContent = 'Testing...';

          const res = await fetch('/api/smtp/test');
          const data = await res.json();
          if (data.success) {
            await showModal({
              title: 'SMTP OK',
              body: `SMTP connection successful.\nHost: ${data.host}\nPort: ${data.port}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}`,
            });
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `SMTP Connection Failed:\n${errorMsg}${errorCode}\n\nHost: ${data.host || 'N/A'}\nPort: ${data.port || 'N/A'}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}\n\n${data.troubleshooting || ''}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('SMTP Connection Error', errorText);
            console.error('SMTP test error:', data);
          }
        } catch (err) {
          showCopyableError('SMTP Test Error', `Error testing SMTP: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
          console.error('SMTP test error:', err);
        } finally {
          testSmtpConnectionBtn.disabled = false;
          testSmtpConnectionBtn.textContent = 'Test SMTP Connection';
        }
      };

      // Test send email to eric.brilliant@gmail.com
      testSendEmailBtn.onclick = async () => {
        const ok = await showModal({
          title: 'Send test email',
          body: 'Send test email to eric.brilliant@gmail.com?',
          okText: 'Send',
          cancelText: 'Cancel'
        });
        if (!ok) return;
        try {
          testSendEmailBtn.disabled = true;
          testSendEmailBtn.textContent = 'Sending...';
          const res = await fetch('/api/email/test', { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            await showModal({ title: 'Sent', body: `Test email sent successfully to ${data.to}!` });
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `Test Email Error:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('Test Email Error', errorText);
            console.error('Test email error:', data);
          }
        } catch (err) {
          showCopyableError('Test Email Error', `Error: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
        } finally {
          testSendEmailBtn.disabled = false;
          testSendEmailBtn.textContent = 'Send Test Email';
        }
      };

      // Load and display sent emails
      loadSentEmails();
      const refreshSentEmailsBtn = document.getElementById('refreshSentEmailsBtn');
      refreshSentEmailsBtn.onclick = () => loadSentEmails();

      // Add search/filter event listeners
      document.getElementById('sentDateSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentFromSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentToSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentSubjectSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentStatusFilter').addEventListener('change', filterSentEmails);
      document.getElementById('sentDetailsSearch').addEventListener('input', filterSentEmails);
    }

    // Load sent emails from API
    async function loadSentEmails() {
      console.log('Loading sent emails from database...');
      const tableBody = document.getElementById('sentEmailsTableBody');
      const loadingDiv = document.getElementById('sentEmailsLoading');
      const emptyDiv = document.getElementById('sentEmailsEmpty');

      loadingDiv.style.display = 'block';
      emptyDiv.style.display = 'none';
      tableBody.innerHTML = '';

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        // Fetch sent emails from database (includes full body content)
        console.log('Fetching sent emails from database...');
        const res = await fetch('/api/sent-emails?limit=100', { signal: controller.signal });
        console.log('API response status:', res.status);
        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        console.log('API response data:', data);
        if (data.success) {
          currentSentEmails = data.sentEmails || [];
          console.log('Current sent emails from database:', currentSentEmails);
          renderSentEmailsTable(currentSentEmails);
        } else {
          throw new Error(data.error || 'Failed to load sent emails');
        }
      } catch (err) {
        console.error('Failed to load sent emails:', err);
        tableBody.innerHTML = `<tr><td colspan="6" style="padding:20px; text-align:center; border:1px solid #000; color:#666;">Failed to load sent emails: ${err.message}</td></tr>`;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Render sent emails table from IMAP data
    function renderSentEmailsTableFromIMAP(sentEmails) {
      console.log('Rendering sent emails table from IMAP with', sentEmails.length, 'emails');
      const tableBody = document.getElementById('sentEmailsTableBody');
      const emptyDiv = document.getElementById('sentEmailsEmpty');

      tableBody.innerHTML = '';

      if (sentEmails.length === 0) {
        console.log('No sent emails to display');
        emptyDiv.style.display = 'block';
        return;
      }

      emptyDiv.style.display = 'none';

      sentEmails.forEach(email => {
        const row = document.createElement('tr');
        row.style.border = '1px solid #000';

        // Format date from envelope
        const sentDate = new Date(email.envelope?.date);
        const formattedDate = sentDate.toLocaleDateString() + ' ' + sentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Extract sender and recipient from envelope
        const fromEmail = email.envelope?.from?.[0]?.address || email.envelope?.from?.[0]?.name || 'Unknown';
        const toEmail = email.envelope?.to?.[0]?.address || email.envelope?.to?.[0]?.name || 'Unknown';
        const subject = email.envelope?.subject || '(No subject)';

        // Status is always "Sent" for emails in sent folder
        const statusClass = 'color:#008000;';
        const statusText = 'Sent';

        // Create content preview - we'll need to fetch the full email to show details
        const previewText = '<span style="cursor:pointer; font-weight:500;">Click to view</span>';

        row.innerHTML = `
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${formattedDate}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${fromEmail}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${toEmail}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${subject}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top; ${statusClass} font-weight:bold;">${statusText}</td>
          <td class="sent-email-view-cell" style="padding:12px; border:1px solid #000; vertical-align:top;">${previewText}</td>
        `;

        tableBody.appendChild(row);

        // Add event listeners after appending to DOM
        row.onmouseover = () => row.style.background = 'rgba(0, 0, 0, 0.3)';
        row.onmouseout = () => row.style.background = '#fff';

        // Only make the "Click to view" cell clickable
        const viewCell = row.querySelector('.sent-email-view-cell');
        viewCell.onclick = (event) => {
          console.log('Sent email view cell clicked, UID:', email.uid);
          showSentEmail(email.uid);
        };
      });
    }

    // Render sent emails table
    function renderSentEmailsTable(sentEmails) {
      console.log('Rendering sent emails table with', sentEmails.length, 'emails');
      const tableBody = document.getElementById('sentEmailsTableBody');
      const emptyDiv = document.getElementById('sentEmailsEmpty');

      tableBody.innerHTML = '';

      if (sentEmails.length === 0) {
        console.log('No sent emails to display');
        emptyDiv.style.display = 'block';
        return;
      }

      emptyDiv.style.display = 'none';

      sentEmails.forEach(email => {
        const row = document.createElement('tr');
        row.style.border = '1px solid #000';

        // Format date
        const sentDate = new Date(email.sent_at);
        const formattedDate = sentDate.toLocaleDateString() + ' ' + sentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Status styling
        const statusClass = email.status === 'sent' ? 'color:#008000;' : 'color:#ff0000;';
        const statusText = email.status === 'sent' ? 'Sent' : 'Failed';

        // Create content preview for details column
        const contentPreview = email.body_text || email.body_html || '';
        const previewText = contentPreview.length > 50 ? contentPreview.substring(0, 50) + '...' : contentPreview;

        row.innerHTML = `
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${formattedDate}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.sender_email || 'Unknown'}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.to_email}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.subject || '(No subject)'}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top; ${statusClass} font-weight:bold;">${statusText}</td>
          <td class="sent-email-details-cell" style="padding:12px; border:1px solid #000; vertical-align:top; cursor:pointer; font-weight:500;">${previewText}</td>
        `;

        tableBody.appendChild(row);

        // Add hover effects
        row.onmouseover = () => row.style.background = 'rgba(0, 0, 0, 0.3)';
        row.onmouseout = () => row.style.background = '#fff';

        // Only make the preview cell clickable
        const detailsCell = row.querySelector('.sent-email-details-cell');
        detailsCell.onclick = () => {
          console.log('Sent email details cell clicked, id=', email.id, 'subject=', email.subject);
          try {
            showSentEmailDetails(email);
          } catch (e) {
            console.error('Error in showSentEmailDetails:', e);
          }
        };
      });
    }

    // Filter sent emails based on search inputs
    function filterSentEmails() {
      const dateSearch = document.getElementById('sentDateSearch').value.toLowerCase();
      const fromSearch = document.getElementById('sentFromSearch').value.toLowerCase();
      const toSearch = document.getElementById('sentToSearch').value.toLowerCase();
      const subjectSearch = document.getElementById('sentSubjectSearch').value.toLowerCase();
      const statusFilter = document.getElementById('sentStatusFilter').value;
      const detailsSearch = document.getElementById('sentDetailsSearch').value.toLowerCase();

      const filteredEmails = currentSentEmails.filter(email => {
        const date = new Date(email.sent_at).toLocaleDateString().toLowerCase();
        const from = (email.sender_email || '').toLowerCase();
        const to = email.to_email.toLowerCase();
        const subject = (email.subject || '').toLowerCase();
        const status = email.status;
        const content = (email.body_text || email.body_html || '').toLowerCase();

        return date.includes(dateSearch) &&
               from.includes(fromSearch) &&
               to.includes(toSearch) &&
               subject.includes(subjectSearch) &&
               (statusFilter === '' || status === statusFilter) &&
               content.includes(detailsSearch);
      });

      renderSentEmailsTable(filteredEmails);
    }

    // Show sent email details using the same email modal as received emails
    function showSentEmailDetails(email) {
      const subject = email.subject || '(No subject)';
      const from = email.sender_email || 'Unknown';
      const date = email.sent_at ? new Date(email.sent_at).toLocaleString() : 'Unknown';
      console.log('showSentEmailDetails called for id=', email.id, 'subject=', subject);
      console.log('Full email object:', email);

      // Prefer HTML body if it looks like HTML, otherwise use plain text
      let bodyContent = email.body_html || email.body_text || '';
      console.log('bodyContent length:', bodyContent.length);
      console.log('bodyContent preview:', bodyContent.substring(0, 200));
      console.log('email.body_html:', email.body_html ? 'exists (length: ' + email.body_html.length + ')' : 'null/undefined');
      console.log('email.body_text:', email.body_text ? 'exists (length: ' + email.body_text.length + ')' : 'null/undefined');

      // For already-sent emails with embedded MIME, we can't fix them retroactively
      // The fix in sendQuotationEmail (lines 6825-6862) will prevent this for future emails

      // Check if bodyContent is a raw MIME message and parse it
      // Only parse as MIME if it's NOT already HTML (check for DOCTYPE or opening HTML tags at the start)
      const isAlreadyHtml = /^\s*<!DOCTYPE|^\s*<html/i.test(bodyContent);

      if (!isAlreadyHtml && bodyContent && (bodyContent.includes('Content-Type:') || bodyContent.includes('Content-Transfer-Encoding:') || bodyContent.includes('This is a multi-part message'))) {
        console.log('Detected raw MIME message, parsing...');

        try {
          // Use regex to extract base64 content directly
          // Pattern matches: Content-Type: text/html or text/plain, followed by base64 encoding, followed by base64 content
          // This handles both line breaks and spaces between elements
          const htmlMatch = bodyContent.match(/Content-Type:\s*text\/html[^\r\n]*[\s\r\n]+Content-Transfer-Encoding:\s*base64[\s\r\n]+([A-Za-z0-9+\/=\s]+?)(?=\s*------=_NextPart|$)/i);
          const plainMatch = bodyContent.match(/Content-Type:\s*text\/plain[^\r\n]*[\s\r\n]+Content-Transfer-Encoding:\s*base64[\s\r\n]+([A-Za-z0-9+\/=\s]+?)(?=\s*------=_NextPart|$)/i);

          let htmlContent = '';
          let plainContent = '';

          // Decode HTML content if found
          if (htmlMatch && htmlMatch[1]) {
            try {
              const cleanBase64 = htmlMatch[1].replace(/\s+/g, '');
              htmlContent = atob(cleanBase64);
              console.log('Decoded HTML content:', htmlContent.substring(0, 100));
            } catch (e) {
              console.warn('Failed to decode HTML base64:', e);
            }
          }

          // Decode plain text content if found
          if (plainMatch && plainMatch[1]) {
            try {
              const cleanBase64 = plainMatch[1].replace(/\s+/g, '');
              plainContent = atob(cleanBase64);
              console.log('Decoded plain text content:', plainContent.substring(0, 100));
            } catch (e) {
              console.warn('Failed to decode plain text base64:', e);
            }
          }

          // Use decoded content if available (prefer HTML over plain text)
          if (htmlContent || plainContent) {
            bodyContent = htmlContent || plainContent;
            console.log('Successfully parsed MIME content, length:', bodyContent.length);
          }
        } catch (e) {
          console.error('Error parsing MIME message:', e);
        }
      }

      if (bodyContent && !(bodyContent.includes('<') && bodyContent.includes('>'))) {
        // keep as plain text
      }

      const emailMeta = {
        id: email.id,
        subject: subject,
        from: from,
        to: email.to_email || null,
        email: (from.match && from.match(/<([^>]+)>/) ? from.match(/<([^>]+)>/)[1] : from),
        date: date,
        messageId: email.message_id || null,
        smtpResponse: email.smtp_response || null,
        status: email.status || null,
      };

      // Populate and show the standard email modal so behavior matches received-email popup
      // Pass isSentEmail=true to hide Quotation and Image Lib buttons for sent emails
      populateEmailModal(subject, from, date, bodyContent, emailMeta, true);
      // Ensure modal is attached to document.body so it's visible even when the emails panel is hidden
      try {
        const modalEl = document.getElementById('emailModal');
        if (modalEl && modalEl.parentNode !== document.body) {
          document.body.appendChild(modalEl);
        }
      } catch (attachErr) {
        console.error('Failed to attach modal to body (sent):', attachErr);
      }
      // Append delivery info to modal body (message id / smtp response / error) for sent emails
      const modalBody = document.getElementById('emailModalBody');
      const infoLines = [];
      if (email.message_id) infoLines.push(`<strong>Message ID:</strong> ${email.message_id}`);
      if (email.smtp_response) infoLines.push(`<strong>SMTP Response:</strong> ${email.smtp_response}`);
      if (email.error_message) infoLines.push(`<strong style="color:#ff0000;">Error:</strong> ${email.error_message}`);
      if (infoLines.length > 0) {
        const infoHtml = `<div style="margin-top:12px; padding:10px; border-top:1px solid #000; background:#fafafa;">${infoLines.join('<br>')}</div>`;
        // If modal body is HTML, append; otherwise, append after converting to HTML
        if (modalBody.innerHTML && modalBody.innerHTML.trim() !== '') {
          modalBody.innerHTML = modalBody.innerHTML + infoHtml;
        } else {
          modalBody.innerHTML = (modalBody.textContent || '') + infoHtml;
        }
      }

      document.getElementById('emailModal').style.display = 'flex';
      document.body.classList.add('modal-open');
      // Debug: verify modal visibility and computed style
      try {
        const modalEl = document.getElementById('emailModal');
        const modalBody = document.getElementById('emailModalBody');
        console.log('emailModal element after show:', modalEl);
        console.log('emailModal.style.display:', modalEl.style.display);
        console.log('emailModal computed display:', getComputedStyle(modalEl).display);
        console.log('emailModal bounding rect:', modalEl.getBoundingClientRect());
        console.log('emailModalBody content length:', (modalBody && modalBody.innerHTML) ? modalBody.innerHTML.length : 0);
        console.log('document.body.classList:', document.body.classList ? document.body.classList.toString() : document.body.className);
      } catch (dbgErr) {
        console.error('Modal debug error:', dbgErr);
      }
      // Force inline styles in case CSS is being overridden or viewport metrics are zero
      try {
        const modalEl2 = document.getElementById('emailModal');
        modalEl2.style.position = 'fixed';
        modalEl2.style.left = '0';
        modalEl2.style.top = '0';
        modalEl2.style.width = '100vw';
        modalEl2.style.height = '100vh';
        modalEl2.style.inset = '0';
        modalEl2.style.zIndex = '10001';
        modalEl2.style.display = 'flex';
        modalEl2.style.visibility = 'visible';
        modalEl2.style.opacity = '1';
        // Ensure inner modal has a minimum size
        const inner = modalEl2.querySelector('.email-modal');
        if (inner) {
          inner.style.maxHeight = '90vh';
          inner.style.width = inner.style.width || 'min(1200px, 95vw)';
        }
        // Scroll modal into view
        modalEl2.scrollIntoView({ block: 'center', inline: 'center', behavior: 'auto' });
        console.log('Forced inline modal styles applied');
      } catch (err) {
        console.error('Failed to force modal styles:', err);
      }
    }

    // ========== CUSTOMER PANEL FUNCTIONALITY ==========

    // currentCustomerData is declared earlier in the file (line ~1152)
    let membersData = [];
    let savedCustomers = []; // Store all saved customers

    // Supplier data storage
    let currentSupplierData = null;
    let supplierMembersData = [];
    let savedSuppliers = []; // Store all saved suppliers

    function initializeCustomerPanel() {
      // Reset customer data and disable member tab
      currentCustomerData = null;
      membersData = [];

      // Disable member tab initially
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.add('tab-disabled');

      // Tab switching
      const customerTab = document.querySelector('[data-tab="customer-info"]');

      customerTab.onclick = () => switchCustomerTab('customer');
      memberTab.onclick = () => switchCustomerTab('member');

      // Start with customer tab active
      switchCustomerTab('customer');

      // Form elements
      const dummyInputBtn = document.getElementById('dummyInputBtn');
      const saveCustomerBtn = document.getElementById('saveCustomerBtn');
      const addMemberBtn = document.getElementById('addMemberBtn');
      const dummyMemberBtn = document.getElementById('dummyMemberBtn');

      // Dummy input functionality
      dummyInputBtn.onclick = () => fillDummyData();

      // Save customer and continue to members
      saveCustomerBtn.onclick = () => saveCustomerInfo();

      // Add member functionality
      addMemberBtn.onclick = () => addNewMember();

      // Dummy member functionality
      dummyMemberBtn.onclick = () => addDummyMember();

      // File upload functionality
      initializeFileUpload();
    }

    function switchCustomerTab(tab) {
      const customerTab = document.querySelector('[data-tab="customer-info"]');
      const memberTab = document.querySelector('[data-tab="member-info"]');

      // Prevent switching to member tab if it's disabled
      if (tab === 'member' && memberTab.classList.contains('tab-disabled')) {
        return; // Do nothing if member tab is disabled
      }

      const customerInfoTab = document.getElementById('customerInfoTab');
      const memberInfoTab = document.getElementById('memberInfoTab');

      if (tab === 'customer') {
        customerTab.classList.add('tab-active');
        memberTab.classList.remove('tab-active');
        customerInfoTab.style.display = 'block';
        memberInfoTab.style.display = 'none';
      } else {
        customerTab.classList.remove('tab-active');
        memberTab.classList.add('tab-active');
        customerInfoTab.style.display = 'none';
        memberInfoTab.style.display = 'block';
      }
    }

    async function saveCustomerInfo() {
      const companyName = document.getElementById('companyName').value.trim();
      const emailDomain = document.getElementById('emailDomain').value.trim();
      const companyAddress = document.getElementById('companyAddress').value.trim();
      const companyTel = document.getElementById('companyTel').value.trim();
      const companyType = document.getElementById('companyType').value;
      const companyWebsite = document.getElementById('companyWebsite').value.trim();

      // Validation
      if (!companyName) {
        showModal({ title: 'Validation Error', body: 'Company Name is required.' });
        return;
      }
      if (!emailDomain) {
        showModal({ title: 'Validation Error', body: 'Email Domain is required.' });
        return;
      }
      if (!companyType) {
        showModal({ title: 'Validation Error', body: 'Type is required.' });
        return;
      }

      // Validate email domain format
      const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/;
      if (!domainRegex.test(emailDomain)) {
        showModal({ title: 'Validation Error', body: 'Please enter a valid email domain (e.g., example.com).' });
        return;
      }

      // Save customer data
      currentCustomerData = {
        id: Date.now(), // Simple ID based on timestamp
        companyName,
        emailDomain,
        companyAddress,
        companyTel,
        companyType,
        companyWebsite,
        members: [] // Will be populated when members are saved
      };

      // Enable member tab
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.remove('tab-disabled');

      // Switch to member tab
      switchCustomerTab('member');

      showModal({ title: 'Success', body: 'Customer information saved. Member tab is now enabled.' });
    }

    function addNewMember() {
      if (!currentCustomerData) {
        showModal({ title: 'Error', body: 'Please complete customer information first.' });
        return;
      }

      const memberIndex = membersData.length;
      const memberHtml = `
        <div class="member-item" style="border:1px solid #000; padding:15px; margin-bottom:10px; background:#f9f9f9;">
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Name *</label>
              <input type="text" class="member-name" placeholder="Full Name" required>
            </div>
            <div style="flex:1;">
              <label>Email *</label>
              <div style="display:flex;">
                <input type="text" class="member-email-prefix" placeholder="username" required style="flex:1;">
                <span style="padding:8px; background:#eee; border:1px solid #000;">@${currentCustomerData.emailDomain}</span>
              </div>
            </div>
          </div>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Title</label>
              <input type="text" class="member-title" placeholder="Job Title">
            </div>
            <div style="flex:1;">
              <label>Telephone</label>
              <input type="tel" class="member-tel" placeholder="Phone Number">
            </div>
          </div>
          <div class="row">
            <button class="page-btn save-member-btn" data-index="${memberIndex}">Save Member</button>
            <button class="page-btn delete-member-btn" data-index="${memberIndex}" style="margin-left:10px;">Delete</button>
          </div>
        </div>
      `;

      document.getElementById('membersList').insertAdjacentHTML('beforeend', memberHtml);

      // Add event listeners to the new member
      const memberDiv = document.getElementById('membersList').lastElementChild;
      const saveBtn = memberDiv.querySelector('.save-member-btn');
      const deleteBtn = memberDiv.querySelector('.delete-member-btn');

      saveBtn.onclick = () => saveMember(memberIndex);
      deleteBtn.onclick = () => deleteMember(memberIndex);

      // Initialize with empty data
      membersData.push({
        name: '',
        emailPrefix: '',
        title: '',
        tel: ''
      });
    }

    async function saveMember(index) {
      const memberDiv = document.querySelectorAll('.member-item')[index];
      const name = memberDiv.querySelector('.member-name').value.trim();
      const emailPrefix = memberDiv.querySelector('.member-email-prefix').value.trim();
      const title = memberDiv.querySelector('.member-title').value.trim();
      const tel = memberDiv.querySelector('.member-tel').value.trim();

      if (!name) {
        showModal({ title: 'Validation Error', body: 'Member name is required.' });
        return;
      }
      if (!emailPrefix) {
        showModal({ title: 'Validation Error', body: 'Member email prefix is required.' });
        return;
      }

      membersData[index] = {
        name,
        emailPrefix,
        title,
        tel
      };

      // Update current customer with members
      if (currentCustomerData) {
        currentCustomerData.members = [...membersData];
        // Save to database (this will create or update the customer)
        await saveCustomerToStorage(currentCustomerData);
      }

      // Handle save completion with add more prompt
      handleMemberSaveComplete(name);
    }

    function showAddMoreModal(memberName) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Save Complete';

        const content = document.createElement('div');
        content.className = 'modal-body';
        content.innerHTML = `
          Member "${memberName}" saved successfully.<br><br>
          <strong>Do you want to add more members?</strong>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const yesBtn = document.createElement('button');
        yesBtn.className = 'btn primary';
        yesBtn.textContent = 'Yes, Add More';
        yesBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(true);
        };

        const noBtn = document.createElement('button');
        noBtn.className = 'btn';
        noBtn.textContent = 'No, Finish';
        noBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(false);
        };

        actions.appendChild(noBtn);
        actions.appendChild(yesBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Handle Escape key
        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            document.body.removeChild(overlay);
            resolve(false); // Default to No on escape
          }
        };
        document.addEventListener('keydown', onKey);
      });
    }

    async function handleMemberSaveComplete(memberName) {
      const addMore = await showAddMoreModal(memberName);

      if (!addMore) {
        // Clear all data and reset forms
        clearAllCustomerData();
      }
      // If addMore is true, just close the modal and stay on the page
    }

    function clearAllCustomerData() {
      // Reset customer data
      currentCustomerData = null;
      membersData = [];

      // Clear customer form
      document.getElementById('companyName').value = '';
      document.getElementById('emailDomain').value = '';
      document.getElementById('companyAddress').value = '';
      document.getElementById('companyTel').value = '';
      document.getElementById('companyType').selectedIndex = 0;
      document.getElementById('companyWebsite').value = '';

      // Clear file input
      const fileInput = document.getElementById('companyDocs');
      fileInput.value = '';

      // Clear members list
      document.getElementById('membersList').innerHTML = '';

      // Disable member tab again
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.add('tab-disabled');

      // Switch back to customer tab
      switchCustomerTab('customer');

      showModal({ title: 'Cleared', body: 'All customer and member data has been cleared.' });
    }

    function deleteMember(index) {
      if (confirm('Are you sure you want to delete this member?')) {
        document.querySelectorAll('.member-item')[index].remove();
        membersData.splice(index, 1);
        // Re-index remaining members
        updateMemberIndices();
      }
    }

    function updateMemberIndices() {
      const memberItems = document.querySelectorAll('.member-item');
      memberItems.forEach((item, index) => {
        const saveBtn = item.querySelector('.save-member-btn');
        const deleteBtn = item.querySelector('.delete-member-btn');
        saveBtn.setAttribute('data-index', index);
        deleteBtn.setAttribute('data-index', index);
        saveBtn.onclick = () => saveMember(index);
        deleteBtn.onclick = () => deleteMember(index);
      });
    }

    function initializeFileUpload() {
      const fileInput = document.getElementById('companyDocs');
      const dropZone = fileInput.parentElement;

      // Drag and drop functionality
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = '#e8f4f8';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = '#f9f9f9';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#f9f9f9';
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });

      // Click to browse
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
      });

      // Paste functionality
      document.addEventListener('paste', (e) => {
        if (document.activeElement.closest('#customerPanel')) {
          const items = Array.from(e.clipboardData.items);
          const files = items
            .filter(item => item.kind === 'file')
            .map(item => item.getAsFile())
            .filter(file => file);
          if (files.length > 0) {
            handleFiles(files);
          }
        }
      });
    }

    function handleFiles(files) {
      console.log('Files uploaded:', files);
      // Here you would implement actual file handling logic
      showModal({
        title: 'Files Uploaded',
        body: `${files.length} file(s) uploaded successfully. File handling will be implemented in the backend.`
      });
    }

    async function saveCustomerToStorage(customer) {
      try {
        let response;
        let result;

        if (customer.id) {
          // Try to update first
          response = await fetch(`/api/customers/${customer.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });

          // If customer not found (404), try to create instead
          if (response.status === 404) {
            console.log('Customer not found, creating new customer instead');
            response = await fetch('/api/customers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...customer, id: undefined }) // Remove ID for creation
            });
          }

          result = await response.json();
        } else {
          // Create new customer
          response = await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });
          result = await response.json();
        }

        if (!result.success) {
          throw new Error(result.error || 'Failed to save customer');
        }

        // Update customer ID if it was created
        if (result.customer && result.customer.id && !customer.id) {
          customer.id = result.customer.id;
        }

        // Refresh autocomplete if it exists
        if (window.customerAutocomplete) {
          window.customerAutocomplete.refreshCustomers();
        }

        console.log('Customer saved:', result.customer);
        return result.customer;
      } catch (error) {
        console.error('Error saving customer to database:', error);
        throw error;
      }
    }

    async function loadCustomersFromStorage() {
      try {
        const response = await fetch('/api/customers');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load customers');
        }
        return result.customers || [];
      } catch (error) {
        console.error('Error loading customers from database:', error);
        return [];
      }
    }

    async function deleteCustomerFromStorage(customerId) {
      try {
        const response = await fetch(`/api/customers/${customerId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to delete customer');
        }

        return true;
      } catch (error) {
        console.error('Error deleting customer from database:', error);
        throw error;
      }
    }

    async function displayCustomers() {
      const tbody = document.getElementById('customersTableBody');
      const customers = await loadCustomersFromStorage();

      if (customers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No customers saved yet. Create customers first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredCustomers = applyCustomerFilters(customers);

      if (filteredCustomers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No customers match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filteredCustomers.forEach((customer, custIndex) => {
        const membersCount = customer.members ? customer.members.length : 0;
        const membersTooltip = customer.members && customer.members.length > 0
          ? customer.members.map(m => `${m.name} (${m.emailPrefix}@${customer.emailDomain})`).join('\n')
          : 'No members';

        // Main customer row
        html += `
          <tr style="border:1px solid #000;" class="customer-row" data-cust-index="${custIndex}">
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(customer.companyName)}</td>
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(customer.companyType)}</td>
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(customer.emailDomain)}</td>
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(customer.companyTel || 'N/A')}</td>
            <td style="border:1px solid #000; padding:8px;">${customer.companyWebsite ? `<a href="${escapeHtml(customer.companyWebsite)}" target="_blank">${escapeHtml(customer.companyWebsite)}</a>` : 'N/A'}</td>
            <td style="border:1px solid #000; padding:8px; text-align:center;">
              <span style="cursor:pointer;" class="customer-members-cell" title="${escapeHtml(membersTooltip)}">${membersCount}</span>
            </td>
            <td style="border:1px solid #000; padding:8px; text-align:right;">
              <button class="btn" style="padding:4px 8px; font-weight:600;" data-cust-index="${custIndex}" onclick="onEditCustomerButtonClick(event)">Edit</button>
            </td>
          </tr>
        `;

        // Hidden members detail row (initially hidden) â€” include Edit button per member
        const membersHtml = (customer.members && customer.members.length > 0) ? customer.members.map((m, mi) => {
          const email = `${escapeHtml(m.emailPrefix)}@${escapeHtml(customer.emailDomain)}`;
          return `<div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #eee;">` +
                 `<div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${email}</small></div>` +
                 `<div style="width:140px;">${escapeHtml(m.title || '')}</div>` +
                 `<div style="width:120px;">${escapeHtml(m.tel || '')}</div>` +
                 `<div><button class="btn member-inline-edit-btn" data-cust-index="${custIndex}" data-member-index="${mi}" style="padding:4px 8px;">Edit</button></div>` +
                 `</div>`;
        }).join('') : '<div style="color:#666; padding:6px 0;">No members</div>';

        html += `
          <tr class="customer-members-row" style="display:none;">
            <td colspan="6" style="border:1px solid #000; padding:8px; background:#fff;">
              <div style="padding:8px 0;">${membersHtml}</div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Add hover effects to table rows
      document.querySelectorAll('.customer-row').forEach(row => {
        row.addEventListener('mouseenter', () => {
          row.style.background = '#000';
          row.style.color = '#fff';
        });
        row.addEventListener('mouseleave', () => {
          row.style.background = '';
          row.style.color = '';
        });
      });

      // Add click handlers to members count spans to toggle details
      document.querySelectorAll('.customer-members-cell').forEach((cell) => {
        cell.addEventListener('click', (e) => {
          const tr = cell.closest('tr');
          const detailsRow = tr.nextElementSibling;
          if (detailsRow && detailsRow.classList.contains('customer-members-row')) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
          }
        });
      });

      // Bind inline member edit buttons in the expanded member rows
      document.querySelectorAll('.member-inline-edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const custIndex = parseInt(btn.getAttribute('data-cust-index'), 10);
          const memberIndex = parseInt(btn.getAttribute('data-member-index'), 10);
          const customers = await loadCustomersFromStorage();
          const customer = customers[custIndex];
          if (!customer) return;
          await showMemberEditForm(customer, memberIndex);
          // refresh storage/UI
          await displayCustomers();
        });
      });

      // Edit button handlers are wired via inline onclick -> onEditCustomerButtonClick
    }

    function applyCustomerFilters(customers) {
      const filters = {
        name: document.getElementById('customerFilterName').value.toLowerCase().trim(),
        type: document.getElementById('customerFilterType').value,
        domain: document.getElementById('customerFilterDomain').value.toLowerCase().trim(),
        phone: document.getElementById('customerFilterPhone').value.toLowerCase().trim(),
        website: document.getElementById('customerFilterWebsite').value.toLowerCase().trim(),
        members: document.getElementById('customerFilterMembers').value.toLowerCase().trim()
      };

      return customers.filter(customer => {
        if (filters.name && !customer.companyName.toLowerCase().includes(filters.name)) return false;
        if (filters.type && customer.companyType !== filters.type) return false;
        if (filters.domain && !customer.emailDomain.toLowerCase().includes(filters.domain)) return false;
        if (filters.phone && !customer.companyTel?.toLowerCase().includes(filters.phone)) return false;
        if (filters.website && !customer.companyWebsite?.toLowerCase().includes(filters.website)) return false;
        if (filters.members && customer.members && customer.members.length > 0) {
          const memberNames = customer.members.map(m => m.name.toLowerCase()).join(' ');
          if (!memberNames.includes(filters.members)) return false;
        } else if (filters.members) {
          return false; // No members but filter requires members
        }
        return true;
      });
    }

    // Helper to escape HTML when rendering user-provided text
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        switch (s) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '\"': return '&quot;';
          case '\'': return '&#39;';
          case '/': return '&#47;';
          case '`': return '&#96;';
          case '=': return '&#61;';
          default: return s;
        }
      });
    }

    function addDummyMember() {
      if (!currentCustomerData) {
        showModal({ title: 'Error', body: 'Please complete customer information first.' });
        return;
      }

      // Add a new member first
      addNewMember();

      // Get the newly added member
      const memberItems = document.querySelectorAll('.member-item');
      const newMember = memberItems[memberItems.length - 1];

      // Fill with dummy data
      const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'David', 'Lisa', 'Robert', 'Emily', 'James', 'Maria'];
      const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
      const titles = ['Manager', 'Director', 'Supervisor', 'Coordinator', 'Specialist', 'Assistant', 'Officer', 'Executive', 'Analyst', 'Administrator'];

      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const fullName = `${firstName} ${lastName}`;

      // Generate username from first initial + last name
      const username = `${firstName.charAt(0).toLowerCase()}${lastName.toLowerCase()}`;

      const randomTitle = titles[Math.floor(Math.random() * titles.length)];

      // Fill the form
      newMember.querySelector('.member-name').value = fullName;
      newMember.querySelector('.member-email-prefix').value = username;
      newMember.querySelector('.member-title').value = randomTitle;

      // Random phone number
      const areaCode = Math.floor(Math.random() * 900) + 100;
      const exchange = Math.floor(Math.random() * 900) + 100;
      const number = Math.floor(Math.random() * 9000) + 1000;
      const phoneNumber = `(${areaCode}) ${exchange}-${number}`;

      newMember.querySelector('.member-tel').value = phoneNumber;

      showModal({
        title: 'Dummy Member Added',
        body: `Member "${fullName}" with email "${username}@${currentCustomerData.emailDomain}" has been added with dummy data.`
      });
    }

    // Choice modal: simple HTML content with option buttons
    function showChoiceModal(title, htmlBody, options = []) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = title;
        const content = document.createElement('div');
        content.className = 'modal-body';
        content.innerHTML = htmlBody;
        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = opt.label;
          btn.onclick = () => {
            try { document.body.removeChild(overlay); } catch {}
            resolve(opt.value);
          };
          actions.appendChild(btn);
        });

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = () => {
          try { document.body.removeChild(overlay); } catch {}
          resolve(null);
        };
        actions.appendChild(cancelBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    // Inline onclick handler for Edit button in customer table
    window.onEditCustomerButtonClick = async function (event) {
      const btn = event.currentTarget;
      const custIndex = parseInt(btn.getAttribute('data-cust-index'), 10);
      const customers = await loadCustomersFromStorage();
      const customer = customers[custIndex];
      if (!customer) return;

      const choice = await showChoiceModal('Edit', '<div style=\"margin-bottom:10px;\">Choose what to edit:</div>', [
        { label: 'Edit Company', value: 'company' },
        { label: 'Edit Members', value: 'members' }
      ]);

      if (choice === 'company') {
        await showCustomerEditForm(custIndex);
        await displayCustomers();
      } else if (choice === 'members') {
        await showMembersListModal(custIndex);
        await displayCustomers();
      }
    };

    // Modal form to edit company details
    async function showCustomerEditForm(custIndex) {
      const customers = await loadCustomersFromStorage();
      const customer = customers[custIndex];
      if (!customer) return;

      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Company';
        const content = document.createElement('div');
        content.className = 'modal-body';

        content.innerHTML = `
          <div style="display:grid; gap:8px;">
            <label style="font-weight:700;">Company Name</label>
            <input id="editCompanyName" type="text" value="${escapeHtml(customer.companyName || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Company Type</label>
            <input id="editCompanyType" type="text" value="${escapeHtml(customer.companyType || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Email Domain</label>
            <input id="editEmailDomain" type="text" value="${escapeHtml(customer.emailDomain || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Telephone</label>
            <input id="editCompanyTel" type="text" value="${escapeHtml(customer.companyTel || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Website</label>
            <input id="editCompanyWebsite" type="text" value="${escapeHtml(customer.companyWebsite || '')}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = 'Save';

        cancelBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        okBtn.onclick = async () => {
          customer.companyName = document.getElementById('editCompanyName').value.trim();
          customer.companyType = document.getElementById('editCompanyType').value.trim();
          customer.emailDomain = document.getElementById('editEmailDomain').value.trim();
          customer.companyTel = document.getElementById('editCompanyTel').value.trim();
          customer.companyWebsite = document.getElementById('editCompanyWebsite').value.trim();
          try {
            await saveCustomerToStorage(customer);
            try { document.body.removeChild(overlay); } catch {}
            resolve(true);
          } catch (err) {
            showModal({ title: 'Error', body: 'Failed to save company: ' + (err.message || err) });
          }
        };

        actions.appendChild(cancelBtn);
        actions.appendChild(okBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    // Modal to list members and allow editing individual member
    async function showMembersListModal(custIndex) {
      const customers = await loadCustomersFromStorage();
      const customer = customers[custIndex];
      if (!customer) return;

      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Members';
        const content = document.createElement('div');
        content.className = 'modal-body';

        const listHtml = (customer.members && customer.members.length > 0) ? customer.members.map((m, idx) => {
          return `<div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
                    <div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${escapeHtml(m.emailPrefix)}@${escapeHtml(customer.emailDomain)}</small></div>
                    <div><button class="btn edit-member-btn" data-member-index="${idx}">Edit</button></div>
                  </div>`;
        }).join('') : '<div style="color:#666;">No members</div>';

        content.innerHTML = `<div>${listHtml}</div>`;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn';
        closeBtn.textContent = 'Close';
        closeBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        actions.appendChild(closeBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // attach handlers to edit buttons
        content.querySelectorAll('.edit-member-btn').forEach(btn => {
          btn.onclick = async (e) => {
            const memberIndex = parseInt(btn.getAttribute('data-member-index'), 10);
            await showMemberEditForm(customer, memberIndex);
            // refresh list UI
            const updatedCustomers = await loadCustomersFromStorage();
            const updatedCustomer = updatedCustomers[custIndex];
            customer.members = updatedCustomer.members || [];
            content.querySelector('div').innerHTML = (customer.members.length > 0) ? customer.members.map((m, idx) => {
              return `<div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
                        <div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${escapeHtml(m.emailPrefix)}@${escapeHtml(customer.emailDomain)}</small></div>
                        <div><button class="btn edit-member-btn" data-member-index="${idx}">Edit</button></div>
                      </div>`;
            }).join('') : '<div style="color:#666;">No members</div>';

            // re-bind new buttons
            content.querySelectorAll('.edit-member-btn').forEach(btn2 => {
              btn2.onclick = async () => {
                const mi = parseInt(btn2.getAttribute('data-member-index'), 10);
                await showMemberEditForm(customer, mi);
                await saveCustomerToStorage(customer);
              };
            });
          };
        });
      });
    }

    // Modal to edit a single member object (in-place)
    function showMemberEditForm(customer, memberIndex) {
      return new Promise((resolve) => {
        const member = customer.members[memberIndex];
        if (!member) return resolve(false);
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Member';
        const content = document.createElement('div');
        content.className = 'modal-body';

        content.innerHTML = `
          <div style="display:grid; gap:8px;">
            <label style="font-weight:700;">Full Name</label>
            <input id="editMemberName" type="text" value="${escapeHtml(member.name || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Email Prefix</label>
            <input id="editMemberEmail" type="text" value="${escapeHtml(member.emailPrefix || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Title</label>
            <input id="editMemberTitle" type="text" value="${escapeHtml(member.title || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Telephone</label>
            <input id="editMemberTel" type="text" value="${escapeHtml(member.tel || '')}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn primary';
        saveBtn.textContent = 'Save';

        cancelBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        saveBtn.onclick = async () => {
          member.name = document.getElementById('editMemberName').value.trim();
          member.emailPrefix = document.getElementById('editMemberEmail').value.trim();
          member.title = document.getElementById('editMemberTitle').value.trim();
          member.tel = document.getElementById('editMemberTel').value.trim();
          try {
            await saveCustomerToStorage(customer);
            try { document.body.removeChild(overlay); } catch {}
            resolve(true);
          } catch (err) {
            showModal({ title: 'Error', body: 'Failed to save member: ' + (err.message || err) });
          }
        };

        actions.appendChild(cancelBtn);
        actions.appendChild(saveBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    function fillDummyData() {
      // Company names
      const companyNames = [
        'ABC Corporation', 'Global Industries Ltd', 'Tech Solutions Inc',
        'Manufacturing Co', 'Trading Company LLC', 'International Group',
        'Premier Enterprises', 'Quality Products Corp', 'Advanced Systems Ltd'
      ];

      // Email domains
      const domains = [
        'company.com', 'corp.net', 'industries.org', 'solutions.biz',
        'group.info', 'enterprises.co', 'products.com', 'systems.net'
      ];

      // Cities for addresses
      const cities = [
        'New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX',
        'Phoenix, AZ', 'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA',
        'Dallas, TX', 'San Jose, CA', 'Austin, TX', 'Jacksonville, FL'
      ];

      // Phone numbers
      const generatePhone = () => {
        const areaCode = Math.floor(Math.random() * 900) + 100;
        const exchange = Math.floor(Math.random() * 900) + 100;
        const number = Math.floor(Math.random() * 9000) + 1000;
        return `(${areaCode}) ${exchange}-${number}`;
      };

      // Websites
      const websites = [
        'www.companywebsite.com', 'corporate.site.net', 'business.online.org',
        'enterprise.web.biz', 'firm.digital.info', 'corp.portal.co'
      ];

      // Fill form with random data
      document.getElementById('companyName').value =
        companyNames[Math.floor(Math.random() * companyNames.length)];

      document.getElementById('emailDomain').value =
        domains[Math.floor(Math.random() * domains.length)];

      document.getElementById('companyAddress').value =
        `${Math.floor(Math.random() * 999) + 1} Business St, ${cities[Math.floor(Math.random() * cities.length)]}`;

      document.getElementById('companyTel').value = generatePhone();

      // Random type selection
      const typeSelect = document.getElementById('companyType');
      const randomType = Math.random() < 0.5 ? 'buyer' : 'agent';
      typeSelect.value = randomType;

      document.getElementById('companyWebsite').value =
        websites[Math.floor(Math.random() * websites.length)];

      showModal({
        title: 'Dummy Data Filled',
        body: 'Form has been populated with random test data. You can now save or modify as needed.'
      });
    }

    async function initializeCustomerViewPanel() {
      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshCustomersBtn');
      refreshBtn.onclick = async () => await displayCustomers();

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#customerViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displayCustomers());
        input.addEventListener('change', async () => await displayCustomers());
      });

      // Load customers on initialization
      await displayCustomers();
    }

    // Helper function to get file icon from path (global scope for use in view modal)
    function getFileIconFromPath(filePath) {
      const fileName = filePath.toLowerCase();
      if (fileName.includes('.pdf')) return 'ðŸ“„';
      if (fileName.includes('.doc') || fileName.includes('.docx')) return 'ðŸ“';
      if (fileName.includes('.txt')) return 'ðŸ“„';
      if (fileName.includes('.jpg') || fileName.includes('.jpeg') || fileName.includes('.png') || fileName.includes('.gif')) return 'ðŸ–¼ï¸';
      return 'ðŸ“„';
    }

    // Supplier Panel Functions
    function initializeSupplierPanel() {
      // Reset supplier data and disable member tab
      currentSupplierData = null;
      supplierMembersData = [];

      // Disable member tab initially
      const memberTab = document.querySelector('[data-tab="supplier-member-info"]');
      memberTab.classList.add('tab-disabled');

      // Tab switching
      const supplierTab = document.querySelector('[data-tab="supplier-info"]');

      supplierTab.onclick = () => switchSupplierTab('supplier');
      memberTab.onclick = () => switchSupplierTab('member');

      // Start with supplier tab active
      switchSupplierTab('supplier');

      // Form elements
      const dummyInputBtn = document.getElementById('supplierDummyInputBtn');
      const saveSupplierBtn = document.getElementById('saveSupplierBtn');
      const addMemberBtn = document.getElementById('addSupplierMemberBtn');
      const dummyMemberBtn = document.getElementById('dummySupplierMemberBtn');

      // Dummy input functionality
      dummyInputBtn.onclick = () => fillSupplierDummyData();

      // Save supplier and continue to members
      saveSupplierBtn.onclick = () => saveSupplierInfo();

      // Add member functionality
      addMemberBtn.onclick = () => addNewSupplierMember();

      // Dummy member functionality
      dummyMemberBtn.onclick = () => addDummySupplierMember();

      // File upload functionality
      initializeSupplierFileUpload();
    }

    function switchSupplierTab(tab) {
      const supplierTab = document.querySelector('[data-tab="supplier-info"]');
      const memberTab = document.querySelector('[data-tab="supplier-member-info"]');

      // Prevent switching to member tab if it's disabled
      if (tab === 'member' && memberTab.classList.contains('tab-disabled')) {
        return; // Do nothing if member tab is disabled
      }

      const supplierInfoTab = document.getElementById('supplierInfoTab');
      const memberInfoTab = document.getElementById('supplierMemberInfoTab');

      if (tab === 'supplier') {
        supplierTab.classList.add('tab-active');
        memberTab.classList.remove('tab-active');
        supplierInfoTab.style.display = 'block';
        memberInfoTab.style.display = 'none';
      } else {
        supplierTab.classList.remove('tab-active');
        memberTab.classList.add('tab-active');
        supplierInfoTab.style.display = 'none';
        memberInfoTab.style.display = 'block';
      }
    }

    function fillSupplierDummyData() {
      document.getElementById('supplierCompanyName').value = 'SUPPLIER-ABC Manufacturing Co.';
      document.getElementById('supplierEmailDomain').value = 'abcmfg.com';
      document.getElementById('supplierCompanyAddress').value = '123 Industrial Park, Shenzhen, China';
      document.getElementById('supplierCompanyTel').value = '+86-755-12345678';
      document.getElementById('supplierCompanyType').value = 'hang_tag';
      document.getElementById('supplierCompanyWebsite').value = 'https://www.abcmfg.com';
    }

    async function saveSupplierInfo() {
      const companyName = document.getElementById('supplierCompanyName').value.trim();
      const emailDomain = document.getElementById('supplierEmailDomain').value.trim();
      const companyAddress = document.getElementById('supplierCompanyAddress').value.trim();
      const companyTel = document.getElementById('supplierCompanyTel').value.trim();
      const companyType = document.getElementById('supplierCompanyType').value;
      const companyWebsite = document.getElementById('supplierCompanyWebsite').value.trim();

      // Validation
      if (!companyName) {
        showModal({ title: 'Validation Error', body: 'Company Name is required.' });
        return;
      }
      if (!emailDomain) {
        showModal({ title: 'Validation Error', body: 'Email Domain is required.' });
        return;
      }
      if (!companyType) {
        showModal({ title: 'Validation Error', body: 'Type is required.' });
        return;
      }

      // Validate email domain format
      const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/;
      if (!domainRegex.test(emailDomain)) {
        showModal({ title: 'Validation Error', body: 'Please enter a valid email domain (e.g., example.com).' });
        return;
      }

      // Save supplier data
      currentSupplierData = {
        id: Date.now(), // Simple ID based on timestamp
        companyName,
        emailDomain,
        companyAddress,
        companyTel,
        companyType,
        companyWebsite,
        members: [] // Will be populated when members are saved
      };

      // Enable member tab
      const memberTab = document.querySelector('[data-tab="supplier-member-info"]');
      memberTab.classList.remove('tab-disabled');

      // Switch to member tab
      switchSupplierTab('member');

      showModal({ title: 'Success', body: 'Supplier information saved. Member tab is now enabled.' });
    }

    function addNewSupplierMember() {
      if (!currentSupplierData) {
        showModal({ title: 'Error', body: 'Please complete supplier information first.' });
        return;
      }

      const memberIndex = supplierMembersData.length;
      const memberHtml = `
        <div class="supplier-member-item" style="border:1px solid #000; padding:15px; margin-bottom:10px; background:#f9f9f9;">
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Name *</label>
              <input type="text" class="supplier-member-name" placeholder="Full Name" required>
            </div>
            <div style="flex:1;">
              <label>Email *</label>
              <div style="display:flex;">
                <input type="text" class="supplier-member-email-prefix" placeholder="username" required style="flex:1;">
                <span style="padding:8px; background:#eee; border:1px solid #000;">@${currentSupplierData.emailDomain}</span>
              </div>
            </div>
          </div>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Title</label>
              <input type="text" class="supplier-member-title" placeholder="Job Title">
            </div>
            <div style="flex:1;">
              <label>Telephone</label>
              <input type="tel" class="supplier-member-tel" placeholder="Phone Number">
            </div>
          </div>
          <div class="row">
            <button class="page-btn save-supplier-member-btn" data-index="${memberIndex}">Save Member</button>
            <button class="page-btn delete-supplier-member-btn" data-index="${memberIndex}" style="margin-left:10px;">Delete</button>
          </div>
        </div>
      `;

      document.getElementById('supplierMembersList').insertAdjacentHTML('beforeend', memberHtml);

      // Add event listeners to the new member
      const memberDiv = document.getElementById('supplierMembersList').lastElementChild;
      const saveBtn = memberDiv.querySelector('.save-supplier-member-btn');
      const deleteBtn = memberDiv.querySelector('.delete-supplier-member-btn');

      saveBtn.onclick = () => saveSupplierMember(memberIndex);
      deleteBtn.onclick = () => deleteSupplierMember(memberIndex);

      // Initialize with empty data
      supplierMembersData.push({
        name: '',
        emailPrefix: '',
        title: '',
        tel: ''
      });
    }

    function addDummySupplierMember() {
      addNewSupplierMember();
      const memberDiv = document.getElementById('supplierMembersList').lastElementChild;
      memberDiv.querySelector('.supplier-member-name').value = 'SUPPLIER-John Smith';
      memberDiv.querySelector('.supplier-member-email-prefix').value = 'john.smith';
      memberDiv.querySelector('.supplier-member-title').value = 'Sales Manager';
      memberDiv.querySelector('.supplier-member-tel').value = '+86-755-87654321';
    }

    async function saveSupplierMember(index) {
      const memberDiv = document.querySelectorAll('.supplier-member-item')[index];
      const name = memberDiv.querySelector('.supplier-member-name').value.trim();
      const emailPrefix = memberDiv.querySelector('.supplier-member-email-prefix').value.trim();
      const title = memberDiv.querySelector('.supplier-member-title').value.trim();
      const tel = memberDiv.querySelector('.supplier-member-tel').value.trim();

      if (!name) {
        showModal({ title: 'Validation Error', body: 'Member name is required.' });
        return;
      }
      if (!emailPrefix) {
        showModal({ title: 'Validation Error', body: 'Member email prefix is required.' });
        return;
      }

      supplierMembersData[index] = {
        name,
        emailPrefix,
        title,
        tel
      };

      // Update current supplier with members
      if (currentSupplierData) {
        currentSupplierData.members = [...supplierMembersData];
        // Save to database (this will create or update the supplier)
        await saveSupplierToStorage(currentSupplierData);
      }

      // Handle save completion with add more prompt
      handleSupplierMemberSaveComplete(name);
    }

    async function handleSupplierMemberSaveComplete(memberName) {
      const addMore = await showSupplierAddMoreModal(memberName);

      if (!addMore) {
        // Clear all data and reset forms
        clearAllSupplierData();
      }
      // If addMore is true, just close the modal and stay on the page
    }

    function showSupplierAddMoreModal(memberName) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Save Complete';

        const content = document.createElement('div');
        content.className = 'modal-body';
        content.innerHTML = `
          Member "${memberName}" saved successfully.<br><br>
          <strong>Do you want to add more members?</strong>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const yesBtn = document.createElement('button');
        yesBtn.className = 'btn primary';
        yesBtn.textContent = 'Yes, Add More';
        yesBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(true);
        };

        const noBtn = document.createElement('button');
        noBtn.className = 'btn';
        noBtn.textContent = 'No, Finish';
        noBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(false);
        };

        actions.appendChild(noBtn);
        actions.appendChild(yesBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Handle Escape key
        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            document.body.removeChild(overlay);
            resolve(false); // Default to No on escape
          }
        };
        document.addEventListener('keydown', onKey);
      });
    }

    function clearAllSupplierData() {
      // Reset supplier data
      currentSupplierData = null;
      supplierMembersData = [];

      // Clear supplier form
      document.getElementById('supplierCompanyName').value = '';
      document.getElementById('supplierEmailDomain').value = '';
      document.getElementById('supplierCompanyAddress').value = '';
      document.getElementById('supplierCompanyTel').value = '';
      document.getElementById('supplierCompanyType').selectedIndex = 0;
      document.getElementById('supplierCompanyWebsite').value = '';

      // Clear file input
      const fileInput = document.getElementById('supplierCompanyDocs');
      fileInput.value = '';

      // Clear members list
      document.getElementById('supplierMembersList').innerHTML = '';

      // Disable member tab again
      const memberTab = document.querySelector('[data-tab="supplier-member-info"]');
      memberTab.classList.add('tab-disabled');

      // Switch back to supplier tab
      switchSupplierTab('supplier');

      showModal({ title: 'Cleared', body: 'All supplier and member data has been cleared.' });
    }

    function deleteSupplierMember(index) {
      if (confirm('Are you sure you want to delete this member?')) {
        document.querySelectorAll('.supplier-member-item')[index].remove();
        supplierMembersData.splice(index, 1);
        // Re-index remaining members
        updateSupplierMemberIndices();
      }
    }

    function updateSupplierMemberIndices() {
      const memberItems = document.querySelectorAll('.supplier-member-item');
      memberItems.forEach((item, index) => {
        const saveBtn = item.querySelector('.save-supplier-member-btn');
        const deleteBtn = item.querySelector('.delete-supplier-member-btn');
        saveBtn.setAttribute('data-index', index);
        deleteBtn.setAttribute('data-index', index);
        saveBtn.onclick = () => saveSupplierMember(index);
        deleteBtn.onclick = () => deleteSupplierMember(index);
      });
    }

    function initializeSupplierFileUpload() {
      const fileInput = document.getElementById('supplierCompanyDocs');
      const dropZone = fileInput.parentElement;

      // Drag and drop functionality
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = '#e8f4f8';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = '#f9f9f9';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#f9f9f9';
        const files = Array.from(e.dataTransfer.files);
        handleSupplierFiles(files);
      });

      // Click to browse
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleSupplierFiles(files);
      });

      // Paste functionality
      document.addEventListener('paste', (e) => {
        if (document.activeElement.closest('#supplierPanel')) {
          const items = Array.from(e.clipboardData.items);
          const files = items
            .filter(item => item.kind === 'file')
            .map(item => item.getAsFile())
            .filter(file => file);
          if (files.length > 0) {
            handleSupplierFiles(files);
          }
        }
      });
    }

    function handleSupplierFiles(files) {
      console.log('Supplier files uploaded:', files);
      showModal({
        title: 'Files Uploaded',
        body: `${files.length} file(s) uploaded successfully. File handling will be implemented in the backend.`
      });
    }

    async function saveSupplierToStorage(supplier) {
      try {
        let response;
        let result;

        // Check if supplier has a real database ID (not a temporary timestamp ID)
        // Database IDs are typically small integers, timestamp IDs are large numbers (> 1000000000000)
        const hasRealDbId = supplier.dbId && typeof supplier.dbId === 'number';

        if (hasRealDbId) {
          // Update existing supplier
          response = await fetch(`/api/suppliers/${supplier.dbId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...supplier, id: supplier.dbId })
          });

          // If supplier not found (404), try to create instead
          if (response.status === 404) {
            console.log('Supplier not found, creating new supplier instead');
            response = await fetch('/api/suppliers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...supplier, id: undefined, dbId: undefined })
            });
          }

          result = await response.json();
        } else {
          // Create new supplier
          response = await fetch('/api/suppliers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...supplier, id: undefined })
          });
          result = await response.json();
        }

        if (!result.success) {
          throw new Error(result.error || 'Failed to save supplier');
        }

        // Update supplier with real database ID
        if (result.supplier && result.supplier.id) {
          supplier.dbId = result.supplier.id;
          currentSupplierData.dbId = result.supplier.id;
        }

        console.log('Supplier saved:', result.supplier);
        return result.supplier;
      } catch (error) {
        console.error('Error saving supplier to database:', error);
        throw error;
      }
    }

    async function loadSuppliersFromStorage() {
      try {
        const response = await fetch('/api/suppliers');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load suppliers');
        }
        return result.suppliers || [];
      } catch (error) {
        console.error('Error loading suppliers from database:', error);
        return [];
      }
    }

    async function deleteSupplierFromStorage(supplierId) {
      try {
        const response = await fetch(`/api/suppliers/${supplierId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to delete supplier');
        }

        return true;
      } catch (error) {
        console.error('Error deleting supplier from database:', error);
        throw error;
      }
    }

    async function initializeSupplierViewPanel() {
      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshSuppliersBtn');
      refreshBtn.onclick = async () => await displaySuppliers();

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#supplierViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displaySuppliers());
        input.addEventListener('change', async () => await displaySuppliers());
      });

      // Load suppliers on initialization
      await displaySuppliers();
    }

    // Helper function to get supplier type display name
    function getSupplierTypeDisplayName(type) {
      const typeMap = {
        'hang_tag': 'Hang Tag',
        'woven_label': 'Woven Label',
        'care_label': 'Care Label',
        'transfer': 'Transfer',
        'other': 'Other'
      };
      return typeMap[type] || type || 'N/A';
    }

    async function displaySuppliers() {
      const tbody = document.getElementById('suppliersTableBody');
      const suppliers = await loadSuppliersFromStorage();

      if (suppliers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No suppliers saved yet. Create suppliers first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredSuppliers = applySupplierFilters(suppliers);

      if (filteredSuppliers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No suppliers match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filteredSuppliers.forEach((supplier, suppIndex) => {
        const membersCount = supplier.members ? supplier.members.length : 0;
        const membersTooltip = supplier.members && supplier.members.length > 0
          ? supplier.members.map(m => `${m.name} (${m.emailPrefix}@${supplier.emailDomain})`).join('\n')
          : 'No members';

        // Main supplier row
        html += `
          <tr style="border:1px solid #000;" class="supplier-row" data-supp-index="${suppIndex}">
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(supplier.companyName)}</td>
            <td style="border:1px solid #000; padding:8px;">${getSupplierTypeDisplayName(supplier.companyType)}</td>
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(supplier.emailDomain)}</td>
            <td style="border:1px solid #000; padding:8px;">${escapeHtml(supplier.companyTel || 'N/A')}</td>
            <td style="border:1px solid #000; padding:8px;">${supplier.companyWebsite ? `<a href="${escapeHtml(supplier.companyWebsite)}" target="_blank">${escapeHtml(supplier.companyWebsite)}</a>` : 'N/A'}</td>
            <td style="border:1px solid #000; padding:8px; text-align:center;">
              <span style="cursor:pointer;" class="supplier-members-cell" title="${escapeHtml(membersTooltip)}">${membersCount}</span>
            </td>
            <td style="border:1px solid #000; padding:8px; text-align:right;">
              <button class="btn" style="padding:4px 8px; font-weight:600;" data-supp-index="${suppIndex}" onclick="onEditSupplierButtonClick(event)">Edit</button>
            </td>
          </tr>
        `;

        // Hidden members detail row (initially hidden) â€” include Edit button per member
        const membersHtml = (supplier.members && supplier.members.length > 0) ? supplier.members.map((m, mi) => {
          const email = `${escapeHtml(m.emailPrefix)}@${escapeHtml(supplier.emailDomain)}`;
          return `<div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #eee;">` +
                 `<div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${email}</small></div>` +
                 `<div style="width:140px;">${escapeHtml(m.title || '')}</div>` +
                 `<div style="width:120px;">${escapeHtml(m.tel || '')}</div>` +
                 `<div><button class="btn supplier-member-inline-edit-btn" data-supp-index="${suppIndex}" data-member-index="${mi}" style="padding:4px 8px;">Edit</button></div>` +
                 `</div>`;
        }).join('') : '<div style="color:#666; padding:6px 0;">No members</div>';

        html += `
          <tr class="supplier-members-row" style="display:none;">
            <td colspan="7" style="border:1px solid #000; padding:8px; background:#fff;">
              <div style="padding:8px 0;">${membersHtml}</div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Add hover effects to table rows
      document.querySelectorAll('.supplier-row').forEach(row => {
        row.addEventListener('mouseenter', () => {
          row.style.background = '#f5f5f5';
        });
        row.addEventListener('mouseleave', () => {
          row.style.background = '';
        });
      });

      // Add click to expand members
      document.querySelectorAll('.supplier-members-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const membersRow = row.nextElementSibling;
          if (membersRow && membersRow.classList.contains('supplier-members-row')) {
            membersRow.style.display = membersRow.style.display === 'none' ? 'table-row' : 'none';
          }
        });
      });

      // Bind inline supplier member edit buttons in the expanded member rows
      document.querySelectorAll('.supplier-member-inline-edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();

          // Show immediate feedback
          const originalText = btn.textContent;
          btn.disabled = true;
          btn.textContent = 'Loading...';

          const suppIndex = parseInt(btn.getAttribute('data-supp-index'), 10);
          const memberIndex = parseInt(btn.getAttribute('data-member-index'), 10);
          const suppliers = await loadSuppliersFromStorage();
          const supplier = suppliers[suppIndex];

          if (!supplier) {
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          await showSupplierMemberEditForm(supplier, memberIndex);

          // Reset button state
          btn.disabled = false;
          btn.textContent = originalText;

          // Refresh storage/UI
          await displaySuppliers();
        });
      });
    }

    function applySupplierFilters(suppliers) {
      const filters = {
        name: document.getElementById('supplierFilterName').value.toLowerCase().trim(),
        type: document.getElementById('supplierFilterType').value,
        domain: document.getElementById('supplierFilterDomain').value.toLowerCase().trim(),
        phone: document.getElementById('supplierFilterPhone').value.toLowerCase().trim(),
        website: document.getElementById('supplierFilterWebsite').value.toLowerCase().trim(),
        members: document.getElementById('supplierFilterMembers').value.toLowerCase().trim()
      };

      return suppliers.filter(supplier => {
        if (filters.name && !supplier.companyName.toLowerCase().includes(filters.name)) return false;
        if (filters.type && supplier.companyType !== filters.type) return false;
        if (filters.domain && !supplier.emailDomain.toLowerCase().includes(filters.domain)) return false;
        if (filters.phone && !(supplier.companyTel || '').toLowerCase().includes(filters.phone)) return false;
        if (filters.website && !(supplier.companyWebsite || '').toLowerCase().includes(filters.website)) return false;
        if (filters.members) {
          const membersStr = (supplier.members || []).map(m => m.name).join(' ').toLowerCase();
          if (!membersStr.includes(filters.members)) return false;
        }
        return true;
      });
    }

    // Edit supplier button click handler
    window.onEditSupplierButtonClick = async function (event) {
      event.stopPropagation();
      const btn = event.currentTarget;
      const suppIndex = parseInt(btn.getAttribute('data-supp-index'), 10);
      const suppliers = await loadSuppliersFromStorage();
      const supplier = suppliers[suppIndex];
      if (!supplier) return;

      const choice = await showChoiceModal('Edit', '<div style=\"margin-bottom:10px;\">Choose what to edit:</div>', [
        { label: 'Edit Company', value: 'company' },
        { label: 'Edit Members', value: 'members' }
      ]);

      if (choice === 'company') {
        await showSupplierEditForm(suppIndex);
        await displaySuppliers();
      } else if (choice === 'members') {
        await showSupplierMembersListModal(suppIndex);
        await displaySuppliers();
      }
    };

    // Modal form to edit supplier company details
    async function showSupplierEditForm(suppIndex) {
      const suppliers = await loadSuppliersFromStorage();
      const supplier = suppliers[suppIndex];
      if (!supplier) return;

      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Supplier Company';
        const content = document.createElement('div');
        content.className = 'modal-body';

        content.innerHTML = `
          <div style="display:grid; gap:8px;">
            <label style="font-weight:700;">Company Name</label>
            <input id="editSupplierCompanyName" type="text" value="${escapeHtml(supplier.companyName || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Company Type</label>
            <select id="editSupplierCompanyType" style="width:100%; padding:8px; border:1px solid #000;">
              <option value="hang_tag" ${supplier.companyType === 'hang_tag' ? 'selected' : ''}>Hang Tag</option>
              <option value="woven_label" ${supplier.companyType === 'woven_label' ? 'selected' : ''}>Woven Label</option>
              <option value="care_label" ${supplier.companyType === 'care_label' ? 'selected' : ''}>Care Label</option>
              <option value="transfer" ${supplier.companyType === 'transfer' ? 'selected' : ''}>Transfer</option>
              <option value="other" ${supplier.companyType === 'other' ? 'selected' : ''}>Other</option>
            </select>
            <label style="font-weight:700;">Email Domain</label>
            <input id="editSupplierEmailDomain" type="text" value="${escapeHtml(supplier.emailDomain || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Telephone</label>
            <input id="editSupplierCompanyTel" type="text" value="${escapeHtml(supplier.companyTel || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Website</label>
            <input id="editSupplierCompanyWebsite" type="text" value="${escapeHtml(supplier.companyWebsite || '')}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = 'Save';

        cancelBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        okBtn.onclick = async () => {
          supplier.companyName = document.getElementById('editSupplierCompanyName').value.trim();
          supplier.companyType = document.getElementById('editSupplierCompanyType').value;
          supplier.emailDomain = document.getElementById('editSupplierEmailDomain').value.trim();
          supplier.companyTel = document.getElementById('editSupplierCompanyTel').value.trim();
          supplier.companyWebsite = document.getElementById('editSupplierCompanyWebsite').value.trim();
          try {
            await fetch(`/api/suppliers/${supplier.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(supplier)
            });
            try { document.body.removeChild(overlay); } catch {}
            resolve(true);
          } catch (err) {
            showModal({ title: 'Error', body: 'Failed to save supplier: ' + (err.message || err) });
          }
        };

        actions.appendChild(cancelBtn);
        actions.appendChild(okBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    // Modal to list supplier members and allow editing individual member
    async function showSupplierMembersListModal(suppIndex) {
      const suppliers = await loadSuppliersFromStorage();
      const supplier = suppliers[suppIndex];
      if (!supplier) return;

      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Supplier Members';
        const content = document.createElement('div');
        content.className = 'modal-body';

        const listHtml = (supplier.members && supplier.members.length > 0) ? supplier.members.map((m, idx) => {
          return `<div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
                    <div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${escapeHtml(m.emailPrefix)}@${escapeHtml(supplier.emailDomain)}</small></div>
                    <div><button class="btn edit-supplier-member-btn" data-member-index="${idx}">Edit</button></div>
                  </div>`;
        }).join('') : '<div style="color:#666;">No members</div>';

        content.innerHTML = `<div>${listHtml}</div>`;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn';
        closeBtn.textContent = 'Close';
        closeBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        actions.appendChild(closeBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // attach handlers to edit buttons
        content.querySelectorAll('.edit-supplier-member-btn').forEach(btn => {
          btn.onclick = async (e) => {
            const memberIndex = parseInt(btn.getAttribute('data-member-index'), 10);
            await showSupplierMemberEditForm(supplier, memberIndex);
            // refresh list UI
            const updatedSuppliers = await loadSuppliersFromStorage();
            const updatedSupplier = updatedSuppliers[suppIndex];
            supplier.members = updatedSupplier.members || [];
            content.querySelector('div').innerHTML = (supplier.members.length > 0) ? supplier.members.map((m, idx) => {
              return `<div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
                        <div style="flex:1;"><strong>${escapeHtml(m.name)}</strong><br><small>${escapeHtml(m.emailPrefix)}@${escapeHtml(supplier.emailDomain)}</small></div>
                        <div><button class="btn edit-supplier-member-btn" data-member-index="${idx}">Edit</button></div>
                      </div>`;
            }).join('') : '<div style="color:#666;">No members</div>';

            // re-bind new buttons
            content.querySelectorAll('.edit-supplier-member-btn').forEach(btn2 => {
              btn2.onclick = async () => {
                const mi = parseInt(btn2.getAttribute('data-member-index'), 10);
                await showSupplierMemberEditForm(supplier, mi);
              };
            });
          };
        });
      });
    }

    // Modal to edit a single supplier member object (in-place)
    function showSupplierMemberEditForm(supplier, memberIndex) {
      return new Promise((resolve) => {
        const member = supplier.members[memberIndex];
        if (!member) return resolve(false);
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Edit Supplier Member';
        const content = document.createElement('div');
        content.className = 'modal-body';

        content.innerHTML = `
          <div style="display:grid; gap:8px;">
            <label style="font-weight:700;">Full Name</label>
            <input id="editSupplierMemberName" type="text" value="${escapeHtml(member.name || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Email Prefix</label>
            <input id="editSupplierMemberEmail" type="text" value="${escapeHtml(member.emailPrefix || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Title</label>
            <input id="editSupplierMemberTitle" type="text" value="${escapeHtml(member.title || '')}" style="width:100%; padding:8px; border:1px solid #000;">
            <label style="font-weight:700;">Telephone</label>
            <input id="editSupplierMemberTel" type="text" value="${escapeHtml(member.tel || '')}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn primary';
        saveBtn.textContent = 'Save';

        cancelBtn.onclick = () => { try { document.body.removeChild(overlay); } catch {} resolve(false); };
        saveBtn.onclick = async () => {
          // Show loading state
          saveBtn.disabled = true;
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saving...';

          member.name = document.getElementById('editSupplierMemberName').value.trim();
          member.emailPrefix = document.getElementById('editSupplierMemberEmail').value.trim();
          member.title = document.getElementById('editSupplierMemberTitle').value.trim();
          member.tel = document.getElementById('editSupplierMemberTel').value.trim();
          try {
            await fetch(`/api/suppliers/${supplier.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(supplier)
            });

            // Show success feedback
            saveBtn.textContent = 'âœ“ Saved';
            setTimeout(() => {
              try { document.body.removeChild(overlay); } catch {}
              resolve(true);
            }, 500);
          } catch (err) {
            // Reset button state on error
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
            showModal({ title: 'Error', body: 'Failed to save member: ' + (err.message || err) });
          }
        };

        actions.appendChild(cancelBtn);
        actions.appendChild(saveBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    async function initializeQuotationViewPanel() {
      console.log('initializeQuotationViewPanel called');
      // Load quotations immediately when panel is initialized
      await displayQuotations();

      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshQuotationsBtn');
      if (refreshBtn) {
        refreshBtn.onclick = async () => await displayQuotations();
      }

      // Select All button functionality
      const selectAllBtn = document.getElementById('selectAllQuotationsBtn');
      if (selectAllBtn) {
        selectAllBtn.onclick = () => {
          const checkboxes = document.querySelectorAll('.quotation-checkbox');
          checkboxes.forEach(cb => cb.checked = true);
        };
      }

      // Deselect All button functionality
      const deselectAllBtn = document.getElementById('deselectAllQuotationsBtn');
      if (deselectAllBtn) {
        deselectAllBtn.onclick = () => {
          const checkboxes = document.querySelectorAll('.quotation-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
        };
      }

      // Batch Delete button functionality
      const batchDeleteBtn = document.getElementById('batchDeleteQuotationsBtn');
      if (batchDeleteBtn) {
        batchDeleteBtn.onclick = async () => await batchDeleteQuotations();
      }

      // Batch Update Status button functionality
      const batchUpdateStatusBtn = document.getElementById('batchUpdateStatusBtn');
      if (batchUpdateStatusBtn) {
        batchUpdateStatusBtn.onclick = async () => await batchUpdateQuotationStatus();
      }

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#quotationViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displayQuotations());
        input.addEventListener('change', async () => await displayQuotations());
      });

      // Load quotations on initialization
      await displayQuotations();
    }

    // Initialize Outsourcing View Panel
    async function initializeOutsourcingViewPanel() {
      console.log('initializeOutsourcingViewPanel called');
      // Display outsourcing quotations in separate panel
      await displayOutsourcingQuotations();

      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshOutsourcingBtn');
      if (refreshBtn) {
        refreshBtn.onclick = async () => await displayOutsourcingQuotations();
      }

      // Select All button functionality
      const selectAllBtn = document.getElementById('selectAllOutsourcingBtn');
      if (selectAllBtn) {
        selectAllBtn.onclick = () => {
          const checkboxes = document.querySelectorAll('.outsourcing-checkbox');
          checkboxes.forEach(cb => cb.checked = true);
        };
      }

      // Deselect All button functionality
      const deselectAllBtn = document.getElementById('deselectAllOutsourcingBtn');
      if (deselectAllBtn) {
        deselectAllBtn.onclick = () => {
          const checkboxes = document.querySelectorAll('.outsourcing-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
        };
      }

      // Batch Delete button functionality
      const batchDeleteBtn = document.getElementById('batchDeleteOutsourcingBtn');
      if (batchDeleteBtn) {
        batchDeleteBtn.onclick = async () => await batchDeleteOutsourcingQuotations();
      }

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#outsourcingViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displayOutsourcingQuotations());
        input.addEventListener('change', async () => await displayOutsourcingQuotations());
      });

      // Load outsourcing quotations on initialization
      await displayOutsourcingQuotations();
    }

    // Batch delete outsourcing quotations
    async function batchDeleteOutsourcingQuotations() {
      const checkboxes = document.querySelectorAll('.outsourcing-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.quotationId);

      if (selectedIds.length === 0) {
        showModal({
          title: 'No Selection',
          body: 'Please select at least one quotation to delete.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        return;
      }

      showModal({
        title: 'Confirm Delete',
        body: `Are you sure you want to delete ${selectedIds.length} quotation(s)?`,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Delete', action: async () => {
            for (const id of selectedIds) {
              await deleteQuotationFromStorage(id);
            }
            await displayOutsourcingQuotations();
          }}
        ]
      });
    }

    // Initialize Outsourcing Panel (for creating outsourcing quotations)
    function initializeOutsourcingPanel() {
      console.log('initializeOutsourcingPanel called');
      // Auto-select "other" product type for outsourcing
      const quotationButtons = document.querySelectorAll('.quotation-tag-btn');
      let otherButton = null;

      quotationButtons.forEach(button => {
        if (button.dataset.tag === 'other') {
          otherButton = button;
        }
      });

      // Automatically click the "other" button to show outsourcing form
      if (otherButton) {
        setTimeout(() => {
          otherButton.click();
        }, 100);
      }
    }

    // Display outsourcing quotations (only 'other' type)
    async function displayOutsourcingQuotations() {
      console.log('displayOutsourcingQuotations called');
      const tbody = document.getElementById('outsourcingTableBody');

      // Load only 'other' type quotations from separate API endpoint
      const quotations = await loadOutsourcingQuotationsFromStorage();

      console.log('Loaded outsourcing quotations:', quotations);

      if (quotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="14" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No outsourcing quotations saved yet. Create outsourcing quotations first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredQuotations = applyOutsourcingFilters(quotations);

      if (filteredQuotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="14" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No outsourcing quotations match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date created (newest first)
      filteredQuotations.sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated));

      // Helper function to format date as yyyymmdd, hh:mm:ss
      function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}, ${hours}:${minutes}:${seconds}`;
      }

      // Helper function to get outsourcing action button based on status
      function getOutsourcingActionButton(quotation, supplier = null) {
        const status = quotation.status || 'pending';
        const statusMap = {
          'pending': { next: 'send to outsourcing supplier', label: 'Send to Supplier' },
          'send to outsourcing supplier': { next: 'await quotation', label: 'Await Quotation' },
          'await quotation': { next: 'compare quotation', label: 'Compare Quotation' },
          'compare quotation': { next: 'send to customer', label: 'Send to Customer' },
          'send to customer': { next: 'price confirmed', label: 'Confirm Price' },
          'price confirmed': { next: 'sampling', label: 'Start Sampling' },
          'sampling': { next: 'sample delivered', label: 'Mark Delivered' },
          'sample delivered': { next: null, label: 'Completed' }
        };

        const action = statusMap[status];
        if (!action || !action.next) {
          return '<span style="color:#999;">Completed</span>';
        }

        return `<button class="page-btn" style="padding:4px 8px; font-size:12px;" onclick="event.stopPropagation(); updateOutsourcingStatus(${quotation.id}, '${action.next}')">${action.label}</button>`;
      }

      // Fetch suppliers for each quotation and build the rows
      const rows = [];
      for (const quotation of filteredQuotations) {
        // Fetch linked suppliers
        const suppliersResponse = await fetch(`/api/quotations/${quotation.id}/suppliers`);
        const suppliersData = await suppliersResponse.json();
        const suppliers = suppliersData.success ? suppliersData.suppliers : [];

        if (suppliers.length === 0) {
          // No suppliers linked - show single row with "No supplier" message
          rows.push(`
            <tr style="cursor:pointer;" onclick="viewQuotationDetails(${quotation.id})">
              <td style="border:1px solid #000; padding:8px; text-align:center;" onclick="event.stopPropagation();">
                <input type="checkbox" class="outsourcing-checkbox" data-quotation-id="${quotation.id}" style="cursor:pointer;">
              </td>
              <td style="border:1px solid #000; padding:8px;">${quotation.customerName}</td>
              <td style="border:1px solid #000; padding:8px;">${quotation.contactPerson || 'N/A'}</td>
              <td style="border:1px solid #000; padding:8px;">${quotation.email || 'N/A'}</td>
              <td style="border:1px solid #000; padding:8px;">${quotation.phone || 'N/A'}</td>
              <td style="border:1px solid #000; padding:8px;">${getProductTypeDisplayName(quotation.productType)}</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.quantity.toLocaleString()}</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.total.toFixed(2)}</td>
              <td style="border:1px solid #000; padding:8px;">${quotation.type || 'non email'}</td>
              <td style="border:1px solid #000; padding:8px;">${quotation.status || 'pending'}</td>
              <td style="border:1px solid #000; padding:8px;">${formatDate(quotation.dateCreated)}</td>
              <td style="border:1px solid #000; padding:8px; color:#999;">No supplier</td>
              <td style="border:1px solid #000; padding:8px; text-align:center;">
                <button class="page-btn" style="padding:4px 8px; font-size:12px;" onclick="event.stopPropagation(); openLinkSupplierModal(${quotation.id})">Link Supplier</button>
              </td>
              <td style="border:1px solid #000; padding:8px; text-align:center;">
                <button class="page-btn" style="padding:4px 8px; font-size:12px; background:#dc3545; color:#fff;" onclick="event.stopPropagation(); deleteQuotation(${quotation.id})">Delete</button>
              </td>
            </tr>
          `);
        } else {
          // Has suppliers - show row for each supplier with rowspan on quotation fields
          suppliers.forEach((supplier, index) => {
            const supplierMembers = supplier.members || [];
            const memberNames = supplierMembers.map(m => m.name).join(', ') || 'No members';

            if (index === 0) {
              // First row - include all quotation fields with rowspan
              rows.push(`
                <tr style="cursor:pointer;" onclick="viewQuotationDetails(${quotation.id})">
                  <td style="border:1px solid #000; padding:8px; text-align:center;" rowspan="${suppliers.length}" onclick="event.stopPropagation();">
                    <input type="checkbox" class="outsourcing-checkbox" data-quotation-id="${quotation.id}" style="cursor:pointer;">
                  </td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.customerName}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.contactPerson || 'N/A'}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.email || 'N/A'}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.phone || 'N/A'}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${getProductTypeDisplayName(quotation.productType)}</td>
                  <td style="border:1px solid #000; padding:8px; text-align:right;" rowspan="${suppliers.length}">${quotation.quantity.toLocaleString()}</td>
                  <td style="border:1px solid #000; padding:8px; text-align:right;" rowspan="${suppliers.length}">${quotation.total.toFixed(2)}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.type || 'non email'}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${quotation.status || 'pending'}</td>
                  <td style="border:1px solid #000; padding:8px;" rowspan="${suppliers.length}">${formatDate(quotation.dateCreated)}</td>
                  <td style="border:1px solid #000; padding:8px;">
                    <strong>${supplier.name}</strong><br>
                    <span style="font-size:12px; color:#666;">${memberNames}</span>
                  </td>
                  <td style="border:1px solid #000; padding:8px; text-align:center;" rowspan="${suppliers.length}">
                    ${getOutsourcingActionButton(quotation, supplier)}
                  </td>
                  <td style="border:1px solid #000; padding:8px; text-align:center;" rowspan="${suppliers.length}">
                    <button class="page-btn" style="padding:4px 8px; font-size:12px; background:#dc3545; color:#fff;" onclick="event.stopPropagation(); deleteQuotation(${quotation.id})">Delete</button>
                  </td>
                </tr>
              `);
            } else {
              // Subsequent rows - only supplier field
              rows.push(`
                <tr style="cursor:pointer;" onclick="viewQuotationDetails(${quotation.id})">
                  <td style="border:1px solid #000; padding:8px;">
                    <strong>${supplier.name}</strong><br>
                    <span style="font-size:12px; color:#666;">${memberNames}</span>
                  </td>
                </tr>
              `);
            }
          });
        }
      }

      tbody.innerHTML = rows.join('');
    }

    // Update outsourcing quotation status
    window.updateOutsourcingStatus = async function(quotationId, newStatus) {
      console.log('updateOutsourcingStatus called:', quotationId, newStatus);
      try {
        // Get current quotation data
        const response = await fetch(`/api/quotations/${quotationId}`);
        const result = await response.json();
        if (!result.success) {
          throw new Error('Failed to get quotation');
        }

        const quotation = result.quotation;

        // Update the status
        const updateResponse = await fetch(`/api/quotations/${quotationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...quotation,
            status: newStatus
          })
        });

        if (!updateResponse.ok) {
          throw new Error('Failed to update status');
        }

        showModal({
          title: 'Success',
          body: `Status updated to "${newStatus}" successfully!`,
          buttons: [{ text: 'OK', action: 'close' }]
        });

        // Refresh the outsourcing list
        await displayOutsourcingQuotations();
      } catch (error) {
        console.error('Error updating outsourcing status:', error);
        showModal({
          title: 'Error',
          body: 'Failed to update status. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    };

    // Apply filters for outsourcing quotations
    function applyOutsourcingFilters(quotations) {
      const filters = {
        customer: document.getElementById('outsourcingFilterCustomer')?.value.toLowerCase().trim() || '',
        contact: document.getElementById('outsourcingFilterContact')?.value.toLowerCase().trim() || '',
        email: document.getElementById('outsourcingFilterEmail')?.value.toLowerCase().trim() || '',
        phone: document.getElementById('outsourcingFilterPhone')?.value.toLowerCase().trim() || '',
        quantity: document.getElementById('outsourcingFilterQuantity')?.value.toLowerCase().trim() || '',
        total: document.getElementById('outsourcingFilterTotal')?.value.toLowerCase().trim() || '',
        status: document.getElementById('outsourcingFilterStatus')?.value || '',
        date: document.getElementById('outsourcingFilterDate')?.value.toLowerCase().trim() || ''
      };

      return quotations.filter(quotation => {
        if (filters.customer && !quotation.customerName.toLowerCase().includes(filters.customer)) return false;
        if (filters.contact && !quotation.contactPerson?.toLowerCase().includes(filters.contact)) return false;
        if (filters.email && !quotation.email?.toLowerCase().includes(filters.email)) return false;
        if (filters.phone && !quotation.phone?.toLowerCase().includes(filters.phone)) return false;
        if (filters.quantity && !quotation.quantity.toString().includes(filters.quantity)) return false;
        if (filters.total && !quotation.total.toString().includes(filters.total)) return false;
        if (filters.status && quotation.status !== filters.status) return false;
        if (filters.date && !new Date(quotation.dateCreated).toLocaleDateString().toLowerCase().includes(filters.date)) return false;
        return true;
      });
    }

    // Display all quotations
    async function displayQuotations() {
      console.log('displayQuotations called');
      const tbody = document.getElementById('quotationsTableBody');
      const quotations = await loadQuotationsFromStorage();
      console.log('Loaded quotations:', quotations);

      if (quotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="13" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No quotations saved yet. Create quotations first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredQuotations = applyQuotationFilters(quotations);

      if (filteredQuotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="13" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No quotations match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date created (newest first)
      filteredQuotations.sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated));

      // Helper function to format date as yyyymmdd, hh:mm:ss
      function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}, ${hours}:${minutes}:${seconds}`;
      }

      // Helper function to get action button based on status
      function getActionButton(quotation) {
        const status = quotation.status || 'draft';
        const statusMap = {
          'pending': { next: 'send to customer', label: 'Send to Customer' },
          'send to customer': { next: 'price confirmed', label: 'Confirm Price' },
          'price confirmed': { next: 'sampling', label: 'Start Sampling' },
          'sampling': { next: 'sample delivered', label: 'Mark Delivered' },
          'sample delivered': { next: null, label: 'Completed' }
        };

        const action = statusMap[status];
        if (!action || !action.next) {
          return '<span style="color:#999;">-</span>';
        }

        return `<button class="page-btn" style="padding:4px 8px; font-size:12px;" onclick="event.stopPropagation(); updateQuotationStatus(${quotation.id}, '${action.next}', '${quotation.type || 'non email'}', ${JSON.stringify(quotation).replace(/"/g, '&quot;')})">${action.label}</button>`;
      }

      tbody.innerHTML = filteredQuotations.map(quotation => `
        <tr style="cursor:pointer;" onclick="viewQuotationDetails(${quotation.id})">
          <td style="border:1px solid #000; padding:8px; text-align:center;" onclick="event.stopPropagation();">
            <input type="checkbox" class="quotation-checkbox" data-quotation-id="${quotation.id}" style="cursor:pointer;">
          </td>
          <td style="border:1px solid #000; padding:8px;">${quotation.customerName}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.contactPerson || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.email || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.phone || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${getProductTypeDisplayName(quotation.productType)}</td>
          <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.quantity.toLocaleString()}</td>
          <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.total.toFixed(2)}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.type || 'non email'}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.status || 'draft'}</td>
          <td style="border:1px solid #000; padding:8px;">${formatDate(quotation.dateCreated)}</td>
          <td style="border:1px solid #000; padding:8px; text-align:center;">${getActionButton(quotation)}</td>
          <td style="border:1px solid #000; padding:8px; text-align:center;">
            <button class="page-btn" style="padding:4px 8px; font-size:12px; background:#dc3545; color:#fff;" onclick="event.stopPropagation(); deleteQuotation(${quotation.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function applyQuotationFilters(quotations) {
      const filters = {
        customer: document.getElementById('quotationFilterCustomer').value.toLowerCase().trim(),
        contact: document.getElementById('quotationFilterContact').value.toLowerCase().trim(),
        email: document.getElementById('quotationFilterEmail').value.toLowerCase().trim(),
        phone: document.getElementById('quotationFilterPhone').value.toLowerCase().trim(),
        type: document.getElementById('quotationFilterType').value,
        quantity: document.getElementById('quotationFilterQuantity').value.toLowerCase().trim(),
        total: document.getElementById('quotationFilterTotal').value.toLowerCase().trim(),
        status: document.getElementById('quotationFilterStatus').value,
        date: document.getElementById('quotationFilterDate').value.toLowerCase().trim()
      };

      return quotations.filter(quotation => {
        if (filters.customer && !quotation.customerName.toLowerCase().includes(filters.customer)) return false;
        if (filters.contact && !quotation.contactPerson?.toLowerCase().includes(filters.contact)) return false;
        if (filters.email && !quotation.email?.toLowerCase().includes(filters.email)) return false;
        if (filters.phone && !quotation.phone?.toLowerCase().includes(filters.phone)) return false;
        if (filters.type && quotation.productType !== filters.type) return false;
        if (filters.quantity && !quotation.quantity.toString().includes(filters.quantity)) return false;
        if (filters.total && !quotation.total.toString().includes(filters.total)) return false;
        if (filters.status && quotation.status !== filters.status) return false;
        if (filters.date && !new Date(quotation.dateCreated).toLocaleDateString().toLowerCase().includes(filters.date)) return false;
        return true;
      });
    }

    function getProductTypeDisplayName(type) {
      const names = {
        'hang-tag': 'Hang Tag',
        'woven-label': 'Woven Label',
        'care-label': 'Care Label',
        'heat-transfer': 'Heat Transfer',
        'others': 'Others'
      };
      return names[type] || type;
    }

    window.updateQuotationStatus = async function(quotationId, newStatus, quotationType, quotationData) {
      console.log('=== updateQuotationStatus called ===');
      console.log('Quotation ID:', quotationId);
      console.log('New Status:', newStatus);
      console.log('Quotation Type:', quotationType);

      try {
        // Update the quotation status in the database
        const response = await fetch(`/api/quotations/${quotationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...quotationData,
            status: newStatus
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update quotation status');
        }

        const result = await response.json();
        console.log('Status update result:', result);

        // If changing from "pending" to "send to customer", send email
        if (newStatus === 'send to customer' && quotationType === 'email') {
          console.log('Sending quotation email to customer...');

          // Get the full quotation data with email metadata
          const quotations = await loadQuotationsFromStorage();
          const quotation = quotations.find(q => q.id == quotationId);

          if (quotation && quotation.sourceEmailMessageId) {
            // Construct email metadata from quotation
            const emailMeta = {
              uid: quotation.sourceEmailUid,
              subject: quotation.sourceEmailSubject,
              messageId: quotation.sourceEmailMessageId,
              email: quotation.email
            };

            try {
              await sendQuotationEmail(quotation, emailMeta);
              showModal({
                title: 'Success',
                body: `Status updated to "${newStatus}" and quotation email sent to customer successfully!`
              });
            } catch (emailError) {
              console.error('Failed to send quotation email:', emailError);
              showModal({
                title: 'Warning',
                body: `Status updated to "${newStatus}", but failed to send email. You can send it manually later.`
              });
            }
          } else {
            showModal({
              title: 'Warning',
              body: `Status updated to "${newStatus}", but email metadata not found. Cannot send email automatically.`
            });
          }
        } else {
          // For other status transitions, just show success message
          showModal({
            title: 'Success',
            body: `Status updated to "${newStatus}" successfully!`
          });
        }

        // Refresh the quotations list to show updated status
        await displayQuotations();

      } catch (error) {
        console.error('Error updating quotation status:', error);
        showModal({
          title: 'Error',
          body: 'Failed to update quotation status. Please try again.'
        });
      }
    };

    async function viewQuotationDetails(quotationId) {
      console.log('Viewing quotation with ID:', quotationId);
      const quotations = await loadQuotationsFromStorage();
      console.log('All quotations:', quotations);

      const quotation = quotations.find(q => q.id == quotationId); // Use == for type coercion
      console.log('Found quotation:', quotation ? 'YES' : 'NO');
      console.log('Looking for ID:', quotationId, 'Type:', typeof quotationId);
      console.log('Available IDs:', quotations.map(q => ({ id: q.id, type: typeof q.id })));

      if (quotation) {
        console.log('Found quotation data:', {
          id: quotation.id,
          customerName: quotation.customerName,
          profileImagePath: quotation.profileImagePath,
          attachmentPaths: quotation.attachmentPaths
        });
        console.log('Profile image path exists?', !!quotation.profileImagePath);
        console.log('Profile image path value:', quotation.profileImagePath);
        console.log('Attachment paths exist?', !!quotation.attachmentPaths);
        console.log('Attachment paths value:', quotation.attachmentPaths);
      }

      if (!quotation) {
        console.error('Quotation not found for ID:', quotationId);
        console.error('Available quotation IDs:', quotations.map(q => q.id));
        showModal({
          title: 'Error',
          body: 'Quotation not found.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        return;
      }

      // Generate the quotation form HTML for this product type (same as create form)
      const tagName = getProductTypeDisplayName(quotation.productType);
      const formHtml = generateQuotationContentForView(quotation.productType, tagName, quotation);

      const modalContent = `
        <div style="max-width: 1200px; max-height: 85vh; overflow-y: auto;">
          <div style="margin-bottom: 15px; padding: 10px; background: #f8f8f8; border: 1px solid #000;">
            <strong>Quotation Details</strong> - Created: ${new Date(quotation.dateCreated).toLocaleString()}
            <span style="float: right; font-size: 0.9em; color: #666;">Status: ${quotation.status || 'Draft'}</span>
          </div>
          <div id="quotationViewFormContainer">
            ${formHtml}
          </div>
        </div>
      `;

      // Create a custom modal overlay for the quotation form
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '11000';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '900px';
      modal.style.width = '90vw';

      const header = document.createElement('div');
      header.className = 'modal-header';
      header.textContent = `Quotation Details - ${quotation.customerName}`;

      const body = document.createElement('div');
      body.className = 'modal-body';
      body.innerHTML = modalContent;

      const actions = document.createElement('div');
      actions.className = 'modal-actions';
      actions.innerHTML = `
        <button class="btn" onclick="closeQuotationViewModal()">Close</button>
        <button class="btn primary" onclick="editQuotationFromView(${quotation.id})">Edit Quotation</button>
        <button class="btn" style="background: #ff6b6b; color: white;" onclick="deleteQuotation(${quotation.id})">Delete</button>
      `;

      modal.appendChild(header);
      modal.appendChild(body);
      modal.appendChild(actions);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Prevent body scroll when modal is open
      document.body.classList.add('modal-open');

      // Populate the form with quotation data immediately after DOM insertion
      requestAnimationFrame(() => {
        populateQuotationViewForm(quotation);
      });

      // Global function to close the modal
      window.closeQuotationViewModal = function() {
        document.body.removeChild(overlay);
        document.body.classList.remove('modal-open');
      };

      // Global function to preview attachment
      window.previewAttachment = function(attachmentPath) {
        const fileName = (attachmentPath.split('/').pop() || attachmentPath.split('\\\\').pop());
        const fileNameLower = attachmentPath.toLowerCase();
        if (fileNameLower.includes('.jpg') || fileNameLower.includes('.jpeg') || fileNameLower.includes('.png') || fileNameLower.includes('.gif')) {
          // Image preview
          showModal({
            title: fileName,
            body: `<img src="/${attachmentPath}" style="max-width:100%; max-height:400px; object-fit:contain;" alt="Attachment">`,
            buttons: [{ text: 'Close', action: 'close' }]
          });
        } else {
          // Download prompt for other files
          showModal({
            title: 'File Preview',
            body: `Preview not available for this file type. <a href="/${attachmentPath}" download="${fileName}" style="color:#000; text-decoration:underline;">Click here to download</a> the file.`,
            buttons: [{ text: 'Close', action: 'close' }]
          });
        }
      };
    }

    function populateQuotationViewForm(quotation) {
      console.log('Setting up view form (fields already populated):', quotation);

      // Wait for DOM to be fully ready, then disable all form elements for view mode
      setTimeout(() => {
        console.log('Disabling form fields for view mode...');

        // Get the form container first
        const formContainer = document.getElementById('quotationViewFormContainer');
        console.log('Form container found:', formContainer ? 'YES' : 'NO');

        if (!formContainer) {
          console.error('quotationViewFormContainer not found!');
          return;
        }

        // Disable and dim all input, textarea, and select elements in the form
        const allFormElements = document.querySelectorAll('#quotationViewFormContainer input, #quotationViewFormContainer textarea, #quotationViewFormContainer select');
        allFormElements.forEach(element => {
          element.disabled = true;
          element.readOnly = true;
          element.style.backgroundColor = '#f5f5f5';
          element.style.color = '#666';
          element.style.cursor = 'not-allowed';
        });

        console.log('Form fields disabled for view mode');
      }, 200);
    }

    async function editQuotationFromView(quotationId) {
      // Enable inline editing mode
      const formContainer = document.getElementById('quotationViewFormContainer');
      if (!formContainer) return;

      // Enable all form fields
      const allInputs = formContainer.querySelectorAll('input, select, textarea');
      allInputs.forEach(input => {
        input.disabled = false;
        input.readOnly = false;
        input.style.backgroundColor = '#fff';
        input.style.color = '#000';
        input.style.cursor = 'text';
      });

      // Update modal actions to show Save and Cancel buttons
      const actionsDiv = document.querySelector('.modal-actions');
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <button class="btn" onclick="cancelInlineEdit(${quotationId})">Cancel</button>
          <button class="btn primary" onclick="saveInlineQuotationEdit(${quotationId})">Save Changes</button>
        `;
      }

      // Store original quotation data for cancel functionality
      const quotations = await loadQuotationsFromStorage();
      const quotation = quotations.find(q => q.id === quotationId);
      window.originalQuotationData = quotation;
    }

    window.cancelInlineEdit = async function(quotationId) {
      // Restore original data and close modal
      closeQuotationViewModal();

      // Reopen the view with original data
      await viewQuotationDetails(quotationId);
    };

    window.saveInlineQuotationEdit = async function(quotationId) {
      console.log('=== saveInlineQuotationEdit called ===');
      console.log('Quotation ID:', quotationId);

      try {
        // Get the original quotation to preserve fields we're not editing
        const quotations = await loadQuotationsFromStorage();
        const originalQuotation = quotations.find(q => q.id === quotationId);

        if (!originalQuotation) {
          throw new Error('Original quotation not found');
        }

        // Collect updated data from form fields
        const customerName = document.getElementById('quotationCustomerName')?.value.trim();
        const contactPerson = document.getElementById('quotationContactPerson')?.value;
        const email = document.getElementById('quotationEmail')?.value.trim();
        const phone = document.getElementById('quotationPhone')?.value.trim();
        const quantity = document.getElementById('quotationQuantity')?.value;
        const unitPrice = document.getElementById('quotationUnitPrice')?.value;
        const notes = document.getElementById('quotationNotes')?.value.trim();

        // Validation
        if (!customerName) {
          showModal({ title: 'Validation Error', body: 'Customer Name is required.' });
          return;
        }
        if (!quantity || quantity <= 0) {
          showModal({ title: 'Validation Error', body: 'Quantity must be greater than 0.' });
          return;
        }

        // Get product-specific fields
        let productDetails = {};
        if (originalQuotation.productType === 'hang-tag') {
          productDetails = {
            material: document.getElementById('quotationMaterial')?.value || '',
            size: document.getElementById('quotationSize')?.value || '',
            printingMethod: document.getElementById('quotationPrintingMethod')?.value || ''
          };
        }
        // Add other product types as needed

        // Calculate total
        const total = parseFloat(quantity) * parseFloat(unitPrice || 0);

        // Update quotation object
        const updatedQuotation = {
          ...originalQuotation,
          customerName,
          contactPerson,
          email,
          phone,
          productDetails,
          quantity: parseInt(quantity),
          unitPrice: parseFloat(unitPrice) || 0,
          total: total,
          notes
        };

        console.log('Updated quotation:', updatedQuotation);

        // Save to database
        const response = await fetch(`/api/quotations/${quotationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedQuotation)
        });

        if (!response.ok) {
          throw new Error('Failed to update quotation');
        }

        const result = await response.json();
        console.log('Update result:', result);

        // Show success message
        showModal({
          title: 'Success',
          body: 'Quotation updated successfully!'
        });

        // Close modal and refresh quotations list
        closeQuotationViewModal();
        await displayQuotations();

      } catch (error) {
        console.error('Error saving quotation:', error);
        showModal({
          title: 'Error',
          body: 'Failed to save quotation changes. Please try again.'
        });
      }
    };

    function populateQuotationForEditing(quotation) {
      // Populate customer name
      const customerNameField = document.getElementById('quotationCustomerName');
      if (customerNameField) {
        customerNameField.value = quotation.customerName;
      }

      // Populate contact person
      const contactField = document.getElementById('quotationContactPerson');
      if (contactField) {
        contactField.value = quotation.contactPerson;
      }

      // Populate email and phone
      const emailField = document.getElementById('quotationEmail');
      if (emailField) {
        emailField.value = quotation.email || '';
      }

      const phoneField = document.getElementById('quotationPhone');
      if (phoneField) {
        phoneField.value = quotation.phone || '';
      }

      // Populate product-specific fields
      if (quotation.productDetails) {
        Object.entries(quotation.productDetails).forEach(([key, value]) => {
          const fieldId = `quotation${key.charAt(0).toUpperCase() + key.slice(1)}`;
          const field = document.getElementById(fieldId);
          if (field) {
            field.value = value;
          }
        });
      }

      // Populate quantity and pricing
      const quantityField = document.getElementById('quotationQuantity');
      if (quantityField) {
        quantityField.value = quotation.quantity;
        quantityField.dispatchEvent(new Event('input', { bubbles: true }));
      }

      const unitPriceField = document.getElementById('quotationUnitPrice');
      if (unitPriceField) {
        unitPriceField.value = quotation.unitPrice.toFixed(2);
        unitPriceField.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Populate notes
      const notesField = document.getElementById('quotationNotes');
      if (notesField) {
        notesField.value = quotation.notes || '';
      }

      // Populate existing files
      populateExistingFilesForEditing(quotation);

      // Store the quotation ID for updating
      window.editingQuotationId = quotation.id;
    }

    function populateExistingFilesForEditing(quotation) {
      // Populate profile image if exists
      if (quotation.profileImagePath) {
        const profileImagePreview = document.getElementById('profileImagePreview');
        const profileImagePlaceholder = document.getElementById('profileImagePlaceholder');
        const removeProfileImageBtn = document.getElementById('removeProfileImageBtn');
        const profileImageDropZone = document.getElementById('profileImageDropZone');

        if (profileImagePreview && profileImagePlaceholder && removeProfileImageBtn && profileImageDropZone) {
          profileImagePreview.style.backgroundImage = `url(/${quotation.profileImagePath})`;
          profileImagePreview.style.display = 'block';
          profileImagePlaceholder.style.display = 'none';
          removeProfileImageBtn.style.display = 'inline-block';

          // Update drop zone styling
          profileImageDropZone.style.borderColor = '#000';
          profileImageDropZone.style.backgroundColor = '#f9f9f9';
        }
      }

      // Populate attachments if exist
      if (quotation.attachmentPaths && Array.isArray(quotation.attachmentPaths) && quotation.attachmentPaths.length > 0) {
        const attachmentsList = document.getElementById('attachmentsList');

        if (attachmentsList) {
          // Hide placeholder
          const placeholder = attachmentsList.querySelector('.text-align\\:center') || attachmentsList.querySelector('div');
          if (placeholder) {
            placeholder.style.display = 'none';
          }

          // Add existing attachments
          quotation.attachmentPaths.forEach(attachmentPath => {
            const fileName = attachmentPath.split('/').pop() || attachmentPath.split('\\\\').pop();
            const fileIcon = getFileIconFromPath(attachmentPath);

            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'attachment-item';
            attachmentItem.style.cssText = 'display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #ddd; margin-bottom:5px; background:#fff;';

            const icon = document.createElement('span');
            icon.style.cssText = 'font-size:16px;';
            icon.textContent = fileIcon;

            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = fileName;
            fileNameSpan.style.cssText = 'flex:1; font-size:12px; cursor:pointer;';
            fileNameSpan.onclick = () => previewAttachment(attachmentPath);

            const downloadBtn = document.createElement('a');
            downloadBtn.href = `/${attachmentPath}`;
            downloadBtn.download = fileName;
            downloadBtn.style.cssText = 'font-size:12px; color:#000; text-decoration:none;';
            downloadBtn.textContent = 'ðŸ“¥';

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Ã—';
            removeBtn.className = 'btn';
            removeBtn.style.cssText = 'font-size:12px; padding:2px 6px; background:#ff6b6b; color:white;';
            removeBtn.onclick = () => {
              // For existing attachments, we need to remove from the database
              removeExistingAttachment(quotation.id, attachmentPath, attachmentItem);
            };

            attachmentItem.appendChild(icon);
            attachmentItem.appendChild(fileNameSpan);
            attachmentItem.appendChild(downloadBtn);
            attachmentItem.appendChild(removeBtn);

            attachmentsList.appendChild(attachmentItem);
          });
        }
      }
    }

    async function removeExistingAttachment(quotationId, attachmentPath, attachmentItem) {
      try {
        // Call API to remove attachment from quotation
        const response = await fetch(`/api/quotations/${quotationId}/attachments/${encodeURIComponent(attachmentPath.split('/').pop())}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          attachmentItem.remove();

          // Show placeholder if no attachments left
          const attachmentsList = document.getElementById('attachmentsList');
          const attachmentItems = attachmentsList.querySelectorAll('.attachment-item');
          if (attachmentItems.length === 0) {
            const placeholder = attachmentsList.querySelector('.text-align\\:center') || attachmentsList.querySelector('div');
            if (placeholder) {
              placeholder.style.display = 'block';
            }
          }
        } else {
          console.error('Failed to remove attachment');
        }
      } catch (error) {
        console.error('Error removing attachment:', error);
      }
    }

    async function deleteQuotation(quotationId) {
      if (!confirm('Are you sure you want to delete this quotation? This action cannot be undone.')) {
        return;
      }

      try {
        await deleteQuotationFromStorage(quotationId);

        // Close modal if it exists (when called from within modal)
        if (typeof closeQuotationViewModal === 'function') {
          closeQuotationViewModal();
        }

        await displayQuotations(); // Refresh the table

        showModal({
          title: 'Success',
          body: 'Quotation deleted successfully.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      } catch (error) {
        console.error('Error deleting quotation:', error);
        showModal({
          title: 'Error',
          body: 'Failed to delete quotation. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    async function batchDeleteQuotations() {
      const checkboxes = document.querySelectorAll('.quotation-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.quotationId);

      if (selectedIds.length === 0) {
        showModal({
          title: 'No Selection',
          body: 'Please select at least one quotation to delete.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        return;
      }

      if (!confirm(`Are you sure you want to delete ${selectedIds.length} quotation(s)? This action cannot be undone.`)) {
        return;
      }

      try {
        let successCount = 0;
        let failCount = 0;

        for (const id of selectedIds) {
          try {
            await deleteQuotationFromStorage(id);
            successCount++;
          } catch (error) {
            console.error(`Failed to delete quotation ${id}:`, error);
            failCount++;
          }
        }

        await displayQuotations(); // Refresh the table

        if (failCount === 0) {
          showModal({
            title: 'Success',
            body: `Successfully deleted ${successCount} quotation(s).`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        } else {
          showModal({
            title: 'Partial Success',
            body: `Deleted ${successCount} quotation(s). Failed to delete ${failCount} quotation(s).`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        }
      } catch (error) {
        console.error('Error in batch delete:', error);
        showModal({
          title: 'Error',
          body: 'Failed to delete quotations. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    async function batchUpdateQuotationStatus() {
      const checkboxes = document.querySelectorAll('.quotation-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.quotationId);

      if (selectedIds.length === 0) {
        showModal({
          title: 'No Selection',
          body: 'Please select at least one quotation to update.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        return;
      }

      // Get all quotations to find the selected ones
      const quotations = await loadQuotationsFromStorage();
      const selectedQuotations = quotations.filter(q => selectedIds.includes(q.id.toString()));

      // Create status selection modal
      const statusOptions = [
        { value: 'draft', label: 'Draft' },
        { value: 'pending', label: 'Pending' },
        { value: 'send to customer', label: 'Send to Customer' },
        { value: 'price confirmed', label: 'Price Confirmed' },
        { value: 'sampling', label: 'Sampling' },
        { value: 'sample delivered', label: 'Sample Delivered' }
      ];

      const optionsHtml = statusOptions.map(opt =>
        `<option value="${opt.value}">${opt.label}</option>`
      ).join('');

      const modalHtml = `
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:5px; font-weight:bold;">Select new status for ${selectedIds.length} quotation(s):</label>
          <select id="batchStatusSelect" style="width:100%; padding:8px; border:1px solid #ccc;">
            ${optionsHtml}
          </select>
        </div>
      `;

      showModal({
        title: 'Update Status',
        body: modalHtml,
        buttons: [
          {
            text: 'Update',
            action: async () => {
              const newStatus = document.getElementById('batchStatusSelect').value;
              await performBatchStatusUpdate(selectedQuotations, newStatus);
            }
          },
          { text: 'Cancel', action: 'close' }
        ]
      });
    }

    async function performBatchStatusUpdate(quotations, newStatus) {
      try {
        let successCount = 0;
        let failCount = 0;

        for (const quotation of quotations) {
          try {
            const updatedQuotation = { ...quotation, status: newStatus };
            await saveQuotationToStorage(updatedQuotation);
            successCount++;
          } catch (error) {
            console.error(`Failed to update quotation ${quotation.id}:`, error);
            failCount++;
          }
        }

        await displayQuotations(); // Refresh the table

        if (failCount === 0) {
          showModal({
            title: 'Success',
            body: `Successfully updated ${successCount} quotation(s) to "${newStatus}".`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        } else {
          showModal({
            title: 'Partial Success',
            body: `Updated ${successCount} quotation(s). Failed to update ${failCount} quotation(s).`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        }
      } catch (error) {
        console.error('Error in batch status update:', error);
        showModal({
          title: 'Error',
          body: 'Failed to update quotation status. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    // -------- QUOTATION TAG SELECTION --------
    let selectedQuotationTag = null;

    function initializeQuotationPanel() {
      const quotationButtons = document.querySelectorAll('.quotation-tag-btn');

      quotationButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tagType = button.dataset.tag;
          const tagName = button.textContent;

          // Remove selected class from all buttons
          quotationButtons.forEach(btn => btn.classList.remove('selected'));

          // Add selected class to clicked button
          button.classList.add('selected');

          // Update selected tag
          selectedQuotationTag = tagType;

          // Show sub-board with content
          showQuotationSubBoard(tagType, tagName);
        });
      });
    }

    function showQuotationSubBoard(tagType, tagName) {
      const subBoard = document.getElementById('quotationSubBoard');
      const subBoardTitle = document.getElementById('quotationSubBoardTitle');
      const subBoardContent = document.getElementById('quotationSubBoardContent');

      // Update title
      subBoardTitle.textContent = `${tagName} Quotation`;

      // Generate content based on tag type
      const content = generateQuotationContent(tagType, tagName, 'non email');
      subBoardContent.innerHTML = content;

      // Initialize autocomplete for customer field and file upload functionality
      setTimeout(() => {
        if (document.getElementById('quotationCustomerName')) {
          window.customerAutocomplete = new CustomerAutocomplete('quotationCustomerName', 'customerAutocompleteDropdown');
        }

        // Initialize file upload functionality
        initializeFileUploads(tagType);

        // Add event listener for contact person selection
        const contactPersonField = document.getElementById('quotationContactPerson');
        if (contactPersonField) {
          contactPersonField.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const emailField = document.getElementById('quotationEmail');
            const phoneField = document.getElementById('quotationPhone');

            if (selectedOption && selectedOption.value && selectedOption.dataset.memberData) {
              const memberData = JSON.parse(selectedOption.dataset.memberData);

              // Auto-populate and disable email field
              if (emailField && memberData.emailPrefix) {
                emailField.value = `${memberData.emailPrefix}@${window.customerAutocomplete.selectedCustomer.emailDomain}`;
                emailField.disabled = true;
                emailField.style.backgroundColor = '#f5f5f5';
                emailField.style.color = '#666';
              }

              // Auto-populate and disable phone field
              if (phoneField && memberData.tel) {
                phoneField.value = memberData.tel;
                phoneField.disabled = true;
                phoneField.style.backgroundColor = '#f5f5f5';
                phoneField.style.color = '#666';
              }
            } else {
              // No contact person selected - enable fields for manual entry
              if (emailField) {
                emailField.disabled = false;
                emailField.style.backgroundColor = '#fff';
                emailField.style.color = '#000';
              }
              if (phoneField) {
                phoneField.disabled = false;
                phoneField.style.backgroundColor = '#fff';
                phoneField.style.color = '#000';
              }
            }
          });
        }
      }, 100);

      // Set up event listeners for total calculation
      setTimeout(() => {
        const quantityInput = document.getElementById('quotationQuantity');
        const unitPriceInput = document.getElementById('quotationUnitPrice');

        if (quantityInput && unitPriceInput) {
          const updateTotal = () => {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const total = quantity * unitPrice;
            const totalInput = document.getElementById('quotationTotal');
            if (totalInput) {
              totalInput.value = total.toFixed(2);
            }
          };

          quantityInput.addEventListener('input', updateTotal);
          unitPriceInput.addEventListener('input', updateTotal);
        }
      }, 100);

      // Show sub-board
      subBoard.style.display = 'block';
    }

    function initializeFileUploads(tagType) {
      // Profile Image Upload Functionality
      const profileImageDropZone = document.getElementById('profileImageDropZone');
      const profileImageInput = document.getElementById('profileImageInput');
      const profileImagePreview = document.getElementById('profileImagePreview');
      const profileImagePlaceholder = document.getElementById('profileImagePlaceholder');
      const removeProfileImageBtn = document.getElementById('removeProfileImageBtn');

      // Check if all required elements exist
      if (!profileImageDropZone || !profileImageInput || !profileImagePreview || !profileImagePlaceholder) {
        console.error('Profile image upload elements not found. Cannot initialize file uploads.');
        console.error('Elements found:', {
          profileImageDropZone: !!profileImageDropZone,
          profileImageInput: !!profileImageInput,
          profileImagePreview: !!profileImagePreview,
          profileImagePlaceholder: !!profileImagePlaceholder
        });
        return;
      }

      let currentQuotationId = null;

      // Get current quotation ID if editing
      const urlParams = new URLSearchParams(window.location.search);
      currentQuotationId = urlParams.get('edit');

      // Load existing profile image if editing
      if (currentQuotationId) {
        loadExistingProfileImage(currentQuotationId);
      }

      // Profile Image: Click to browse
      profileImageDropZone.addEventListener('click', () => {
        profileImageInput.click();
      });

      // Profile Image: File input change
      profileImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          console.log('File selected via input:', file.name, 'Size:', file.size, 'Type:', file.type);
          handleProfileImageFile(file);
        }
      });

      // Profile Image: Drag and drop
      profileImageDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        profileImageDropZone.style.borderColor = '#000';
        profileImageDropZone.style.backgroundColor = '#f0f0f0';
      });

      profileImageDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        profileImageDropZone.style.borderColor = '#ccc';
        profileImageDropZone.style.backgroundColor = '#fff';
      });

      profileImageDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        profileImageDropZone.style.borderColor = '#ccc';
        profileImageDropZone.style.backgroundColor = '#fff';

        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleProfileImageFile(file);
        } else {
          showModal({
            title: 'Invalid File',
            body: 'Please select an image file.',
            buttons: [{ text: 'OK', action: 'close' }]
          });
        }
      });

      // Profile Image: Paste functionality (Ctrl+V)
      document.addEventListener('paste', (e) => {
        if (document.activeElement.closest('#profileImageDropZone')) {
          const items = e.clipboardData.items;
          for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
              const file = items[i].getAsFile();
              handleProfileImageFile(file);
              break;
            }
          }
        }
      });

      // Profile Image: Handle file processing
      async function handleProfileImageFile(file) {
        console.log('handleProfileImageFile called with:', file.name, 'Type:', file.type, 'Size:', file.size);

        if (!file.type.startsWith('image/')) {
          showModal({
            title: 'Invalid File',
            body: 'Please select an image file.',
            buttons: [{ text: 'OK', action: 'close' }]
          });
          return;
        }

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = (e) => {
          console.log('FileReader loaded, setting preview');
          profileImagePreview.style.backgroundImage = `url(${e.target.result})`;
          profileImagePreview.style.display = 'block';
          profileImagePlaceholder.style.display = 'none';
          if (removeProfileImageBtn) {
            removeProfileImageBtn.style.display = 'inline-block';
          }

          // Also update the drop zone styling to indicate it contains an image
          profileImageDropZone.style.borderColor = '#000';
          profileImageDropZone.style.backgroundColor = '#f9f9f9';
        };
        reader.onerror = (error) => {
          console.error('FileReader error:', error);
        };
        reader.readAsDataURL(file);

        // Upload to server if we have a quotation ID
        if (currentQuotationId) {
          console.log('Uploading to server with quotation ID:', currentQuotationId);
          await uploadProfileImage(file, currentQuotationId);
        } else {
          // Store file temporarily until quotation is saved
          console.log('Storing file temporarily in window.tempProfileImageFile');
          window.tempProfileImageFile = file;
          console.log('Stored file:', window.tempProfileImageFile.name, 'Size:', window.tempProfileImageFile.size);
        }
      }

      // Profile Image: Remove functionality
      window.removeProfileImage = function() {
        profileImagePreview.style.backgroundImage = '';
        profileImagePreview.style.display = 'none';
        profileImagePlaceholder.style.display = 'block';
        removeProfileImageBtn.style.display = 'none';
        profileImageInput.value = '';

        // Reset drop zone styling
        profileImageDropZone.style.borderColor = '#ccc';
        profileImageDropZone.style.backgroundColor = '#fff';

        // Clear temporary file
        if (window.tempProfileImageFile) {
          delete window.tempProfileImageFile;
        }

        // TODO: Remove from server if uploaded
      };

      // Attachments Upload Functionality
      const attachmentsDropZone = document.getElementById('attachmentsDropZone');
      const attachmentsInput = document.getElementById('attachmentsInput');
      const attachmentsList = document.getElementById('attachmentsList');

      // Attachments: Click to browse
      attachmentsDropZone.addEventListener('click', (e) => {
        // Don't trigger if clicking on attachment items
        if (e.target.closest('.attachment-item')) return;
        attachmentsInput.click();
      });

      // Attachments: File input change
      attachmentsInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => handleAttachmentFile(file));
      });

      // Attachments: Drag and drop
      attachmentsDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        attachmentsDropZone.style.borderColor = '#000';
        attachmentsDropZone.style.backgroundColor = '#f0f0f0';
      });

      attachmentsDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        attachmentsDropZone.style.borderColor = '#ccc';
        attachmentsDropZone.style.backgroundColor = '#fff';
      });

      attachmentsDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        attachmentsDropZone.style.borderColor = '#ccc';
        attachmentsDropZone.style.backgroundColor = '#fff';

        const files = Array.from(e.dataTransfer.files);
        files.forEach(file => handleAttachmentFile(file));
      });

      // Attachments: Paste functionality (Ctrl+V)
      document.addEventListener('paste', (e) => {
        if (document.activeElement.closest('#attachmentsDropZone')) {
          const items = e.clipboardData.items;
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.kind === 'file') {
              const file = item.getAsFile();
              handleAttachmentFile(file);
            }
          }
        }
      });

      // Attachments: Handle file processing
      function handleAttachmentFile(file) {
        // Validate file type
        const allowedTypes = ['image/', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/'];
        const isAllowed = allowedTypes.some(type => file.type.startsWith(type) || file.name.toLowerCase().endsWith('.pdf', '.doc', '.docx', '.txt'));

        if (!isAllowed) {
          showModal({
            title: 'Unsupported File Type',
            body: 'Please upload PDF, DOC, DOCX, TXT, or image files only.',
            buttons: [{ text: 'OK', action: 'close' }]
          });
          return;
        }

        // Add to UI
        addAttachmentToList(file);

        // Upload to server if we have a quotation ID
        if (currentQuotationId) {
          uploadAttachment(file, currentQuotationId);
        } else {
          // Store files temporarily until quotation is saved
          if (!window.tempAttachmentFiles) {
            window.tempAttachmentFiles = [];
          }
          window.tempAttachmentFiles.push(file);
        }
      }

      // Attachments: Add to UI list
      function addAttachmentToList(file) {
        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.style.cssText = 'display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #ddd; margin-bottom:5px; background:#fff;';

        const fileIcon = getFileIcon(file.type, file.name);
        const fileName = document.createElement('span');
        fileName.textContent = file.name;
        fileName.style.cssText = 'flex:1; font-size:12px; cursor:pointer;';
        fileName.onclick = () => previewFile(file);

        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.className = 'btn';
        renameBtn.style.cssText = 'font-size:10px; padding:2px 6px;';
        renameBtn.onclick = () => renameAttachment(file, attachmentItem);

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Ã—';
        removeBtn.className = 'btn';
        removeBtn.style.cssText = 'font-size:12px; padding:2px 6px; background:#ff6b6b; color:white;';
        removeBtn.onclick = () => removeAttachment(file, attachmentItem);

        attachmentItem.appendChild(fileIcon);
        attachmentItem.appendChild(fileName);
        attachmentItem.appendChild(renameBtn);
        attachmentItem.appendChild(removeBtn);

        // Hide placeholder if this is the first attachment
        const placeholder = attachmentsList.querySelector('.text-align\\:center');
        if (placeholder) {
          placeholder.style.display = 'none';
        }

        attachmentsList.appendChild(attachmentItem);
      }

      // Attachments: Get file icon
      function getFileIcon(mimeType, fileName) {
        const icon = document.createElement('span');
        icon.style.cssText = 'font-size:16px;';

        if (mimeType.startsWith('image/')) {
          icon.textContent = 'ðŸ–¼ï¸';
        } else if (mimeType === 'application/pdf') {
          icon.textContent = 'ðŸ“„';
        } else if (mimeType.includes('word') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
          icon.textContent = 'ðŸ“';
        } else {
          icon.textContent = 'ðŸ“„';
        }

        return icon;
      }

      // Attachments: Preview file
      function previewFile(file) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            showModal({
              title: file.name,
              body: `<img src="${e.target.result}" style="max-width:100%; max-height:400px;">`,
              buttons: [{ text: 'Close', action: 'close' }]
            });
          };
          reader.readAsDataURL(file);
        } else {
          showModal({
            title: 'Preview Not Available',
            body: `Preview for ${file.name} is not available in the browser. The file will be saved with the quotation.`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        }
      }

      // Attachments: Rename functionality
      function renameAttachment(file, attachmentItem) {
        const currentName = file.name;
        const newName = prompt('Enter new filename:', currentName);
        if (newName && newName !== currentName) {
          // Update file name display
          const fileNameSpan = attachmentItem.querySelector('span');
          fileNameSpan.textContent = newName;

          // Update file object (create a new one with the new name)
          const newFile = new File([file], newName, { type: file.type });
          Object.setPrototypeOf(newFile, File.prototype);

          // Replace in temporary storage
          if (window.tempAttachmentFiles) {
            const index = window.tempAttachmentFiles.indexOf(file);
            if (index !== -1) {
              window.tempAttachmentFiles[index] = newFile;
            }
          }

          // TODO: Handle server-side rename if already uploaded
        }
      }

      // Attachments: Remove functionality
      function removeAttachment(file, attachmentItem) {
        attachmentItem.remove();

        // Remove from temporary storage
        if (window.tempAttachmentFiles) {
          const index = window.tempAttachmentFiles.indexOf(file);
          if (index !== -1) {
            window.tempAttachmentFiles.splice(index, 1);
          }
        }

        // Show placeholder if no attachments left
        const attachmentItems = attachmentsList.querySelectorAll('.attachment-item');
        if (attachmentItems.length === 0) {
          const placeholder = attachmentsList.querySelector('.text-align\\:center') || attachmentsList.querySelector('div');
          if (placeholder) {
            placeholder.style.display = 'block';
          }
        }

        // TODO: Remove from server if uploaded
      }

      // Load existing profile image for editing
      async function loadExistingProfileImage(quotationId) {
        try {
          const response = await fetch(`/api/quotations/${quotationId}`);
          const result = await response.json();

          if (result.success && result.quotation && result.quotation.profileImagePath) {
            // Display existing profile image
            profileImagePreview.style.backgroundImage = `url(/${result.quotation.profileImagePath})`;
            profileImagePreview.style.display = 'block';
            profileImagePlaceholder.style.display = 'none';
            removeProfileImageBtn.style.display = 'inline-block';

            // Update drop zone styling
            profileImageDropZone.style.borderColor = '#000';
            profileImageDropZone.style.backgroundColor = '#f9f9f9';
          }
        } catch (error) {
          console.warn('Failed to load existing profile image:', error);
        }
      }
    }

    // File upload helper functions
    async function uploadProfileImage(file, quotationId) {
      const formData = new FormData();
      formData.append('profileImage', file);

      try {
        const response = await fetch(`/api/quotations/${quotationId}/upload-profile-image`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Upload failed');
        }

        console.log('Profile image uploaded:', result.profileImagePath);
      } catch (error) {
        console.error('Error uploading profile image:', error);
        showModal({
          title: 'Upload Error',
          body: 'Failed to upload profile image: ' + error.message,
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    async function uploadAttachment(file, quotationId) {
      const formData = new FormData();
      formData.append('attachments', file);

      try {
        const response = await fetch(`/api/quotations/${quotationId}/upload-attachments`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Upload failed');
        }

        console.log('Attachment uploaded:', result.attachmentPaths);
      } catch (error) {
        console.error('Error uploading attachment:', error);
        showModal({
          title: 'Upload Error',
          body: 'Failed to upload attachment: ' + error.message,
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    function resetFileUploadUI() {
      // Reset profile image UI
      const profileImagePreview = document.getElementById('profileImagePreview');
      const profileImagePlaceholder = document.getElementById('profileImagePlaceholder');
      const removeProfileImageBtn = document.getElementById('removeProfileImageBtn');
      const profileImageInput = document.getElementById('profileImageInput');

      if (profileImagePreview) {
        profileImagePreview.style.backgroundImage = '';
        profileImagePreview.style.display = 'none';
      }
      if (profileImagePlaceholder) {
        profileImagePlaceholder.style.display = 'block';
      }
      if (removeProfileImageBtn) {
        removeProfileImageBtn.style.display = 'none';
      }
      if (profileImageInput) {
        profileImageInput.value = '';
      }

      // Reset attachments UI
      const attachmentsList = document.getElementById('attachmentsList');
      const attachmentsInput = document.getElementById('attachmentsInput');

      if (attachmentsList) {
        // Remove all attachment items except the placeholder
        const attachmentItems = attachmentsList.querySelectorAll('.attachment-item');
        attachmentItems.forEach(item => item.remove());

        // Show placeholder
        const placeholder = attachmentsList.querySelector('div');
        if (placeholder) {
          placeholder.style.display = 'block';
        }
      }

      if (attachmentsInput) {
        attachmentsInput.value = '';
      }
    }

    function generateQuotationContentForView(tagType, tagName, quotation) {
      // Same split layout as create form but for view mode (form left, files right)
      return '<div style="display:flex; height:650px;">' +
        // Left side: Form (70% width) - same as create form
        '<div style="flex:0 0 70%; overflow-y:auto; padding-right:10px;">' +
          '<form id="quotationForm">' +
            '<div style="margin-bottom:20px;">' +
              '<h4>Customer Information</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Customer Name *</label>' +
                  '<div class="autocomplete-container">' +
                    '<input type="text" id="quotationCustomerName" class="autocomplete-input" placeholder="Enter customer name" autocomplete="off" value="' + (quotation.customerName || '') + '">' +
                    '<div id="customerAutocompleteDropdown" class="autocomplete-dropdown"></div>' +
                  '</div>' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Contact Person</label>' +
                  '<select id="quotationContactPerson" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">' +
                    '<option value="">Select Contact Person</option>' +
                    (quotation.contactPerson ? '<option value="' + quotation.contactPerson + '" selected>' + quotation.contactPerson + '</option>' : '') +
                  '</select>' +
                '</div>' +
              '</div>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Email</label>' +
                  '<input type="email" id="quotationEmail" style="width:100%; padding:8px; border:1px solid #000;" placeholder="customer@email.com" value="' + (quotation.email || '') + '">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Phone</label>' +
                  '<input type="tel" id="quotationPhone" style="width:100%; padding:8px; border:1px solid #000;" placeholder="+852 1234 5678" value="' + (quotation.phone || '') + '">' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Product Specifications</h4>' +
              getProductSpecificFieldsForView(tagType, quotation.productDetails || {}) +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Quantity & Pricing</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Quantity *</label>' +
                  '<input type="number" id="quotationQuantity" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1000" min="1" value="' + (quotation.quantity || '') + '">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Unit Price (HKD)</label>' +
                  '<input type="number" id="quotationUnitPrice" style="width:100%; padding:8px; border:1px solid #000;" placeholder="0.50" step="0.01" min="0" value="' + (quotation.unitPrice ? quotation.unitPrice.toFixed(2) : '') + '">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Total (Auto)</label>' +
                  '<input type="text" id="quotationTotal" style="width:100%; padding:8px; border:1px solid #000; background:#f5f5f5;" readonly value="' + (quotation.total ? quotation.total.toFixed(2) : '') + '">' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Additional Notes</h4>' +
              '<textarea id="quotationNotes" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;" placeholder="Special requirements, delivery instructions, etc.">' + (quotation.notes || '') + '</textarea>' +
            '</div>' +
          '</form>' +
        '</div>' +

        // Right side: File uploads (30% width) - populated with saved data
        '<div id="quotationFileUploads" style="flex:0 0 30%; display:flex; flex-direction:column; gap:15px;">' +
          // Profile Image Upload (upper 30%)
          '<div style="flex:0 0 30%; border:1px solid #000; padding:10px; background:#fafafa; margin:20px;">' +
            '<h5 style="margin:0 0 10px 0; font-size:14px;">Profile Image</h5>' +
            '<div id="profileImageDropZone" style="width:100%; height:120px; border:2px dashed #ccc; border-radius:0; display:flex; align-items:center; justify-content:center; background:#fff; position:relative; overflow:hidden;">' +
              (quotation.profileImagePath ?
                '<img src="/' + quotation.profileImagePath + '" style="width:100%; height:100%; object-fit:cover;" alt="Profile Image" onerror="console.error(\'Failed to load image: /' + quotation.profileImagePath + '\'); this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';">' +
                '<div style="display:none; text-align:center; color:#666; width:100%;">' +
                  '<div style="font-size:24px; margin-bottom:5px;">ðŸ–¼ï¸âŒ</div>' +
                  '<div style="font-size:12px;">Image failed to load</div>' +
                  '<div style="font-size:10px; margin-top:5px;">' + quotation.profileImagePath + '</div>' +
                '</div>'
              :
                '<div style="text-align:center; color:#666;">' +
                  '<div style="font-size:24px; margin-bottom:5px;">ðŸ“·</div>' +
                  '<div style="font-size:12px;">No image uploaded</div>' +
                '</div>'
              ) +
            '</div>' +
          '</div>' +

          // Attachments Upload (lower 70%)
          '<div style="flex:1; border:1px solid #000; padding:10px; background:#fafafa; overflow:hidden; display:flex; flex-direction:column; margin:20px;">' +
            '<h5 style="margin:0 0 10px 0; font-size:14px;">Attachments</h5>' +
            '<div id="attachmentsDropZone" style="flex:1; border:2px dashed #ccc; border-radius:0; display:flex; flex-direction:column; background:#fff; position:relative; overflow-y:auto;">' +
              '<div id="attachmentsList" style="flex:1; padding:10px;">' +
                (quotation.attachmentPaths && quotation.attachmentPaths.length > 0 ?
                  quotation.attachmentPaths.map(attachmentPath => {
                    const fileName = attachmentPath.split('/').pop() || attachmentPath.split('\\\\').pop();
                    const fileIcon = getFileIconFromPath(attachmentPath);
                    return '<div style="display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #ddd;">' +
                      '<span style="font-size: 16px;">' + fileIcon + '</span>' +
                      '<span style="flex: 1; font-size: 12px; cursor: pointer;" onclick="previewAttachment(\'' + attachmentPath + '\')">' + fileName + '</span>' +
                      '<a href="/' + attachmentPath + '" download="' + fileName + '" style="font-size: 12px; color: #000; text-decoration: none;">ðŸ“¥</a>' +
                    '</div>';
                  }).join('') :
                  '<div style="text-align:center; color:#666; font-size:12px;">' +
                    '<div style="font-size:20px; margin-bottom:5px;">ðŸ“Ž</div>' +
                    '<div>No attachments uploaded</div>' +
                  '</div>'
                ) +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function generateQuotationContent(tagType, tagName, source = 'non email', isDummy2Mode = false) {
      console.log('=== generateQuotationContent called ===');
      console.log('tagType:', tagType);
      console.log('tagName:', tagName);
      console.log('source:', source);
      console.log('isDummy2Mode:', isDummy2Mode);

      // Determine if customer fields should be disabled
      const customerFieldsDisabled = isDummy2Mode;
      const disabledStyle = customerFieldsDisabled ? 'background:#f5f5f5; color:#999; cursor:not-allowed;' : '';
      const disabledAttr = customerFieldsDisabled ? 'disabled' : '';

      // Base form structure with split layout (left: form, right: file uploads)
      return '<div style="display:flex; height:600px;">' +
        // Left side: Form (70% width)
        '<div style="flex:0 0 70%; overflow-y:auto; padding-right:10px;">' +
          '<form id="quotationForm">' +
            '<div style="margin-bottom:20px;">' +
              '<h4>Customer Information</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Customer Name *</label>' +
                  '<div class="autocomplete-container">' +
                    '<input type="text" id="quotationCustomerName" class="autocomplete-input" placeholder="Enter customer name" autocomplete="off" ' + disabledAttr + ' style="width:100%; padding:8px; border:1px solid #000; ' + disabledStyle + '">' +
                    '<div id="customerAutocompleteDropdown" class="autocomplete-dropdown"></div>' +
                  '</div>' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Contact Person</label>' +
                  '<select id="quotationContactPerson" style="width:100%; padding:8px; border:1px solid #000; background:#fff; ' + disabledStyle + '" ' + disabledAttr + '>' +
                    '<option value="">Select Contact Person</option>' +
                  '</select>' +
                '</div>' +
              '</div>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Email</label>' +
                  '<input type="email" id="quotationEmail" style="width:100%; padding:8px; border:1px solid #000; ' + disabledStyle + '" placeholder="customer@email.com" ' + disabledAttr + '>' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Phone</label>' +
                  '<input type="tel" id="quotationPhone" style="width:100%; padding:8px; border:1px solid #000; ' + disabledStyle + '" placeholder="+852 1234 5678" ' + disabledAttr + '>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Product Specifications</h4>' +
              '<div style="margin-bottom:15px;">' +
                '<label style="display:block; margin-bottom:5px; font-weight:600;">Product Type *</label>' +
                '<select id="quotationProductType" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">' +
                  '<option value="hang-tag"' + (tagType === 'hang-tag' ? ' selected' : '') + '>Hang Tag</option>' +
                  '<option value="woven-label"' + (tagType === 'woven-label' ? ' selected' : '') + '>Woven Label</option>' +
                  '<option value="care-label"' + (tagType === 'care-label' ? ' selected' : '') + '>Care Label</option>' +
                  '<option value="heat-transfer"' + (tagType === 'heat-transfer' ? ' selected' : '') + '>Heat Transfer</option>' +
                  '<option value="outsource"' + (tagType === 'outsource' || tagType === 'other' || tagType === 'others' ? ' selected' : '') + '>Outsource</option>' +
                '</select>' +
              '</div>' +
              getProductSpecificFields(tagType) +
            '</div>' +

            '<div id="supplierSelectionSection" style="margin-bottom:20px; display:none;">' +
              '<h4>Supplier Selection</h4>' +
              '<div style="margin-bottom:10px;">' +
                '<label style="display:block; margin-bottom:5px; font-weight:600;">Select Suppliers</label>' +
                '<div class="autocomplete-container">' +
                  '<input type="text" id="quotationSupplierSearch" class="autocomplete-input" placeholder="Search and add suppliers..." autocomplete="off" style="width:100%; padding:8px; border:1px solid #000;">' +
                  '<div id="supplierAutocompleteDropdown" class="autocomplete-dropdown"></div>' +
                '</div>' +
              '</div>' +
              '<div id="selectedSuppliersList" style="display:flex; flex-wrap:wrap; gap:8px; min-height:40px; padding:10px; border:1px solid #ccc; background:#fafafa;">' +
                '<div style="color:#999; font-size:14px;">No suppliers selected</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Quantity & Pricing</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Quantity *</label>' +
                  '<input type="number" id="quotationQuantity" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1000" min="1">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Unit Price (HKD)</label>' +
                  '<input type="number" id="quotationUnitPrice" style="width:100%; padding:8px; border:1px solid #000;" placeholder="0.50" step="0.01" min="0">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Total (Auto)</label>' +
                  '<input type="text" id="quotationTotal" style="width:100%; padding:8px; border:1px solid #000; background:#f5f5f5;" readonly>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Additional Notes</h4>' +
              '<textarea id="quotationNotes" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;" placeholder="Special requirements, delivery instructions, etc."></textarea>' +
            '</div>' +

            '<div style="display:flex; gap:10px; justify-content:flex-end;">' +
              '<button type="button" class="page-btn" onclick="fillDummyQuotationData(true)">Dummy 2</button>' +
              '<button type="button" class="page-btn" onclick="fillDummyQuotationForm()">Dummy Fill</button>' +
              '<button type="button" class="page-btn" onclick="clearQuotationForm()">Clear</button>' +
              '<button type="button" class="page-btn" onclick="saveQuotationWithConfirmation(\'' + tagType + '\', \'' + source + '\')">SAVE</button>' +
              '<button type="button" class="page-btn primary" onclick="generateQuotation(\'' + tagType + '\')">Generate PDF</button>' +
            '</div>' +
          '</form>' +
        '</div>' +

        // Right side: File uploads (30% width)
        '<div id="quotationFileUploads" style="flex:0 0 30%; display:flex; flex-direction:column; gap:15px;">' +
          // Profile Image Upload (upper 30%)
          '<div style="flex:0 0 30%; border:1px solid #000; padding:10px; background:#fafafa; margin:20px;">' +
            '<h5 style="margin:0 0 10px 0; font-size:14px;">Profile Image</h5>' +
            '<div id="profileImageDropZone" style="width:100%; height:120px; border:2px dashed #ccc; border-radius:0; display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative; overflow:hidden;">' +
              '<div id="profileImagePreview" style="width:100%; height:100%; display:none; background-size:cover; background-repeat:no-repeat; background-position:center; position:absolute; top:0; left:0; z-index:1;"></div>' +
              '<div id="profileImagePlaceholder" style="text-align:center; color:#666; position:relative; z-index:2;">' +
                '<div style="font-size:24px; margin-bottom:5px;">ðŸ“·</div>' +
                '<div style="font-size:12px;">Drop image here or click to browse</div>' +
                '<div style="font-size:10px; margin-top:5px;">(Ctrl+V or Ctrl+P to paste)</div>' +
              '</div>' +
              '<input type="file" id="profileImageInput" accept="image/*" style="display:none; position:relative; z-index:3;">' +
            '</div>' +
            '<div style="margin-top:5px; text-align:center; position:relative; z-index:4;">' +
              '<button type="button" class="btn" id="removeProfileImageBtn" style="display:none; font-size:12px; padding:4px 8px;" onclick="removeProfileImage()">Remove</button>' +
            '</div>' +
          '</div>' +

          // Attachments Upload (lower 70%)
          '<div style="flex:1; border:1px solid #000; padding:10px; background:#fafafa; overflow:hidden; display:flex; flex-direction:column; margin:20px;">' +
            '<h5 style="margin:0 0 10px 0; font-size:14px;">Attachments</h5>' +
            '<div id="attachmentsDropZone" style="flex:1; border:2px dashed #ccc; border-radius:0; display:flex; flex-direction:column; background:#fff; cursor:pointer; position:relative; overflow-y:auto;">' +
              '<div id="attachmentsList" style="flex:1; padding:10px;">' +
                '<div style="text-align:center; color:#666; font-size:12px;">' +
                  '<div style="font-size:20px; margin-bottom:5px;">ðŸ“Ž</div>' +
                  '<div>Drop files here or click to browse</div>' +
                  '<div style="font-size:10px; margin-top:5px;">(Ctrl+V or Ctrl+P to paste)</div>' +
                  '<div style="font-size:10px; margin-top:2px;">Supports: PDF, DOC, images, text files</div>' +
                '</div>' +
              '</div>' +
              '<input type="file" id="attachmentsInput" multiple style="display:none;">' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function getProductSpecificFields(tagType) {
      const fields = {
        'hang-tag': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material</label>
              <select id="quotationMaterial" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="paper">Paper</option>
                <option value="cardboard">Cardboard</option>
                <option value="plastic">Plastic</option>
                <option value="fabric">Fabric</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Size</label>
              <input type="text" id="quotationSize" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2x3 inches">
            </div>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Printing Method</label>
            <select id="quotationPrintingMethod" style="width:100%; padding:8px; border:1px solid #000;">
              <option value="">Select Printing Method</option>
              <option value="screen-printing">Screen Printing</option>
              <option value="digital-printing">Digital Printing</option>
              <option value="offset-printing">Offset Printing</option>
              <option value="embroidery">Embroidery</option>
            </select>
          </div>
        `,
        'woven-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Width</label>
              <input type="text" id="quotationWidth" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1 inch">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Length</label>
              <input type="text" id="quotationLength" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2 inches">
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Color Count</label>
              <select id="quotationColorCount" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="1">1 Color</option>
                <option value="2">2 Colors</option>
                <option value="3">3 Colors</option>
                <option value="4">4+ Colors</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Edge Finish</label>
              <select id="quotationEdgeFinish" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="cut">Cut Edge</option>
                <option value="hemmed">Hemmed Edge</option>
                <option value="overlocked">Overlocked</option>
              </select>
            </div>
          </div>
        `,
        'care-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material Type</label>
              <select id="quotationMaterialType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="satin">Satin Tape</option>
                <option value="cotton">Cotton Tape</option>
                <option value="woven">Woven Fabric</option>
                <option value="paper">Paper</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Wash Care Symbols</label>
              <input type="text" id="quotationWashSymbols" style="width:100%; padding:8px; border:1px solid #000;" placeholder="Machine wash, tumble dry, etc.">
            </div>
          </div>
        `,
        'heat-transfer': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Transfer Type</label>
              <select id="quotationTransferType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Type</option>
                <option value="screen-print">Screen Print Transfer</option>
                <option value="digital-print">Digital Print Transfer</option>
                <option value="vinyl-cut">Vinyl Cut Transfer</option>
                <option value="sublimation">Sublimation Transfer</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Application Method</label>
              <select id="quotationApplication" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="heat-press">Heat Press</option>
                <option value="iron">Household Iron</option>
                <option value="commercial">Commercial Press</option>
              </select>
            </div>
          </div>
        `,
        'others': `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Product Description *</label>
            <textarea id="quotationProductDescription" style="width:100%; min-height:60px; padding:8px; border:1px solid #000;" placeholder="Describe the custom product or service..."></textarea>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Category</label>
              <input type="text" id="quotationCategory" style="width:100%; padding:8px; border:1px solid #000;" placeholder="e.g., Packaging, Stickers">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Complexity</label>
              <select id="quotationComplexity" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="simple">Simple</option>
                <option value="medium">Medium</option>
                <option value="complex">Complex</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
        `
      };

      return fields[tagType] || fields['others'];
    }

    function getProductSpecificFieldsForView(tagType, productDetails) {
      const fields = {
        'hang-tag': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material</label>
              <select id="quotationMaterial" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="paper" ${productDetails.material === 'paper' ? 'selected' : ''}>Paper</option>
                <option value="cardboard" ${productDetails.material === 'cardboard' ? 'selected' : ''}>Cardboard</option>
                <option value="plastic" ${productDetails.material === 'plastic' ? 'selected' : ''}>Plastic</option>
                <option value="fabric" ${productDetails.material === 'fabric' ? 'selected' : ''}>Fabric</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Size</label>
              <input type="text" id="quotationSize" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2x3 inches" value="${productDetails.size || ''}">
            </div>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Printing Method</label>
            <select id="quotationPrintingMethod" style="width:100%; padding:8px; border:1px solid #000;">
              <option value="">Select Printing Method</option>
              <option value="screen-printing" ${productDetails.printingMethod === 'screen-printing' ? 'selected' : ''}>Screen Printing</option>
              <option value="digital-printing" ${productDetails.printingMethod === 'digital-printing' ? 'selected' : ''}>Digital Printing</option>
              <option value="offset-printing" ${productDetails.printingMethod === 'offset-printing' ? 'selected' : ''}>Offset Printing</option>
              <option value="embroidery" ${productDetails.printingMethod === 'embroidery' ? 'selected' : ''}>Embroidery</option>
            </select>
          </div>
        `,
        'woven-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Width</label>
              <input type="text" id="quotationWidth" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1 inch" value="${productDetails.width || ''}">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Length</label>
              <input type="text" id="quotationLength" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2 inches" value="${productDetails.length || ''}">
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Color Count</label>
              <select id="quotationColorCount" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="1" ${productDetails.colorCount === '1' ? 'selected' : ''}>1 Color</option>
                <option value="2" ${productDetails.colorCount === '2' ? 'selected' : ''}>2 Colors</option>
                <option value="3" ${productDetails.colorCount === '3' ? 'selected' : ''}>3 Colors</option>
                <option value="4" ${productDetails.colorCount === '4' ? 'selected' : ''}>4+ Colors</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Edge Finish</label>
              <select id="quotationEdgeFinish" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="cut" ${productDetails.edgeFinish === 'cut' ? 'selected' : ''}>Cut Edge</option>
                <option value="hemmed" ${productDetails.edgeFinish === 'hemmed' ? 'selected' : ''}>Hemmed Edge</option>
                <option value="overlocked" ${productDetails.edgeFinish === 'overlocked' ? 'selected' : ''}>Overlocked</option>
              </select>
            </div>
          </div>
        `,
        'care-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material Type</label>
              <select id="quotationMaterialType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="satin" ${productDetails.materialType === 'satin' ? 'selected' : ''}>Satin Tape</option>
                <option value="cotton" ${productDetails.materialType === 'cotton' ? 'selected' : ''}>Cotton Tape</option>
                <option value="woven" ${productDetails.materialType === 'woven' ? 'selected' : ''}>Woven Fabric</option>
                <option value="paper" ${productDetails.materialType === 'paper' ? 'selected' : ''}>Paper</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Wash Care Symbols</label>
              <input type="text" id="quotationWashSymbols" style="width:100%; padding:8px; border:1px solid #000;" placeholder="Machine wash, tumble dry, etc." value="${productDetails.washSymbols || ''}">
            </div>
          </div>
        `,
        'heat-transfer': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Transfer Type</label>
              <select id="quotationTransferType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Type</option>
                <option value="screen-print" ${productDetails.transferType === 'screen-print' ? 'selected' : ''}>Screen Print Transfer</option>
                <option value="digital-print" ${productDetails.transferType === 'digital-print' ? 'selected' : ''}>Digital Print Transfer</option>
                <option value="vinyl-cut" ${productDetails.transferType === 'vinyl-cut' ? 'selected' : ''}>Vinyl Cut Transfer</option>
                <option value="sublimation" ${productDetails.transferType === 'sublimation' ? 'selected' : ''}>Sublimation Transfer</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Application Method</label>
              <select id="quotationApplication" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="heat-press" ${productDetails.application === 'heat-press' ? 'selected' : ''}>Heat Press</option>
                <option value="iron" ${productDetails.application === 'iron' ? 'selected' : ''}>Household Iron</option>
                <option value="commercial" ${productDetails.application === 'commercial' ? 'selected' : ''}>Commercial Press</option>
              </select>
            </div>
          </div>
        `,
        'others': `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Product Description *</label>
            <textarea id="quotationProductDescription" style="width:100%; min-height:60px; padding:8px; border:1px solid #000;" placeholder="Describe the custom product or service...">${productDetails.productDescription || ''}</textarea>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Category</label>
              <input type="text" id="quotationCategory" style="width:100%; padding:8px; border:1px solid #000;" placeholder="e.g., Packaging, Stickers" value="${productDetails.category || ''}">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Complexity</label>
              <select id="quotationComplexity" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="simple" ${productDetails.complexity === 'simple' ? 'selected' : ''}>Simple</option>
                <option value="medium" ${productDetails.complexity === 'medium' ? 'selected' : ''}>Medium</option>
                <option value="complex" ${productDetails.complexity === 'complex' ? 'selected' : ''}>Complex</option>
                <option value="custom" ${productDetails.complexity === 'custom' ? 'selected' : ''}>Custom</option>
              </select>
            </div>
          </div>
        `
      };

      return fields[tagType] || fields['others'];
    }

    // Supplier autocomplete and tag management functions
    function setupSupplierAutocomplete() {
      const supplierInput = document.getElementById('quotationSupplierSearch');
      const dropdown = document.getElementById('supplierAutocompleteDropdown');

      if (!supplierInput || !dropdown) return;

      let allSuppliers = [];
      let selectedSuppliers = new Set();

      // Load suppliers from API
      loadSuppliersFromStorage().then(suppliers => {
        allSuppliers = suppliers;
      });

      supplierInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();

        if (searchTerm.length === 0) {
          dropdown.style.display = 'none';
          return;
        }

        // Filter suppliers
        const matches = allSuppliers.filter(supplier =>
          !selectedSuppliers.has(supplier.id) &&
          (supplier.companyName.toLowerCase().includes(searchTerm) ||
           supplier.emailDomain.toLowerCase().includes(searchTerm))
        );

        if (matches.length === 0) {
          dropdown.innerHTML = '<div class="autocomplete-no-results">No suppliers found</div>';
          dropdown.style.display = 'block';
          return;
        }

        // Build dropdown HTML
        dropdown.innerHTML = matches.slice(0, 10).map(supplier => `
          <div class="autocomplete-item" data-supplier-id="${supplier.id}">
            <div style="font-weight:600;">${escapeHtml(supplier.companyName)}</div>
            <div style="font-size:12px; color:#666;">${escapeHtml(supplier.emailDomain)}</div>
          </div>
        `).join('');

        dropdown.style.display = 'block';

        // Add click handlers
        dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
          item.addEventListener('click', function() {
            const supplierId = parseInt(this.getAttribute('data-supplier-id'));
            const supplier = allSuppliers.find(s => s.id === supplierId);
            if (supplier) {
              addSupplierTag(supplier);
              selectedSuppliers.add(supplierId);
              supplierInput.value = '';
              dropdown.style.display = 'none';
            }
          });
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!supplierInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
    }

    function addSupplierTag(supplier) {
      const container = document.getElementById('selectedSuppliersList');

      // Remove "no suppliers" message if present
      const noSuppliersMsg = container.querySelector('[style*="color:#999"]');
      if (noSuppliersMsg) {
        container.innerHTML = '';
      }

      // Create tag element
      const tag = document.createElement('div');
      tag.className = 'supplier-tag';
      tag.setAttribute('data-supplier-id', supplier.id);
      tag.innerHTML = `
        <span>${escapeHtml(supplier.companyName)}</span>
        <span class="supplier-tag-remove" onclick="removeSupplierTag(${supplier.id})">Ã—</span>
      `;

      container.appendChild(tag);
    }

    window.removeSupplierTag = function(supplierId) {
      const container = document.getElementById('selectedSuppliersList');
      const tag = container.querySelector(`[data-supplier-id="${supplierId}"]`);

      if (tag) {
        tag.remove();
      }

      // Show "no suppliers" message if empty
      if (container.children.length === 0) {
        container.innerHTML = '<div style="color:#999; font-size:14px;">No suppliers selected</div>';
      }
    };

    function getSelectedSupplierIds() {
      const container = document.getElementById('selectedSuppliersList');
      const tags = container.querySelectorAll('.supplier-tag[data-supplier-id]');
      return Array.from(tags).map(tag => parseInt(tag.getAttribute('data-supplier-id')));
    }

    function toggleSupplierSection(productType) {
      const supplierSection = document.getElementById('supplierSelectionSection');
      if (supplierSection) {
        if (productType === 'outsource' || productType === 'other' || productType === 'others') {
          supplierSection.style.display = 'block';
        } else {
          supplierSection.style.display = 'none';
        }
      }
    }

    // Global functions for quotation form
    window.clearQuotationForm = function() {
      const form = document.getElementById('quotationForm');
      if (form) {
        // Save customer field values if they're disabled (from email view)
        const customerNameField = document.getElementById('quotationCustomerName');
        const contactField = document.getElementById('quotationContactPerson');
        const emailField = document.getElementById('quotationEmail');
        const phoneField = document.getElementById('quotationPhone');

        const customerFieldsDisabled = customerNameField?.disabled || false;
        const savedCustomerName = customerNameField?.value || '';
        const savedContactPerson = contactField?.value || '';
        const savedContactPersonHTML = contactField?.innerHTML || '';
        const savedEmail = emailField?.value || '';
        const savedPhone = phoneField?.value || '';

        // Reset the form (clears all fields)
        form.reset();
        document.getElementById('quotationTotal').value = '';

        // If customer fields were disabled (from email view), restore their values and keep them disabled
        if (customerFieldsDisabled) {
          if (customerNameField) {
            customerNameField.value = savedCustomerName;
            customerNameField.disabled = true;
            customerNameField.style.backgroundColor = '#f5f5f5';
            customerNameField.style.color = '#999';
            customerNameField.style.cursor = 'not-allowed';
          }
          if (contactField) {
            contactField.innerHTML = savedContactPersonHTML;
            contactField.value = savedContactPerson;
            contactField.disabled = true;
            contactField.style.backgroundColor = '#f5f5f5';
            contactField.style.color = '#999';
            contactField.style.cursor = 'not-allowed';
          }
          if (emailField) {
            emailField.value = savedEmail;
            emailField.disabled = true;
            emailField.style.backgroundColor = '#f5f5f5';
            emailField.style.color = '#999';
            emailField.style.cursor = 'not-allowed';
          }
          if (phoneField) {
            phoneField.value = savedPhone;
            phoneField.disabled = true;
            phoneField.style.backgroundColor = '#f5f5f5';
            phoneField.style.color = '#999';
            phoneField.style.cursor = 'not-allowed';
          }
        }

        // Clear edit mode
        window.editingQuotationId = null;

        // Reset file upload UI
        resetFileUploadUI();
      }
    };

    window.fillDummyQuotationForm = async function() {
      const form = document.getElementById('quotationForm');
      if (form) {
        fillDummyForm(form);

        // Check if supplier selection section is visible (for Outsource product type)
        const supplierSection = document.getElementById('supplierSelectionSection');
        if (supplierSection && supplierSection.style.display !== 'none') {
          // Clear existing selected suppliers
          const container = document.getElementById('selectedSuppliersList');
          if (container) {
            container.innerHTML = '<div style="color:#999; font-size:14px;">No suppliers selected</div>';
          }

          // Load suppliers from database and select random ones
          try {
            const suppliers = await loadSuppliersFromStorage();
            if (suppliers && suppliers.length > 0) {
              // Randomly select 1-3 suppliers
              const numSuppliersToSelect = Math.floor(Math.random() * 3) + 1; // 1 to 3 suppliers
              const selectedSuppliers = [];

              // Create a copy of suppliers array to avoid modifying original
              const availableSuppliers = [...suppliers];

              // Randomly select suppliers
              for (let i = 0; i < Math.min(numSuppliersToSelect, availableSuppliers.length); i++) {
                const randomIndex = Math.floor(Math.random() * availableSuppliers.length);
                selectedSuppliers.push(availableSuppliers[randomIndex]);
                availableSuppliers.splice(randomIndex, 1); // Remove selected supplier to avoid duplicates
              }

              // Add selected suppliers as tags
              selectedSuppliers.forEach(supplier => {
                addSupplierTag(supplier);
              });
            }
          } catch (error) {
            console.error('Failed to load suppliers for dummy data:', error);
          }
        }
      }
    };

    window.saveQuotationWithConfirmation = async function(tagType, source = 'non email') {
      console.log('=== saveQuotationWithConfirmation called ===');
      console.log('tagType:', tagType);
      console.log('source:', source);

      // Show confirmation modal (returns true for Yes, false for No)
      const sendToCustomer = await showModal({
        title: 'Save Quotation',
        body: 'Saved to quotation, do you want to send to customer directly?',
        okText: 'Yes',
        cancelText: 'No'
      });

      if (sendToCustomer) {
        // User clicked "Yes" - Save with status "send to customer" and send email
        try {
          const savedQuotation = await saveQuotation(tagType, source, 'send to customer');

          // If this is an email quotation, send the email
          if (source === 'email' && window.currentQuotationEmailMeta && savedQuotation) {
            console.log('=== AUTO-SENDING QUOTATION EMAIL ===');
            console.log('Email metadata:', window.currentQuotationEmailMeta);
            console.log('Saved quotation:', savedQuotation);

            try {
              await sendQuotationEmail(savedQuotation, window.currentQuotationEmailMeta);
              showModal({
                title: 'Success',
                body: 'Quotation saved and email sent to customer successfully!'
              });
            } catch (emailError) {
              console.error('Failed to send quotation email:', emailError);
              showModal({
                title: 'Warning',
                body: 'Quotation saved successfully, but failed to send email. You can send it manually later.'
              });
            }
          }
        } catch (error) {
          console.error('Error saving quotation:', error);
          showModal({
            title: 'Error',
            body: 'Failed to save quotation. Please try again.'
          });
        }
      } else {
        // User clicked "No" - Save with status "pending"
        try {
          await saveQuotation(tagType, source, 'pending');
        } catch (error) {
          console.error('Error saving quotation:', error);
          showModal({
            title: 'Error',
            body: 'Failed to save quotation. Please try again.'
          });
        }
      }
    };

    window.saveQuotation = async function(tagType, source = 'non email', status = 'draft') {
      console.log('=== saveQuotation called ===');
      console.log('tagType:', tagType);
      console.log('source:', source);
      console.log('source type:', typeof source);

      try {
        const customerName = document.getElementById('quotationCustomerName').value.trim();
        const contactPerson = document.getElementById('quotationContactPerson').value;
        const email = document.getElementById('quotationEmail').value.trim();
        const phone = document.getElementById('quotationPhone').value.trim();
        const quantity = document.getElementById('quotationQuantity').value;
        const unitPrice = document.getElementById('quotationUnitPrice').value;
        const total = document.getElementById('quotationTotal').value;
        const notes = document.getElementById('quotationNotes').value.trim();

        console.log('Saving quotation with data:', {
          customerName, contactPerson, email, phone, quantity, unitPrice, total, notes, tagType, source
        });

        // Get product-specific fields
        let productDetails = {};
        if (tagType === 'hang-tag') {
          productDetails = {
            material: document.getElementById('quotationMaterial')?.value || '',
            size: document.getElementById('quotationSize')?.value || '',
            printingMethod: document.getElementById('quotationPrintingMethod')?.value || ''
          };
        }
        // Add other product types as needed

        // Validation
        if (!customerName) {
          showModal({ title: 'Validation Error', body: 'Customer Name is required.' });
          return;
        }
        if (!quantity || quantity <= 0) {
          showModal({ title: 'Validation Error', body: 'Quantity must be greater than 0.' });
          return;
        }

        // Create quotation object first (without files)
        const quotation = {
          ...(window.editingQuotationId && { id: window.editingQuotationId }),
          customerName,
          contactPerson,
          email,
          phone,
          productType: tagType,
          productDetails,
          quantity: parseInt(quantity),
          unitPrice: parseFloat(unitPrice) || 0,
          total: parseFloat(total) || 0,
          notes,
          type: source,
          sourceEmailUid: (source === 'email' && window.currentQuotationEmailMeta) ? window.currentQuotationEmailMeta.uid : null,
          sourceEmailSubject: (source === 'email' && window.currentQuotationEmailMeta) ? window.currentQuotationEmailMeta.subject : null,
          sourceEmailMessageId: (source === 'email' && window.currentQuotationEmailMeta) ? window.currentQuotationEmailMeta.messageId : null,
          profileImagePath: null,
          attachmentPaths: [],
          dateCreated: new Date().toISOString(),
          status: status
        };

        console.log('=== QUOTATION OBJECT CREATED ===');
        console.log('quotation.type:', quotation.type);
        console.log('Full quotation object:', JSON.stringify(quotation, null, 2));

        // Save quotation to database first to get ID
        const savedQuotation = await saveQuotationToStorage(quotation);
        const quotationId = savedQuotation.id;

        // Now upload files with the actual quotation ID
        let profileImagePath = null;
        let attachmentPaths = [];

        console.log('Uploading files for quotation ID:', quotationId);
        console.log('Temp profile image file:', window.tempProfileImageFile ? 'EXISTS' : 'NOT SET');
        console.log('Temp attachment files:', window.tempAttachmentFiles ? window.tempAttachmentFiles.length : 'NOT SET');

        // Handle profile image
        if (window.tempProfileImageFile) {
          console.log('Uploading profile image file:', window.tempProfileImageFile.name, 'Size:', window.tempProfileImageFile.size);

          const profileFormData = new FormData();
          profileFormData.append('profileImage', window.tempProfileImageFile, window.tempProfileImageFile.name);

          console.log('FormData created, sending to:', `/api/quotations/${quotationId}/upload-profile-image`);

          try {
            const profileResponse = await fetch(`/api/quotations/${quotationId}/upload-profile-image`, {
              method: 'POST',
              body: profileFormData
            });

            console.log('Profile upload response status:', profileResponse.status);

            if (!profileResponse.ok) {
              const errorText = await profileResponse.text();
              console.error('Profile upload HTTP error:', profileResponse.status, errorText);
              throw new Error(`HTTP ${profileResponse.status}: ${errorText}`);
            }

            const profileResult = await profileResponse.json();
            console.log('Profile upload result:', profileResult);

            if (profileResult.success && profileResult.profileImagePath) {
              profileImagePath = profileResult.profileImagePath;
              console.log('Profile image uploaded successfully:', profileImagePath);
            } else {
              console.error('Profile upload failed:', profileResult.error || 'No path returned');
            }
          } catch (error) {
            console.error('Failed to upload profile image:', error);
            console.error('Error details:', error.message, error.stack);
          }
        } else {
          console.log('No profile image file to upload');
        }

        // Handle attachments
        if (window.tempAttachmentFiles && window.tempAttachmentFiles.length > 0) {
          const attachmentFormData = new FormData();
          window.tempAttachmentFiles.forEach(file => {
            attachmentFormData.append('attachments', file);
          });

          try {
            const attachmentResponse = await fetch(`/api/quotations/${quotationId}/upload-attachments`, {
              method: 'POST',
              body: attachmentFormData
            });
            const attachmentResult = await attachmentResponse.json();
            if (attachmentResult.success) {
              attachmentPaths = attachmentResult.attachmentPaths;
            }
          } catch (error) {
            console.warn('Failed to upload attachments:', error);
          }
        }

        // Update quotation with file paths if any files were uploaded
        console.log('Profile image path to save:', profileImagePath);
        console.log('Attachment paths to save:', attachmentPaths);

        let finalQuotation = savedQuotation;
        if (profileImagePath || attachmentPaths.length > 0) {
          const updateData = {
            ...savedQuotation,
            profileImagePath,
            attachmentPaths
          };
          console.log('Updating quotation with file data:', updateData);
          finalQuotation = await saveQuotationToStorage(updateData);
          console.log('Final quotation after update:', finalQuotation);
          console.log('Final profileImagePath:', finalQuotation.profileImagePath);
          console.log('Final attachmentPaths:', finalQuotation.attachmentPaths);
        }

        // Link suppliers to quotation (only if suppliers were selected)
        const supplierIds = getSelectedSupplierIds();
        if (supplierIds.length > 0 && quotationId) {
          console.log('Linking suppliers to quotation:', supplierIds);
          for (const supplierId of supplierIds) {
            try {
              await fetch(`/api/quotations/${quotationId}/suppliers/${supplierId}`, {
                method: 'POST'
              });
            } catch (error) {
              console.error(`Failed to link supplier ${supplierId}:`, error);
            }
          }
        }

        // Clear edit mode
        window.editingQuotationId = null;

        // Only show success modal if status is 'draft' or 'pending' (not when sending to customer)
        if (status === 'draft' || status === 'pending') {
          showModal({
            title: 'Success',
            body: `Quotation saved successfully with status: ${status}`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        }

        // Clear form and temporary files
        clearQuotationForm();

        // Clear temporary files
        delete window.tempProfileImageFile;
        delete window.tempAttachmentFiles;

        // Reset file upload UI
        resetFileUploadUI();

        // Refresh the quotations list to show the newly saved quotation
        await displayQuotations();

        // Return the final quotation for use by saveQuotationWithConfirmation
        return finalQuotation;

      } catch (error) {
        console.error('Error saving quotation:', error);
        showModal({
          title: 'Save Error',
          body: 'Failed to save quotation. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        throw error; // Re-throw so saveQuotationWithConfirmation can handle it
      }
    };

    async function saveQuotationToStorage(quotation) {
      try {
        console.log('saveQuotationToStorage called with:', quotation);
        let response;
        let result;

        if (quotation.id) {
          // Try to update first
          response = await fetch(`/api/quotations/${quotation.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(quotation)
          });

          // If quotation not found (404), try to create instead
          if (response.status === 404) {
            console.log('Quotation not found, creating new quotation instead');
            response = await fetch('/api/quotations', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...quotation, id: undefined }) // Remove ID for creation
            });
          }

          result = await response.json();
        } else {
          // Create new quotation
          response = await fetch('/api/quotations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(quotation)
          });
          result = await response.json();
        }

        if (!result.success) {
          throw new Error(result.error || 'Failed to save quotation');
        }

        // Update quotation ID if it was created (for new quotations that didn't have an ID)
        if (result.quotation && result.quotation.id && !quotation.id) {
          quotation.id = result.quotation.id;
          console.log('Assigned new quotation ID:', quotation.id);
        }

        console.log('Quotation saved successfully:', result.quotation);
        return result.quotation;
      } catch (error) {
        console.error('Error saving quotation to database:', error);
        throw error;
      }
    }

    async function loadQuotationsFromStorage() {
      try {
        const response = await fetch('/api/quotations');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load quotations');
        }
        return result.quotations || [];
      } catch (error) {
        console.error('Error loading quotations from database:', error);
        return [];
      }
    }

    // Load outsourcing quotations from separate API (only 'other' type)
    async function loadOutsourcingQuotationsFromStorage() {
      try {
        const response = await fetch('/api/quotations/outsourcing');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load outsourcing quotations');
        }
        return result.quotations || [];
      } catch (error) {
        console.error('Error loading outsourcing quotations from database:', error);
        return [];
      }
    }

    async function deleteQuotationFromStorage(quotationId) {
      try {
        console.log('Deleting quotation with ID:', quotationId);
        const response = await fetch(`/api/quotations/${quotationId}`, {
          method: 'DELETE'
        });

        console.log('Delete response status:', response.status);
        console.log('Delete response ok:', response.ok);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Delete failed with status:', response.status, 'Body:', errorText);
          throw new Error(`Failed to delete quotation: ${response.status} ${errorText}`);
        }

        const result = await response.json();
        console.log('Delete result:', result);

        if (!result.success) {
          throw new Error(result.error || 'Failed to delete quotation');
        }

        return true;
      } catch (error) {
        console.error('Error deleting quotation from database:', error);
        throw error;
      }
    }

    // Send quotation email as reply to original email
    async function sendQuotationEmail(quotation, emailMeta) {
      console.log('=== SENDING QUOTATION EMAIL ===');
      console.log('Quotation:', quotation);
      console.log('Email metadata:', emailMeta);

      // Fetch the original email content
      let originalEmailHtml = '';
      if (emailMeta && emailMeta.uid) {
        try {
          const response = await fetch(`/api/emails/${emailMeta.uid}`);
          const data = await response.json();
          if (data.success && data.source) {
            // Extract the original email body
            const source = data.source;
            const headerEndMatch = source.match(/\n\n|\r\n\r\n/);
            if (headerEndMatch) {
              let bodyPart = source.substring(headerEndMatch.index + headerEndMatch[0].length);

              // Decode MIME content if present
              if (bodyPart.includes('Content-Type:') || bodyPart.includes('Content-Transfer-Encoding:')) {
                console.log('Found MIME content in original email, attempting to decode...');
                try {
                  // Split by MIME boundary to get individual parts
                  const boundaryMatch = bodyPart.match(/------=_NextPart_[A-F0-9_]+/);

                  if (boundaryMatch) {
                    const boundary = boundaryMatch[0];
                    const parts = bodyPart.split(boundary);

                    let htmlContent = '';
                    let plainContent = '';

                    // Process each MIME part
                    for (const part of parts) {
                      if (!part.trim() || part.trim() === '--') continue;

                      const isHtml = part.includes('Content-Type: text/html');
                      const isPlain = part.includes('Content-Type: text/plain');
                      const isBase64 = part.includes('Content-Transfer-Encoding: base64');

                      if ((isHtml || isPlain) && isBase64) {
                        // Extract ONLY valid base64 characters (A-Z, a-z, 0-9, +, /, =, and whitespace)
                        const base64Match = part.match(/Content-Transfer-Encoding:\s*base64\s+([A-Za-z0-9+\/=\s]+)/i);

                        if (base64Match && base64Match[1]) {
                          try {
                            // Remove ALL whitespace
                            const base64String = base64Match[1].replace(/\s+/g, '');

                            if (base64String.length > 0) {
                              const decoded = atob(base64String);

                              if (isHtml) {
                                htmlContent = decoded;
                                console.log('Successfully decoded HTML content:', decoded.substring(0, 100));
                              } else if (isPlain) {
                                plainContent = decoded;
                                console.log('Successfully decoded plain text content:', decoded.substring(0, 100));
                              }
                            }
                          } catch (e) {
                            console.warn('Failed to decode base64:', e);
                          }
                        }
                      }
                    }

                    // Use decoded content if available (prefer HTML over plain text)
                    if (htmlContent || plainContent) {
                      bodyPart = htmlContent || plainContent;
                      console.log('Using decoded content for original email');
                    } else {
                      console.log('No MIME content was successfully decoded, using raw body');
                    }
                  } else {
                    console.log('No MIME boundary found, using raw body');
                  }
                } catch (e) {
                  console.warn('Failed to parse MIME content:', e);
                }
              }

              originalEmailHtml = bodyPart;
            }
          }
        } catch (err) {
          console.warn('Failed to fetch original email for threading:', err);
        }
      }

      // Generate HTML email content
      const emailHtml = generateQuotationEmailHtml(quotation, emailMeta, originalEmailHtml);

      // Prepare email subject with "Re:" prefix and "- Quotation" suffix
      const emailSubject = `Re: ${emailMeta.subject} - Quotation`;

      // Prepare email data
      const emailData = {
        to: emailMeta.email,
        subject: emailSubject,
        html: emailHtml,
        inReplyTo: emailMeta.messageId,
        references: emailMeta.messageId
      };

      console.log('Sending email with data:', emailData);

      // Send email via API
      const response = await fetch('/api/email/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(emailData)
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to send email');
      }

      console.log('Email sent successfully:', result);

      showModal({
        title: 'Success',
        body: 'Quotation saved and email sent successfully!',
        buttons: [{ text: 'OK', action: 'close' }]
      });

      return result;
    }

    // Generate HTML email content for quotation
    function generateQuotationEmailHtml(quotation, emailMeta, originalEmailHtml) {
      const productTypeNames = {
        'hang-tag': 'Hang Tag',
        'woven-label': 'Woven Label',
        'care-label': 'Care Label',
        'transfer': 'Transfer',
        'other': 'Other'
      };

      const productTypeName = productTypeNames[quotation.productType] || quotation.productType;

      let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .quotation-container { max-width: 800px; margin: 0 auto; padding: 20px; border: 2px solid #000; }
    .quotation-header { background: #000; color: #fff; padding: 15px; text-align: center; }
    .quotation-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    .quotation-section h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .quotation-row { display: flex; margin: 10px 0; }
    .quotation-label { font-weight: bold; width: 150px; }
    .quotation-value { flex: 1; }
    .quotation-total { font-size: 1.2em; font-weight: bold; color: #000; text-align: right; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="quotation-container">
    <div class="quotation-header">
      <h2>QUOTATION</h2>
      <p>${productTypeName}</p>
    </div>

    <div class="quotation-section">
      <h3>Customer Information</h3>
      <div class="quotation-row">
        <div class="quotation-label">Customer Name:</div>
        <div class="quotation-value">${quotation.customerName || 'N/A'}</div>
      </div>
      <div class="quotation-row">
        <div class="quotation-label">Contact Person:</div>
        <div class="quotation-value">${quotation.contactPerson || 'N/A'}</div>
      </div>
      <div class="quotation-row">
        <div class="quotation-label">Email:</div>
        <div class="quotation-value">${quotation.email || 'N/A'}</div>
      </div>
      <div class="quotation-row">
        <div class="quotation-label">Phone:</div>
        <div class="quotation-value">${quotation.phone || 'N/A'}</div>
      </div>
    </div>

    <div class="quotation-section">
      <h3>Product Details</h3>
      <div class="quotation-row">
        <div class="quotation-label">Product Type:</div>
        <div class="quotation-value">${productTypeName}</div>
      </div>
      <div class="quotation-row">
        <div class="quotation-label">Quantity:</div>
        <div class="quotation-value">${quotation.quantity.toLocaleString()}</div>
      </div>
      <div class="quotation-row">
        <div class="quotation-label">Unit Price:</div>
        <div class="quotation-value">HKD ${quotation.unitPrice.toFixed(2)}</div>
      </div>
    </div>

    ${quotation.notes ? `
    <div class="quotation-section">
      <h3>Additional Notes</h3>
      <p>${quotation.notes.replace(/\n/g, '<br>')}</p>
    </div>
    ` : ''}

    <div class="quotation-total">
      Total: HKD ${quotation.total.toFixed(2)}
    </div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.9em; color: #666;">
      <p>Thank you for your inquiry. Please review the quotation above and let us know if you have any questions.</p>
      <p>Date: ${new Date(quotation.dateCreated).toLocaleDateString()}</p>
    </div>
  </div>

  ${originalEmailHtml ? `
  <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ccc;">
    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
      <strong>---------- Original Message ----------</strong><br>
      ${emailMeta ? `
      <strong>From:</strong> ${emailMeta.from || 'Unknown'}<br>
      <strong>Date:</strong> ${emailMeta.date || 'Unknown'}<br>
      <strong>Subject:</strong> ${emailMeta.subject || '(No subject)'}
      ` : ''}
    </div>
    <div style="color: #333; border-left: 3px solid #ccc; padding-left: 15px; margin-left: 10px;">
      ${originalEmailHtml}
    </div>
  </div>
  ` : ''}

</body>
</html>
`;

      return html;
    }

    window.generateQuotation = function(tagType) {
      // TODO: Implement PDF generation
      showModal({
        title: 'Generate PDF',
        body: 'PDF generation functionality will be implemented. For now, this is a placeholder.',
        buttons: [{ text: 'OK', action: 'close' }]
      });
    };

    // -------- FUZZY SEARCH AND AUTOCOMPLETE --------

    // Fuzzy search function using Levenshtein distance
    function fuzzySearch(query, target) {
      if (!query || !target) return 0;

      query = query.toLowerCase();
      target = target.toLowerCase();

      // Exact match gets highest score
      if (target.includes(query)) return 1;

      // Calculate Levenshtein distance
      const matrix = [];
      for (let i = 0; i <= target.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= query.length; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= target.length; i++) {
        for (let j = 1; j <= query.length; j++) {
          if (target.charAt(i - 1) === query.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // substitution
              matrix[i][j - 1] + 1,     // insertion
              matrix[i - 1][j] + 1      // deletion
            );
          }
        }
      }

      const distance = matrix[target.length][query.length];
      const maxLength = Math.max(query.length, target.length);

      // Return similarity score (1 = perfect match, 0 = no similarity)
      return 1 - (distance / maxLength);
    }

    // Autocomplete class for customer search
    class CustomerAutocomplete {
      constructor(inputId, dropdownId) {
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);
        this.customers = [];
        this.currentIndex = -1;
        this.selectedCustomer = null;
        this.loaded = false;

        this.init();
      }

      async init() {
        await this.loadCustomers();
        this.loaded = true;

        this.input.addEventListener('input', (e) => this.onInput(e));
        this.input.addEventListener('keydown', (e) => this.onKeydown(e));
        this.input.addEventListener('blur', () => setTimeout(() => this.hideDropdown(), 200));
        this.input.addEventListener('focus', () => {
          if (this.input.value.trim()) {
            this.showSuggestions(this.input.value.trim());
          }
        });
      }

      async loadCustomers() {
        this.customers = await loadCustomersFromStorage();
      }

      async refreshCustomers() {
        await this.loadCustomers();
      }

      onInput(e) {
        const query = e.target.value.trim();
        this.selectedCustomer = null;

        if (!this.loaded || query.length < 2) {
          this.hideDropdown();
          return;
        }

        this.showSuggestions(query);
      }

      onKeydown(e) {
        if (!this.dropdown.style.display || this.dropdown.style.display === 'none') {
          return;
        }

        const items = this.dropdown.querySelectorAll('.autocomplete-item');
        if (!items.length) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            this.currentIndex = (this.currentIndex + 1) % items.length;
            this.highlightItem(this.currentIndex);
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.currentIndex = this.currentIndex <= 0 ? items.length - 1 : this.currentIndex - 1;
            this.highlightItem(this.currentIndex);
            break;
          case 'Enter':
            e.preventDefault();
            if (this.currentIndex >= 0 && this.currentIndex < items.length) {
              const selectedItem = items[this.currentIndex];
              const customerId = parseInt(selectedItem.dataset.customerId);
              this.selectCustomer(customerId);
            }
            break;
          case 'Escape':
            this.hideDropdown();
            break;
        }
      }

      showSuggestions(query) {
        const suggestions = this.getSuggestions(query);

        if (suggestions.length === 0) {
          this.dropdown.innerHTML = '<div class="autocomplete-no-results">No matching customers found</div>';
          this.dropdown.style.display = 'block';
          return;
        }

        const html = suggestions.map(customer => `
          <div class="autocomplete-item" data-customer-id="${customer.id}">
            <div style="font-weight: 600;">${this.highlightMatch(customer.companyName, query)}</div>
            <div style="font-size: 12px; color: #666;">${customer.emailDomain} â€¢ ${customer.companyType}</div>
          </div>
        `).join('');

        this.dropdown.innerHTML = html;
        this.dropdown.style.display = 'block';
        this.currentIndex = -1;

        // Add click handlers
        this.dropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
          item.addEventListener('click', () => {
            const customerId = parseInt(item.dataset.customerId);
            this.selectCustomer(customerId);
          });
          item.addEventListener('mouseenter', () => {
            this.currentIndex = index;
            this.highlightItem(index);
          });
        });
      }

      getSuggestions(query) {
        return this.customers
          .map(customer => ({
            ...customer,
            score: fuzzySearch(query, customer.companyName)
          }))
          .filter(customer => customer.score > 0.3) // Minimum similarity threshold
          .sort((a, b) => b.score - a.score) // Sort by similarity score
          .slice(0, 10); // Limit to top 10 results
      }

      highlightMatch(text, query) {
        if (!query) return text;

        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
      }

      highlightItem(index) {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');
        items.forEach((item, i) => {
          item.classList.toggle('highlighted', i === index);
        });
      }

      selectCustomer(customerId) {
        const customer = this.customers.find(c => c.id === customerId);
        if (!customer) return;

        this.selectedCustomer = customer;
        this.input.value = customer.companyName;
        this.hideDropdown();

        // Auto-populate other quotation fields if they exist and are empty
        this.populateRelatedFields(customer);

        // Make input more compact after selection
        this.input.style.fontSize = '14px';
        this.input.style.padding = '6px';
      }

      populateRelatedFields(customer) {
        // Populate email field if empty
        const emailField = document.getElementById('quotationEmail');
        if (emailField && !emailField.value.trim()) {
          emailField.value = `contact@${customer.emailDomain}`;
        }

        // Populate phone field if empty
        const phoneField = document.getElementById('quotationPhone');
        if (phoneField && !phoneField.value.trim() && customer.companyTel) {
          phoneField.value = customer.companyTel;
        }

        // Populate contact person dropdown with all members
        const contactField = document.getElementById('quotationContactPerson');
        if (contactField) {
          // Clear existing options except the default
          contactField.innerHTML = '<option value="">Select Contact Person</option>';

          // Add all members as options
          if (customer.members && customer.members.length > 0) {
            customer.members.forEach(member => {
              if (member.name) {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = `${member.name}${member.title ? ` (${member.title})` : ''}`;
                option.dataset.memberData = JSON.stringify(member);
                contactField.appendChild(option);
              }
            });

            // Auto-select first member if no selection yet
            if (contactField.selectedIndex === 0) {
              contactField.selectedIndex = 1; // Select first member
            }
          }
        }
      }

      hideDropdown() {
        this.dropdown.style.display = 'none';
        this.currentIndex = -1;
      }

      refreshCustomers() {
        this.loadCustomers();
      }
    }

    // -------- AGENT SKILLS MANAGEMENT --------
    let currentAgentSkills = [];

    function loadAgentSkills() {
      const tbody = document.getElementById('skillsTableBody');
      const loadingRow = document.getElementById('skillsLoadingRow');
      loadingRow.style.display = 'table-row';

      fetch('/api/skills')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            currentAgentSkills = data.skills;
            displayAgentSkills();
            loadSkillStats();
          } else {
            tbody.innerHTML = `<tr><td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">Error: ${data.error}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('Error loading skills:', error);
          tbody.innerHTML = `<tr><td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">Failed to load skills: ${error.message}</td></tr>`;
        })
        .finally(() => {
          loadingRow.style.display = 'none';
        });
    }

    function loadSkillStats() {
      fetch('/api/skills/stats')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const stats = data.stats;
            document.getElementById('totalSkills').textContent = stats.total;
            document.getElementById('completedSkills').textContent = stats.completed || 0;
            document.getElementById('inProgressSkills').textContent = stats.inProgress || 0;
            document.getElementById('plannedSkills').textContent = stats.planned || 0;
          }
        })
        .catch(error => {
          console.error('Error loading skill stats:', error);
        });
    }

    function displayAgentSkills() {
      const tbody = document.getElementById('skillsTableBody');
      let filteredSkills = applyAgentSkillFilters(currentAgentSkills);

      if (filteredSkills.length === 0 && currentAgentSkills.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No skills documented yet. Create your first skill.
            </td>
          </tr>
        `;
        return;
      }

      if (filteredSkills.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No skills match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filteredSkills.forEach((skill) => {
        const statusColor = getStatusColor(skill.status);
        const primaryTag = skill.tags && skill.tags.length > 0 ? skill.tags[0] : 'other';
        const categoryColor = getCategoryColor(primaryTag);

        html += '<tr style="background:#fff;">' +
          '<td style="border:1px solid #000; padding:8px; font-weight:600;">' + skill.name + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<span style="background:' + statusColor + '; color:#fff; padding:2px 6px; border-radius:0; font-size:11px; font-weight:600;">' +
              skill.status.replace('-', ' ').toUpperCase() +
            '</span>' +
          '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<span style="background:' + categoryColor + '; color:#fff; padding:2px 6px; border-radius:0; font-size:11px; font-weight:600;">' +
              primaryTag.toUpperCase() +
            '</span>' +
          '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' + skill.description + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' + skill.version + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<button class="page-btn view-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px;">View</button>' +
            '<button class="page-btn edit-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px; margin-left:5px;">Edit</button>' +
            '<button class="page-btn delete-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px; margin-left:5px;">Delete</button>' +
          '</td>' +
        '</tr>';
      });

      tbody.innerHTML = html;

      // Add event listeners
      document.querySelectorAll('.view-skill-btn').forEach(btn => {
        btn.onclick = () => viewSkill(btn.dataset.skill);
      });
      document.querySelectorAll('.edit-skill-btn').forEach(btn => {
        btn.onclick = () => editSkill(btn.dataset.skill);
      });
      document.querySelectorAll('.delete-skill-btn').forEach(btn => {
        btn.onclick = () => deleteSkill(btn.dataset.skill);
      });
    }

    function getStatusColor(status) {
      switch (status) {
        case 'completed': return '#28a745';
        case 'in-progress': return '#ffc107';
        case 'planned': return '#6c757d';
        case 'deprecated': return '#dc3545';
        default: return '#6c757d';
      }
    }

    function getCategoryColor(category) {
      switch (category) {
        case 'frontend': return '#007bff';
        case 'backend': return '#28a745';
        case 'database': return '#fd7e14';
        case 'deployment': return '#6f42c1';
        case 'design': return '#e83e8c';
        case 'testing': return '#20c997';
        case 'documentation': return '#17a2b8';
        default: return '#6c757d';
      }
    }

    function applyAgentSkillFilters(skills) {
      const statusFilter = document.getElementById('skillStatusFilter').value;
      const categoryFilter = document.getElementById('skillCategoryFilter').value;
      const searchFilter = document.getElementById('skillSearch').value.toLowerCase();

      return skills.filter(skill => {
        const matchesStatus = !statusFilter || skill.status === statusFilter;
        const matchesCategory = !categoryFilter || (skill.tags && skill.tags.some(tag => tag.toLowerCase() === categoryFilter.toLowerCase()));
        const matchesSearch = !searchFilter ||
          skill.name.toLowerCase().includes(searchFilter) ||
          skill.description.toLowerCase().includes(searchFilter) ||
          (skill.tags && skill.tags.some(tag => tag.toLowerCase().includes(searchFilter)));

        return matchesStatus && matchesCategory && matchesSearch;
      });
    }

    function createSkill() {
      showModal({
        title: 'Create New Skill',
        body: `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Skill Name * <small>(kebab-case, e.g., email-integration)</small></label>
            <input type="text" id="skillNameInput" style="width:100%; padding:8px; border:1px solid #000;" placeholder="email-system-integration">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Primary Tag *</label>
            <select id="skillCategoryInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
              <option value="">Select Category</option>
              <option value="frontend">Frontend</option>
              <option value="backend">Backend</option>
              <option value="database">Database</option>
              <option value="deployment">Deployment</option>
              <option value="design">Design</option>
              <option value="testing">Testing</option>
              <option value="documentation">Documentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Status *</label>
            <select id="skillStatusInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
              <option value="planned">Planned</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="deprecated">Deprecated</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Version *</label>
            <input type="text" id="skillVersionInput" value="1.0.0" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1.0.0">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Description *</label>
            <textarea id="skillDescriptionInput" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;" placeholder="Brief description of what this skill accomplishes"></textarea>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Tags <small>(comma-separated)</small></label>
            <input type="text" id="skillTagsInput" style="width:100%; padding:8px; border:1px solid #000;" placeholder="ui, email, integration">
          </div>
        `,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Create Skill', action: 'create', primary: true }
        ]
      });

      // Handle create skill
      const createBtn = document.querySelector('.modal-btn[data-action="create"]');
      if (createBtn) {
        createBtn.onclick = () => {
          const name = document.getElementById('skillNameInput').value.trim();
          const primaryTag = document.getElementById('skillCategoryInput').value;
          const status = document.getElementById('skillStatusInput').value;
          const version = document.getElementById('skillVersionInput').value.trim();
          const description = document.getElementById('skillDescriptionInput').value.trim();
          const tagsInput = document.getElementById('skillTagsInput').value.trim();

          if (!name || !primaryTag || !status || !version || !description) {
            showModal({
              title: 'Validation Error',
              body: 'Please fill in all required fields marked with *.',
              buttons: [{ text: 'OK', action: 'close' }]
            });
            return;
          }

          // Create tags array with primary tag first, then additional tags
          let tags = [primaryTag];
          if (tagsInput) {
            const additionalTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== primaryTag);
            tags = tags.concat(additionalTags);
          }
          const now = new Date().toISOString().split('T')[0];

          const skillData = {
            name,
            status,
            version,
            description,
            tags,
            created: now,
            updated: now
          };

          fetch('/api/skills', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(skillData)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
          closeModal();
              loadAgentSkills();
              showModal({
                title: 'Success',
                body: `Skill "${name}" created successfully!`,
                buttons: [{ text: 'OK', action: 'close' }]
              });
            } else {
              throw new Error(data.error);
            }
          })
          .catch(error => {
            showModal({
              title: 'Error',
              body: `Failed to create skill: ${error.message}`,
              buttons: [{ text: 'OK', action: 'close' }]
            });
          });
        };
      }
    }

    function viewSkill(skillName) {
      fetch(`/api/skills/${skillName}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const skill = data.skill;
            let body = '<div style="margin-bottom:15px;">' +
              '<strong>Name:</strong> ' + skill.name +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Status:</strong> <span style="background:' + getStatusColor(skill.status) + '; color:#fff; padding:2px 6px; font-size:11px; font-weight:600;">' + skill.status.toUpperCase() + '</span>' +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Category:</strong> <span style="background:' + getCategoryColor(skill.tags && skill.tags.length > 0 ? skill.tags[0] : 'other') + '; color:#fff; padding:2px 6px; font-size:11px; font-weight:600;">' + (skill.tags && skill.tags.length > 0 ? skill.tags[0].toUpperCase() : 'OTHER') + '</span>' +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Version:</strong> ' + skill.version +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Description:</strong><br>' + skill.description +
            '</div>';

            if (skill.tags && skill.tags.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Tags:</strong> ${skill.tags.join(', ')}</div>`;
            }

            if (skill.changes && skill.changes.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Changes:</strong><ul>`;
              skill.changes.forEach(change => {
                body += `<li><strong>${change.component}:</strong> ${change.description}`;
                if (change.impact) body += ` <em>(${change.impact})</em>`;
                body += `</li>`;
              });
              body += `</ul></div>`;
            }

            if (skill.dependencies && skill.dependencies.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Dependencies:</strong> ${skill.dependencies.join(', ')}</div>`;
            }

            body += `
              <div style="margin-bottom:15px;">
                <strong>Created:</strong> ${skill.created}
              </div>
              <div style="margin-bottom:15px;">
                <strong>Updated:</strong> ${skill.updated}
              </div>
            `;

            showModal({
              title: `Skill: ${skill.name}`,
              body: body,
              buttons: [{ text: 'Close', action: 'close' }]
            });
          } else {
            throw new Error(data.error);
          }
        })
        .catch(error => {
          showModal({
            title: 'Error',
            body: `Failed to load skill details: ${error.message}`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        });
    }

    function editSkill(skillName) {
      // Load skill data first
      fetch(`/api/skills/${skillName}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const skill = data.skill;
      showModal({
        title: 'Edit Skill',
        body: `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Skill Name *</label>
                  <input type="text" id="editSkillNameInput" value="${skill.name}" style="width:100%; padding:8px; border:1px solid #000;" readonly>
                  <small style="color:#666;">Skill name cannot be changed</small>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Primary Tag *</label>
                  <select id="editSkillCategoryInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                    <option value="frontend" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'frontend' ? 'selected' : ''}>Frontend</option>
                    <option value="backend" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'backend' ? 'selected' : ''}>Backend</option>
                    <option value="database" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'database' ? 'selected' : ''}>Database</option>
                    <option value="deployment" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'deployment' ? 'selected' : ''}>Deployment</option>
                    <option value="design" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'design' ? 'selected' : ''}>Design</option>
                    <option value="testing" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'testing' ? 'selected' : ''}>Testing</option>
                    <option value="documentation" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'documentation' ? 'selected' : ''}>Documentation</option>
                    <option value="other" ${(!skill.tags || skill.tags.length === 0 || !['frontend','backend','database','deployment','design','testing','documentation'].includes(skill.tags[0])) ? 'selected' : ''}>Other</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Status *</label>
                  <select id="editSkillStatusInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                    <option value="planned" ${skill.status === 'planned' ? 'selected' : ''}>Planned</option>
                    <option value="in-progress" ${skill.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${skill.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="deprecated" ${skill.status === 'deprecated' ? 'selected' : ''}>Deprecated</option>
                  </select>
          </div>
          <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Version *</label>
                  <input type="text" id="editSkillVersionInput" value="${skill.version}" style="width:100%; padding:8px; border:1px solid #000;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Description *</label>
                  <textarea id="editSkillDescriptionInput" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;">${skill.description}</textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Tags <small>(comma-separated)</small></label>
                  <input type="text" id="editSkillTagsInput" value="${skill.tags ? skill.tags.join(', ') : ''}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Save Changes', action: 'save', primary: true }
        ]
      });

      // Handle save changes
      const saveBtn = document.querySelector('.modal-btn[data-action="save"]');
      if (saveBtn) {
        saveBtn.onclick = () => {
                const primaryTag = document.getElementById('editSkillCategoryInput').value;
                const status = document.getElementById('editSkillStatusInput').value;
                const version = document.getElementById('editSkillVersionInput').value.trim();
                const description = document.getElementById('editSkillDescriptionInput').value.trim();
                const tagsInput = document.getElementById('editSkillTagsInput').value.trim();

                if (!primaryTag || !status || !version || !description) {
                  showModal({
                    title: 'Validation Error',
                    body: 'Please fill in all required fields marked with *.',
                    buttons: [{ text: 'OK', action: 'close' }]
                  });
            return;
          }

                // Create tags array with primary tag first, then additional tags
                let tags = [primaryTag];
                if (tagsInput) {
                  const additionalTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== primaryTag);
                  tags = tags.concat(additionalTags);
                }
                const now = new Date().toISOString().split('T')[0];

                const updates = {
                  status,
                  version,
            description,
                  tags,
                  updated: now
                };

                fetch(`/api/skills/${skillName}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updates)
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
          closeModal();
                    loadAgentSkills();
                    showModal({
                      title: 'Success',
                      body: `Skill "${skillName}" updated successfully!`,
                      buttons: [{ text: 'OK', action: 'close' }]
                    });
                  } else {
                    throw new Error(data.error);
                  }
                })
                .catch(error => {
                  showModal({
                    title: 'Error',
                    body: `Failed to update skill: ${error.message}`,
                    buttons: [{ text: 'OK', action: 'close' }]
                  });
                });
              };
            }
          } else {
            throw new Error(data.error);
          }
        })
        .catch(error => {
          showModal({
            title: 'Error',
            body: `Failed to load skill for editing: ${error.message}`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        });
    }

    function deleteSkill(skillName) {
      showModal({
        title: 'Confirm Delete',
        body: `Are you sure you want to delete the skill "${skillName}"? This action cannot be undone.`,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Delete', action: 'delete', primary: true }
        ]
      });

      const deleteBtn = document.querySelector('.modal-btn[data-action="delete"]');
      if (deleteBtn) {
        deleteBtn.onclick = () => {
          fetch(`/api/skills/${skillName}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              closeModal();
              loadAgentSkills();
              showModal({
                title: 'Success',
                body: `Skill "${skillName}" deleted successfully!`,
                buttons: [{ text: 'OK', action: 'close' }]
              });
            } else {
              throw new Error(data.error);
            }
          })
          .catch(error => {
            closeModal();
            showModal({
              title: 'Error',
              body: `Failed to delete skill: ${error.message}`,
              buttons: [{ text: 'OK', action: 'close' }]
            });
          });
        };
      }
    }

    // Agent Skills panel event listeners
    document.getElementById('addSkillBtn').onclick = () => createSkill();
    document.getElementById('refreshSkillsBtn').onclick = () => loadAgentSkills();

    // Skills filter event listeners
    document.getElementById('skillStatusFilter').addEventListener('change', () => displayAgentSkills());
    document.getElementById('skillCategoryFilter').addEventListener('change', () => displayAgentSkills());
    document.getElementById('skillSearch').addEventListener('input', () => displayAgentSkills());
    
    load();
  </script>
</body>
</html>

