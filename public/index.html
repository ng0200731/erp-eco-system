<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Client</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìß</text></svg>">
  <style>
    /* STRICT monochrome: only black (#000) and white (#fff) */
    body {font-family: Arial, sans-serif; margin: 0; padding: 0; background:#fff; color:#000;}
    h1 {margin:0 0 16px 0;}

    /* Layout: 20% menu (left) + 80% board (right) */
    #layout{
      display:flex;
      min-height:100vh;
    }
    #sidebar{
      flex:0 0 5%;
      min-width:60px;
      border-right:1px solid #000;
      padding:20px;
      box-sizing:border-box;
      transition:flex-basis 0.2s ease;
      display:flex;
      flex-direction:column;
      gap:10px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    #sidebar:hover{
      flex-basis:11%;
    }
    #board{
      flex:1;
      padding:20px;
      box-sizing:border-box;
    }

    #emails {max-width:800px; margin:0; background:#fff; border:1px solid #000; padding:20px;}
    ul {list-style:none; padding:0; margin:0;}
    li {padding:12px; border-bottom:1px solid #000; cursor:pointer;}
    li:hover {background:#000; color:#fff;}
    .sub {font-weight:bold;}
    .meta {font-size:.9em;}
    pre {white-space:pre-wrap; background:#fff; padding:15px; border:1px solid #000;}

    /* Inputs (monochrome) */
    input, textarea{
      width:100%;
      padding:8px;
      border:1px solid #000;
      background:#fff;
      color:#000;
      box-sizing:border-box;
      font-family:inherit;
    }
    textarea{ min-height:150px; resize:vertical; }

    /* Minimal monochrome modal (no browser alerts/confirms) */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      z-index:10000;
      padding:20px;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      color:#000;
      border:1px solid #000;
      box-shadow:0 12px 32px rgba(0,0,0,.25);
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid #000;
      font-weight:700;
      letter-spacing:.2px;
    }
    .modal-body{
      padding:14px 16px;
      font-size:14px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .modal-actions{
      padding:12px 16px;
      border-top:1px solid #000;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Email reader modal - Microsoft Outlook style */
    .email-modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.2);
      display:flex; align-items:center; justify-content:center;
      z-index:10001;
      padding:10px;
      overflow-y: auto; /* Allow modal overlay to scroll if content is too tall */
    }
    .email-modal{
      width:min(1200px, 95vw);
      height:min(800px, 90vh);
      background:#fff;
      color:#000;
      border:1px solid #000;
      box-shadow:0 12px 32px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      max-height: 90vh; /* Ensure modal doesn't exceed viewport height */
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    .email-modal-header{
      padding:16px 20px;
      border-bottom:1px solid #000;
      background:#f8f8f8;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .email-modal-title{
      font-weight:700;
      font-size:16px;
      margin:0;
      flex:1;
    }
    .email-modal-close{
      background:none;
      border:1px solid #000;
      color:#000;
      cursor:pointer;
      padding:6px 12px;
      font-size:14px;
    }
    .email-modal-close:hover{
      background:#000;
      color:#fff;
    }
    .email-modal-meta{
      padding:12px 20px;
      border-bottom:1px solid #000;
      background:#fafafa;
      font-size:14px;
    }
    .email-modal-from{
      font-weight:600;
      margin-bottom:4px;
    }
    .email-modal-date{
      color:#666;
      font-size:13px;
    }
    .email-modal-body{
      flex:1;
      padding:20px;
      overflow-y:auto;
      font-family:Arial, sans-serif;
      line-height:1.5;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    /* Remove focus outline / highlight for date input in modal */
    .email-modal input[type="date"] {
      outline: none;
      box-shadow: none;
    }
    .email-modal input[type="date"]:focus {
      outline: none;
      box-shadow: none;
    }
    .btn{
      appearance:none;
      border:1px solid #000;
      background:#fff;
      color:#000;
      padding:8px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{ background:#000; color:#fff; }
    .btn.primary{ background:#000; color:#fff; }
    .btn.primary:hover{ background:#fff; color:#000; }

    /* Page buttons */
    .topbar{ margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; }
    .page-btn{
      border:1px solid #000;
      background:#fff;
      color:#000;
      padding:10px 16px;
      cursor:pointer;
      font-weight:700;
      text-align:center;
    }
    .page-btn:hover{ background:#000; color:#fff; }
    /* Sidebar buttons: make square and center the letter precisely */
    #sidebar .page-btn {
      width:44px;
      height:44px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      overflow:hidden;
      white-space:nowrap;
      transition: width 0.18s ease, padding 0.18s ease, justify-content 0.18s ease;
    }
    /* When sidebar is hovered, expand buttons to fill sidebar width and left-align text */
    #sidebar:hover .page-btn {
      width:100%;
      padding:8px 10px;
      justify-content:center;
      text-align:center;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .notice{
      padding:12px;
      border-bottom:1px solid #000;
      background:#fff;
      color:#000;
      font-weight:700;
    }

    /* Tabs (board top) */
    .tabs-bar{
      display:flex;
      gap:4px;
      margin-bottom:10px;
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #000;
      padding: 10px 0;
      z-index: 100;
    }
    .tab{
      border:1px solid #000;
      background:#fff;
      color:#000;
      padding:6px 10px;
      cursor:pointer;
      font-weight:600;
      position:relative;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tab-active{
      background:#000;
      color:#fff;
    }
    .tab-disabled{
      opacity:0.5;
      cursor:not-allowed;
      background:#f0f0f0;
      color:#999;
    }

    /* Quotation tag selection styles */
    .quotation-tag-btn.selected {
      background:#000 !important;
      color:#fff !important;
    }
    .quotation-tag-btn:hover:not(.selected) {
      background:#ccc !important;
      color:#000 !important;
    }
    .tab-close{
      display:none;
      border:none;
      background:transparent;
      color:inherit;
      cursor:pointer;
      padding:0;
      width:16px;
      height:16px;
      font-size:14px;
      line-height:1;
    }
    .tab:hover .tab-close{
      display:block;
    }

    /* Submenu styling */
    .menu-group {
      position: relative;
    }
    .submenu {
      margin-left: 20px;
      margin-top: 5px;
    }
    .submenu-btn {
      appearance: none;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      width: 100%;
      text-align: left;
      margin-bottom: 2px;
    }
    .submenu-btn:hover {
      background: #000;
      color: #fff;
    }

    /* Submenu styling */
    .menu-group {
      position: relative;
    }
    .submenu {
      margin-left: 20px;
      margin-top: 5px;
    }
    .submenu-btn {
      appearance: none;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      width: 100%;
      text-align: left;
      margin-bottom: 2px;
    }
    .submenu-btn:hover {
      background: #000;
      color: #fff;
    }

    /* Autocomplete dropdown styling */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    .autocomplete-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #000;
      background: #fff;
      color: #000;
      box-sizing: border-box;
      font-family: inherit;
    }
    .autocomplete-input:focus {
      outline: none;
      border-color: #666;
    }
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #000;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: #000;
      color: #fff;
    }
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    .autocomplete-no-results {
      padding: 8px 12px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="layout">
    <div id="sidebar">
      <div class="menu-group">
        <button id="menuEmail" class="page-btn" data-short="E" data-full="Email">E</button>
        <div id="emailSubmenu" class="submenu" style="display:none;">
          <button id="emailReceiveBtn" class="submenu-btn">Receive</button>
          <button id="emailSendBtn" class="submenu-btn">Send</button>
        </div>
      </div>
      <div class="menu-group">
        <button id="menuCustomer" class="page-btn" data-short="C" data-full="Customer">C</button>
        <div id="customerSubmenu" class="submenu" style="display:none;">
          <button id="customerCreateBtn" class="submenu-btn">Create</button>
          <button id="customerViewBtn" class="submenu-btn">View</button>
        </div>
      </div>
      <button id="menuTasks" class="page-btn" data-short="T" data-full="Task List">T</button>
      <button id="menuSkills" class="page-btn" data-short="K" data-full="Skills">K</button>
      <div class="menu-group">
      <button id="menuQuotation" class="page-btn" data-short="Q" data-full="Quotation">Q</button>
        <div id="quotationSubmenu" class="submenu" style="display:none;">
          <button id="quotationCreateBtn" class="submenu-btn">Create</button>
          <button id="quotationViewBtn" class="submenu-btn">View</button>
        </div>
      </div>
      <button id="menuSettings" class="page-btn" data-short="S" data-full="Setting">S</button>
      <div style="flex:1;"></div>
      <div style="font-size:0.75em; text-align:center; color:#666; margin-top:10px; padding:5px;">
        v1.0.14
      </div>
    </div>
    <div id="board">
      <div id="tabsBar" class="tabs-bar"></div>

      <!-- Welcome / future dashboard -->
      <div id="welcomePanel" style="border:1px solid #000; padding:20px; margin-bottom:20px;">
        <h3>Welcome</h3>
        <p class="meta">
          This board will become the main dashboard: open tasks, follow-ups, and status overview.
          For now, use the left menu to open <strong>Setting</strong> and configure email profiles.
        </p>
      </div>

      <!-- Profiles list (landing page for settings) -->
      <div id="profilesListPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3>Email Profiles</h3>
          <button id="addProfileBtn" class="page-btn" style="font-size:18px; padding:8px 16px;">+</button>
        </div>
        <div id="profilesList"></div>
      </div>

      <!-- Task List board -->
      <div id="tasksPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <h3>Task List</h3>
        <!-- Task list content will go here -->
      </div>

      <!-- Customer board -->
      <div id="customerPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <!-- Customer Tabs -->
        <div class="tabs-bar" style="margin-bottom:20px;">
          <div class="tab tab-active" data-tab="customer-info">Customer</div>
          <div class="tab tab-disabled" data-tab="member-info">Member</div>
        </div>

        <!-- Customer Info Tab -->
        <div id="customerInfoTab" style="display:block;">
          <form id="customerForm">
            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyName">Company Name *</label>
                <input id="companyName" type="text" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="emailDomain">Email Domain *</label>
                <input id="emailDomain" type="text" placeholder="example.com" required style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyAddress">Address</label>
                <textarea id="companyAddress" style="width:100%; min-height:60px;"></textarea>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyTel">Telephone</label>
                <input id="companyTel" type="tel" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyType">Type *</label>
                <select id="companyType" required style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                  <option value="">Select Type</option>
                  <option value="buyer">Buyer</option>
                  <option value="agent">Agent</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyWebsite">Website</label>
                <input id="companyWebsite" type="url" placeholder="https://www.example.com" style="width:100%;">
              </div>
            </div>

            <div class="row" style="margin-bottom:15px;">
              <div style="flex:1;">
                <label for="companyDocs">Documents</label>
                <div style="border:2px dashed #ccc; padding:20px; text-align:center; background:#f9f9f9;">
                  <p>Drag & drop files here, or click to browse</p>
                  <input id="companyDocs" type="file" multiple style="margin-top:10px;">
                  <p style="font-size:0.8em; color:#666; margin-top:10px;">
                    Support: Browse, Copy & Paste, Drag & Drop
                  </p>
                </div>
              </div>
            </div>

            <div class="row">
              <button type="button" id="dummyInputBtn" class="page-btn" style="margin-right:10px;">Dummy Input</button>
              <button type="button" id="saveCustomerBtn" class="page-btn">Save & Continue to Members</button>
            </div>
          </form>
        </div>

        <!-- Member Info Tab -->
        <div id="memberInfoTab" style="display:none;">
          <div style="margin-bottom:15px;">
            <button id="addMemberBtn" class="page-btn">+ Add Member</button>
            <button id="dummyMemberBtn" class="page-btn" style="margin-left:10px;">Dummy Input</button>
          </div>

          <div id="membersList">
            <!-- Members will be added here dynamically -->
          </div>
        </div>
      </div>

      <!-- Customer View board -->
      <div id="customerViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <button id="refreshCustomersBtn" class="page-btn">Refresh List</button>
        </div>


        <!-- Customer Table -->
        <div id="customersTableContainer">
          <table id="customersTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Company Name</div>
                  <input type="text" id="customerFilterName" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Type</div>
                  <select id="customerFilterType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="buyer">Buyer</option>
                    <option value="agent">Agent</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email Domain</div>
                  <input type="text" id="customerFilterDomain" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="customerFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Website</div>
                  <input type="text" id="customerFilterWebsite" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Members</div>
                  <input type="text" id="customerFilterMembers" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <tr>
                <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No customers saved yet. Create customers first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quotation View board -->
      <div id="quotationViewPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <button id="refreshQuotationsBtn" class="page-btn">Refresh List</button>
        </div>

        <!-- Quotation Table -->
        <div id="quotationsTableContainer">
          <table id="quotationsTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Customer Name</div>
                  <input type="text" id="quotationFilterCustomer" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Contact Person</div>
                  <input type="text" id="quotationFilterContact" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Email</div>
                  <input type="text" id="quotationFilterEmail" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Phone</div>
                  <input type="text" id="quotationFilterPhone" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Product Type</div>
                  <select id="quotationFilterType" class="filter-input" style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                    <option value="">All Types</option>
                    <option value="hang-tag">Hang Tag</option>
                    <option value="woven-label">Woven Label</option>
                    <option value="care-label">Care Label</option>
                    <option value="heat-transfer">Heat Transfer</option>
                    <option value="others">Others</option>
                  </select>
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Quantity</div>
                  <input type="text" id="quotationFilterQuantity" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Total (HKD)</div>
                  <input type="text" id="quotationFilterTotal" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">
                  <div>Date Created</div>
                  <input type="text" id="quotationFilterDate" class="filter-input" placeholder="Filter..." style="width:100%; margin-top:4px; padding:4px; font-size:12px; border:1px solid #ccc;">
                </th>
              </tr>
            </thead>
            <tbody id="quotationsTableBody">
              <tr>
                <td colspan="8" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
                  No quotations saved yet. Create quotations first.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Agent Skills board -->
      <div id="skillsPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div style="margin-bottom:15px;">
          <h3>Agent Skills Documentation System</h3>
          <p class="meta" style="margin-bottom:10px;">Track technical skills, implementations, and achievements</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="addSkillBtn" class="page-btn">Create Skill</button>
            <button id="refreshSkillsBtn" class="page-btn">Refresh</button>
            <select id="skillStatusFilter" class="page-btn" style="background:#fff; color:#000; border:1px solid #000; padding:8px;">
              <option value="">All Status</option>
              <option value="planned">Planned</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="deprecated">Deprecated</option>
            </select>
            <select id="skillCategoryFilter" class="page-btn" style="background:#fff; color:#000; border:1px solid #000; padding:8px;">
              <option value="">All Categories</option>
              <option value="frontend">Frontend</option>
              <option value="backend">Backend</option>
              <option value="database">Database</option>
              <option value="deployment">Deployment</option>
              <option value="design">Design</option>
              <option value="testing">Testing</option>
              <option value="documentation">Documentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-top:10px;">
            <input type="text" id="skillSearch" placeholder="Search skills..." style="width:100%; padding:8px; border:1px solid #000; box-sizing:border-box;">
          </div>
        </div>

        <!-- Skills Statistics -->
        <div id="skillsStats" style="margin-bottom:20px; padding:15px; background:#f8f8f8; border:1px solid #000;">
          <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div><strong>Total Skills:</strong> <span id="totalSkills">0</span></div>
            <div><strong>Completed:</strong> <span id="completedSkills">0</span></div>
            <div><strong>In Progress:</strong> <span id="inProgressSkills">0</span></div>
            <div><strong>Planned:</strong> <span id="plannedSkills">0</span></div>
          </div>
        </div>

        <!-- Skills Table -->
        <div id="skillsTableContainer">
          <table id="skillsTable" style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead>
              <tr style="background:#f8f8f8;">
                <th style="border:1px solid #000; padding:8px; text-align:left;">Skill Name</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Status</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Category</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Description</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Version</th>
                <th style="border:1px solid #000; padding:8px; text-align:left;">Actions</th>
              </tr>
            </thead>
            <tbody id="skillsTableBody">
              <tr id="skillsLoadingRow">
                <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center;">
                  Loading skills...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quotation board -->
      <div id="quotationPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <div class="row" style="gap:10px; flex-wrap:wrap; margin-bottom:20px;">
          <button class="quotation-tag-btn page-btn" id="hangTagBtn" data-tag="hang-tag">Hang Tag</button>
          <button class="quotation-tag-btn page-btn" id="wovenLabelBtn" data-tag="woven-label">Woven Label</button>
          <button class="quotation-tag-btn page-btn" id="careLabelBtn" data-tag="care-label">Care Label</button>
          <button class="quotation-tag-btn page-btn" id="heatTransferBtn" data-tag="heat-transfer">Heat Transfer</button>
          <button class="quotation-tag-btn page-btn" id="othersBtn" data-tag="others">Others</button>
        </div>

        <!-- Quotation Sub-board -->
        <div id="quotationSubBoard" style="display:none; margin-top:20px; padding:20px; border:1px solid #000; min-height: 600px;">
          <div id="quotationSubBoardHeader" style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #000;">
            <h3 id="quotationSubBoardTitle" style="margin:0;"></h3>
          </div>
          <div id="quotationSubBoardContent">
            <!-- Content will be dynamically loaded here -->
          </div>
        </div>
      </div>

      <!-- Settings board (IMAP/SMTP profile edit form) -->
      <div id="settingsPanel" style="border:1px solid #000; padding:20px; margin-bottom:20px; display:none;">
        <form id="settingsForm">
        <h3>Profile &amp; Connection Settings</h3>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:1;">
            <label for="cfgMailUser">MAIL_USER</label>
            <input id="cfgMailUser" type="email" autocomplete="username">
          </div>
          <div style="flex:1;">
            <label for="cfgMailPass">MAIL_PASS</label>
            <div style="position:relative;">
              <input id="cfgMailPass" type="password" autocomplete="current-password" style="padding-right:30px;">
              <button id="togglePassword" type="button" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:#000; font-size:14px;">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <h4>IMAP (incoming)</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:2;">
            <label for="cfgImapHost">IMAP_HOST</label>
            <input id="cfgImapHost" type="text">
          </div>
          <div style="flex:1;">
            <label for="cfgImapPort">IMAP_PORT</label>
            <input id="cfgImapPort" type="number">
          </div>
          <div style="flex:1;">
            <label for="cfgImapTls">IMAP_TLS (true/false)</label>
            <input id="cfgImapTls" type="text">
          </div>
        </div>

        <h4>SMTP (outgoing)</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:2;">
            <label for="cfgSmtpHost">SMTP_HOST</label>
            <input id="cfgSmtpHost" type="text">
          </div>
          <div style="flex:1;">
            <label for="cfgSmtpPort">SMTP_PORT</label>
            <input id="cfgSmtpPort" type="number">
          </div>
          <div style="flex:1;">
            <label for="cfgSmtpSecure">SMTP_SECURE (true/false)</label>
            <input id="cfgSmtpSecure" type="text">
          </div>
        </div>

        <h4>Server</h4>
        <div class="row" style="margin-bottom:10px;">
          <div style="flex:1;">
            <label for="cfgPort">PORT</label>
            <input id="cfgPort" type="number">
          </div>
        </div>

        <div class="row">
          <button id="saveConfigBtn" class="page-btn">Save Settings</button>
          <button id="dummyFillSettingsBtn" class="page-btn" type="button">Auto Fill (Random)</button>
        </div>
        <p class="meta" id="settingsNote"></p>
        </form>
      </div>

      <!-- Email UI (next step; hidden for now) -->
      <div id="emails" style="margin:0; display:none; width:100%;">
        <div class="topbar">
          <button id="composeBtn" class="page-btn">Compose</button>
          <button id="refreshEmailsBtn" class="page-btn">Refresh List</button>
          <button id="testSendBtn" class="page-btn">Send Test Email</button>
          <button id="testSmtpBtn" class="page-btn">Test SMTP Connection</button>
        </div>
        <div id="composeForm" style="display:none; background:#fff; padding:15px; border:1px solid #000; margin-bottom:15px;">
          <h3>Compose Email</h3>
          <input type="email" id="toEmail" placeholder="To:" style="margin-bottom:10px;">
          <input type="text" id="subjectEmail" placeholder="Subject:" style="margin-bottom:10px;">
          <textarea id="bodyEmail" placeholder="Message:" style="margin-bottom:10px;"></textarea>
          <div class="row">
            <button id="sendBtn" class="page-btn">Send</button>
            <button id="cancelBtn" class="page-btn">Cancel</button>
            <button id="dummyFillComposeBtn" class="page-btn" type="button" style="margin-left:auto;">Dummy Fill</button>
          </div>
        </div>
        <table id="emailTable" style="width:100%; border-collapse:collapse; border:1px solid #000; margin-bottom:15px;">
          <thead>
            <tr style="background:#fff;">
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Date</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Sender</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Subject</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Context</th>
              <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Attachment</th>
            </tr>
            <tr style="background:#fff;">
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="dateSearch" placeholder="Search date..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="senderSearch" placeholder="Search sender..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="subjectSearch" placeholder="Search subject..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="contextSearch" placeholder="Search content..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
              <th style="padding:8px; border:1px solid #000;">
                <input type="text" id="attachmentSearch" placeholder="Search attachments..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
              </th>
            </tr>
          </thead>
          <tbody id="emailTableBody"></tbody>
        </table>

        <!-- Email Reader Modal (Microsoft Outlook style) -->
        <div id="emailModal" class="email-modal-overlay" style="display:none;">
          <div class="email-modal">
            <div class="email-modal-header">
              <h2 id="emailModalSubject" class="email-modal-title">Email Subject</h2>
              <button id="emailModalClose" class="email-modal-close">√ó</button>
          </div>
            <div class="email-modal-meta">
              <div id="emailModalFrom" class="email-modal-from">From: sender@example.com</div>
              <div id="emailModalTo" class="email-modal-from">To: recipient@example.com</div>
              <div id="emailModalDate" class="email-modal-date">Date: 2024-01-15</div>
            </div>
            <div id="emailModalBody" class="email-modal-body">
              Email content will appear here...
            </div>
          </div>
        </div>

        <!-- Image Viewing Modal -->
        <div id="imageModal" class="modal-overlay" style="display:none; z-index:10001;">
          <div class="modal" style="max-width: 90vw; max-height: 90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #000;">
              <h3 style="margin:0; font-weight:bold;">Product Image Preview</h3>
              <button id="imageModalClose" style="font-size:24px; padding:5px 10px; border:1px solid #000; background:#fff; cursor:pointer;">√ó</button>
            </div>
            <div id="imageModalContent" style="text-align:center; max-height:75vh; overflow:auto;">
              <!-- Image will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Attachment Preview Modal -->
        <div id="attachmentModal" class="modal-overlay" style="display:none; z-index:10002;">
          <div class="modal" style="max-width: 90vw; max-height: 90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #000;">
              <h3 id="attachmentModalTitle" style="margin:0; font-weight:bold;">Attachment Preview</h3>
              <button id="attachmentModalClose" style="font-size:24px; padding:5px 10px; border:1px solid #000; background:#fff; cursor:pointer;">√ó</button>
            </div>
            <div id="attachmentModalContent" style="max-height:75vh; overflow:auto;">
              <!-- Attachment content will be displayed here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Email Send UI (duplicated from receive with send focus) -->
      <div id="email-send" style="margin:0; display:none; width:100%;">
        <div class="topbar">
          <button id="composeSendBtn" class="page-btn">Compose</button>
          <button id="testSendEmailBtn" class="page-btn">Send Test Email</button>
          <button id="testSmtpConnectionBtn" class="page-btn">Test SMTP Connection</button>
        </div>
        <div id="composeSendForm" style="display:none; background:#fff; padding:15px; border:1px solid #000; margin-bottom:15px;">
          <h3>Compose Email</h3>
          <input type="email" id="toSendEmail" placeholder="To:" style="margin-bottom:10px;">
          <input type="text" id="subjectSendEmail" placeholder="Subject:" style="margin-bottom:10px;">
          <textarea id="bodySendEmail" placeholder="Message:" style="margin-bottom:10px;"></textarea>
          <div class="row">
            <button id="sendEmailBtn" class="page-btn">Send</button>
            <button id="cancelSendBtn" class="page-btn">Cancel</button>
            <button id="dummyFillSendComposeBtn" class="page-btn" type="button" style="margin-left:auto;">Dummy Fill</button>
          </div>
        </div>
        <div style="border:1px solid #000; padding:15px; margin-bottom:15px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Sent Emails from m.yau.01@longriverlabel.com</h3>
            <button id="refreshSentEmailsBtn" class="page-btn">Refresh</button>
          </div>
          <table id="sentEmailsTable" style="width:100%; border-collapse:collapse; border:1px solid #000; margin-bottom:15px;">
            <thead>
              <tr style="background:#fff;">
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Date Sent</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">From</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">To</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Subject</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Status</th>
                <th style="padding:8px; border:1px solid #000; text-align:left; font-weight:bold;">Details</th>
              </tr>
              <tr style="background:#fff;">
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentDateSearch" placeholder="Search date..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentFromSearch" placeholder="Search sender..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentToSearch" placeholder="Search recipient..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentSubjectSearch" placeholder="Search subject..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <select id="sentStatusFilter" style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                    <option value="">All Status</option>
                    <option value="sent">Sent</option>
                    <option value="failed">Failed</option>
                  </select>
                </th>
                <th style="padding:8px; border:1px solid #000;">
                  <input type="text" id="sentDetailsSearch" placeholder="Search content..." style="width:100%; border:1px solid #000; padding:4px; box-sizing:border-box;">
                </th>
              </tr>
            </thead>
            <tbody id="sentEmailsTableBody"></tbody>
          </table>
          <div id="sentEmailsLoading" style="text-align:center; padding:20px; display:none;">Loading sent emails...</div>
          <div id="sentEmailsEmpty" style="text-align:center; padding:20px; color:#666; display:none;">No sent emails found from m.yau.01@longriverlabel.com</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const tabsBar = document.getElementById('tabsBar');
    const welcomePanel = document.getElementById('welcomePanel');
    const profilesListPanel = document.getElementById('profilesListPanel');
    const settingsPanel = document.getElementById('settingsPanel');

    const menuSettingsBtn = document.getElementById('menuSettings');
    const menuTasksBtn = document.getElementById('menuTasks');
    const menuSkillsBtn = document.getElementById('menuSkills');
    const menuQuotationBtn = document.getElementById('menuQuotation');
    const addProfileBtn = document.getElementById('addProfileBtn');
    const profilesListEl = document.getElementById('profilesList');
    const settingsNoteEl = document.getElementById('settingsNote');
    
    // Store current email list for quick access
    let currentEmails = [];
    let currentLoadController = null; // Track current load request
    let currentEmailMeta = null; // Track currently shown email (for task creation)
    let currentEmailModalMeta = null; // Track email in modal (for task creation)

    // -------- SETTINGS (board) --------
    const cfgMailUser = document.getElementById('cfgMailUser');
    const cfgMailPass = document.getElementById('cfgMailPass');
    const cfgImapHost = document.getElementById('cfgImapHost');
    const cfgImapPort = document.getElementById('cfgImapPort');
    const cfgImapTls = document.getElementById('cfgImapTls');
    const cfgSmtpHost = document.getElementById('cfgSmtpHost');
    const cfgSmtpPort = document.getElementById('cfgSmtpPort');
    const cfgSmtpSecure = document.getElementById('cfgSmtpSecure');
    const cfgPort = document.getElementById('cfgPort');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const dummyFillSettingsBtn = document.getElementById('dummyFillSettingsBtn');
    const togglePasswordBtn = document.getElementById('togglePassword');

    async function loadConfig() {
      try {
        const res = await fetch('/api/config', { cache: 'no-cache' });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Load Settings Error', JSON.stringify(data, null, 2));
          return;
        }
        const cfg = data.config || {};
        cfgMailUser.value = cfg.MAIL_USER || '';
        cfgMailPass.value = cfg.MAIL_PASS || '';
        cfgImapHost.value = cfg.IMAP_HOST || '';
        cfgImapPort.value = cfg.IMAP_PORT || '';
        cfgImapTls.value = cfg.IMAP_TLS || '';
        cfgSmtpHost.value = cfg.SMTP_HOST || '';
        cfgSmtpPort.value = cfg.SMTP_PORT || '';
        cfgSmtpSecure.value = cfg.SMTP_SECURE || '';
        cfgPort.value = cfg.PORT || '';
        settingsNoteEl.textContent = data.note || 'Changes require server restart.';
      } catch (err) {
        await showCopyableError('Load Settings Error', `Error loading config: ${err.message}`);
      }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // Helper functions for dummy file generation
    function generateDummyImage() {
      try {
        // Create a simple SVG placeholder image as a data URL
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
        const bgColor = colors[randomInt(0, colors.length - 1)];
        const textColor = '#000';
        const size = 200;

        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
          <rect width="${size}" height="${size}" fill="${bgColor}"/>
          <text x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="${textColor}">Dummy</text>
          <text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="${textColor}">Image</text>
        </svg>`;

        // Create a File object
        const blob = new Blob([svg], { type: 'image/svg+xml' });
        return new File([blob], `dummy-image-${randomInt(1000, 9999)}.svg`, { type: 'image/svg+xml' });
      } catch (e) {
        console.error('Failed to generate dummy image:', e);
        // Fallback: create a simple text file
        const fallbackContent = 'Dummy image placeholder';
        const blob = new Blob([fallbackContent], { type: 'text/plain' });
        return new File([blob], `dummy-image-fallback-${randomInt(1000, 9999)}.txt`, { type: 'text/plain' });
      }
    }

    function generateDummyAttachment() {
      try {
        const fileTypes = [
          { ext: 'pdf', type: 'application/pdf', name: 'Document' },
          { ext: 'docx', type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', name: 'Document' },
          { ext: 'xlsx', type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', name: 'Spreadsheet' },
          { ext: 'txt', type: 'text/plain', name: 'Text File' },
          { ext: 'zip', type: 'application/zip', name: 'Archive' }
        ];

        const fileType = fileTypes[randomInt(0, fileTypes.length - 1)];
        const fileName = `${fileType.name.toLowerCase().replace(' ', '-')}-${randomInt(1000, 9999)}.${fileType.ext}`;

        // Create dummy content based on file type
        let content = '';
        switch (fileType.ext) {
          case 'txt':
            content = `This is a dummy ${fileType.name} generated for testing purposes.\nCreated on: ${new Date().toISOString()}\nRandom number: ${randomInt(1000, 9999)}`;
            break;
          case 'pdf':
          case 'docx':
          case 'xlsx':
          case 'zip':
            content = `Dummy ${fileType.name} content - ${randomInt(1000, 9999)}`;
            break;
        }

        const blob = new Blob([content], { type: fileType.type });
        return new File([blob], fileName, { type: fileType.type });
      } catch (e) {
        console.error('Failed to generate dummy attachment:', e);
        // Fallback: create a simple text file
        const fallbackContent = 'Dummy attachment placeholder';
        const blob = new Blob([fallbackContent], { type: 'text/plain' });
        return new File([blob], `dummy-attachment-fallback-${randomInt(1000, 9999)}.txt`, { type: 'text/plain' });
      }
    }

    function simulateFileInput(inputEl, files) {
      try {
        // Create a DataTransfer object to simulate file selection
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));

        // Set the files property
        inputEl.files = dt.files;

      // Dispatch change event to trigger any file handling logic
      // Use setTimeout to ensure event is dispatched after current execution context
      setTimeout(() => {
        try {
          inputEl.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch change event for file input:', e);
        }
      }, 0);

        console.log(`Simulated ${files.length} dummy file(s) for ${inputEl.id || inputEl.name}`);
      } catch (e) {
        console.error('Failed to simulate file input:', e);
      }
    }

    function fillDummyForm(panelEl) {
      const controls = Array.from(panelEl.querySelectorAll('input, textarea, select'));

      for (const el of controls) {
        if (el.disabled) continue;
        if (el.tagName === 'INPUT') {
          const type = (el.type || 'text').toLowerCase();
          if (type === 'button' || type === 'submit' || type === 'reset' || type === 'hidden') continue;
        }

        // Skip hidden/inactive elements (but allow file inputs even if hidden)
        if (el.offsetParent === null && el.type !== 'file') continue;

        const id = (el.id || '').toLowerCase();
        const name = (el.name || '').toLowerCase();
        const labelEl = el.id ? panelEl.querySelector(`label[for="${CSS.escape(el.id)}"]`) : null;
        const label = (labelEl?.textContent || '').toLowerCase();
        const hint = `${id} ${name} ${label}`;

        if (el.tagName === 'SELECT') {
          const enabledOptions = Array.from(el.options).filter(o => !o.disabled && o.value !== '');
          if (enabledOptions.length) el.value = randomFrom(enabledOptions).value;
          continue;
        }

        if (el.tagName === 'TEXTAREA') {
          if (!el.value.trim()) el.value = 'Dummy text ' + randomInt(1000, 9999);
          try {
          el.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch input event:', e);
        }
          continue;
        }

        // INPUT types
        const type = (el.type || 'text').toLowerCase();
        if (type === 'checkbox') {
          el.checked = true;
          try {
          el.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch change event:', e);
        }
          continue;
        }
        if (type === 'radio') {
          el.checked = true;
          try {
          el.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch change event:', e);
        }
          continue;
        }
        if (type === 'number') {
          if (!String(el.value || '').trim()) el.value = String(randomInt(1, 9999));
          try {
          el.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch input event:', e);
        }
          continue;
        }
        if (el.tagName === 'SELECT') {
          if (hint.includes('contact') && hint.includes('person')) {
            // Special handling for contact person - will be populated when customer is selected
            continue;
          }
          const enabledOptions = Array.from(el.options).filter(o => !o.disabled && o.value !== '');
          if (enabledOptions.length) el.value = randomFrom(enabledOptions).value;
          try {
          el.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch change event:', e);
        }
          continue;
        }
        if (type === 'email') {
          if (!el.value.trim()) el.value = `dummy${randomInt(10, 999)}@example.com`;
          try {
          el.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch input event:', e);
        }
          continue;
        }
        if (type === 'password') {
          if (!el.value) el.value = 'DummyPass' + randomInt(1000, 9999);
          try {
          el.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch input event:', e);
        }
          continue;
        }
        if (type === 'file') {
          // Handle file inputs - simulate file selection with dummy data
          if (hint.includes('image') || hint.includes('profile') || hint.includes('photo') || el.accept?.includes('image')) {
            // Generate dummy image for image inputs
            const dummyFile = generateDummyImage();
            simulateFileInput(el, [dummyFile]);
          } else {
            // Generate dummy attachments for other file inputs
            const numFiles = el.multiple ? randomInt(1, 3) : 1;
            const dummyFiles = [];
            for (let i = 0; i < numFiles; i++) {
              dummyFiles.push(generateDummyAttachment());
            }
            simulateFileInput(el, dummyFiles);
          }
          continue;
        }

        // Heuristics based on id/label
        if (!el.value.trim()) {
          if (hint.includes('imap_host')) el.value = 'imap.example.com';
          else if (hint.includes('smtp_host')) el.value = 'smtp.example.com';
          else if (hint.includes('host')) el.value = 'localhost';
          else if (hint.includes('imap_port')) el.value = '993';
          else if (hint.includes('smtp_port')) el.value = '465';
          else if (hint.includes('port')) el.value = '3001';
          else if (hint.includes('tls') || hint.includes('secure')) el.value = 'true';
          else if (hint.includes('customer') && hint.includes('name')) el.value = 'ABC Company Ltd';
          else if (hint.includes('contact') && hint.includes('person')) el.value = 'John Smith';
          else if (hint.includes('phone')) el.value = '+852 ' + randomInt(90000000, 99999999);
          else if (hint.includes('size')) el.value = randomInt(1, 5) + 'x' + randomInt(1, 8) + ' inches';
          else if (hint.includes('width')) el.value = randomInt(1, 4) + ' inch';
          else if (hint.includes('quantity')) el.value = String(randomFrom([500, 1000, 2000, 5000, 10000]));
          else if (hint.includes('unit') && hint.includes('price')) el.value = String(randomFrom([0.1, 0.25, 0.5, 0.75, 1.0, 1.5, 2.0]));
          else el.value = 'Dummy ' + randomInt(1000, 9999);
        }
        try {
          el.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (e) {
          console.warn('Failed to dispatch input event:', e);
        }
      }
    }

    dummyFillSettingsBtn.onclick = () => {
      fillDummyForm(settingsPanel);
    };

    togglePasswordBtn.onclick = () => {
      const passwordInput = document.getElementById('cfgMailPass');
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      togglePasswordBtn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    };

    saveConfigBtn.onclick = async () => {
      try {
        // 1) Validate settings form completeness FIRST (before any profile-name prompt)
        const inputs = Array.from(settingsPanel.querySelectorAll('input'));
        const missingLabels = [];

        for (const input of inputs) {
          // Skip inputs that are not actionable/visible
          if (input.disabled) continue;
          if (input.type === 'button' || input.type === 'submit' || input.type === 'reset') continue;

          // Skip hidden inputs or anything inside a hidden container
          // (offsetParent is null when display:none or not in layout)
          if (input.type === 'hidden' || input.offsetParent === null) continue;

          const value = (input.value ?? '').toString().trim();
          if (value) continue;

          // Derive label from <label for="..."> when possible, fallback to id/name
          const labelEl = settingsPanel.querySelector(`label[for="${CSS.escape(input.id)}"]`);
          const label = (labelEl?.textContent || input.name || input.id || 'Unnamed field').trim();
          missingLabels.push(label);
        }

        if (missingLabels.length) {
          await showModal({
            title: 'Incomplete fields',
            body: `Please fill in:\n${missingLabels.join('\n')}`
          });
          return;
        }

        // 2) Load existing profiles (for duplicate name check)
        const listRes = await fetch('/api/profiles', { cache: 'no-cache' });
        const listData = await listRes.json();
        const profiles = listData?.profiles || [];

        // 3) Prompt for profile name (required + unique)
        let profileName = currentEditingProfileId ? (profiles.find(p => p.id === currentEditingProfileId)?.name || '') : '';
        while (true) {
          const result = await showTextInputModal({
            title: 'Profile name',
            label: 'Profile name (required):',
            initialValue: profileName,
            okText: 'OK',
            cancelText: 'Cancel'
          });

          if (!result.ok) {
            return; // user cancelled
          }

          profileName = (result.value || '').trim();
          if (!profileName) {
            await showModal({ title: 'Profile name required', body: 'Please enter a profile name.' });
            continue;
          }
          const exists = profiles.some(p => String(p.name || '').toLowerCase() === profileName.toLowerCase() && p.id !== currentEditingProfileId);
          if (exists) {
            await showModal({ title: 'Name already exists', body: `Profile name "${profileName}" already exists. Please use a different name.` });
            continue;
          }
          break;
        }

        const payload = {
          name: profileName,
          remark: profileName,
          mailUser: cfgMailUser.value.trim(),
          mailPass: cfgMailPass.value,
          imapHost: cfgImapHost.value.trim(),
          imapPort: cfgImapPort.value.trim(),
          imapTls: cfgImapTls.value.trim(),
          smtpHost: cfgSmtpHost.value.trim(),
          smtpPort: cfgSmtpPort.value.trim(),
          smtpSecure: cfgSmtpSecure.value.trim(),
          port: cfgPort.value.trim(),
          isActive: 0,
        };

        const url = currentEditingProfileId ? `/api/profiles/${currentEditingProfileId}` : '/api/profiles';
        const method = currentEditingProfileId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Save Profile Error', JSON.stringify(data, null, 2));
          return;
        }

        settingsHasUnsavedChanges = false;
        await loadProfilesList();

        await showModal({
          title: 'Profile Saved',
          body: `Profile "${profileName}" saved.\nIf you want it to take effect for sending/receiving email, select the profile and implement activation logic (next step).`,
        });

        // Close editor after saving
        settingsPanel.style.display = 'none';
        currentEditingProfileId = null;
      } catch (err) {
        await showCopyableError('Save Profile Error', `Error saving profile: ${err.message}`);
      }
    };

    // Track changes to settings form
    [cfgMailUser, cfgMailPass, cfgImapHost, cfgImapPort, cfgImapTls, cfgSmtpHost, cfgSmtpPort, cfgSmtpSecure, cfgPort].forEach(input => {
      input.addEventListener('input', () => {
        settingsHasUnsavedChanges = true;
      });
    });

    // Track if settings have unsaved changes
    let settingsHasUnsavedChanges = false;
    let currentEditingProfileId = null; // null means creating new profile

    // --- Tabs handling (welcome + future boards) ---
    function ensureTab(id, label) {
      let tab = tabsBar.querySelector(`[data-tab-id="${id}"]`);
      if (!tab) {
        tab = document.createElement('div');
        tab.className = 'tab';
        tab.dataset.tabId = id;
        
        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        tab.appendChild(labelSpan);
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.textContent = '√ó';
        closeBtn.onclick = async (e) => {
          e.stopPropagation();
          await closeTab(id);
        };
        tab.appendChild(closeBtn);
        
        tab.onclick = () => activateTab(id);
        tabsBar.appendChild(tab);
      }
      return tab;
    }

    async function closeTab(id) {
      // Always prompt warning before closing profiles tab
      if (id === 'profiles') {
        const confirmed = await showModal({
          title: 'Warning',
          body: 'Closing this tag will lose everything.',
          okText: 'Close',
          cancelText: 'Cancel'
        });
        if (!confirmed) {
          return; // Do not close if user cancels
        }
      }
      
      // Hide all panels first
      settingsPanel.style.display = 'none';
      profilesListPanel.style.display = 'none';
      
      // Remove tab
      const tab = tabsBar.querySelector(`[data-tab-id="${id}"]`);
      if (tab) {
        tab.remove();
      }
      
      // Always switch to welcome when closing a tab
      activateTab('welcome');
      
      // Reset unsaved changes flag
      settingsHasUnsavedChanges = false;
    }

    function activateTab(id) {
      // Visual active state
      Array.from(tabsBar.children).forEach(el => {
        if (el.dataset.tabId === id) {
          el.classList.add('tab-active');
        } else {
          el.classList.remove('tab-active');
        }
      });

      // Panels
      welcomePanel.style.display = id === 'welcome' ? 'block' : 'none';
      profilesListPanel.style.display = id === 'profiles' ? 'block' : 'none';
      document.getElementById('emails').style.display = id === 'emails' ? 'block' : 'none';
      document.getElementById('email-send').style.display = id === 'email-send' ? 'block' : 'none';
      document.getElementById('customerPanel').style.display = id === 'customer' ? 'block' : 'none';
      document.getElementById('customerViewPanel').style.display = id === 'customer-view' ? 'block' : 'none';
      document.getElementById('tasksPanel').style.display = id === 'tasks' ? 'block' : 'none';
      document.getElementById('skillsPanel').style.display = id === 'skills' ? 'block' : 'none';
      document.getElementById('quotationPanel').style.display = id === 'quotation' ? 'block' : 'none';
      document.getElementById('quotationViewPanel').style.display = id === 'quotation-view' ? 'block' : 'none';
      // settingsPanel is shown inline within profiles when a profile is clicked
      settingsPanel.style.display = 'none';

      if (id === 'profiles') {
        loadProfilesList().catch(() => {});
      }
    }

    // Profiles list functions
    async function loadProfilesList() {
      try {
        const res = await fetch('/api/profiles', { cache: 'no-cache' });
        const data = await res.json();
        if (!data.success) {
          await showCopyableError('Load Profiles Error', JSON.stringify(data, null, 2));
          return;
        }
        const profiles = data.profiles || [];
        
        // If no profiles, create default "longriver.com"
        if (profiles.length === 0) {
          await createDefaultProfile();
          return loadProfilesList(); // Reload after creating default
        }

        profilesListEl.innerHTML = '';
        profiles.forEach(p => {
          const item = document.createElement('div');
          item.style.cssText = 'padding:12px; border-bottom:1px solid #000; cursor:pointer;';
          item.innerHTML = `
            <div style="font-weight:700;">${p.name || 'Unnamed'}</div>
            <div class="meta">${p.remark || ''}</div>
            <div class="meta" style="font-size:0.85em;">${p.mailUser || ''} | Active: ${p.isActive ? 'Yes' : 'No'}</div>
          `;
          item.innerHTML += `<div style="margin-top:6px; display:flex; gap:6px;">
              <button class="btn ${p.isActive ? 'primary' : ''}" data-action="activate">${p.isActive ? 'Active' : 'Activate'}</button>
              <button class="btn" data-action="edit">Edit</button>
              <button class="btn" data-action="delete">Delete</button>
            </div>`;
          item.onclick = (e) => {
            const action = e.target?.dataset?.action;
            if (action === 'activate') {
              e.stopPropagation();
              (async () => {
                // Toggle active state
                const newActiveState = p.isActive ? 0 : 1;
                const res = await fetch(`/api/profiles/${p.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ...p, isActive: newActiveState })
                });
                const data = await res.json();
                if (!data.success) {
                  await showCopyableError('Update Profile Error', JSON.stringify(data, null, 2));
                  return;
                }
                await loadProfilesList(); // Refresh the list
              })();
            } else if (action === 'edit') {
              e.stopPropagation();
              // Edit profile
              currentEditingProfileId = p.id;
            settingsPanel.style.display = 'block';
            cfgMailUser.value = p.mailUser || '';
            cfgMailPass.value = p.mailPass || '';
            cfgImapHost.value = p.imapHost || '';
            cfgImapPort.value = p.imapPort || '';
            cfgImapTls.value = p.imapTls || 'true';
            cfgSmtpHost.value = p.smtpHost || '';
            cfgSmtpPort.value = p.smtpPort || '';
            cfgSmtpSecure.value = p.smtpSecure || 'true';
            cfgPort.value = p.port || '';
            } else if (action === 'delete') {
              e.stopPropagation();
              (async () => {
                const ok = await showModal({
                  title: 'Delete profile',
                  body: `Delete profile "${p.name}"?`,
                  okText: 'Delete',
                  cancelText: 'Cancel'
                });
                if (!ok) return;
                await fetch(`/api/profiles/${p.id}`, { method: 'DELETE' });
                await loadProfilesList();
              })();
            } else {
              // View profile details (toggle behavior)
              if (currentEditingProfileId === p.id && settingsPanel.style.display === 'block') {
                // Clicking the same profile that's currently displayed - collapse it
                settingsPanel.style.display = 'none';
                currentEditingProfileId = null;
              } else {
                // Clicking a different profile or expanding - show it
              currentEditingProfileId = p.id;
              settingsPanel.style.display = 'block';
              cfgMailUser.value = p.mailUser || '';
              cfgMailPass.value = p.mailPass || '';
              cfgImapHost.value = p.imapHost || '';
              cfgImapPort.value = p.imapPort || '';
              cfgImapTls.value = p.imapTls || 'true';
              cfgSmtpHost.value = p.smtpHost || '';
              cfgSmtpPort.value = p.smtpPort || '';
              cfgSmtpSecure.value = p.smtpSecure || 'true';
              cfgPort.value = p.port || '';
              }
            }
          };
          profilesListEl.appendChild(item);
        });
      } catch (err) {
        await showCopyableError('Load Profiles Error', `Error: ${err.message}`);
      }
    }

    async function createDefaultProfile() {
      try {
        // Get current config from server
        const configRes = await fetch('/api/config', { cache: 'no-cache' });
        const configData = await configRes.json();
        const cfg = configData.config || {};

        // Default profile: longriver.com
        const res = await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'longriver.com',
            remark: 'longriver.com',
            mailUser: cfg.MAIL_USER || '',
            mailPass: cfg.MAIL_PASS || '',
            imapHost: cfg.IMAP_HOST || 'imap.bbmail.com.hk',
            imapPort: Number(cfg.IMAP_PORT) || 993,
            imapTls: cfg.IMAP_TLS || 'true',
            smtpHost: cfg.SMTP_HOST || 'homegw.bbmail.com.hk',
            smtpPort: Number(cfg.SMTP_PORT) || 465,
            smtpSecure: cfg.SMTP_SECURE || 'true',
            port: Number(cfg.PORT) || 3001,
            isActive: 1
          })
        });
        const data = await res.json();
        if (!data.success) {
          console.error('Failed to create default profile:', data);
        }

        // Additional profile: lcf
        const resLcf = await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'lcf',
            remark: 'lcf',
            mailUser: 'weiwu@fuchanghk.com',
            mailPass: 'mrkE190#',
            imapHost: 'imap.qiye.163.com',
            imapPort: 993,
            imapTls: 'true',
            smtpHost: 'smtp.qiye.163.com',
            smtpPort: 994,
            smtpSecure: 'true',
            port: 3001,
            isActive: 0
          })
        });
        const dataLcf = await resLcf.json();
        if (!dataLcf.success) {
          console.error('Failed to create lcf profile:', dataLcf);
        }
      } catch (err) {
        console.error('Error creating default profile:', err);
      }
    }

    // Initial state: Welcome tab
    ensureTab('welcome', 'Welcome');
    activateTab('welcome');

    const menuEmailBtn = document.getElementById('menuEmail');
    const menuCustomerBtn = document.getElementById('menuCustomer');
    const sidebar = document.getElementById('sidebar');

    // Menu click: toggle email submenu
    menuEmailBtn.onclick = () => {
      const submenu = document.getElementById('emailSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Menu click: toggle customer submenu
    menuCustomerBtn.onclick = () => {
      const submenu = document.getElementById('customerSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Menu click: toggle quotation submenu
    menuQuotationBtn.onclick = () => {
      const submenu = document.getElementById('quotationSubmenu');
      const isVisible = submenu.style.display !== 'none';

      // Hide all other submenus first
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });

      // Toggle this submenu
      submenu.style.display = isVisible ? 'none' : 'block';
    };

    // Customer submenu buttons
    const customerCreateBtn = document.getElementById('customerCreateBtn');
    const customerViewBtn = document.getElementById('customerViewBtn');

    customerCreateBtn.onclick = () => {
      // Hide submenu and go to customer creation
      document.getElementById('customerSubmenu').style.display = 'none';
      ensureTab('customer', 'Customer (Create)');
      activateTab('customer');
      initializeCustomerPanel();
    };

    customerViewBtn.onclick = () => {
      // Hide submenu and go to customer view
      document.getElementById('customerSubmenu').style.display = 'none';
      ensureTab('customer-view', 'Customer (View)');
      activateTab('customer-view');
      initializeCustomerViewPanel();
    };

    // Email submenu buttons
    const emailReceiveBtn = document.getElementById('emailReceiveBtn');
    const emailSendBtn = document.getElementById('emailSendBtn');

    emailReceiveBtn.onclick = () => {
      // Hide submenu and go to email receive board
      document.getElementById('emailSubmenu').style.display = 'none';
      ensureTab('emails', 'Email (receive)');
      activateTab('emails');
      // Load emails if not already loaded
      if (!currentEmails || currentEmails.length === 0) {
        load(true);
      }
    };

    emailSendBtn.onclick = () => {
      // Hide submenu and go to email send board
      document.getElementById('emailSubmenu').style.display = 'none';
      ensureTab('email-send', 'Email (send)');
      activateTab('email-send');
      // Initialize email send panel
      initializeEmailSendPanel();
    };

    // Hover on entire sidebar to show full text
    sidebar.onmouseenter = () => {
      menuEmailBtn.textContent = menuEmailBtn.dataset.full || 'Email';
      menuCustomerBtn.textContent = menuCustomerBtn.dataset.full || 'Customer';
      menuSettingsBtn.textContent = menuSettingsBtn.dataset.full || 'Setting';
      menuTasksBtn.textContent = menuTasksBtn.dataset.full || 'Task List';
      menuSkillsBtn.textContent = menuSkillsBtn.dataset.full || 'Skills';
      menuQuotationBtn.textContent = menuQuotationBtn.dataset.full || 'Quotation';
    };
    sidebar.onmouseleave = () => {
      menuEmailBtn.textContent = menuEmailBtn.dataset.short || 'E';
      menuCustomerBtn.textContent = menuCustomerBtn.dataset.short || 'C';
      menuSettingsBtn.textContent = menuSettingsBtn.dataset.short || 'S';
      menuTasksBtn.textContent = menuTasksBtn.dataset.short || 'T';
      menuSkillsBtn.textContent = menuSkillsBtn.dataset.short || 'K';
      menuQuotationBtn.textContent = menuQuotationBtn.dataset.short || 'Q';
      // Hide submenus on mouse leave
      document.querySelectorAll('.submenu').forEach(sub => {
        sub.style.display = 'none';
      });
    };

    // Menu click: show profiles list (settings landing page)
    menuSettingsBtn.onclick = () => {
      ensureTab('profiles', 'Setting');
      activateTab('profiles');
      loadProfilesList();
    };

    // Menu click: show tasks
    menuTasksBtn.onclick = () => {
      ensureTab('tasks', 'Task');
      activateTab('tasks');
    };

    // Menu click: show agent skills
    menuSkillsBtn.onclick = () => {
      ensureTab('skills', 'Agent Skills');
      activateTab('skills');
      loadAgentSkills();
    };

    // Quotation submenu button
    const quotationCreateBtn = document.getElementById('quotationCreateBtn');

    quotationCreateBtn.onclick = () => {
      // Hide submenu and go to quotation creation board
      document.getElementById('quotationSubmenu').style.display = 'none';
      ensureTab('quotation', 'Quotation (create)');
      activateTab('quotation');
      initializeQuotationPanel();
    };

    quotationViewBtn.onclick = () => {
      // Hide submenu and go to quotation view
      document.getElementById('quotationSubmenu').style.display = 'none';
      ensureTab('quotation-view', 'Quotation (View)');
      activateTab('quotation-view');
      initializeQuotationViewPanel();
    };

    // Add profile button
    addProfileBtn.onclick = () => {
      // Show blank form for new profile input
      settingsPanel.style.display = 'block';
      currentEditingProfileId = null; // create mode
      cfgMailUser.value = '';
      cfgMailPass.value = '';
      cfgImapHost.value = '';
      cfgImapPort.value = '';
      cfgImapTls.value = 'true';
      cfgSmtpHost.value = '';
      cfgSmtpPort.value = '';
      cfgSmtpSecure.value = 'true';
      cfgPort.value = '';
    };
    
    async function load(showLoading = true) {
      try {
        // Cancel any existing load request
        if (currentLoadController) {
          
          currentLoadController.abort();
        }
        
        // Create new abort controller for this request
        currentLoadController = new AbortController();
        const controller = currentLoadController;
        
        if (showLoading) {
          const tableBody = document.getElementById('emailTableBody');
          tableBody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center; border:1px solid #000;">Loading emails...</td></tr>';
        } else {
          
        }
        
        // Add timeout to fetch request
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            
            controller.abort();
          }
        }, 30000); // 30 second timeout
        
        let res;
        try {
          res = await fetch('/api/emails?limit=50', { 
            signal: controller.signal,
            cache: 'no-cache' // Prevent caching
          });
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on success
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on error
          
          if (fetchErr.name === 'AbortError') {
            // Only show error if we were showing loading state
            if (showLoading) {
              throw new Error('Request timeout - server took too long to respond');
            } else {
              // Background refresh failed, just log it
              console.warn('Background refresh failed:', fetchErr.message);
              return;
            }
          }
          throw fetchErr;
        }
        
        
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to load emails';
          const errorCode = errorData.code ? ` (${errorData.code})` : '';
          const troubleshooting = errorData.troubleshooting ? '\n\nTroubleshooting:\n' + errorData.troubleshooting.join('\n') : '';

          await showCopyableError('Email Loading Error',
            `Error: ${errorMsg}${errorCode}\nStatus: ${res.status}${troubleshooting}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`
          );
          return;
        }
        
        const data = await res.json();
        
        
        if (!data.success) {
          const tableBody = document.getElementById('emailTableBody');
          tableBody.innerHTML = `<tr><td colspan="5" style="padding:20px; border:1px solid #000; text-align:center;">Error: ${data.error || 'Failed to load emails'}</td></tr>`;
          console.error('API error:', data);
          return;
        }
        
        const emails = data.emails || [];
        
        currentEmails = emails; // Store for reference
        
        // Render the email list (only if showLoading was true, otherwise we're in background)
        if (showLoading) {
          renderEmailList(emails);
        } else {
          // Background refresh - update cache and re-render list
          currentEmails = emails;
            renderEmailList(emails);
        }
      } catch (err) {
        console.error('Load function error:', err);
        // Show error modal for any loading issues
        await showCopyableError('Email Loading Error',
          `Failed to load emails: ${err.message}\n\nThis could be due to:\n‚Ä¢ Network connectivity issues\n‚Ä¢ Email server configuration problems\n‚Ä¢ Authentication failures\n\nStack trace:\n${err.stack || 'N/A'}`
        );
      }
    }
    
    async function show(uid){
      // NOTE: after long idle, the browser may throw "TypeError: Failed to fetch" even though
      // the backend can reconnect. We retry once automatically to avoid showing an error popup.
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      // Show loading state in modal
      document.getElementById('emailModalBody').textContent = 'Loading email...';

      async function fetchEmailOnce(attempt){
        

        // Add timeout to fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            
            controller.abort();
          }
        }, 30000); // 30 second timeout

        try {
          const res = await fetch('/api/emails/'+uid, {
            signal: controller.signal,
            cache: 'no-cache'
          });
          clearTimeout(timeoutId);

          

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${res.status}` };
            }
            const errorMsg = errorData.error || 'Failed to fetch email';
            const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isHttpError = true;
            err.__fullError = fullError;
            throw err;
          }

          const data = await res.json();
          if (!data.success) {
            const errorMsg = data.error || 'Failed to load email';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            const err = new Error(errorMsg);
            err.__isApiError = true;
            err.__fullError = fullError;
            throw err;
          }

          return data;
        } catch (fetchErr) {
          clearTimeout(timeoutId);

          // Normalize "idle timeout" style errors so we can retry once.
          const isAbort = fetchErr?.name === 'AbortError';
          const msg = fetchErr?.message || '';
          const isNetwork = msg.includes('Failed to fetch') || msg.includes('NetworkError') || fetchErr instanceof TypeError;
          const isRetryable = isAbort || isNetwork;

          if (isRetryable) {
            const err = new Error(isAbort
              ? 'Request timeout - server took too long to respond'
              : 'Network error - connection lost');
            err.__retryable = true;
            err.__original = fetchErr;
            throw err;
          }

          throw fetchErr;
        }
      }

      let data;
      try {
        data = await fetchEmailOnce(1);
      } catch (err1) {
        // Retry once automatically for idle network/timeout issues
        if (err1?.__retryable) {
          // Inform user we are reconnecting, but do not show any popup
          document.getElementById('d-body').textContent = 'Connection timed out (idle). Reconnecting??(retrying)';
          
          // Refresh email list/cache in the background so we truly "reconnect"
          try {
            await load(false);
          } catch (loadErr) {
            console.warn('Background reconnect (list reload) failed:', loadErr);
          }

          await sleep(500); // small pause so reconnect can settle

          try {
            // Second attempt to fetch the same email after reconnect
            data = await fetchEmailOnce(2);
          } catch (err2) {
            // Show error in modal
            console.warn('Email fetch failed after retry:', err2);
            document.getElementById('emailModalBody').textContent = 'Failed to load email. Please try again.';
            return;
          }
        } else if (err1?.__fullError) {
          showCopyableError(err1.__isHttpError ? 'Fetch Email Error' : 'Email Error', err1.__fullError);
          console.error('Fetch email error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        } else {
          const fullError = `Error fetching email: ${err1.message}\n\nUID: ${uid}\n\nStack trace:\n${err1.stack || 'N/A'}`;
          showCopyableError('Network Error', fullError);
          console.error('Fetch error:', err1);
          document.getElementById('emailModal').style.display='none';
          document.body.classList.remove('modal-open');
          return;
        }
      }
        
        // Parse email from source - simplified to just show context/body
        const source = data.source || '';
        let subject = '';
        let from = '';
        let date = '';
        let bodyContent = '';
        
        // Extract headers
        const subjectMatch = source.match(/^Subject:\s*(.+)$/mi);
        const fromMatch = source.match(/^From:\s*(.+)$/mi);
        const dateMatch = source.match(/^Date:\s*(.+)$/mi);
        
        if (subjectMatch) subject = subjectMatch[1].trim();
        if (fromMatch) from = fromMatch[1].trim();
        if (dateMatch) date = dateMatch[1].trim();
        
        // Extract just the actual email content (skip headers and boundaries)
        const headerEndMatch = source.match(/\n\n|\r\n\r\n/);
        if (headerEndMatch) {
          const bodyPart = source.substring(headerEndMatch.index + headerEndMatch[0].length);

          // Simple approach: find the first actual content after headers
          // Look for content that comes after Content-Type declarations
          const lines = bodyPart.split('\n');
          let contentStart = -1;

          for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('Content-Type:') && lines[i+1] && lines[i+1].includes('Content-Transfer-Encoding:')) {
              // Found a content section, the actual content starts 2 lines after the encoding line
              contentStart = i + 2;
              break;
            }
          }

          if (contentStart >= 0 && contentStart < lines.length) {
            // Collect content until we hit a boundary
            const contentLines = [];
            for (let i = contentStart; i < lines.length; i++) {
              if (lines[i].startsWith('----_')) {
                break; // Stop at boundary
              }
              contentLines.push(lines[i]);
            }
            let rawContent = contentLines.join('\n').trim();

            // Check if content is base64 encoded (look for base64 in the Content-Transfer-Encoding header)
            let isHtmlContent = false;
            if (lines[contentStart - 1] && lines[contentStart - 1].toLowerCase().includes('base64')) {
              try {
                // Remove any whitespace and validate base64 format
                const cleanBase64 = rawContent.replace(/\s/g, '');

                // Check if it looks like valid base64 (only contains valid base64 characters)
                if (/^[A-Za-z0-9+/]*={0,2}$/.test(cleanBase64)) {
                  const decodedContent = atob(cleanBase64);

                  // Check if decoded content is HTML
                  if (decodedContent.includes('<') && decodedContent.includes('>')) {
                    isHtmlContent = true;
                    bodyContent = decodedContent;
            } else {
                    bodyContent = decodedContent;
            }
          } else {
                  console.warn('Content appears to be base64 but contains invalid characters, keeping original');
                  bodyContent = rawContent;
                }
              } catch (e) {
                console.warn('Failed to decode base64 content:', e);
                // Keep original content if decoding fails
                bodyContent = rawContent;
          }
        } else {
              bodyContent = rawContent;
            }

            // Handle HTML content display
            if (isHtmlContent) {
              document.getElementById('emailModalBody').innerHTML = bodyContent;
              return; // Skip normal text display
            }
          } else {
            // Try to extract any readable content from mixed/corrupted emails
            let extractedContent = '';

            // Look for any lines that might be readable text (not base64, not headers)
            const contentLines = bodyPart.split('\n');
            for (const line of contentLines) {
              // Skip obvious headers and boundaries
              if (line.includes('Content-Type:') ||
                  line.includes('Content-Transfer-Encoding:') ||
                  line.startsWith('----') ||
                  line.trim() === '' ||
                  line.includes('charset=')) {
                continue;
              }

              // Try to decode if it looks like base64
              if (/^[A-Za-z0-9+/]*={0,2}$/.test(line.trim()) && line.length > 10) {
                try {
                  const decoded = atob(line.trim());
                  // Only use if decoding gives readable text
                  if (decoded.length > 0 && !/[\x00-\x08\x0B\x0C\x0E-\x1F]/.test(decoded)) {
                    extractedContent += decoded + '\n';
                    continue;
                  }
                } catch (e) {
                  // Not valid base64, continue
                }
              }

              // Keep line if it looks like readable text
              if (line.length > 0 && !/^[A-Za-z0-9+/]*={0,2}$/.test(line.trim().replace(/\s/g, ''))) {
                extractedContent += line + '\n';
              }
            }

            bodyContent = extractedContent.trim() || bodyPart.replace(/----_[^\n]*\n/g, '').replace(/Content-Type:[^\n]*\n/g, '').replace(/Content-Transfer-Encoding:[^\n]*\n/g, '').replace(/^\n+/, '').replace(/\n+$/, '');
          }
        } else {
          // Fallback: show the whole source
          bodyContent = source;
        }

        // Display just the actual message content
        document.getElementById('emailModalBody').textContent = bodyContent || 'No content available';

        // Display email metadata in modal
        document.getElementById('emailModalSubject').textContent = subject || '(No subject)';
        document.getElementById('emailModalFrom').textContent = `From: ${from || 'Unknown'}`;
        document.getElementById('emailModalDate').textContent = `Date: ${date || 'Unknown'}`;

        // Extract plain email address from From header if possible
        let emailAddress = null;
        if (from) {
          const m = from.match(/<([^>]+)>/);
          emailAddress = m ? m[1].trim() : from.trim();
        }

        // Remember current email meta for task creation
        // Extract To header if present
        let toAddress = null;
        const toMatch = source.match(/^To:\s*(.+)$/mi);
        if (toMatch) {
          toAddress = toMatch[1].trim();
        }

        currentEmailMeta = {
          uid,
          subject: subject || '',
          from: from || '',
          email: emailAddress || null,
          to: toAddress || null,
          date: date || ''
        };
        
      // Show email modal
      populateEmailModal(subject, from, date, bodyContent, currentEmailMeta);
      // Ensure modal is attached to document.body so it's visible even when the emails panel is hidden
      try {
        const modalEl = document.getElementById('emailModal');
        if (modalEl && modalEl.parentNode !== document.body) {
          document.body.appendChild(modalEl);
        }
      } catch (attachErr) {
        console.error('Failed to attach modal to body:', attachErr);
      }
      document.getElementById('emailModal').style.display='flex';
      document.body.classList.add('modal-open');
    }
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randPick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randString(len) {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let out = '';
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    function fillFormDummy(container, { includeHidden = false } = {}) {
      const inputs = Array.from(container.querySelectorAll('input'));
      const textareas = Array.from(container.querySelectorAll('textarea'));

      const fillInput = (input) => {
        if (input.disabled) return;
        if (input.type === 'button' || input.type === 'submit' || input.type === 'reset') return;
        if (!includeHidden && (input.type === 'hidden' || input.offsetParent === null)) return;

        const id = (input.id || '').toLowerCase();
        const name = (input.name || '').toLowerCase();
        const key = `${id} ${name}`;

        if (input.type === 'email' || key.includes('mail_user') || key.includes('user') || key.includes('email')) {
          const domain = randPick(['example.com', 'longriver.com', 'test.local']);
          input.value = `user.${randString(6)}@${domain}`;
        } else if (input.type === 'password' || key.includes('pass')) {
          input.value = `P@ss${randString(10)}!`;
        } else if (input.type === 'number' || key.includes('port')) {
          // reasonable defaults for known ports
          if (key.includes('imap')) input.value = String(randPick([993, 143]));
          else if (key.includes('smtp')) input.value = String(randPick([465, 587, 25]));
          else input.value = String(randPick([3001, 3000, 8080, randInt(1024, 65535)]));
        } else if (key.includes('tls') || key.includes('secure')) {
          input.value = randPick(['true', 'false']);
        } else if (key.includes('host')) {
          const host = randPick(['imap.qiye.163.com', 'smtp.qiye.163.com', 'imap.bbmail.com.hk', 'homegw.bbmail.com.hk', 'mail.example.com']);
          input.value = host;
        } else {
          input.value = randString(10);
        }

        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
      };

      const fillTextarea = (ta) => {
        if (ta.disabled) return;
        if (!includeHidden && ta.offsetParent === null) return;
        ta.value = `Dummy content ${randString(12)}\n\nLine 2 ${randString(8)}`;
        ta.dispatchEvent(new Event('input', { bubbles: true }));
        ta.dispatchEvent(new Event('change', { bubbles: true }));
      };

      inputs.forEach(fillInput);
      textareas.forEach(fillTextarea);
    }
    
    // Copyable modal in minimal black & white style (no browser popups)
    async function showCopyableError(title, errorText) {
      await showModal({
        title,
        body: errorText,
        copyText: errorText,
        okText: 'Close'
      });
    }

    // Minimal black & white modal (replaces alert/confirm)
    function showModal({ title = 'Message', body = '', copyText = null, okText = 'OK', cancelText = null }) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = title;

        const content = document.createElement('div');
        content.className = 'modal-body';
        content.textContent = body;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = okText;

        const close = (result) => {
          try { document.body.removeChild(overlay); } catch {}
          resolve(result);
        };

        okBtn.onclick = () => close(true);

        if (copyText) {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn';
          copyBtn.textContent = 'Copy';
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(copyText);
              copyBtn.textContent = 'Copied';
              setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
            } catch (e) {
              // Fallback: select-able content already in body
              copyBtn.textContent = 'Copy failed';
              setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
            }
          };
          actions.appendChild(copyBtn);
        }

        if (cancelText) {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn';
          cancelBtn.textContent = cancelText;
          cancelBtn.onclick = () => close(false);
          actions.appendChild(cancelBtn);
        }

        actions.appendChild(okBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Close on clicking overlay (only for non-confirm)
        overlay.onclick = (e) => {
          if (e.target === overlay && !cancelText) close(true);
        };

        // ESC closes (OK for non-confirm, Cancel for confirm)
        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            close(cancelText ? false : true);
          }
        };
        document.addEventListener('keydown', onKey);
      });
    }
    
    // Text input modal (replaces prompt)
    function showTextInputModal({ title = 'Input', label = '', initialValue = '', okText = 'OK', cancelText = 'Cancel' }) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = title;

        const content = document.createElement('div');
        content.className = 'modal-body';

        const labelEl = document.createElement('div');
        labelEl.style.fontWeight = '700';
        labelEl.style.marginBottom = '8px';
        labelEl.textContent = label;

        const input = document.createElement('input');
        input.type = 'text';
        input.value = initialValue || '';

        content.appendChild(labelEl);
        content.appendChild(input);

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = cancelText;

        const okBtn = document.createElement('button');
        okBtn.className = 'btn primary';
        okBtn.textContent = okText;

        const close = (result) => {
          try { document.body.removeChild(overlay); } catch {}
          resolve(result);
        };

        cancelBtn.onclick = () => close({ ok: false, value: input.value });
        okBtn.onclick = () => close({ ok: true, value: input.value });

        actions.appendChild(cancelBtn);
        actions.appendChild(okBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        overlay.onclick = (e) => {
          if (e.target === overlay) close({ ok: false, value: input.value });
        };

        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            close({ ok: false, value: input.value });
          }
          if (e.key === 'Enter') {
            document.removeEventListener('keydown', onKey);
            close({ ok: true, value: input.value });
          }
        };
        document.addEventListener('keydown', onKey);

        // focus after attach
        setTimeout(() => {
          input.focus();
          input.select();
        }, 0);
      });
    }
    

    
    // Function to populate and show email modal
    function populateEmailModal(subject, from, date, body, emailMeta) {
      document.getElementById('emailModalSubject').textContent = subject || '(No subject)';
      document.getElementById('emailModalFrom').textContent = `From: ${from || 'Unknown'}`;
      // Set To field if available
      const modalToEl = document.getElementById('emailModalTo');
      if (modalToEl) {
        const toVal = (emailMeta && (emailMeta.to || emailMeta.toEmail || emailMeta.email)) || '';
        modalToEl.textContent = toVal ? `To: ${toVal}` : 'To: (unknown)';
      }
      document.getElementById('emailModalDate').textContent = `Date: ${date || 'Unknown'}`;

      // Display the already processed body content
      const modalBody = document.getElementById('emailModalBody');
      if (body && typeof body === 'string') {
        // Check if it's HTML content that was already processed
        if (body.includes('<') && body.includes('>') && (body.includes('<div') || body.includes('<p>'))) {
          modalBody.innerHTML = body;
        } else {
          // Plain text content
          modalBody.textContent = body;
        }
      } else {
        modalBody.textContent = 'No content available';
      }

      // Store current email meta for task creation
      currentEmailModalMeta = emailMeta;
    }
    
    // Helper function to render email list
    function renderEmailList(emails) {
      const tableBody = document.getElementById('emailTableBody');
      tableBody.innerHTML='';
      
      if (emails.length === 0) {
        const noEmailsRow = document.createElement('tr');
        noEmailsRow.innerHTML = '<td colspan="5" style="padding:20px; text-align:center; border:1px solid #000;">No emails found in inbox</td>';
        tableBody.appendChild(noEmailsRow);
        return;
      }
      
      emails.forEach(e=>{
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.style.border = '1px solid #000';

        // Format date
        const date = new Date(e.date);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Extract sender email from from field
        let senderEmail = '';
        const fromMatch = (e.from || '').match(/<([^>]+)>/);
        if (fromMatch) {
          senderEmail = fromMatch[1];
        } else {
          senderEmail = e.from || '';
        }

        // For now, we'll use placeholder data for context and attachments since they're not available in the current email data structure
        const context = '<span style="cursor:pointer; font-weight:500;">Click to view</span>'; // Placeholder with clickable styling
        const attachment = 'N/A'; // Placeholder - would need to be extracted from email headers

        row.innerHTML = `
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${formattedDate}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${senderEmail}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${e.subject||'No subject'}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${context}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${attachment}</td>
        `;

        tableBody.appendChild(row);

        // Add event listeners after appending to DOM
        row.onmouseover = () => row.style.background = 'rgba(0, 0, 0, 0.3)';
        row.onmouseout = () => row.style.background = '#fff';
        row.onclick = (event) => {
          console.log('Row clicked for email UID:', e.uid, event.target);
          show(e.uid);
        };
      });

    }

    // Search functionality
    let currentFilteredEmails = [];

    function filterEmails() {
      const dateSearch = document.getElementById('dateSearch').value.toLowerCase();
      const senderSearch = document.getElementById('senderSearch').value.toLowerCase();
      const subjectSearch = document.getElementById('subjectSearch').value.toLowerCase();
      const contextSearch = document.getElementById('contextSearch').value.toLowerCase();
      const attachmentSearch = document.getElementById('attachmentSearch').value.toLowerCase();

      currentFilteredEmails = currentEmails.filter(email => {
        const date = new Date(email.date).toLocaleDateString().toLowerCase();
        const sender = (email.from || '').toLowerCase();
        const subject = (email.subject || '').toLowerCase();
        const context = '(click to view)'; // Placeholder for now
        const attachment = 'n/a'; // Placeholder for now

        return date.includes(dateSearch) &&
               sender.includes(senderSearch) &&
               subject.includes(subjectSearch) &&
               context.includes(contextSearch) &&
               attachment.includes(attachmentSearch);
      });

      renderEmailList(currentFilteredEmails);
    }

    // Add event listeners for search inputs
    document.getElementById('dateSearch').addEventListener('input', filterEmails);
    document.getElementById('senderSearch').addEventListener('input', filterEmails);
    document.getElementById('subjectSearch').addEventListener('input', filterEmails);
    document.getElementById('contextSearch').addEventListener('input', filterEmails);
    document.getElementById('attachmentSearch').addEventListener('input', filterEmails);
    
    // Compose email handlers
    const composeBtn = document.getElementById('composeBtn');
    const composeForm = document.getElementById('composeForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const sendBtn = document.getElementById('sendBtn');
    const testSendBtn = document.getElementById('testSendBtn');
    const dummyFillComposeBtn = document.getElementById('dummyFillComposeBtn');
    if (dummyFillComposeBtn) {
      dummyFillComposeBtn.onclick = () => {
        fillDummyForm(composeForm);
      };
    }
    
    composeBtn.onclick = () => {
      composeForm.style.display = composeForm.style.display === 'none' ? 'block' : 'none';
    };

    refreshEmailsBtn.onclick = () => {
      // Refresh the email list
      load(true);
    };
    
    cancelBtn.onclick = () => {
      composeForm.style.display = 'none';
      document.getElementById('toEmail').value = '';
      document.getElementById('subjectEmail').value = '';
      document.getElementById('bodyEmail').value = '';
    };
    
    sendBtn.onclick = async () => {
      const to = document.getElementById('toEmail').value;
      const subject = document.getElementById('subjectEmail').value;
      const text = document.getElementById('bodyEmail').value;
      
      if (!to || !subject || !text) {
        await showModal({ title: 'Missing fields', body: 'Please fill in: To, Subject, and Message.' });
        return;
      }
      
      try {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        
        // Add timeout to fetch request (increased for idle reconnection)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            controller.abort();
          }
        }, 60000); // 60 second timeout (increased to allow for SMTP reconnection)
        
        let res;
        try {
          res = await fetch('/api/email/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, subject, text }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          if (fetchErr.name === 'AbortError') {
            throw new Error('Request timeout - server took too long to respond');
          }
          throw new Error(`Network error: ${fetchErr.message}`);
        }
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to send email';
          const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
          const fullError = `Error sending email:\n${errorMsg}${errorCode}\n\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
          showCopyableError('Send Email Error', fullError);
          console.error('Send email error:', errorData);
          return;
        }
        
        const data = await res.json();
        if (data.success) {
          await showModal({
            title: 'Sent',
            body: `Email sent successfully.\nMessage ID: ${data.messageId || 'N/A'}`,
          });
          composeForm.style.display = 'none';
          document.getElementById('toEmail').value = '';
          document.getElementById('subjectEmail').value = '';
          document.getElementById('bodyEmail').value = '';
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Error sending email:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Send Email Error', errorText);
          console.error('Send email error:', data);
        }
      } catch (err) {
        const errorText = `Error sending email: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`;
        showCopyableError('Send Email Error', errorText);
        console.error('Send email error:', err);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    };
    
    // Test SMTP connection
    const testSmtpBtn = document.getElementById('testSmtpBtn');
    testSmtpBtn.onclick = async () => {
      try {
        testSmtpBtn.disabled = true;
        testSmtpBtn.textContent = 'Testing...';
        
        const res = await fetch('/api/smtp/test');
        const data = await res.json();
        if (data.success) {
          await showModal({
            title: 'SMTP OK',
            body: `SMTP connection successful.\nHost: ${data.host}\nPort: ${data.port}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}`,
          });
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `??SMTP Connection Failed:\n${errorMsg}${errorCode}\n\nHost: ${data.host || 'N/A'}\nPort: ${data.port || 'N/A'}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}\n\n${data.troubleshooting || ''}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('SMTP Connection Error', errorText);
          console.error('SMTP test error:', data);
        }
      } catch (err) {
        showCopyableError('SMTP Test Error', `Error testing SMTP: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
        console.error('SMTP test error:', err);
      } finally {
        testSmtpBtn.disabled = false;
        testSmtpBtn.textContent = '?? Test SMTP Connection';
      }
    };
    
    // Test send email to eric.brilliant@gmail.com
    testSendBtn.onclick = async () => {
      const ok = await showModal({
        title: 'Send test email',
        body: 'Send test email to eric.brilliant@gmail.com?',
        okText: 'Send',
        cancelText: 'Cancel'
      });
      if (!ok) return;
      try {
        testSendBtn.disabled = true;
        testSendBtn.textContent = 'Sending...';
        const res = await fetch('/api/email/test', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          await showModal({ title: 'Sent', body: `Test email sent successfully to ${data.to}!` });
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Test Email Error:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Test Email Error', errorText);
          console.error('Test email error:', data);
        }
      } catch (err) {
        showCopyableError('Test Email Error', `Error: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
      } finally {
        testSendBtn.disabled = false;
        testSendBtn.textContent = '?ÔøΩÔøΩ Send Test Email';
      }
    };

    // Email modal event listeners
    document.getElementById('emailModalClose').onclick = () => {
      document.getElementById('emailModal').style.display = 'none';
      document.body.classList.remove('modal-open');
    };

    document.getElementById('emailModal').onclick = (e) => {
      if (e.target === document.getElementById('emailModal')) {
        document.getElementById('emailModal').style.display = 'none';
        document.body.classList.remove('modal-open');
      }
    };

    // ========== EMAIL SEND PANEL FUNCTIONALITY ==========

    // Store current sent emails list
    let currentSentEmails = [];

    function initializeEmailSendPanel() {
      console.log('Initializing email send panel');
      // Compose email handlers for send panel
      const composeSendBtn = document.getElementById('composeSendBtn');
      const composeSendForm = document.getElementById('composeSendForm');
      const cancelSendBtn = document.getElementById('cancelSendBtn');
      const sendEmailBtn = document.getElementById('sendEmailBtn');
      const testSendEmailBtn = document.getElementById('testSendEmailBtn');
      const testSmtpConnectionBtn = document.getElementById('testSmtpConnectionBtn');
      const dummyFillSendComposeBtn = document.getElementById('dummyFillSendComposeBtn');

      if (dummyFillSendComposeBtn) {
        dummyFillSendComposeBtn.onclick = () => {
          fillDummyForm(composeSendForm);
        };
      }

      composeSendBtn.onclick = () => {
        composeSendForm.style.display = composeSendForm.style.display === 'none' ? 'block' : 'none';
      };

      cancelSendBtn.onclick = () => {
        composeSendForm.style.display = 'none';
        document.getElementById('toSendEmail').value = '';
        document.getElementById('subjectSendEmail').value = '';
        document.getElementById('bodySendEmail').value = '';
      };

      sendEmailBtn.onclick = async () => {
        const to = document.getElementById('toSendEmail').value;
        const subject = document.getElementById('subjectSendEmail').value;
        const text = document.getElementById('bodySendEmail').value;

        if (!to || !subject || !text) {
          await showModal({ title: 'Missing fields', body: 'Please fill in: To, Subject, and Message.' });
          return;
        }

        try {
          sendEmailBtn.disabled = true;
          sendEmailBtn.textContent = 'Sending...';

          // Add timeout to fetch request (increased for idle reconnection)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            if (!controller.signal.aborted) {
              controller.abort();
            }
          }, 60000); // 60 second timeout (increased to allow for SMTP reconnection)

          let res;
          try {
            res = await fetch('/api/email/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ to, subject, text }),
              signal: controller.signal
            });
            clearTimeout(timeoutId);
          } catch (fetchErr) {
            clearTimeout(timeoutId);
            if (fetchErr.name === 'AbortError') {
              throw new Error('Request timeout - server took too long to respond');
            }
            throw new Error(`Network error: ${fetchErr.message}`);
          }

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `HTTP ${res.status}` };
            }
            const errorMsg = errorData.error || 'Failed to send email';
            const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
            const fullError = `Error sending email:\n${errorMsg}${errorCode}\n\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
            showCopyableError('Send Email Error', fullError);
            console.error('Send email error:', errorData);
            return;
          }

          const data = await res.json();
          if (data.success) {
            await showModal({
              title: 'Sent',
              body: `Email sent successfully.\nMessage ID: ${data.messageId || 'N/A'}`,
            });
            composeSendForm.style.display = 'none';
            document.getElementById('toSendEmail').value = '';
            document.getElementById('subjectSendEmail').value = '';
            document.getElementById('bodySendEmail').value = '';
            // Auto refresh the sent emails table to show the newly sent email
            loadSentEmails();
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `Error sending email:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('Send Email Error', errorText);
            console.error('Send email error:', data);
          }
        } catch (err) {
          const errorText = `Error sending email: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`;
          showCopyableError('Send Email Error', errorText);
          console.error('Send email error:', err);
        } finally {
          sendEmailBtn.disabled = false;
          sendEmailBtn.textContent = 'Send';
        }
      };

      // Test SMTP connection
      testSmtpConnectionBtn.onclick = async () => {
        try {
          testSmtpConnectionBtn.disabled = true;
          testSmtpConnectionBtn.textContent = 'Testing...';

          const res = await fetch('/api/smtp/test');
          const data = await res.json();
          if (data.success) {
            await showModal({
              title: 'SMTP OK',
              body: `SMTP connection successful.\nHost: ${data.host}\nPort: ${data.port}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}`,
            });
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `SMTP Connection Failed:\n${errorMsg}${errorCode}\n\nHost: ${data.host || 'N/A'}\nPort: ${data.port || 'N/A'}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}\n\n${data.troubleshooting || ''}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('SMTP Connection Error', errorText);
            console.error('SMTP test error:', data);
          }
        } catch (err) {
          showCopyableError('SMTP Test Error', `Error testing SMTP: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
          console.error('SMTP test error:', err);
        } finally {
          testSmtpConnectionBtn.disabled = false;
          testSmtpConnectionBtn.textContent = 'Test SMTP Connection';
        }
      };

      // Test send email to eric.brilliant@gmail.com
      testSendEmailBtn.onclick = async () => {
        const ok = await showModal({
          title: 'Send test email',
          body: 'Send test email to eric.brilliant@gmail.com?',
          okText: 'Send',
          cancelText: 'Cancel'
        });
        if (!ok) return;
        try {
          testSendEmailBtn.disabled = true;
          testSendEmailBtn.textContent = 'Sending...';
          const res = await fetch('/api/email/test', { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            await showModal({ title: 'Sent', body: `Test email sent successfully to ${data.to}!` });
          } else {
            const errorMsg = data.error || 'Unknown error';
            const errorCode = data.code ? ` (Code: ${data.code})` : '';
            const errorText = `Test Email Error:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
            showCopyableError('Test Email Error', errorText);
            console.error('Test email error:', data);
          }
        } catch (err) {
          showCopyableError('Test Email Error', `Error: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
        } finally {
          testSendEmailBtn.disabled = false;
          testSendEmailBtn.textContent = 'Send Test Email';
        }
      };

      // Load and display sent emails
      loadSentEmails();
      const refreshSentEmailsBtn = document.getElementById('refreshSentEmailsBtn');
      refreshSentEmailsBtn.onclick = () => loadSentEmails();

      // Add search/filter event listeners
      document.getElementById('sentDateSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentFromSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentToSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentSubjectSearch').addEventListener('input', filterSentEmails);
      document.getElementById('sentStatusFilter').addEventListener('change', filterSentEmails);
      document.getElementById('sentDetailsSearch').addEventListener('input', filterSentEmails);
    }

    // Load sent emails from API
    async function loadSentEmails() {
      console.log('Loading sent emails...');
      const tableBody = document.getElementById('sentEmailsTableBody');
      const loadingDiv = document.getElementById('sentEmailsLoading');
      const emptyDiv = document.getElementById('sentEmailsEmpty');

      loadingDiv.style.display = 'block';
      emptyDiv.style.display = 'none';
      tableBody.innerHTML = '';

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        // Filter by specific sender email
        console.log('Fetching sent emails from API...');
        const res = await fetch('/api/sent-emails?limit=100&sender_email=m.yau.01@longriverlabel.com', { signal: controller.signal });
        console.log('API response status:', res.status);
        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        console.log('API response data:', data);
        if (data.success) {
          currentSentEmails = data.sentEmails || [];
          console.log('Current sent emails:', currentSentEmails);
          renderSentEmailsTable(currentSentEmails);
        } else {
          throw new Error(data.error || 'Failed to load sent emails');
        }
      } catch (err) {
        console.error('Failed to load sent emails:', err);
        tableBody.innerHTML = `<tr><td colspan="6" style="padding:20px; text-align:center; border:1px solid #000; color:#666;">Failed to load sent emails: ${err.message}</td></tr>`;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Render sent emails table
    function renderSentEmailsTable(sentEmails) {
      console.log('Rendering sent emails table with', sentEmails.length, 'emails');
      const tableBody = document.getElementById('sentEmailsTableBody');
      const emptyDiv = document.getElementById('sentEmailsEmpty');

      tableBody.innerHTML = '';

      if (sentEmails.length === 0) {
        console.log('No sent emails to display');
        emptyDiv.style.display = 'block';
        return;
      }

      emptyDiv.style.display = 'none';

      sentEmails.forEach(email => {
        const row = document.createElement('tr');
        row.style.border = '1px solid #000';

        // Format date
        const sentDate = new Date(email.sent_at);
        const formattedDate = sentDate.toLocaleDateString() + ' ' + sentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Status styling
        const statusClass = email.status === 'sent' ? 'color:#008000;' : 'color:#ff0000;';
        const statusText = email.status === 'sent' ? 'Sent' : 'Failed';

        // Create content preview for details column
        const contentPreview = email.body_text || email.body_html || '';
        const previewText = contentPreview.length > 50 ? contentPreview.substring(0, 50) + '...' : contentPreview;

        row.innerHTML = `
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${formattedDate}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.sender_email || 'Unknown'}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.to_email}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${email.subject || '(No subject)'}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top; ${statusClass} font-weight:bold;">${statusText}</td>
          <td style="padding:12px; border:1px solid #000; vertical-align:top;">${previewText}</td>
        `;

        // Add click handler for viewing details
        row.onclick = () => {
          console.log('Sent email row clicked, id=', email.id, 'subject=', email.subject);
          try {
            showSentEmailDetails(email);
          } catch (e) {
            console.error('Error in showSentEmailDetails:', e);
          }
        };
        row.onmouseover = () => row.style.background = 'rgba(0, 0, 0, 0.3)';
        row.onmouseout = () => row.style.background = '#fff';

        tableBody.appendChild(row);
      });
    }

    // Filter sent emails based on search inputs
    function filterSentEmails() {
      const dateSearch = document.getElementById('sentDateSearch').value.toLowerCase();
      const fromSearch = document.getElementById('sentFromSearch').value.toLowerCase();
      const toSearch = document.getElementById('sentToSearch').value.toLowerCase();
      const subjectSearch = document.getElementById('sentSubjectSearch').value.toLowerCase();
      const statusFilter = document.getElementById('sentStatusFilter').value;
      const detailsSearch = document.getElementById('sentDetailsSearch').value.toLowerCase();

      const filteredEmails = currentSentEmails.filter(email => {
        const date = new Date(email.sent_at).toLocaleDateString().toLowerCase();
        const from = (email.sender_email || '').toLowerCase();
        const to = email.to_email.toLowerCase();
        const subject = (email.subject || '').toLowerCase();
        const status = email.status;
        const content = (email.body_text || email.body_html || '').toLowerCase();

        return date.includes(dateSearch) &&
               from.includes(fromSearch) &&
               to.includes(toSearch) &&
               subject.includes(subjectSearch) &&
               (statusFilter === '' || status === statusFilter) &&
               content.includes(detailsSearch);
      });

      renderSentEmailsTable(filteredEmails);
    }

    // Show sent email details using the same email modal as received emails
    function showSentEmailDetails(email) {
      const subject = email.subject || '(No subject)';
      const from = email.sender_email || 'Unknown';
      const date = email.sent_at ? new Date(email.sent_at).toLocaleString() : 'Unknown';
      console.log('showSentEmailDetails called for id=', email.id, 'subject=', subject);

      // Prefer HTML body if it looks like HTML, otherwise use plain text
      let bodyContent = email.body_html || email.body_text || '';
      if (bodyContent && !(bodyContent.includes('<') && bodyContent.includes('>'))) {
        // keep as plain text
      }

      const emailMeta = {
        id: email.id,
        subject: subject,
        from: from,
        to: email.to_email || null,
        email: (from.match && from.match(/<([^>]+)>/) ? from.match(/<([^>]+)>/)[1] : from),
        date: date,
        messageId: email.message_id || null,
        smtpResponse: email.smtp_response || null,
        status: email.status || null,
      };

      // Populate and show the standard email modal so behavior matches received-email popup
      populateEmailModal(subject, from, date, bodyContent, emailMeta);
      // Ensure modal is attached to document.body so it's visible even when the emails panel is hidden
      try {
        const modalEl = document.getElementById('emailModal');
        if (modalEl && modalEl.parentNode !== document.body) {
          document.body.appendChild(modalEl);
        }
      } catch (attachErr) {
        console.error('Failed to attach modal to body (sent):', attachErr);
      }
      // Append delivery info to modal body (message id / smtp response / error) for sent emails
      const modalBody = document.getElementById('emailModalBody');
      const infoLines = [];
      if (email.message_id) infoLines.push(`<strong>Message ID:</strong> ${email.message_id}`);
      if (email.smtp_response) infoLines.push(`<strong>SMTP Response:</strong> ${email.smtp_response}`);
      if (email.error_message) infoLines.push(`<strong style="color:#ff0000;">Error:</strong> ${email.error_message}`);
      if (infoLines.length > 0) {
        const infoHtml = `<div style="margin-top:12px; padding:10px; border-top:1px solid #000; background:#fafafa;">${infoLines.join('<br>')}</div>`;
        // If modal body is HTML, append; otherwise, append after converting to HTML
        if (modalBody.innerHTML && modalBody.innerHTML.trim() !== '') {
          modalBody.innerHTML = modalBody.innerHTML + infoHtml;
        } else {
          modalBody.innerHTML = (modalBody.textContent || '') + infoHtml;
        }
      }

      document.getElementById('emailModal').style.display = 'flex';
      document.body.classList.add('modal-open');
      // Debug: verify modal visibility and computed style
      try {
        const modalEl = document.getElementById('emailModal');
        const modalBody = document.getElementById('emailModalBody');
        console.log('emailModal element after show:', modalEl);
        console.log('emailModal.style.display:', modalEl.style.display);
        console.log('emailModal computed display:', getComputedStyle(modalEl).display);
        console.log('emailModal bounding rect:', modalEl.getBoundingClientRect());
        console.log('emailModalBody content length:', (modalBody && modalBody.innerHTML) ? modalBody.innerHTML.length : 0);
        console.log('document.body.classList:', document.body.classList ? document.body.classList.toString() : document.body.className);
      } catch (dbgErr) {
        console.error('Modal debug error:', dbgErr);
      }
      // Force inline styles in case CSS is being overridden or viewport metrics are zero
      try {
        const modalEl2 = document.getElementById('emailModal');
        modalEl2.style.position = 'fixed';
        modalEl2.style.left = '0';
        modalEl2.style.top = '0';
        modalEl2.style.width = '100vw';
        modalEl2.style.height = '100vh';
        modalEl2.style.inset = '0';
        modalEl2.style.zIndex = '10001';
        modalEl2.style.display = 'flex';
        modalEl2.style.visibility = 'visible';
        modalEl2.style.opacity = '1';
        // Ensure inner modal has a minimum size
        const inner = modalEl2.querySelector('.email-modal');
        if (inner) {
          inner.style.maxHeight = '90vh';
          inner.style.width = inner.style.width || 'min(1200px, 95vw)';
        }
        // Scroll modal into view
        modalEl2.scrollIntoView({ block: 'center', inline: 'center', behavior: 'auto' });
        console.log('Forced inline modal styles applied');
      } catch (err) {
        console.error('Failed to force modal styles:', err);
      }
    }

    // ========== CUSTOMER PANEL FUNCTIONALITY ==========

    let currentCustomerData = null;
    let membersData = [];
    let savedCustomers = []; // Store all saved customers

    function initializeCustomerPanel() {
      // Reset customer data and disable member tab
      currentCustomerData = null;
      membersData = [];

      // Disable member tab initially
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.add('tab-disabled');

      // Tab switching
      const customerTab = document.querySelector('[data-tab="customer-info"]');

      customerTab.onclick = () => switchCustomerTab('customer');
      memberTab.onclick = () => switchCustomerTab('member');

      // Start with customer tab active
      switchCustomerTab('customer');

      // Form elements
      const dummyInputBtn = document.getElementById('dummyInputBtn');
      const saveCustomerBtn = document.getElementById('saveCustomerBtn');
      const addMemberBtn = document.getElementById('addMemberBtn');
      const dummyMemberBtn = document.getElementById('dummyMemberBtn');

      // Dummy input functionality
      dummyInputBtn.onclick = () => {
        dummyInputBtn.textContent = '‚è≥ Processing...';
        dummyInputBtn.style.background = '#666';
        dummyInputBtn.style.fontWeight = 'bold';
        dummyInputBtn.style.color = '#fff';
        // Add a small delay to make the processing state visible
        setTimeout(() => {
          fillDummyData();
          // Keep processing state visible for a bit longer
          setTimeout(() => {
            dummyInputBtn.textContent = 'Dummy Input';
            dummyInputBtn.style.background = '';
            dummyInputBtn.style.fontWeight = '';
            dummyInputBtn.style.color = '';
          }, 2000);
        }, 300);
      };

      // Save customer and continue to members
      saveCustomerBtn.onclick = () => saveCustomerInfo();

      // Add member functionality
      addMemberBtn.onclick = () => addNewMember();

      // Dummy member functionality
      dummyMemberBtn.onclick = () => addDummyMember();

      // File upload functionality
      initializeFileUpload();
    }

    function switchCustomerTab(tab) {
      const customerTab = document.querySelector('[data-tab="customer-info"]');
      const memberTab = document.querySelector('[data-tab="member-info"]');

      // Prevent switching to member tab if it's disabled
      if (tab === 'member' && memberTab.classList.contains('tab-disabled')) {
        return; // Do nothing if member tab is disabled
      }

      const customerInfoTab = document.getElementById('customerInfoTab');
      const memberInfoTab = document.getElementById('memberInfoTab');

      if (tab === 'customer') {
        customerTab.classList.add('tab-active');
        memberTab.classList.remove('tab-active');
        customerInfoTab.style.display = 'block';
        memberInfoTab.style.display = 'none';
      } else {
        customerTab.classList.remove('tab-active');
        memberTab.classList.add('tab-active');
        customerInfoTab.style.display = 'none';
        memberInfoTab.style.display = 'block';
      }
    }

    async function saveCustomerInfo() {
      const companyName = document.getElementById('companyName').value.trim();
      const emailDomain = document.getElementById('emailDomain').value.trim();
      const companyAddress = document.getElementById('companyAddress').value.trim();
      const companyTel = document.getElementById('companyTel').value.trim();
      const companyType = document.getElementById('companyType').value;
      const companyWebsite = document.getElementById('companyWebsite').value.trim();

      // Validation
      if (!companyName) {
        showModal({ title: 'Validation Error', body: 'Company Name is required.' });
        return;
      }
      if (!emailDomain) {
        showModal({ title: 'Validation Error', body: 'Email Domain is required.' });
        return;
      }
      if (!companyType) {
        showModal({ title: 'Validation Error', body: 'Type is required.' });
        return;
      }

      // Validate email domain format
      const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/;
      if (!domainRegex.test(emailDomain)) {
        showModal({ title: 'Validation Error', body: 'Please enter a valid email domain (e.g., example.com).' });
        return;
      }

      // Save customer data
      currentCustomerData = {
        id: Date.now(), // Simple ID based on timestamp
        companyName,
        emailDomain,
        companyAddress,
        companyTel,
        companyType,
        companyWebsite,
        members: [] // Will be populated when members are saved
      };

      // Enable member tab
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.remove('tab-disabled');

      // Switch to member tab
      switchCustomerTab('member');

      showModal({ title: 'Success', body: 'Customer information saved. Member tab is now enabled.' });
    }

    function addNewMember() {
      if (!currentCustomerData) {
        showModal({ title: 'Error', body: 'Please complete customer information first.' });
        return;
      }

      const memberIndex = membersData.length;
      const memberHtml = `
        <div class="member-item" style="border:1px solid #000; padding:15px; margin-bottom:10px; background:#f9f9f9;">
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Name *</label>
              <input type="text" class="member-name" placeholder="Full Name" required>
            </div>
            <div style="flex:1;">
              <label>Email *</label>
              <div style="display:flex;">
                <input type="text" class="member-email-prefix" placeholder="username" required style="flex:1;">
                <span style="padding:8px; background:#eee; border:1px solid #000;">@${currentCustomerData.emailDomain}</span>
              </div>
            </div>
          </div>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1;">
              <label>Title</label>
              <input type="text" class="member-title" placeholder="Job Title">
            </div>
            <div style="flex:1;">
              <label>Telephone</label>
              <input type="tel" class="member-tel" placeholder="Phone Number">
            </div>
          </div>
          <div class="row">
            <button class="page-btn save-member-btn" data-index="${memberIndex}">Save Member</button>
            <button class="page-btn delete-member-btn" data-index="${memberIndex}" style="margin-left:10px;">Delete</button>
          </div>
        </div>
      `;

      document.getElementById('membersList').insertAdjacentHTML('beforeend', memberHtml);

      // Add event listeners to the new member
      const memberDiv = document.getElementById('membersList').lastElementChild;
      const saveBtn = memberDiv.querySelector('.save-member-btn');
      const deleteBtn = memberDiv.querySelector('.delete-member-btn');

      saveBtn.onclick = () => saveMember(memberIndex);
      deleteBtn.onclick = () => deleteMember(memberIndex);

      // Initialize with empty data
      membersData.push({
        name: '',
        emailPrefix: '',
        title: '',
        tel: ''
      });
    }

    async function saveMember(index) {
      const memberDiv = document.querySelectorAll('.member-item')[index];
      const name = memberDiv.querySelector('.member-name').value.trim();
      const emailPrefix = memberDiv.querySelector('.member-email-prefix').value.trim();
      const title = memberDiv.querySelector('.member-title').value.trim();
      const tel = memberDiv.querySelector('.member-tel').value.trim();

      if (!name) {
        showModal({ title: 'Validation Error', body: 'Member name is required.' });
        return;
      }
      if (!emailPrefix) {
        showModal({ title: 'Validation Error', body: 'Member email prefix is required.' });
        return;
      }

      membersData[index] = {
        name,
        emailPrefix,
        title,
        tel
      };

      // Update current customer with members
      if (currentCustomerData) {
        currentCustomerData.members = [...membersData];
        // Save to database (this will create or update the customer)
        await saveCustomerToStorage(currentCustomerData);
      }

      // Handle save completion with add more prompt
      handleMemberSaveComplete(name);
    }

    function showAddMoreModal(memberName) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        header.textContent = 'Save Complete';

        const content = document.createElement('div');
        content.className = 'modal-body';
        content.innerHTML = `
          Member "${memberName}" saved successfully.<br><br>
          <strong>Do you want to add more members?</strong>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';

        const yesBtn = document.createElement('button');
        yesBtn.className = 'btn primary';
        yesBtn.textContent = 'Yes, Add More';
        yesBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(true);
        };

        const noBtn = document.createElement('button');
        noBtn.className = 'btn';
        noBtn.textContent = 'No, Finish';
        noBtn.onclick = () => {
          document.body.removeChild(overlay);
          resolve(false);
        };

        actions.appendChild(noBtn);
        actions.appendChild(yesBtn);

        modal.appendChild(header);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Handle Escape key
        const onKey = (e) => {
          if (e.key === 'Escape') {
            document.removeEventListener('keydown', onKey);
            document.body.removeChild(overlay);
            resolve(false); // Default to No on escape
          }
        };
        document.addEventListener('keydown', onKey);
      });
    }

    async function handleMemberSaveComplete(memberName) {
      const addMore = await showAddMoreModal(memberName);

      if (!addMore) {
        // Clear all data and reset forms
        clearAllCustomerData();
      }
      // If addMore is true, just close the modal and stay on the page
    }

    function clearAllCustomerData() {
      // Reset customer data
      currentCustomerData = null;
      membersData = [];

      // Clear customer form
      document.getElementById('companyName').value = '';
      document.getElementById('emailDomain').value = '';
      document.getElementById('companyAddress').value = '';
      document.getElementById('companyTel').value = '';
      document.getElementById('companyType').selectedIndex = 0;
      document.getElementById('companyWebsite').value = '';

      // Clear file input
      const fileInput = document.getElementById('companyDocs');
      fileInput.value = '';

      // Clear members list
      document.getElementById('membersList').innerHTML = '';

      // Disable member tab again
      const memberTab = document.querySelector('[data-tab="member-info"]');
      memberTab.classList.add('tab-disabled');

      // Switch back to customer tab
      switchCustomerTab('customer');

      showModal({ title: 'Cleared', body: 'All customer and member data has been cleared.' });
    }

    function deleteMember(index) {
      if (confirm('Are you sure you want to delete this member?')) {
        document.querySelectorAll('.member-item')[index].remove();
        membersData.splice(index, 1);
        // Re-index remaining members
        updateMemberIndices();
      }
    }

    function updateMemberIndices() {
      const memberItems = document.querySelectorAll('.member-item');
      memberItems.forEach((item, index) => {
        const saveBtn = item.querySelector('.save-member-btn');
        const deleteBtn = item.querySelector('.delete-member-btn');
        saveBtn.setAttribute('data-index', index);
        deleteBtn.setAttribute('data-index', index);
        saveBtn.onclick = () => saveMember(index);
        deleteBtn.onclick = () => deleteMember(index);
      });
    }

    function initializeFileUpload() {
      const fileInput = document.getElementById('companyDocs');
      const dropZone = fileInput.parentElement;

      // Drag and drop functionality
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = '#e8f4f8';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = '#f9f9f9';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#f9f9f9';
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });

      // Click to browse
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
      });

      // Paste functionality
      document.addEventListener('paste', (e) => {
        if (document.activeElement.closest('#customerPanel')) {
          const items = Array.from(e.clipboardData.items);
          const files = items
            .filter(item => item.kind === 'file')
            .map(item => item.getAsFile())
            .filter(file => file);
          if (files.length > 0) {
            handleFiles(files);
          }
        }
      });
    }

    function handleFiles(files) {
      console.log('Files uploaded:', files);
      // Here you would implement actual file handling logic
      showModal({
        title: 'Files Uploaded',
        body: `${files.length} file(s) uploaded successfully. File handling will be implemented in the backend.`
      });
    }

    async function saveCustomerToStorage(customer) {
      try {
        let response;
        let result;

        if (customer.id) {
          // Try to update first
          response = await fetch(`/api/customers/${customer.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });

          // If customer not found (404), try to create instead
          if (response.status === 404) {
            console.log('Customer not found, creating new customer instead');
            response = await fetch('/api/customers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...customer, id: undefined }) // Remove ID for creation
            });
          }

          result = await response.json();
        } else {
          // Create new customer
          response = await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });
          result = await response.json();
        }

        if (!result.success) {
          throw new Error(result.error || 'Failed to save customer');
        }

        // Update customer ID if it was created
        if (result.customer && result.customer.id && !customer.id) {
          customer.id = result.customer.id;
        }

        // Refresh autocomplete if it exists
        if (window.customerAutocomplete) {
          window.customerAutocomplete.refreshCustomers();
        }

        console.log('Customer saved:', result.customer);
        return result.customer;
      } catch (error) {
        console.error('Error saving customer to database:', error);
        throw error;
      }
    }

    async function loadCustomersFromStorage() {
      try {
        const response = await fetch('/api/customers');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load customers');
        }
        return result.customers || [];
      } catch (error) {
        console.error('Error loading customers from database:', error);
        return [];
      }
    }

    async function deleteCustomerFromStorage(customerId) {
      try {
        const response = await fetch(`/api/customers/${customerId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to delete customer');
        }

        return true;
      } catch (error) {
        console.error('Error deleting customer from database:', error);
        throw error;
      }
    }

    async function displayCustomers() {
      const tbody = document.getElementById('customersTableBody');
      const customers = await loadCustomersFromStorage();

      if (customers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No customers saved yet. Create customers first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredCustomers = applyCustomerFilters(customers);

      if (filteredCustomers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No customers match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filteredCustomers.forEach(customer => {
        const membersCount = customer.members ? customer.members.length : 0;
        const membersTooltip = customer.members && customer.members.length > 0
          ? customer.members.map(m => `${m.name} (${m.emailPrefix}@${customer.emailDomain})`).join('\n')
          : 'No members';

        html += `
          <tr style="border:1px solid #000;" class="customer-row">
            <td style="border:1px solid #000; padding:8px;">${customer.companyName}</td>
            <td style="border:1px solid #000; padding:8px;">${customer.companyType}</td>
            <td style="border:1px solid #000; padding:8px;">${customer.emailDomain}</td>
            <td style="border:1px solid #000; padding:8px;">${customer.companyTel || 'N/A'}</td>
            <td style="border:1px solid #000; padding:8px;">${customer.companyWebsite ? `<a href="${customer.companyWebsite}" target="_blank">${customer.companyWebsite}</a>` : 'N/A'}</td>
            <td style="border:1px solid #000; padding:8px;" title="${membersTooltip}">${membersCount}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Add hover effects to table rows
      document.querySelectorAll('.customer-row').forEach(row => {
        row.addEventListener('mouseenter', () => {
          row.style.background = '#000';
          row.style.color = '#fff';
        });
        row.addEventListener('mouseleave', () => {
          row.style.background = '';
          row.style.color = '';
        });
      });
    }

    function applyCustomerFilters(customers) {
      const filters = {
        name: document.getElementById('customerFilterName').value.toLowerCase().trim(),
        type: document.getElementById('customerFilterType').value,
        domain: document.getElementById('customerFilterDomain').value.toLowerCase().trim(),
        phone: document.getElementById('customerFilterPhone').value.toLowerCase().trim(),
        website: document.getElementById('customerFilterWebsite').value.toLowerCase().trim(),
        members: document.getElementById('customerFilterMembers').value.toLowerCase().trim()
      };

      return customers.filter(customer => {
        if (filters.name && !customer.companyName.toLowerCase().includes(filters.name)) return false;
        if (filters.type && customer.companyType !== filters.type) return false;
        if (filters.domain && !customer.emailDomain.toLowerCase().includes(filters.domain)) return false;
        if (filters.phone && !customer.companyTel?.toLowerCase().includes(filters.phone)) return false;
        if (filters.website && !customer.companyWebsite?.toLowerCase().includes(filters.website)) return false;
        if (filters.members && customer.members && customer.members.length > 0) {
          const memberNames = customer.members.map(m => m.name.toLowerCase()).join(' ');
          if (!memberNames.includes(filters.members)) return false;
        } else if (filters.members) {
          return false; // No members but filter requires members
        }
        return true;
      });
    }

    function addDummyMember() {
      if (!currentCustomerData) {
        showModal({ title: 'Error', body: 'Please complete customer information first.' });
        return;
      }

      // Add a new member first
      addNewMember();

      // Get the newly added member
      const memberItems = document.querySelectorAll('.member-item');
      const newMember = memberItems[memberItems.length - 1];

      // Fill with dummy data
      const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'David', 'Lisa', 'Robert', 'Emily', 'James', 'Maria'];
      const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
      const titles = ['Manager', 'Director', 'Supervisor', 'Coordinator', 'Specialist', 'Assistant', 'Officer', 'Executive', 'Analyst', 'Administrator'];

      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const fullName = `${firstName} ${lastName}`;

      // Generate username from first initial + last name
      const username = `${firstName.charAt(0).toLowerCase()}${lastName.toLowerCase()}`;

      const randomTitle = titles[Math.floor(Math.random() * titles.length)];

      // Fill the form
      newMember.querySelector('.member-name').value = fullName;
      newMember.querySelector('.member-email-prefix').value = username;
      newMember.querySelector('.member-title').value = randomTitle;

      // Random phone number
      const areaCode = Math.floor(Math.random() * 900) + 100;
      const exchange = Math.floor(Math.random() * 900) + 100;
      const number = Math.floor(Math.random() * 9000) + 1000;
      const phoneNumber = `(${areaCode}) ${exchange}-${number}`;

      newMember.querySelector('.member-tel').value = phoneNumber;

      showModal({
        title: 'Dummy Member Added',
        body: `Member "${fullName}" with email "${username}@${currentCustomerData.emailDomain}" has been added with dummy data.`
      });
    }

    function fillDummyData() {
      // Company names
      const companyNames = [
        'ABC Corporation', 'Global Industries Ltd', 'Tech Solutions Inc',
        'Manufacturing Co', 'Trading Company LLC', 'International Group',
        'Premier Enterprises', 'Quality Products Corp', 'Advanced Systems Ltd'
      ];

      // Email domains
      const domains = [
        'company.com', 'corp.net', 'industries.org', 'solutions.biz',
        'group.info', 'enterprises.co', 'products.com', 'systems.net'
      ];

      // Cities for addresses
      const cities = [
        'New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX',
        'Phoenix, AZ', 'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA',
        'Dallas, TX', 'San Jose, CA', 'Austin, TX', 'Jacksonville, FL'
      ];

      // Phone numbers
      const generatePhone = () => {
        const areaCode = Math.floor(Math.random() * 900) + 100;
        const exchange = Math.floor(Math.random() * 900) + 100;
        const number = Math.floor(Math.random() * 9000) + 1000;
        return `(${areaCode}) ${exchange}-${number}`;
      };

      // Websites
      const websites = [
        'www.companywebsite.com', 'corporate.site.net', 'business.online.org',
        'enterprise.web.biz', 'firm.digital.info', 'corp.portal.co'
      ];

      // Fill form with random data
      document.getElementById('companyName').value =
        companyNames[Math.floor(Math.random() * companyNames.length)];

      document.getElementById('emailDomain').value =
        domains[Math.floor(Math.random() * domains.length)];

      document.getElementById('companyAddress').value =
        `${Math.floor(Math.random() * 999) + 1} Business St, ${cities[Math.floor(Math.random() * cities.length)]}`;

      document.getElementById('companyTel').value = generatePhone();

      // Random type selection
      const typeSelect = document.getElementById('companyType');
      const randomType = Math.random() < 0.5 ? 'buyer' : 'agent';
      typeSelect.value = randomType;

      document.getElementById('companyWebsite').value =
        websites[Math.floor(Math.random() * websites.length)];

      // Handle file inputs - simulate dummy file selection
      const companyDocsInput = document.getElementById('companyDocs');
      if (companyDocsInput && companyDocsInput.type === 'file') {
        const numFiles = companyDocsInput.multiple ? Math.floor(Math.random() * 3) + 1 : 1;
        const dummyFiles = [];
        for (let i = 0; i < numFiles; i++) {
          dummyFiles.push(generateDummyAttachment());
        }
        simulateFileInput(companyDocsInput, dummyFiles);
      }

      showModal({
        title: 'Dummy Data Filled',
        body: 'Form has been populated with random test data (including dummy files). You can now save or modify as needed.'
      });
    }

    async function initializeCustomerViewPanel() {
      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshCustomersBtn');
      refreshBtn.onclick = async () => await displayCustomers();

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#customerViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displayCustomers());
        input.addEventListener('change', async () => await displayCustomers());
      });

      // Load customers on initialization
      await displayCustomers();
    }

    async function initializeQuotationViewPanel() {
      // Refresh button functionality
      const refreshBtn = document.getElementById('refreshQuotationsBtn');
      refreshBtn.onclick = async () => await displayQuotations();

      // Set up filter event listeners
      const filterInputs = document.querySelectorAll('#quotationViewPanel .filter-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', async () => await displayQuotations());
        input.addEventListener('change', async () => await displayQuotations());
      });

      // Load quotations on initialization
      await displayQuotations();
    }

    async function displayQuotations() {
      const tbody = document.getElementById('quotationsTableBody');
      const quotations = await loadQuotationsFromStorage();

      if (quotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No quotations saved yet. Create quotations first.
            </td>
          </tr>
        `;
        return;
      }

      // Apply filters
      const filteredQuotations = applyQuotationFilters(quotations);

      if (filteredQuotations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No quotations match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date created (newest first)
      filteredQuotations.sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated));

      tbody.innerHTML = filteredQuotations.map(quotation => `
        <tr style="cursor:pointer;" onclick="viewQuotationDetails(${quotation.id})">
          <td style="border:1px solid #000; padding:8px;">${quotation.customerName}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.contactPerson || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.email || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${quotation.phone || 'N/A'}</td>
          <td style="border:1px solid #000; padding:8px;">${getProductTypeDisplayName(quotation.productType)}</td>
          <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.quantity.toLocaleString()}</td>
          <td style="border:1px solid #000; padding:8px; text-align:right;">${quotation.total.toFixed(2)}</td>
          <td style="border:1px solid #000; padding:8px;">${new Date(quotation.dateCreated).toLocaleDateString()}</td>
        </tr>
      `).join('');
    }

    function applyQuotationFilters(quotations) {
      const filters = {
        customer: document.getElementById('quotationFilterCustomer').value.toLowerCase().trim(),
        contact: document.getElementById('quotationFilterContact').value.toLowerCase().trim(),
        email: document.getElementById('quotationFilterEmail').value.toLowerCase().trim(),
        phone: document.getElementById('quotationFilterPhone').value.toLowerCase().trim(),
        type: document.getElementById('quotationFilterType').value,
        quantity: document.getElementById('quotationFilterQuantity').value.toLowerCase().trim(),
        total: document.getElementById('quotationFilterTotal').value.toLowerCase().trim(),
        date: document.getElementById('quotationFilterDate').value.toLowerCase().trim()
      };

      return quotations.filter(quotation => {
        if (filters.customer && !quotation.customerName.toLowerCase().includes(filters.customer)) return false;
        if (filters.contact && !quotation.contactPerson?.toLowerCase().includes(filters.contact)) return false;
        if (filters.email && !quotation.email?.toLowerCase().includes(filters.email)) return false;
        if (filters.phone && !quotation.phone?.toLowerCase().includes(filters.phone)) return false;
        if (filters.type && quotation.productType !== filters.type) return false;
        if (filters.quantity && !quotation.quantity.toString().includes(filters.quantity)) return false;
        if (filters.total && !quotation.total.toString().includes(filters.total)) return false;
        if (filters.date && !new Date(quotation.dateCreated).toLocaleDateString().toLowerCase().includes(filters.date)) return false;
        return true;
      });
    }

    function getProductTypeDisplayName(type) {
      const names = {
        'hang-tag': 'Hang Tag',
        'woven-label': 'Woven Label',
        'care-label': 'Care Label',
        'heat-transfer': 'Heat Transfer',
        'others': 'Others'
      };
      return names[type] || type;
    }

    async function viewQuotationDetails(quotationId) {
      console.log('viewQuotationDetails called with quotationId:', quotationId);
      const quotations = await loadQuotationsFromStorage();
      console.log('Loaded quotations:', quotations.length);
      const quotation = quotations.find(q => q.id === quotationId);
      console.log('Found quotation:', quotation);

      if (!quotation) {
        showModal({
          title: 'Error',
          body: 'Quotation not found.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
        return;
      }

      // Generate the quotation form HTML for this product type
      const tagName = getProductTypeDisplayName(quotation.productType);
      const formHtml = generateQuotationContent(quotation.productType, tagName);

      // Create modal with the form
      const modalContent = `
        <div style="max-width: 1200px; max-height: 80vh; overflow-y: auto;">
          <div style="margin-bottom: 15px; padding: 10px; background: #f8f8f8; border: 1px solid #000;">
            <strong>Quotation Details</strong> - Created: ${new Date(quotation.dateCreated).toLocaleString()}
            <span style="float: right; font-size: 0.9em; color: #666;">Status: ${quotation.status || 'Draft'}</span>
          </div>
          <div id="quotationViewFormContainer">
            ${formHtml}
          </div>
        </div>
      `;

      // Create a custom modal overlay for the quotation form
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = '11000';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.maxWidth = '900px';
      modal.style.width = '90vw';

      const header = document.createElement('div');
      header.className = 'modal-header';
      header.textContent = `Quotation Details - ${quotation.customerName}`;

      const body = document.createElement('div');
      body.className = 'modal-body';
      body.innerHTML = modalContent;

      const actions = document.createElement('div');
      actions.className = 'modal-actions';
      actions.innerHTML = `
        <button class="btn" onclick="closeQuotationViewModal()">Close</button>
        <button class="btn primary" onclick="editQuotationFromView(${quotation.id})">Edit Quotation</button>
        <button class="btn" style="background: #ff6b6b; color: white;" onclick="deleteQuotation(${quotation.id})">Delete</button>
      `;

      modal.appendChild(header);
      modal.appendChild(body);
      modal.appendChild(actions);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Prevent body scroll when modal is open
      document.body.classList.add('modal-open');

      // Populate the form with quotation data
      populateQuotationViewForm(quotation);

      // Global function to close the modal
      window.closeQuotationViewModal = function() {
        document.body.removeChild(overlay);
        document.body.classList.remove('modal-open');
      };
    }

    function populateQuotationViewForm(quotation) {
      console.log('populateQuotationViewForm called with quotation:', quotation);
      console.log('quotationViewFormContainer exists:', !!document.getElementById('quotationViewFormContainer'));

      // Wait a bit longer for the DOM to be fully ready
      setTimeout(() => {
        const container = document.getElementById('quotationViewFormContainer');
        console.log('quotationViewFormContainer found:', !!container);

        if (!container) {
          console.error('quotationViewFormContainer not found!');
          return;
        }

        // Disable and dim all input, textarea, and select elements in the form
        const allFormElements = container.querySelectorAll('input, textarea, select');
        console.log('Found form elements to disable:', allFormElements.length);
        allFormElements.forEach(element => {
          element.disabled = true;
          element.readOnly = true;
          element.style.backgroundColor = '#f5f5f5';
          element.style.color = '#666';
          element.style.cursor = 'not-allowed';
        });

        // Populate customer information
        const customerNameField = document.getElementById('quotationCustomerName');
        console.log('customerNameField found:', !!customerNameField, 'quotation.customerName:', quotation.customerName);
        if (customerNameField) {
          customerNameField.value = quotation.customerName || '';
          console.log('Set customerNameField value to:', quotation.customerName);
        }

        // Populate contact person dropdown
        const contactField = document.getElementById('quotationContactPerson');
        console.log('contactField found:', !!contactField, 'quotation.contactPerson:', quotation.contactPerson);
        if (contactField && quotation.contactPerson) {
          contactField.innerHTML = `<option value="${quotation.contactPerson}" selected>${quotation.contactPerson}</option>`;
          console.log('Set contactField innerHTML');
        }

        // Populate email and phone
        const emailField = document.getElementById('quotationEmail');
        console.log('emailField found:', !!emailField, 'quotation.email:', quotation.email);
        if (emailField) {
          emailField.value = quotation.email || '';
          console.log('Set emailField value to:', quotation.email);
        }

        const phoneField = document.getElementById('quotationPhone');
        console.log('phoneField found:', !!phoneField, 'quotation.phone:', quotation.phone);
        if (phoneField) {
          phoneField.value = quotation.phone || '';
          console.log('Set phoneField value to:', quotation.phone);
        }

        // Populate product-specific fields
        console.log('quotation.productDetails:', quotation.productDetails);
        if (quotation.productDetails) {
          Object.entries(quotation.productDetails).forEach(([key, value]) => {
            const fieldId = `quotation${key.charAt(0).toUpperCase() + key.slice(1)}`;
            const field = document.getElementById(fieldId);
            console.log(`Product field ${fieldId} found:`, !!field, 'value:', value);
            if (field) {
              field.value = value || '';
              console.log(`Set ${fieldId} value to:`, value);
            }
          });
        }

        // Populate quantity and pricing
        const quantityField = document.getElementById('quotationQuantity');
        console.log('quantityField found:', !!quantityField, 'quotation.quantity:', quotation.quantity);
        if (quantityField && quotation.quantity) {
          quantityField.value = quotation.quantity;
          console.log('Set quantityField value to:', quotation.quantity);
        }

        const unitPriceField = document.getElementById('quotationUnitPrice');
        console.log('unitPriceField found:', !!unitPriceField, 'quotation.unitPrice:', quotation.unitPrice);
        if (unitPriceField && quotation.unitPrice !== undefined) {
          unitPriceField.value = quotation.unitPrice.toFixed ? quotation.unitPrice.toFixed(2) : quotation.unitPrice;
          console.log('Set unitPriceField value to:', quotation.unitPrice);
        }

        const totalField = document.getElementById('quotationTotal');
        console.log('totalField found:', !!totalField, 'quotation.total:', quotation.total);
        if (totalField && quotation.total !== undefined) {
          totalField.value = quotation.total.toFixed ? quotation.total.toFixed(2) : quotation.total;
          console.log('Set totalField value to:', quotation.total);
        }

        // Populate notes
        const notesField = document.getElementById('quotationNotes');
        console.log('notesField found:', !!notesField, 'quotation.notes:', quotation.notes);
        if (notesField) {
          notesField.value = quotation.notes || '';
          console.log('Set notesField value to:', quotation.notes);
        }

        // Hide all action buttons in view mode
        const allButtons = container.querySelectorAll('button');
        allButtons.forEach(button => {
          button.style.display = 'none';
        });

        console.log('Form population completed for quotation:', quotation.id);
      }, 200); // Increased delay to ensure DOM is ready
    }

    async function editQuotationFromView(quotationId) {
      // Close the view modal
      closeQuotationViewModal();

      // Switch to create tab and load the quotation for editing
      ensureTab('quotation', 'Quotation (create)');
      activateTab('quotation');

      // Load the quotation data into the form for editing
      const quotations = await loadQuotationsFromStorage();
      const quotation = quotations.find(q => q.id === quotationId);

      if (quotation) {
        // Switch to the appropriate product type tab
        const quotationButtons = document.querySelectorAll('.quotation-tag-btn');
        quotationButtons.forEach(button => {
          if (button.dataset.tag === quotation.productType) {
            button.click();
          }
        });

        // Populate the form with quotation data for editing
        setTimeout(async () => {
          await populateQuotationForEditing(quotation);
        }, 200);
      }
    }

    async function populateQuotationForEditing(quotation) {
      // Get field references
      const customerNameField = document.getElementById('quotationCustomerName');
      const emailField = document.getElementById('quotationEmail');
      const phoneField = document.getElementById('quotationPhone');
      const contactField = document.getElementById('quotationContactPerson');

      // Populate customer name
      if (customerNameField) {
        customerNameField.value = quotation.customerName;

        // Try to find customer in autocomplete data to populate additional fields
        if (window.customerAutocomplete && window.customerAutocomplete.customers) {
          const customer = window.customerAutocomplete.customers.find(c =>
            c.companyName.toLowerCase() === quotation.customerName.toLowerCase()
          );

          if (customer) {
            // Populate email if quotation doesn't have specific email
            if (emailField && !quotation.email) {
              emailField.value = `contact@${customer.emailDomain}`;
            }

            // Populate phone if quotation doesn't have specific phone
            if (phoneField && !quotation.phone && customer.companyTel) {
              phoneField.value = customer.companyTel;
            }

            // Populate contact person dropdown with customer members
            if (contactField && customer.members && customer.members.length > 0) {
              contactField.innerHTML = '<option value="">Select Contact Person</option>';
              customer.members.forEach(member => {
                if (member.name) {
                  const option = document.createElement('option');
                  option.value = member.name;
                  option.textContent = `${member.name}${member.title ? ` (${member.title})` : ''}`;
                  contactField.appendChild(option);
                }
              });
            }
          }
        }
      }

      // Always populate the specific quotation data (this overrides customer defaults)
      if (emailField && quotation.email) {
        emailField.value = quotation.email;
      }

      if (phoneField && quotation.phone) {
        phoneField.value = quotation.phone;
      }

      if (contactField && quotation.contactPerson) {
        // If contact dropdown was populated with members, try to select the right one
        // Otherwise, just set the value directly
        const existingOption = Array.from(contactField.options).find(option =>
          option.value === quotation.contactPerson
        );
        if (existingOption) {
          contactField.value = quotation.contactPerson;
        } else {
          // Add the contact person as an option if not already there
          const option = document.createElement('option');
          option.value = quotation.contactPerson;
          option.textContent = quotation.contactPerson;
          contactField.appendChild(option);
          contactField.value = quotation.contactPerson;
        }
      }

      // Populate email and phone (fallback if not set above)
      if (emailField && !emailField.value) {
        emailField.value = quotation.email || '';
      }

      if (phoneField && !phoneField.value) {
        phoneField.value = quotation.phone || '';
      }

      // Populate product-specific fields
      if (quotation.productDetails) {
        Object.entries(quotation.productDetails).forEach(([key, value]) => {
          const fieldId = `quotation${key.charAt(0).toUpperCase() + key.slice(1)}`;
          const field = document.getElementById(fieldId);
          if (field) {
            field.value = value;
          }
        });
      }

      // Populate quantity and pricing
      const quantityField = document.getElementById('quotationQuantity');
      if (quantityField) {
        quantityField.value = quotation.quantity;
        quantityField.dispatchEvent(new Event('input', { bubbles: true }));
      }

      const unitPriceField = document.getElementById('quotationUnitPrice');
      if (unitPriceField) {
        unitPriceField.value = quotation.unitPrice.toFixed(2);
        unitPriceField.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Populate notes
      const notesField = document.getElementById('quotationNotes');
      if (notesField) {
        notesField.value = quotation.notes || '';
      }

      // Store the quotation ID for updating
      window.editingQuotationId = quotation.id;
    }

    async function deleteQuotation(quotationId) {
      if (!confirm('Are you sure you want to delete this quotation? This action cannot be undone.')) {
        return;
      }

      try {
        await deleteQuotationFromStorage(quotationId);
        closeQuotationViewModal();
        await displayQuotations(); // Refresh the table

        showModal({
          title: 'Success',
          body: 'Quotation deleted successfully.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      } catch (error) {
        console.error('Error deleting quotation:', error);
        showModal({
          title: 'Error',
          body: 'Failed to delete quotation. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    }

    // -------- QUOTATION TAG SELECTION --------
    let selectedQuotationTag = null;

    function initializeQuotationPanel() {
      const quotationButtons = document.querySelectorAll('.quotation-tag-btn');

      quotationButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tagType = button.dataset.tag;
          const tagName = button.textContent;

          // Remove selected class from all buttons
          quotationButtons.forEach(btn => btn.classList.remove('selected'));

          // Add selected class to clicked button
          button.classList.add('selected');

          // Update selected tag
          selectedQuotationTag = tagType;

          // Show sub-board with content
          showQuotationSubBoard(tagType, tagName);
        });
      });
    }

    function showQuotationSubBoard(tagType, tagName) {
      const subBoard = document.getElementById('quotationSubBoard');
      const subBoardTitle = document.getElementById('quotationSubBoardTitle');
      const subBoardContent = document.getElementById('quotationSubBoardContent');

      // Update title
      subBoardTitle.textContent = `${tagName} Quotation`;

      // Generate content based on tag type
      const content = generateQuotationContent(tagType, tagName);
      subBoardContent.innerHTML = content;

      // Initialize autocomplete for customer field
      setTimeout(() => {
        if (document.getElementById('quotationCustomerName')) {
          window.customerAutocomplete = new CustomerAutocomplete('quotationCustomerName', 'customerAutocompleteDropdown');
        }

        // Add event listener for contact person selection
        const contactPersonField = document.getElementById('quotationContactPerson');
        if (contactPersonField) {
          contactPersonField.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const emailField = document.getElementById('quotationEmail');
            const phoneField = document.getElementById('quotationPhone');

            if (selectedOption && selectedOption.value && selectedOption.dataset.memberData) {
              const memberData = JSON.parse(selectedOption.dataset.memberData);

              // Auto-populate and disable email field
              if (emailField && memberData.emailPrefix) {
                emailField.value = `${memberData.emailPrefix}@${window.customerAutocomplete.selectedCustomer.emailDomain}`;
                emailField.disabled = true;
                emailField.style.backgroundColor = '#f5f5f5';
                emailField.style.color = '#666';
              }

              // Auto-populate and disable phone field
              if (phoneField && memberData.tel) {
                phoneField.value = memberData.tel;
                phoneField.disabled = true;
                phoneField.style.backgroundColor = '#f5f5f5';
                phoneField.style.color = '#666';
              }
            } else {
              // No contact person selected - enable fields for manual entry
              if (emailField) {
                emailField.disabled = false;
                emailField.style.backgroundColor = '#fff';
                emailField.style.color = '#000';
              }
              if (phoneField) {
                phoneField.disabled = false;
                phoneField.style.backgroundColor = '#fff';
                phoneField.style.color = '#000';
              }
            }
          });
        }
      }, 100);

      // Set up event listeners for total calculation
      setTimeout(() => {
        const quantityInput = document.getElementById('quotationQuantity');
        const unitPriceInput = document.getElementById('quotationUnitPrice');

        if (quantityInput && unitPriceInput) {
          const updateTotal = () => {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const total = quantity * unitPrice;
            const totalInput = document.getElementById('quotationTotal');
            if (totalInput) {
              totalInput.value = total.toFixed(2);
            }
          };

          quantityInput.addEventListener('input', updateTotal);
          unitPriceInput.addEventListener('input', updateTotal);
        }
      }, 100);

      // Show sub-board
      subBoard.style.display = 'block';
    }

    function generateQuotationContent(tagType, tagName) {
      // Two-column layout: left form (70%), right panel (30%)
      return '<div style="display: flex; gap: 20px; height: 100%; padding-right: 20px;">' +
        // Left side - Form (70% width)
        '<div style="flex: 0 0 70%;">' +
          '<form id="quotationForm">' +
            '<div style="margin-bottom:20px;">' +
              '<h4>Customer Information</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Customer Name *</label>' +
                  '<div class="autocomplete-container">' +
                    '<input type="text" id="quotationCustomerName" class="autocomplete-input" placeholder="Enter customer name" autocomplete="off">' +
                    '<div id="customerAutocompleteDropdown" class="autocomplete-dropdown"></div>' +
                  '</div>' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Contact Person</label>' +
                  '<select id="quotationContactPerson" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">' +
                    '<option value="">Select Contact Person</option>' +
                  '</select>' +
                '</div>' +
              '</div>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Email</label>' +
                  '<input type="email" id="quotationEmail" style="width:100%; padding:8px; border:1px solid #000;" placeholder="customer@email.com">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Phone</label>' +
                  '<input type="tel" id="quotationPhone" style="width:100%; padding:8px; border:1px solid #000;" placeholder="+852 1234 5678">' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Product Specifications</h4>' +
              getProductSpecificFields(tagType) +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Quantity & Pricing</h4>' +
              '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Quantity *</label>' +
                  '<input type="number" id="quotationQuantity" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1000" min="1">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Unit Price (HKD)</label>' +
                  '<input type="number" id="quotationUnitPrice" style="width:100%; padding:8px; border:1px solid #000;" placeholder="0.50" step="0.01" min="0">' +
                '</div>' +
                '<div>' +
                  '<label style="display:block; margin-bottom:5px; font-weight:600;">Total (Auto)</label>' +
                  '<input type="text" id="quotationTotal" style="width:100%; padding:8px; border:1px solid #000; background:#f5f5f5;" readonly>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div style="margin-bottom:20px;">' +
              '<h4>Additional Notes</h4>' +
              '<textarea id="quotationNotes" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;" placeholder="Special requirements, delivery instructions, etc."></textarea>' +
            '</div>' +

            '<div style="display:flex; gap:10px; justify-content:flex-end;">' +
              '<button type="button" class="page-btn" id="quotationDummyBtn" onclick="fillDummyQuotationForm()">Dummy Fill</button>' +
              '<button type="button" class="page-btn" onclick="clearQuotationForm()">Clear</button>' +
              '<button type="button" class="page-btn" onclick="saveQuotation(\'' + tagType + '\')">Save Quotation</button>' +
              '<button type="button" class="page-btn primary" onclick="generateQuotation(\'' + tagType + '\')">Generate PDF</button>' +
            '</div>' +
          '</form>' +
        '</div>' +

        // Right side - Product image and attachments (30% width)
        '<div style="flex: 0 0 30%; display: flex; flex-direction: column; gap: 15px;">' +
          // Product Image Section (20% of right panel height)
          '<div style="flex: 0 0 20%; border: 1px solid #000; padding: 10px; background: #f9f9f9;">' +
            '<h5 style="margin: 0 0 10px 0; font-size: 14px;">Product Image</h5>' +
            '<div id="productImageContainer" style="width: 100%; height: 120px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background: #fff; cursor: pointer; position: relative;" onclick="document.getElementById(\'productImageInput\').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleImageDrop(event)" onpaste="handleImagePaste(event)">' +
              '<div style="text-align: center; color: #666;">' +
                '<div style="font-size: 12px; margin-bottom: 5px;">Drop image here or click to browse</div>' +
                '<div style="font-size: 11px; color: #999;">Supports: JPG, PNG, GIF, WebP</div>' +
                '<div style="font-size: 11px; color: #999;">Or paste (Ctrl+V)</div>' +
              '</div>' +
            '</div>' +
            '<input type="file" id="productImageInput" accept="image/*" style="display: none;" onchange="handleProductImageUpload(event)">' +
          '</div>' +

          // Attachments Section (80% of right panel height)
          '<div style="flex: 0 0 80%; border: 1px solid #000; padding: 20px; background: #f9f9f9; display: flex; flex-direction: column;">' +
            '<h5 style="margin: 0 0 10px 0; font-size: 14px;">Attachments</h5>' +
            '<div id="attachmentsContainer" style="flex: 1; min-height: 200px; border: 2px dashed #ccc; padding: 10px; background: #fff; overflow-y: auto;">' +
              '<div id="attachmentsList" style="margin-bottom: 10px;">' +
                '<!-- Attachments will be listed here -->' +
              '</div>' +
              '<button type="button" class="page-btn" style="width: 100%; font-size: 12px;" onclick="document.getElementById(\'attachmentInput\').click()">+ Add Attachment</button>' +
              '<input type="file" id="attachmentInput" multiple style="display: none;" onchange="handleAttachmentUpload(event)">' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function getProductSpecificFields(tagType) {
      const fields = {
        'hang-tag': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material</label>
              <select id="quotationMaterial" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="paper">Paper</option>
                <option value="cardboard">Cardboard</option>
                <option value="plastic">Plastic</option>
                <option value="fabric">Fabric</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Size</label>
              <input type="text" id="quotationSize" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2x3 inches">
            </div>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Printing Method</label>
            <select id="quotationPrintingMethod" style="width:100%; padding:8px; border:1px solid #000;">
              <option value="">Select Printing Method</option>
              <option value="screen-printing">Screen Printing</option>
              <option value="digital-printing">Digital Printing</option>
              <option value="offset-printing">Offset Printing</option>
              <option value="embroidery">Embroidery</option>
            </select>
          </div>
        `,
        'woven-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Width</label>
              <input type="text" id="quotationWidth" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1 inch">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Length</label>
              <input type="text" id="quotationLength" style="width:100%; padding:8px; border:1px solid #000;" placeholder="2 inches">
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Color Count</label>
              <select id="quotationColorCount" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="1">1 Color</option>
                <option value="2">2 Colors</option>
                <option value="3">3 Colors</option>
                <option value="4">4+ Colors</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Edge Finish</label>
              <select id="quotationEdgeFinish" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="cut">Cut Edge</option>
                <option value="hemmed">Hemmed Edge</option>
                <option value="overlocked">Overlocked</option>
              </select>
            </div>
          </div>
        `,
        'care-label': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Material Type</label>
              <select id="quotationMaterialType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Material</option>
                <option value="satin">Satin Tape</option>
                <option value="cotton">Cotton Tape</option>
                <option value="woven">Woven Fabric</option>
                <option value="paper">Paper</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Wash Care Symbols</label>
              <input type="text" id="quotationWashSymbols" style="width:100%; padding:8px; border:1px solid #000;" placeholder="Machine wash, tumble dry, etc.">
            </div>
          </div>
        `,
        'heat-transfer': `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Transfer Type</label>
              <select id="quotationTransferType" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="">Select Type</option>
                <option value="screen-print">Screen Print Transfer</option>
                <option value="digital-print">Digital Print Transfer</option>
                <option value="vinyl-cut">Vinyl Cut Transfer</option>
                <option value="sublimation">Sublimation Transfer</option>
              </select>
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Application Method</label>
              <select id="quotationApplication" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="heat-press">Heat Press</option>
                <option value="iron">Household Iron</option>
                <option value="commercial">Commercial Press</option>
              </select>
            </div>
          </div>
        `,
        'others': `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Product Description *</label>
            <textarea id="quotationProductDescription" style="width:100%; min-height:60px; padding:8px; border:1px solid #000;" placeholder="Describe the custom product or service..."></textarea>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Category</label>
              <input type="text" id="quotationCategory" style="width:100%; padding:8px; border:1px solid #000;" placeholder="e.g., Packaging, Stickers">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px; font-weight:600;">Complexity</label>
              <select id="quotationComplexity" style="width:100%; padding:8px; border:1px solid #000;">
                <option value="simple">Simple</option>
                <option value="medium">Medium</option>
                <option value="complex">Complex</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
        `
      };

      return fields[tagType] || fields['others'];
    }

    // Global functions for quotation form
    window.clearQuotationForm = function() {
      const form = document.getElementById('quotationForm');
      if (form) {
        form.reset();
        document.getElementById('quotationTotal').value = '';

        // Reset contact person dropdown to default state
        const contactField = document.getElementById('quotationContactPerson');
        if (contactField) {
          contactField.innerHTML = '<option value="">Select Contact Person</option>';
        }

        // Re-enable email and phone fields
        const emailField = document.getElementById('quotationEmail');
        const phoneField = document.getElementById('quotationPhone');
        if (emailField) {
          emailField.disabled = false;
          emailField.style.backgroundColor = '#fff';
          emailField.style.color = '#000';
        }
        if (phoneField) {
          phoneField.disabled = false;
          phoneField.style.backgroundColor = '#fff';
          phoneField.style.color = '#000';
        }

        // Clear product image
        const imageContainer = document.getElementById('productImageContainer');
        if (imageContainer) {
          imageContainer.innerHTML = `
            <div style="text-align: center; color: #666;">
              <div style="font-size: 12px; margin-bottom: 5px;">Drop image here or click to browse</div>
              <div style="font-size: 11px; color: #999;">Supports: JPG, PNG, GIF, WebP</div>
              <div style="font-size: 11px; color: #999;">Or paste (Ctrl+V)</div>
            </div>
          `;
        }

        // Clear file inputs
        const imageInput = document.getElementById('productImageInput');
        if (imageInput) imageInput.value = '';

        const attachmentInput = document.getElementById('attachmentInput');
        if (attachmentInput) attachmentInput.value = '';

        // Clear attachments list
        const attachmentsList = document.getElementById('attachmentsList');
        if (attachmentsList) {
          attachmentsList.innerHTML = '';
        }

        // Clear edit mode
        window.editingQuotationId = null;
      }
    };

    window.fillDummyQuotationForm = function() {
      console.log('fillDummyQuotationForm called');
      const form = document.getElementById('quotationForm');
      const dummyBtn = document.getElementById('quotationDummyBtn');

      console.log('Form found:', !!form);
      console.log('Dummy button found:', !!dummyBtn);

      if (dummyBtn) {
        dummyBtn.textContent = '‚è≥ Processing...';
        dummyBtn.style.background = '#666';
        dummyBtn.style.fontWeight = 'bold';
        dummyBtn.style.color = '#fff';
      }

      // Add a small delay to make the processing state visible
      setTimeout(() => {
        // Fill the main form
        if (form) {
          console.log('Filling main form');
          fillDummyForm(form);
        }

        // Also fill file inputs that are in the dynamically generated content
        const subBoardContent = document.getElementById('quotationSubBoardContent');
        console.log('Sub board content found:', !!subBoardContent);
        if (subBoardContent) {
          console.log('Filling sub board content');
          fillDummyForm(subBoardContent);
        }

        // Keep processing state visible for a bit longer
        setTimeout(() => {
          if (dummyBtn) {
            dummyBtn.textContent = 'Dummy Fill';
            dummyBtn.style.background = '';
            dummyBtn.style.fontWeight = '';
            dummyBtn.style.color = '';
          }
        }, 2000);
      }, 300);
    };

    // Product image and attachment handling functions
    function handleProductImageUpload(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        displayImage(file);
      }
    }

    function displayImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const container = document.getElementById('productImageContainer');
        container.innerHTML = '<img src="' + e.target.result + '" style="max-width: 100%; max-height: 120px; object-fit: contain; cursor:pointer;" onclick="showImageModal(\'' + e.target.result + '\', \'' + file.name + '\')" title="Click to view full size">';

        // Update skill system with image generation
        updateSkillWithImageGeneration(file.name, e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function showImageModal(imageSrc, filename) {
      const modal = document.getElementById('imageModal');
      const content = document.getElementById('imageModalContent');

      content.innerHTML = '<img src="' + imageSrc + '" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="' + filename + '">';

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      // Update skill system when image is viewed
      updateSkillWithImageView(filename);
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.style.borderColor = '#007bff';
      event.currentTarget.style.backgroundColor = '#f0f8ff';
    }

    function handleDragLeave(event) {
      event.preventDefault();
      event.currentTarget.style.borderColor = '#ccc';
      event.currentTarget.style.backgroundColor = '#fff';
    }

    function handleImageDrop(event) {
      event.preventDefault();
      event.currentTarget.style.borderColor = '#ccc';
      event.currentTarget.style.backgroundColor = '#fff';

      const files = event.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        displayImage(files[0]);
      }
    }

    function handleImagePaste(event) {
      // Check if the paste event contains image data
      const items = event.clipboardData?.items;
      if (!items) return;

      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          event.preventDefault();
          const file = items[i].getAsFile();
          displayImage(file);
          break;
        }
      }
    }

    function handleAttachmentUpload(event) {
      const files = Array.from(event.target.files);
      const attachmentsList = document.getElementById('attachmentsList');

      files.forEach(file => {
        const attachmentItem = document.createElement('div');
        attachmentItem.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 5px; background: #f0f0f0; margin-bottom: 5px; border-radius: 3px;';

        const fileId = 'attachment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        attachmentItem.innerHTML = `
          <span id="${fileId}_name" style="font-size: 12px; flex: 1; cursor:pointer; text-decoration:underline;" onclick="previewAttachment('${fileId}')">${file.name}</span>
          <span style="font-size: 11px; color: #666;">(${(file.size / 1024).toFixed(1)} KB)</span>
          <button type="button" onclick="this.parentElement.remove()" style="font-size: 12px; padding: 2px 6px; border: 1px solid #000; background: #fff;">√ó</button>
        `;

        // Store file data for preview
        attachmentItem._fileData = {
          id: fileId,
          file: file,
          name: file.name,
          type: file.type,
          size: file.size
        };

        attachmentsList.appendChild(attachmentItem);
      });
    }

    function previewAttachment(fileId) {
      const attachmentsList = document.getElementById('attachmentsList');
      const attachmentItems = attachmentsList.querySelectorAll('div');

      let fileData = null;
      for (let item of attachmentItems) {
        if (item._fileData && item._fileData.id === fileId) {
          fileData = item._fileData;
          break;
        }
      }

      if (!fileData) return;

      const modal = document.getElementById('attachmentModal');
      const title = document.getElementById('attachmentModalTitle');
      const content = document.getElementById('attachmentModalContent');

      title.textContent = `Attachment Preview: ${fileData.name}`;

      if (fileData.type.startsWith('image/')) {
        // Image preview
        const reader = new FileReader();
        reader.onload = function(e) {
          content.innerHTML = '<img src="' + e.target.result + '" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="' + fileData.name + '">';
        };
        reader.readAsDataURL(fileData.file);
      } else if (fileData.type === 'application/pdf') {
        // PDF preview (basic - just show info for now)
        content.innerHTML = `
          <div style="text-align:center; padding:20px;">
            <div style="font-size:48px; margin-bottom:20px;">üìÑ</div>
            <h3>${fileData.name}</h3>
            <p>Type: PDF Document</p>
            <p>Size: ${(fileData.size / 1024).toFixed(1)} KB</p>
            <p style="color:#666; font-style:italic;">PDF preview not available in browser. Download to view.</p>
          </div>
        `;
      } else if (fileData.type.includes('word') || fileData.type.includes('document')) {
        // Word document preview
        content.innerHTML = `
          <div style="text-align:center; padding:20px;">
            <div style="font-size:48px; margin-bottom:20px;">üìù</div>
            <h3>${fileData.name}</h3>
            <p>Type: Word Document</p>
            <p>Size: ${(fileData.size / 1024).toFixed(1)} KB</p>
            <p style="color:#666; font-style:italic;">Document preview not available in browser. Download to view.</p>
          </div>
        `;
      } else if (fileData.type === 'text/plain') {
        // Text file preview
        const reader = new FileReader();
        reader.onload = function(e) {
          content.innerHTML = `
            <div style="padding:10px; background:#f9f9f9; border:1px solid #ccc; font-family:monospace; white-space:pre-wrap; max-height:400px; overflow:auto;">
              ${e.target.result}
            </div>
          `;
        };
        reader.readAsText(fileData.file);
      } else {
        // Generic file preview
        content.innerHTML = `
          <div style="text-align:center; padding:20px;">
            <div style="font-size:48px; margin-bottom:20px;">üìé</div>
            <h3>${fileData.name}</h3>
            <p>Type: ${fileData.type || 'Unknown'}</p>
            <p>Size: ${(fileData.size / 1024).toFixed(1)} KB</p>
          </div>
        `;
      }

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function closeAttachmentModal() {
      const modal = document.getElementById('attachmentModal');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    function updateSkillWithImageGeneration(filename, imageData) {
      // Update skill system when image is generated
      console.log('Image generated for quotation:', filename);
      // This could update a skill tracking system or database
    }

    function updateSkillWithImageView(filename) {
      // Update skill system when image is viewed in modal
      console.log('Image viewed in modal:', filename);
      // This could increment view counters or update skill metrics
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const imageModalClose = document.getElementById('imageModalClose');
      const attachmentModalClose = document.getElementById('attachmentModalClose');

      if (imageModalClose) {
        imageModalClose.addEventListener('click', closeImageModal);
      }

      if (attachmentModalClose) {
        attachmentModalClose.addEventListener('click', closeAttachmentModal);
      }

      // Close modals when clicking outside
      document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
          // Don't close - user must use X button
        }
      });

      document.getElementById('attachmentModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeAttachmentModal();
        }
      });
    });

    window.saveQuotation = async function(tagType) {
      try {
        const customerName = document.getElementById('quotationCustomerName').value.trim();
        const contactPerson = document.getElementById('quotationContactPerson').value;
        const email = document.getElementById('quotationEmail').value.trim();
        const phone = document.getElementById('quotationPhone').value.trim();
        const quantity = document.getElementById('quotationQuantity').value;
        const unitPrice = document.getElementById('quotationUnitPrice').value;
        const total = document.getElementById('quotationTotal').value;
        const notes = document.getElementById('quotationNotes').value.trim();

        // Get product-specific fields
        let productDetails = {};
        if (tagType === 'hang-tag') {
          productDetails = {
            material: document.getElementById('quotationMaterial')?.value || '',
            size: document.getElementById('quotationSize')?.value || '',
            printingMethod: document.getElementById('quotationPrintingMethod')?.value || ''
          };
        }
        // Add other product types as needed

        // Validation
        if (!customerName) {
          showModal({ title: 'Validation Error', body: 'Customer Name is required.' });
          return;
        }
        if (!quantity || quantity <= 0) {
          showModal({ title: 'Validation Error', body: 'Quantity must be greater than 0.' });
          return;
        }

        // Create quotation object
        const quotation = {
          id: window.editingQuotationId || Date.now(),
          customerName,
          contactPerson,
          email,
          phone,
          productType: tagType,
          productDetails,
          quantity: parseInt(quantity),
          unitPrice: parseFloat(unitPrice) || 0,
          total: parseFloat(total) || 0,
          notes,
          dateCreated: new Date().toISOString(),
          status: 'draft'
        };

        // Save to database
        await saveQuotationToStorage(quotation);

        // Clear edit mode
        window.editingQuotationId = null;

        showModal({
          title: 'Success',
          body: window.editingQuotationId ? 'Quotation updated successfully!' : 'Quotation saved successfully!',
          buttons: [{ text: 'OK', action: 'close' }]
        });

        // Clear form
        clearQuotationForm();

      } catch (error) {
        console.error('Error saving quotation:', error);
        showModal({
          title: 'Save Error',
          body: 'Failed to save quotation. Please try again.',
          buttons: [{ text: 'OK', action: 'close' }]
        });
      }
    };

    async function saveQuotationToStorage(quotation) {
      try {
        let response;
        let result;

        if (quotation.id) {
          // Try to update first
          response = await fetch(`/api/quotations/${quotation.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(quotation)
          });

          // If quotation not found (404), try to create instead
          if (response.status === 404) {
            console.log('Quotation not found, creating new quotation instead');
            response = await fetch('/api/quotations', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...quotation, id: undefined }) // Remove ID for creation
            });
          }

          result = await response.json();
        } else {
          // Create new quotation
          response = await fetch('/api/quotations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(quotation)
          });
          result = await response.json();
        }

        if (!result.success) {
          throw new Error(result.error || 'Failed to save quotation');
        }

        // Update quotation ID if it was created
        if (result.quotation && result.quotation.id && !quotation.id) {
          quotation.id = result.quotation.id;
        }

        console.log('Quotation saved:', result.quotation);
        return result.quotation;
      } catch (error) {
        console.error('Error saving quotation to database:', error);
        throw error;
      }
    }

    async function loadQuotationsFromStorage() {
      try {
        const response = await fetch('/api/quotations');
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to load quotations');
        }
        return result.quotations || [];
      } catch (error) {
        console.error('Error loading quotations from database:', error);
        return [];
      }
    }

    async function deleteQuotationFromStorage(quotationId) {
      try {
        const response = await fetch(`/api/quotations/${quotationId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to delete quotation');
        }

        return true;
      } catch (error) {
        console.error('Error deleting quotation from database:', error);
        throw error;
      }
    }

    window.generateQuotation = function(tagType) {
      // TODO: Implement PDF generation
      showModal({
        title: 'Generate PDF',
        body: 'PDF generation functionality will be implemented. For now, this is a placeholder.',
        buttons: [{ text: 'OK', action: 'close' }]
      });
    };

    // -------- FUZZY SEARCH AND AUTOCOMPLETE --------

    // Fuzzy search function using Levenshtein distance
    function fuzzySearch(query, target) {
      if (!query || !target) return 0;

      query = query.toLowerCase();
      target = target.toLowerCase();

      // Exact match gets highest score
      if (target.includes(query)) return 1;

      // Calculate Levenshtein distance
      const matrix = [];
      for (let i = 0; i <= target.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= query.length; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= target.length; i++) {
        for (let j = 1; j <= query.length; j++) {
          if (target.charAt(i - 1) === query.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // substitution
              matrix[i][j - 1] + 1,     // insertion
              matrix[i - 1][j] + 1      // deletion
            );
          }
        }
      }

      const distance = matrix[target.length][query.length];
      const maxLength = Math.max(query.length, target.length);

      // Return similarity score (1 = perfect match, 0 = no similarity)
      return 1 - (distance / maxLength);
    }

    // Autocomplete class for customer search
    class CustomerAutocomplete {
      constructor(inputId, dropdownId) {
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);
        this.customers = [];
        this.currentIndex = -1;
        this.selectedCustomer = null;
        this.loaded = false;

        this.init();
      }

      async init() {
        await this.loadCustomers();
        this.loaded = true;

        this.input.addEventListener('input', (e) => this.onInput(e));
        this.input.addEventListener('keydown', (e) => this.onKeydown(e));
        this.input.addEventListener('blur', () => setTimeout(() => this.hideDropdown(), 200));
        this.input.addEventListener('focus', () => {
          if (this.input.value.trim()) {
            this.showSuggestions(this.input.value.trim());
          }
        });
      }

      async loadCustomers() {
        this.customers = await loadCustomersFromStorage();
      }

      async refreshCustomers() {
        await this.loadCustomers();
      }

      onInput(e) {
        const query = e.target.value.trim();
        this.selectedCustomer = null;

        if (!this.loaded || query.length < 2) {
          this.hideDropdown();
          return;
        }

        this.showSuggestions(query);
      }

      onKeydown(e) {
        if (!this.dropdown.style.display || this.dropdown.style.display === 'none') {
          return;
        }

        const items = this.dropdown.querySelectorAll('.autocomplete-item');
        if (!items.length) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            this.currentIndex = (this.currentIndex + 1) % items.length;
            this.highlightItem(this.currentIndex);
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.currentIndex = this.currentIndex <= 0 ? items.length - 1 : this.currentIndex - 1;
            this.highlightItem(this.currentIndex);
            break;
          case 'Enter':
            e.preventDefault();
            if (this.currentIndex >= 0 && this.currentIndex < items.length) {
              const selectedItem = items[this.currentIndex];
              const customerId = parseInt(selectedItem.dataset.customerId);
              this.selectCustomer(customerId);
            }
            break;
          case 'Escape':
            this.hideDropdown();
            break;
        }
      }

      showSuggestions(query) {
        const suggestions = this.getSuggestions(query);

        if (suggestions.length === 0) {
          this.dropdown.innerHTML = '<div class="autocomplete-no-results">No matching customers found</div>';
          this.dropdown.style.display = 'block';
          return;
        }

        const html = suggestions.map(customer => `
          <div class="autocomplete-item" data-customer-id="${customer.id}">
            <div style="font-weight: 600;">${this.highlightMatch(customer.companyName, query)}</div>
            <div style="font-size: 12px; color: #666;">${customer.emailDomain} ‚Ä¢ ${customer.companyType}</div>
          </div>
        `).join('');

        this.dropdown.innerHTML = html;
        this.dropdown.style.display = 'block';
        this.currentIndex = -1;

        // Add click handlers
        this.dropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
          item.addEventListener('click', () => {
            const customerId = parseInt(item.dataset.customerId);
            this.selectCustomer(customerId);
          });
          item.addEventListener('mouseenter', () => {
            this.currentIndex = index;
            this.highlightItem(index);
          });
        });
      }

      getSuggestions(query) {
        return this.customers
          .map(customer => ({
            ...customer,
            score: fuzzySearch(query, customer.companyName)
          }))
          .filter(customer => customer.score > 0.3) // Minimum similarity threshold
          .sort((a, b) => b.score - a.score) // Sort by similarity score
          .slice(0, 10); // Limit to top 10 results
      }

      highlightMatch(text, query) {
        if (!query) return text;

        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
      }

      highlightItem(index) {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');
        items.forEach((item, i) => {
          item.classList.toggle('highlighted', i === index);
        });
      }

      selectCustomer(customerId) {
        const customer = this.customers.find(c => c.id === customerId);
        if (!customer) return;

        this.selectedCustomer = customer;
        this.input.value = customer.companyName;
        this.hideDropdown();

        // Auto-populate other quotation fields if they exist and are empty
        this.populateRelatedFields(customer);

        // Make input more compact after selection
        this.input.style.fontSize = '14px';
        this.input.style.padding = '6px';
      }

      populateRelatedFields(customer) {
        // Populate email field if empty
        const emailField = document.getElementById('quotationEmail');
        if (emailField && !emailField.value.trim()) {
          emailField.value = `contact@${customer.emailDomain}`;
        }

        // Populate phone field if empty
        const phoneField = document.getElementById('quotationPhone');
        if (phoneField && !phoneField.value.trim() && customer.companyTel) {
          phoneField.value = customer.companyTel;
        }

        // Populate contact person dropdown with all members
        const contactField = document.getElementById('quotationContactPerson');
        if (contactField) {
          // Clear existing options except the default
          contactField.innerHTML = '<option value="">Select Contact Person</option>';

          // Add all members as options
          if (customer.members && customer.members.length > 0) {
            customer.members.forEach(member => {
              if (member.name) {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = `${member.name}${member.title ? ` (${member.title})` : ''}`;
                option.dataset.memberData = JSON.stringify(member);
                contactField.appendChild(option);
              }
            });

            // Auto-select first member if no selection yet
            if (contactField.selectedIndex === 0) {
              contactField.selectedIndex = 1; // Select first member
            }
          }
        }
      }

      hideDropdown() {
        this.dropdown.style.display = 'none';
        this.currentIndex = -1;
      }

      refreshCustomers() {
        this.loadCustomers();
      }
    }

    // -------- AGENT SKILLS MANAGEMENT --------
    let currentAgentSkills = [];

    function loadAgentSkills() {
      const tbody = document.getElementById('skillsTableBody');
      const loadingRow = document.getElementById('skillsLoadingRow');
      loadingRow.style.display = 'table-row';

      fetch('/api/skills')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            currentAgentSkills = data.skills;
            displayAgentSkills();
            loadSkillStats();
          } else {
            tbody.innerHTML = `<tr><td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">Error: ${data.error}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('Error loading skills:', error);
          tbody.innerHTML = `<tr><td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">Failed to load skills: ${error.message}</td></tr>`;
        })
        .finally(() => {
          loadingRow.style.display = 'none';
        });
    }

    function loadSkillStats() {
      fetch('/api/skills/stats')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const stats = data.stats;
            document.getElementById('totalSkills').textContent = stats.total;
            document.getElementById('completedSkills').textContent = stats.completed || 0;
            document.getElementById('inProgressSkills').textContent = stats.inProgress || 0;
            document.getElementById('plannedSkills').textContent = stats.planned || 0;
          }
        })
        .catch(error => {
          console.error('Error loading skill stats:', error);
        });
    }

    function displayAgentSkills() {
      const tbody = document.getElementById('skillsTableBody');
      let filteredSkills = applyAgentSkillFilters(currentAgentSkills);

      if (filteredSkills.length === 0 && currentAgentSkills.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No skills documented yet. Create your first skill.
            </td>
          </tr>
        `;
        return;
      }

      if (filteredSkills.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="border:1px solid #000; padding:20px; text-align:center; color:#666;">
              No skills match the current filters.
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filteredSkills.forEach((skill) => {
        const statusColor = getStatusColor(skill.status);
        const primaryTag = skill.tags && skill.tags.length > 0 ? skill.tags[0] : 'other';
        const categoryColor = getCategoryColor(primaryTag);

        html += '<tr style="background:#fff;">' +
          '<td style="border:1px solid #000; padding:8px; font-weight:600;">' + skill.name + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<span style="background:' + statusColor + '; color:#fff; padding:2px 6px; border-radius:0; font-size:11px; font-weight:600;">' +
              skill.status.replace('-', ' ').toUpperCase() +
            '</span>' +
          '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<span style="background:' + categoryColor + '; color:#fff; padding:2px 6px; border-radius:0; font-size:11px; font-weight:600;">' +
              primaryTag.toUpperCase() +
            '</span>' +
          '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' + skill.description + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' + skill.version + '</td>' +
          '<td style="border:1px solid #000; padding:8px;">' +
            '<button class="page-btn view-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px;">View</button>' +
            '<button class="page-btn edit-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px; margin-left:5px;">Edit</button>' +
            '<button class="page-btn delete-skill-btn" data-skill="' + skill.name + '" style="font-size:12px; padding:4px 8px; margin-left:5px;">Delete</button>' +
          '</td>' +
        '</tr>';
      });

      tbody.innerHTML = html;

      // Add event listeners
      document.querySelectorAll('.view-skill-btn').forEach(btn => {
        btn.onclick = () => viewSkill(btn.dataset.skill);
      });
      document.querySelectorAll('.edit-skill-btn').forEach(btn => {
        btn.onclick = () => editSkill(btn.dataset.skill);
      });
      document.querySelectorAll('.delete-skill-btn').forEach(btn => {
        btn.onclick = () => deleteSkill(btn.dataset.skill);
      });
    }

    function getStatusColor(status) {
      switch (status) {
        case 'completed': return '#28a745';
        case 'in-progress': return '#ffc107';
        case 'planned': return '#6c757d';
        case 'deprecated': return '#dc3545';
        default: return '#6c757d';
      }
    }

    function getCategoryColor(category) {
      switch (category) {
        case 'frontend': return '#007bff';
        case 'backend': return '#28a745';
        case 'database': return '#fd7e14';
        case 'deployment': return '#6f42c1';
        case 'design': return '#e83e8c';
        case 'testing': return '#20c997';
        case 'documentation': return '#17a2b8';
        default: return '#6c757d';
      }
    }

    function applyAgentSkillFilters(skills) {
      const statusFilter = document.getElementById('skillStatusFilter').value;
      const categoryFilter = document.getElementById('skillCategoryFilter').value;
      const searchFilter = document.getElementById('skillSearch').value.toLowerCase();

      return skills.filter(skill => {
        const matchesStatus = !statusFilter || skill.status === statusFilter;
        const matchesCategory = !categoryFilter || (skill.tags && skill.tags.some(tag => tag.toLowerCase() === categoryFilter.toLowerCase()));
        const matchesSearch = !searchFilter ||
          skill.name.toLowerCase().includes(searchFilter) ||
          skill.description.toLowerCase().includes(searchFilter) ||
          (skill.tags && skill.tags.some(tag => tag.toLowerCase().includes(searchFilter)));

        return matchesStatus && matchesCategory && matchesSearch;
      });
    }

    function createSkill() {
      showModal({
        title: 'Create New Skill',
        body: `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Skill Name * <small>(kebab-case, e.g., email-integration)</small></label>
            <input type="text" id="skillNameInput" style="width:100%; padding:8px; border:1px solid #000;" placeholder="email-system-integration">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Primary Tag *</label>
            <select id="skillCategoryInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
              <option value="">Select Category</option>
              <option value="frontend">Frontend</option>
              <option value="backend">Backend</option>
              <option value="database">Database</option>
              <option value="deployment">Deployment</option>
              <option value="design">Design</option>
              <option value="testing">Testing</option>
              <option value="documentation">Documentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Status *</label>
            <select id="skillStatusInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
              <option value="planned">Planned</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="deprecated">Deprecated</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Version *</label>
            <input type="text" id="skillVersionInput" value="1.0.0" style="width:100%; padding:8px; border:1px solid #000;" placeholder="1.0.0">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Description *</label>
            <textarea id="skillDescriptionInput" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;" placeholder="Brief description of what this skill accomplishes"></textarea>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Tags <small>(comma-separated)</small></label>
            <input type="text" id="skillTagsInput" style="width:100%; padding:8px; border:1px solid #000;" placeholder="ui, email, integration">
          </div>
        `,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Create Skill', action: 'create', primary: true }
        ]
      });

      // Handle create skill
      const createBtn = document.querySelector('.modal-btn[data-action="create"]');
      if (createBtn) {
        createBtn.onclick = () => {
          const name = document.getElementById('skillNameInput').value.trim();
          const primaryTag = document.getElementById('skillCategoryInput').value;
          const status = document.getElementById('skillStatusInput').value;
          const version = document.getElementById('skillVersionInput').value.trim();
          const description = document.getElementById('skillDescriptionInput').value.trim();
          const tagsInput = document.getElementById('skillTagsInput').value.trim();

          if (!name || !primaryTag || !status || !version || !description) {
            showModal({
              title: 'Validation Error',
              body: 'Please fill in all required fields marked with *.',
              buttons: [{ text: 'OK', action: 'close' }]
            });
            return;
          }

          // Create tags array with primary tag first, then additional tags
          let tags = [primaryTag];
          if (tagsInput) {
            const additionalTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== primaryTag);
            tags = tags.concat(additionalTags);
          }
          const now = new Date().toISOString().split('T')[0];

          const skillData = {
            name,
            status,
            version,
            description,
            tags,
            created: now,
            updated: now
          };

          fetch('/api/skills', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(skillData)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
          closeModal();
              loadAgentSkills();
              showModal({
                title: 'Success',
                body: `Skill "${name}" created successfully!`,
                buttons: [{ text: 'OK', action: 'close' }]
              });
            } else {
              throw new Error(data.error);
            }
          })
          .catch(error => {
            showModal({
              title: 'Error',
              body: `Failed to create skill: ${error.message}`,
              buttons: [{ text: 'OK', action: 'close' }]
            });
          });
        };
      }
    }

    function viewSkill(skillName) {
      fetch(`/api/skills/${skillName}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const skill = data.skill;
            let body = '<div style="margin-bottom:15px;">' +
              '<strong>Name:</strong> ' + skill.name +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Status:</strong> <span style="background:' + getStatusColor(skill.status) + '; color:#fff; padding:2px 6px; font-size:11px; font-weight:600;">' + skill.status.toUpperCase() + '</span>' +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Category:</strong> <span style="background:' + getCategoryColor(skill.tags && skill.tags.length > 0 ? skill.tags[0] : 'other') + '; color:#fff; padding:2px 6px; font-size:11px; font-weight:600;">' + (skill.tags && skill.tags.length > 0 ? skill.tags[0].toUpperCase() : 'OTHER') + '</span>' +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Version:</strong> ' + skill.version +
            '</div>' +
            '<div style="margin-bottom:15px;">' +
              '<strong>Description:</strong><br>' + skill.description +
            '</div>';

            if (skill.tags && skill.tags.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Tags:</strong> ${skill.tags.join(', ')}</div>`;
            }

            if (skill.changes && skill.changes.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Changes:</strong><ul>`;
              skill.changes.forEach(change => {
                body += `<li><strong>${change.component}:</strong> ${change.description}`;
                if (change.impact) body += ` <em>(${change.impact})</em>`;
                body += `</li>`;
              });
              body += `</ul></div>`;
            }

            if (skill.dependencies && skill.dependencies.length > 0) {
              body += `<div style="margin-bottom:15px;"><strong>Dependencies:</strong> ${skill.dependencies.join(', ')}</div>`;
            }

            body += `
              <div style="margin-bottom:15px;">
                <strong>Created:</strong> ${skill.created}
              </div>
              <div style="margin-bottom:15px;">
                <strong>Updated:</strong> ${skill.updated}
              </div>
            `;

            showModal({
              title: `Skill: ${skill.name}`,
              body: body,
              buttons: [{ text: 'Close', action: 'close' }]
            });
          } else {
            throw new Error(data.error);
          }
        })
        .catch(error => {
          showModal({
            title: 'Error',
            body: `Failed to load skill details: ${error.message}`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        });
    }

    function editSkill(skillName) {
      // Load skill data first
      fetch(`/api/skills/${skillName}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const skill = data.skill;
      showModal({
        title: 'Edit Skill',
        body: `
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Skill Name *</label>
                  <input type="text" id="editSkillNameInput" value="${skill.name}" style="width:100%; padding:8px; border:1px solid #000;" readonly>
                  <small style="color:#666;">Skill name cannot be changed</small>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">Primary Tag *</label>
                  <select id="editSkillCategoryInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                    <option value="frontend" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'frontend' ? 'selected' : ''}>Frontend</option>
                    <option value="backend" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'backend' ? 'selected' : ''}>Backend</option>
                    <option value="database" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'database' ? 'selected' : ''}>Database</option>
                    <option value="deployment" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'deployment' ? 'selected' : ''}>Deployment</option>
                    <option value="design" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'design' ? 'selected' : ''}>Design</option>
                    <option value="testing" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'testing' ? 'selected' : ''}>Testing</option>
                    <option value="documentation" ${skill.tags && skill.tags.length > 0 && skill.tags[0] === 'documentation' ? 'selected' : ''}>Documentation</option>
                    <option value="other" ${(!skill.tags || skill.tags.length === 0 || !['frontend','backend','database','deployment','design','testing','documentation'].includes(skill.tags[0])) ? 'selected' : ''}>Other</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Status *</label>
                  <select id="editSkillStatusInput" style="width:100%; padding:8px; border:1px solid #000; background:#fff;">
                    <option value="planned" ${skill.status === 'planned' ? 'selected' : ''}>Planned</option>
                    <option value="in-progress" ${skill.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${skill.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="deprecated" ${skill.status === 'deprecated' ? 'selected' : ''}>Deprecated</option>
                  </select>
          </div>
          <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Version *</label>
                  <input type="text" id="editSkillVersionInput" value="${skill.version}" style="width:100%; padding:8px; border:1px solid #000;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Description *</label>
                  <textarea id="editSkillDescriptionInput" style="width:100%; min-height:80px; padding:8px; border:1px solid #000;">${skill.description}</textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block; margin-bottom:5px;">Tags <small>(comma-separated)</small></label>
                  <input type="text" id="editSkillTagsInput" value="${skill.tags ? skill.tags.join(', ') : ''}" style="width:100%; padding:8px; border:1px solid #000;">
          </div>
        `,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Save Changes', action: 'save', primary: true }
        ]
      });

      // Handle save changes
      const saveBtn = document.querySelector('.modal-btn[data-action="save"]');
      if (saveBtn) {
        saveBtn.onclick = () => {
                const primaryTag = document.getElementById('editSkillCategoryInput').value;
                const status = document.getElementById('editSkillStatusInput').value;
                const version = document.getElementById('editSkillVersionInput').value.trim();
                const description = document.getElementById('editSkillDescriptionInput').value.trim();
                const tagsInput = document.getElementById('editSkillTagsInput').value.trim();

                if (!primaryTag || !status || !version || !description) {
                  showModal({
                    title: 'Validation Error',
                    body: 'Please fill in all required fields marked with *.',
                    buttons: [{ text: 'OK', action: 'close' }]
                  });
            return;
          }

                // Create tags array with primary tag first, then additional tags
                let tags = [primaryTag];
                if (tagsInput) {
                  const additionalTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== primaryTag);
                  tags = tags.concat(additionalTags);
                }
                const now = new Date().toISOString().split('T')[0];

                const updates = {
                  status,
                  version,
            description,
                  tags,
                  updated: now
                };

                fetch(`/api/skills/${skillName}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updates)
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
          closeModal();
                    loadAgentSkills();
                    showModal({
                      title: 'Success',
                      body: `Skill "${skillName}" updated successfully!`,
                      buttons: [{ text: 'OK', action: 'close' }]
                    });
                  } else {
                    throw new Error(data.error);
                  }
                })
                .catch(error => {
                  showModal({
                    title: 'Error',
                    body: `Failed to update skill: ${error.message}`,
                    buttons: [{ text: 'OK', action: 'close' }]
                  });
                });
              };
            }
          } else {
            throw new Error(data.error);
          }
        })
        .catch(error => {
          showModal({
            title: 'Error',
            body: `Failed to load skill for editing: ${error.message}`,
            buttons: [{ text: 'OK', action: 'close' }]
          });
        });
    }

    function deleteSkill(skillName) {
      showModal({
        title: 'Confirm Delete',
        body: `Are you sure you want to delete the skill "${skillName}"? This action cannot be undone.`,
        buttons: [
          { text: 'Cancel', action: 'close' },
          { text: 'Delete', action: 'delete', primary: true }
        ]
      });

      const deleteBtn = document.querySelector('.modal-btn[data-action="delete"]');
      if (deleteBtn) {
        deleteBtn.onclick = () => {
          fetch(`/api/skills/${skillName}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              closeModal();
              loadAgentSkills();
              showModal({
                title: 'Success',
                body: `Skill "${skillName}" deleted successfully!`,
                buttons: [{ text: 'OK', action: 'close' }]
              });
            } else {
              throw new Error(data.error);
            }
          })
          .catch(error => {
            closeModal();
            showModal({
              title: 'Error',
              body: `Failed to delete skill: ${error.message}`,
              buttons: [{ text: 'OK', action: 'close' }]
            });
          });
        };
      }
    }

    // Agent Skills panel event listeners
    document.getElementById('addSkillBtn').onclick = () => createSkill();
    document.getElementById('refreshSkillsBtn').onclick = () => loadAgentSkills();

    // Skills filter event listeners
    document.getElementById('skillStatusFilter').addEventListener('change', () => displayAgentSkills());
    document.getElementById('skillCategoryFilter').addEventListener('change', () => displayAgentSkills());
    document.getElementById('skillSearch').addEventListener('input', () => displayAgentSkills());
    
    load();
  </script>
</body>
</html>

