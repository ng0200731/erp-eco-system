<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Client</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 0; padding: 20px; background:#f5f5f5;}
    h1 {text-align:center;}
    #emails {max-width:800px; margin:0 auto; background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1);}
    ul {list-style:none; padding:0; margin:0;}
    li {padding:12px; border-bottom:1px solid #eee; cursor:pointer;}
    li:hover {background:#fafafa;}
    .sub {font-weight:bold;}
    .meta {font-size:.9em; color:#666;}
    pre {white-space:pre-wrap; background:#fafafa; padding:15px; border-radius:4px;}
  </style>
</head>
<body>
  <h1>Email Client</h1>
  <div id="emails">
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="composeBtn" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">‚úâ Compose</button>
      <button id="testSendBtn" style="background:#2196F3; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">üìß Send Test Email</button>
      <button id="testSmtpBtn" style="background:#FF9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">üîå Test SMTP Connection</button>
    </div>
    <div id="composeForm" style="display:none; background:#f9f9f9; padding:15px; border-radius:4px; margin-bottom:15px;">
      <h3>Compose Email</h3>
      <input type="email" id="toEmail" placeholder="To:" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">
      <input type="text" id="subjectEmail" placeholder="Subject:" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">
      <textarea id="bodyEmail" placeholder="Message:" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; min-height:150px;"></textarea>
      <div style="display:flex; gap:10px;">
        <button id="sendBtn" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Send</button>
        <button id="cancelBtn" style="background:#999; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Cancel</button>
      </div>
    </div>
    <ul id="list"></ul>
    <div id="detail" style="display:none">
      <button id="back">‚Üê Back</button>
      <h2 id="d-sub"></h2>
      <p class="meta"><span id="d-from"></span> ‚Äì <span id="d-date"></span></p>
      <pre id="d-body"></pre>
    </div>
  </div>
  <script>
    const listEl = document.getElementById('list');
    const detailEl = document.getElementById('detail');
    const backBtn = document.getElementById('back');
    
    // Store current email list for quick access
    let currentEmails = [];
    let currentLoadController = null; // Track current load request
    
    async function load(showLoading = true) {
      try {
        // Cancel any existing load request
        if (currentLoadController) {
          console.log('Cancelling previous load request');
          currentLoadController.abort();
        }
        
        // Create new abort controller for this request
        currentLoadController = new AbortController();
        const controller = currentLoadController;
        
        if (showLoading) {
          console.log('Loading emails...');
          listEl.innerHTML = '<li>Loading emails...</li>';
          listEl.style.display = 'block';
          detailEl.style.display = 'none';
        } else {
          console.log('Refreshing emails in background...');
        }
        
        // Add timeout to fetch request
        const timeoutId = setTimeout(() => {
          if (!controller.signal.aborted) {
            console.log('Request timeout, aborting...');
            controller.abort();
          }
        }, 30000); // 30 second timeout
        
        let res;
        try {
          res = await fetch('/api/emails?limit=50', { 
            signal: controller.signal,
            cache: 'no-cache' // Prevent caching
          });
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on success
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          currentLoadController = null; // Clear on error
          
          if (fetchErr.name === 'AbortError') {
            // Only show error if we were showing loading state
            if (showLoading) {
              throw new Error('Request timeout - server took too long to respond');
            } else {
              // Background refresh failed, just log it
              console.warn('Background refresh failed:', fetchErr.message);
              return;
            }
          }
          throw fetchErr;
        }
        
        console.log('Response status:', res.status, res.statusText);
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to load emails';
          const errorCode = errorData.code ? ` (${errorData.code})` : '';
          listEl.innerHTML = `<li style="color:red; padding:20px; background:#ffe6e6; border:1px solid #ff9999; border-radius:4px;">
            <strong>Error:</strong> ${errorMsg}${errorCode}<br>
            <small>Status: ${res.status}</small>
            ${errorData.details ? `<br><small style="font-family:monospace; font-size:0.8em;">${errorData.details}</small>` : ''}
          </li>`;
          console.error('API error:', errorData, res.status);
          return;
        }
        
        const data = await res.json();
        console.log('Received data:', data);
        
        if (!data.success) {
          listEl.innerHTML = `<li style="color:red; padding:20px;">Error: ${data.error || 'Failed to load emails'}</li>`;
          console.error('API error:', data);
          return;
        }
        
        const emails = data.emails || [];
        console.log('Loaded emails:', emails.length);
        currentEmails = emails; // Store for reference
        
        // Render the email list (only if showLoading was true, otherwise we're in background)
        if (showLoading) {
          renderEmailList(emails);
          console.log('Email list rendered successfully');
        } else {
          // Background refresh - update cache and re-render if list is visible
          currentEmails = emails;
          if (listEl.style.display !== 'none' && detailEl.style.display === 'none') {
            // List is visible, update it
            renderEmailList(emails);
            console.log('Email list refreshed in background');
          } else {
            console.log('Email list cached (detail view is active)');
          }
        }
      } catch (err) {
        console.error('Load function error:', err);
        // Only show error if we were showing loading state
        if (showLoading) {
          listEl.innerHTML = `<li style="color:red; padding:20px;">Error loading emails: ${err.message}<br><small>Check browser console (F12) for details</small></li>`;
        }
        // Background refresh errors are already logged above
      }
    }
    
    async function show(uid){
      try {
        // Show loading state
        detailEl.style.display='block';
        listEl.style.display='none';
        document.getElementById('d-body').textContent = 'Loading email...';
        document.getElementById('d-sub').textContent = '';
        document.getElementById('d-from').textContent = '';
        document.getElementById('d-date').textContent = '';
        
        const res = await fetch('/api/emails/'+uid);
        
        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText || `HTTP ${res.status}` };
          }
          const errorMsg = errorData.error || 'Failed to fetch email';
          const errorCode = errorData.code ? ` (Code: ${errorData.code})` : '';
          const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\nStatus: ${res.status}\n\nFull details:\n${JSON.stringify(errorData, null, 2)}`;
          showCopyableError('Fetch Email Error', fullError);
          console.error('Fetch email error:', errorData);
          // Go back to list on error
          detailEl.style.display='none';
          listEl.style.display='block';
          return;
        }
        
        const data = await res.json();
        if (!data.success) {
          const errorMsg = data.error || 'Failed to load email';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const fullError = `Error: ${errorMsg}${errorCode}\n\nUID: ${uid}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Email Error', fullError);
          console.error('API error:', data);
          // Go back to list on error
          detailEl.style.display='none';
          listEl.style.display='block';
          return;
        }
        
        // Parse email headers from source
        const source = data.source || '';
        let subject = '';
        let from = '';
        let date = '';
        
        // Try to extract headers from raw email source
        const subjectMatch = source.match(/^Subject:\s*(.+)$/mi);
        const fromMatch = source.match(/^From:\s*(.+)$/mi);
        const dateMatch = source.match(/^Date:\s*(.+)$/mi);
        
        if (subjectMatch) subject = subjectMatch[1].trim();
        if (fromMatch) from = fromMatch[1].trim();
        if (dateMatch) date = dateMatch[1].trim();
        
        // Display email
        document.getElementById('d-body').textContent = source || 'No content';
        document.getElementById('d-sub').textContent = subject || '(No subject)';
        document.getElementById('d-from').textContent = from || 'Unknown';
        document.getElementById('d-date').textContent = date || '';
        
        listEl.style.display='none';
        detailEl.style.display='block';
      } catch (err) {
        const fullError = `Error fetching email: ${err.message}\n\nUID: ${uid}\n\nStack trace:\n${err.stack || 'N/A'}`;
        showCopyableError('Network Error', fullError);
        console.error('Fetch error:', err);
        // Go back to list on error
        detailEl.style.display='none';
        listEl.style.display='block';
      }
    }
    
    // Helper function to show copyable error
    function showCopyableError(title, errorText) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
      
      // Create modal box
      const modal = document.createElement('div');
      modal.style.cssText = 'background:white; padding:20px; border-radius:8px; max-width:600px; max-height:80vh; overflow:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);';
      
      // Title
      const titleEl = document.createElement('h3');
      titleEl.textContent = title;
      titleEl.style.cssText = 'margin:0 0 15px 0; color:#d32f2f;';
      
      // Textarea for error (copyable)
      const textarea = document.createElement('textarea');
      textarea.value = errorText;
      textarea.readOnly = true;
      textarea.style.cssText = 'width:100%; min-height:200px; padding:10px; border:1px solid #ccc; border-radius:4px; font-family:monospace; font-size:12px; resize:vertical; box-sizing:border-box;';
      
      // Buttons container
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'margin-top:15px; display:flex; gap:10px; justify-content:flex-end;';
      
      // Copy button
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'üìã Copy Error';
      copyBtn.style.cssText = 'padding:8px 16px; background:#1976d2; color:white; border:none; border-radius:4px; cursor:pointer;';
      copyBtn.onclick = () => {
        textarea.select();
        document.execCommand('copy');
        copyBtn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          copyBtn.textContent = 'üìã Copy Error';
        }, 2000);
      };
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.cssText = 'padding:8px 16px; background:#666; color:white; border:none; border-radius:4px; cursor:pointer;';
      closeBtn.onclick = () => {
        document.body.removeChild(overlay);
      };
      
      // Assemble modal
      modal.appendChild(titleEl);
      modal.appendChild(textarea);
      buttonsDiv.appendChild(copyBtn);
      buttonsDiv.appendChild(closeBtn);
      modal.appendChild(buttonsDiv);
      overlay.appendChild(modal);
      
      // Add to page
      document.body.appendChild(overlay);
      
      // Auto-select text for easy copying
      setTimeout(() => {
        textarea.select();
      }, 100);
      
      // Close on overlay click
      overlay.onclick = (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      };
    }
    
    backBtn.onclick=()=>{
      console.log('Back button clicked');
      detailEl.style.display='none'; 
      listEl.style.display='block';
      
      // If we have cached emails, show them immediately
      if (currentEmails && currentEmails.length > 0) {
        console.log('Using cached email list:', currentEmails.length);
        renderEmailList(currentEmails);
        // Optionally refresh in background (silently, no loading indicator)
        // Only refresh if not already loading
        if (!currentLoadController || currentLoadController.signal.aborted) {
          load(false).catch(err => {
            console.warn('Background refresh failed:', err.message);
            // Silently fail - we already have cached emails displayed
          });
        }
      } else {
        // No cache, must load with loading indicator
        load(true).catch(err => {
          console.error('Error loading emails after back:', err);
          listEl.innerHTML = `<li style="color:red; padding:20px;">Error loading emails: ${err.message}</li>`;
        });
      }
    };
    
    // Helper function to render email list
    function renderEmailList(emails) {
      listEl.innerHTML='';
      
      if (emails.length === 0) {
        listEl.innerHTML = '<li>No emails found in inbox</li>';
        return;
      }
      
      emails.forEach(e=>{
        const li=document.createElement('li');
        li.innerHTML = `<div class="sub">${e.subject||'No subject'}</div><div class="meta">${e.from||''} ‚Äì ${new Date(e.date).toLocaleString()}</div>`;
        li.style.cursor = 'pointer';
        li.onclick=()=>{
          console.log('Clicking email UID:', e.uid);
          show(e.uid);
        };
        listEl.appendChild(li);
      });
      
      listEl.style.display='block';
      detailEl.style.display='none';
    }
    
    // Compose email handlers
    const composeBtn = document.getElementById('composeBtn');
    const composeForm = document.getElementById('composeForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const sendBtn = document.getElementById('sendBtn');
    const testSendBtn = document.getElementById('testSendBtn');
    
    composeBtn.onclick = () => {
      composeForm.style.display = composeForm.style.display === 'none' ? 'block' : 'none';
    };
    
    cancelBtn.onclick = () => {
      composeForm.style.display = 'none';
      document.getElementById('toEmail').value = '';
      document.getElementById('subjectEmail').value = '';
      document.getElementById('bodyEmail').value = '';
    };
    
    sendBtn.onclick = async () => {
      const to = document.getElementById('toEmail').value;
      const subject = document.getElementById('subjectEmail').value;
      const text = document.getElementById('bodyEmail').value;
      
      if (!to || !subject || !text) {
        alert('Please fill in all fields');
        return;
      }
      
      try {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        const res = await fetch('/api/email/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, subject, text })
        });
        const data = await res.json();
        if (data.success) {
          alert('Email sent successfully!\nMessage ID: ' + (data.messageId || 'N/A'));
          composeForm.style.display = 'none';
          document.getElementById('toEmail').value = '';
          document.getElementById('subjectEmail').value = '';
          document.getElementById('bodyEmail').value = '';
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Error sending email:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Send Email Error', errorText);
          console.error('Send email error:', data);
        }
      } catch (err) {
        showCopyableError('Send Email Error', `Error sending email: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    };
    
    // Test SMTP connection
    const testSmtpBtn = document.getElementById('testSmtpBtn');
    testSmtpBtn.onclick = async () => {
      try {
        testSmtpBtn.disabled = true;
        testSmtpBtn.textContent = 'Testing...';
        console.log('Testing SMTP connection...');
        const res = await fetch('/api/smtp/test');
        const data = await res.json();
        if (data.success) {
          alert(`‚úÖ SMTP Connection Successful!\n\nHost: ${data.host}\nPort: ${data.port}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}`);
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `‚ùå SMTP Connection Failed:\n${errorMsg}${errorCode}\n\nHost: ${data.host || 'N/A'}\nPort: ${data.port || 'N/A'}\nSecure: ${data.secure ? 'SSL/TLS' : 'STARTTLS'}\n\n${data.troubleshooting || ''}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('SMTP Connection Error', errorText);
          console.error('SMTP test error:', data);
        }
      } catch (err) {
        showCopyableError('SMTP Test Error', `Error testing SMTP: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
        console.error('SMTP test error:', err);
      } finally {
        testSmtpBtn.disabled = false;
        testSmtpBtn.textContent = 'üîå Test SMTP Connection';
      }
    };
    
    // Test send email to eric.brilliant@gmail.com
    testSendBtn.onclick = async () => {
      if (!confirm('Send test email to eric.brilliant@gmail.com?')) return;
      try {
        testSendBtn.disabled = true;
        testSendBtn.textContent = 'Sending...';
        const res = await fetch('/api/email/test', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert('Test email sent successfully to ' + data.to + '!');
        } else {
          const errorMsg = data.error || 'Unknown error';
          const errorCode = data.code ? ` (Code: ${data.code})` : '';
          const errorText = `Test Email Error:\n${errorMsg}${errorCode}\n\nFull details:\n${JSON.stringify(data, null, 2)}`;
          showCopyableError('Test Email Error', errorText);
          console.error('Test email error:', data);
        }
      } catch (err) {
        showCopyableError('Test Email Error', `Error: ${err.message}\n\nStack trace:\n${err.stack || 'N/A'}`);
      } finally {
        testSendBtn.disabled = false;
        testSendBtn.textContent = 'üìß Send Test Email';
      }
    };
    
    load();
  </script>
</body>
</html>

